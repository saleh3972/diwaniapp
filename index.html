<!DOCTYPE html>
<html dir="rtl" lang="ar">
<!--
    ========================================
    🎯 الديوان - النظام المحاسبي v20.0
    ========================================
    
    📋 التحسينات في هذا الإصدار:
    
    🔴 تحسينات الأمان والأداء:
    ✅ 1. نظام تشفير كلمات المرور (SHA-256)
       - تشفير كلمات المرور الجديدة تلقائياً
       - التوافق مع كلمات المرور القديمة والتحديث التلقائي
       
    ✅ 2. مؤشرات التحميل (Loading Indicators)
       - مؤشر تحميل عند تسجيل الدخول
       - مؤشر تحميل عند إضافة/تحديث/حذف البيانات
       - مؤشر تحميل عند تحميل النشاط
       
    ✅ 3. معالجة الأخطاء المتقدمة (Error Handling)
       - نظام logError لتسجيل الأخطاء
       - حفظ سجل الأخطاء في localStorage
       - رسائل خطأ واضحة للمستخدم
       - استعادة البيانات عند فشل العمليات
    
    ✅ 4. التحقق من صحة المدخلات (Input Validation)
       - ValidationHelper: مجموعة شاملة من دوال التحقق
       - التحقق من الحقول الإلزامية والحد الأدنى/الأقصى للطول
       - التحقق من الأرقام الموجبة والنطاقات
       - التحقق من البريد الإلكتروني ورقم الجوال السعودي
       - منع التكرار في الأسماء والأكواد
       - تلوين الحقول (أحمر للخطأ، أخضر للصحيح)
       - رسائل خطأ واضحة بالعربي مع تأثيرات بصرية
    
    🔵 تحسينات تجربة المستخدم:
    ✅ 5. نظام الإشعارات الذكي
       - إشعارات انخفاض المخزون
       - تنبيهات الديون غير المدفوعة
       - إشعارات الأصناف التي نفذت
       - 4 أنواع من الإشعارات (نجاح، تحذير، خطأ، معلومات)
       
    ✅ 6. سلة المحذوفات
       - نقل العناصر المحذوفة إلى سلة محذوفات
       - إمكانية استعادة العناصر خلال 30 يوم
       - حذف تلقائي للعناصر القديمة
       - دعم جميع أنواع البيانات (أصناف، عملاء، موردين، إلخ)
    
    ✅ 7. نظام الحوار الاحترافي (Professional Confirm Dialog)
       - استبدال رسائل confirm() التقليدية بحوارات احترافية
       - تصميم عصري مع أيقونات ملونة
       - 4 أنواع من الحوارات (تحذير، خطر، معلومات، نجاح)
       - إمكانية الإغلاق بالضغط خارج الحوار أو بزر Escape
       - رسائل واضحة مع أزرار مخصصة لكل حالة
       - تأثيرات بصرية سلسة (Animations)
    
    تاريخ التحديث: 23 أكتوبر 2025
    ========================================
-->
<head>
    <title>النظام المحاسبي - ديواني</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Preconnect للخطوط لتحسين الأداء -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Reem+Kufi&display=swap" rel="stylesheet">
    
    <!-- السكربتات الخارجية - Firebase بدون defer لأنه مطلوب فوراً -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- إضافة Firebase - بدون defer لأن الكود الداخلي يعتمد عليه -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        /* تنسيقات لوحة التحكم المتقدمة */
        .login-form.active {
            display: block !important;
        }
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border-top: 4px solid var(--primary-color);
            margin-bottom: 20px;
        }

        .stat-trend {
            font-size: 0.8em;
            margin-top: 5px;
            font-weight: bold;
        }

        .trend-up { 
            color: var(--success-color); 
        }

        .trend-down { 
            color: var(--accent-color); 
        }

        .analytics-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            .analytics-grid {
                grid-template-columns: 1fr;
            }
      
 
      
        }

        /* إصلاحات عامة للجوال */
        * {
            box-sizing: border-box;
        }
        
        html {
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
        }
        
        body {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
            position: relative;
        }
        
        /* منع أي overflow أفقي */
        .section, .container, .form-grid, table, .invoice-items, .report-controls {
            max-width: 100%;
        }
        
        /* تحسين عرض الجداول */
        table {
            table-layout: auto;
            width: 100%;
        }
        
        /* تحسين touch scrolling */
        .invoice-items, .section table {
            -webkit-overflow-scrolling: touch;
        }

        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #34495e;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --bg-color: #ecf0f1;
            --text-color: #2c3e50;
            --font-size: 16px;
            --font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --sidebar-width: 280px;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --header-bg: linear-gradient(135deg, #2c5aa0 0%, #34495e 100%);
        }
    

/* ===== تحسينات لوحة التحكم المتقدمة ===== */
.chart-card {
    background: white;
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    border-top: 4px solid var(--primary-color);
    margin-bottom: 25px;
    height: 320px;
    position: relative;
    transition: all 0.3s ease;
}

@media (max-width: 480px) {
    .advanced-stats {
        gap: 15px !important;
    }

    .advanced-stats .stat-card {
        padding: 16px 12px;
    }

    .advanced-stats .stat-number {
        font-size: 1.7em;
    }
    th {
        padding: 10px 12px;
    }
}

.chart-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.chart-card canvas {
    width: 100% !important;
    height: 240px !important;
    margin-top: 10px;
}

.chart-card h3 {
    color: var(--primary-color);
    margin-bottom: 15px;
    font-size: 1em;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 10px;
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.analytics-card {
    background: white;
    padding: 10px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin-bottom: 20px;
    min-height: 120px;
    border-right: 4px solid var(--success-color);
    transition: all 0.3s ease;
}

.analytics-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
}

.analytics-card h3 {
    color: var(--primary-color);
    margin-bottom: 15px;
    font-size: 1.1em;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 8px;
    font-weight: 700;
}

.analytics-card p {
    margin: 8px 0;
    font-size: 14px;
    line-height: 1.5;
    color: var(--text-color);
}

.analytics-card strong {
    color: var(--secondary-color);
    font-weight: 700;
}

/* تحسينات للشبكة التحليلية */
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 25px;
    margin: 30px 0;
}

/* تحسينات للإحصائيات الحية */
.stat-card {
    background: white;
    padding: 10px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    border-top: 5px solid var(--primary-color);
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-color), var(--success-color));
}

.stat-number {
    font-size: 1.8em;
    font-weight: bold;
    color: var(--primary-color);
    margin: 8px 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-label {
    color: var(--secondary-color);
    font-size: 0.9em;
    font-weight: 600;
    margin-bottom: 8px;
}

.stat-trend {
    font-size: 0.9em;
    margin-top: 8px;
    font-weight: bold;
    padding: 4px 12px;
    border-radius: 20px;
    display: inline-block;
}

.trend-up {
    background: rgba(39, 174, 96, 0.1);
    color: var(--success-color);
}

.trend-down {
    background: rgba(231, 76, 60, 0.1);
    color: var(--accent-color);
}

/* تخصيص بطاقات الإحصائيات في لوحة التحكم المتقدمة */
.advanced-stats {
    display: grid !important;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)) !important;
    gap: 20px !important;
    margin-bottom: 30px;
}

.advanced-stats .stat-card {
    padding: 20px 15px;
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.advanced-stats .stat-number {
    font-size: 2.4em;
    margin: 10px 0;
}

.advanced-stats .stat-label {
    font-size: 1.1em;
    margin-bottom: 8px;
}

.advanced-stats .stat-trend {
    font-size: 0.95em;
}

/* تحسينات للاستجابة */
@media (max-width: 1024px) {
    .analytics-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .charts-container {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .chart-card {
        height: 350px;
        padding: 20px;
    }
    
    .chart-card canvas {
        height: 250px !important;
    }
    
    .stat-number {
        font-size: 1.8em;
    }
    
    .analytics-card {
        padding: 15px;
        min-height: 140px;
    }

    .advanced-stats .stat-card {
        aspect-ratio: auto;
        padding: 18px 15px;
    }

    .advanced-stats .stat-number {
        font-size: 2em;
    }

    .section {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding: 15px 10px;
    }

    .section table {
        min-width: 540px;
    }

    table {
        font-size: calc(var(--font-size) * 0.85);
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }

    th,
    td {
        padding: 8px 6px;
        font-size: 13px;
    }
    
    /* إصلاح الحاويات */
    .container {
        width: 100%;
        max-width: 100vw;
        padding: 10px 5px;
        overflow-x: hidden;
    }
    
    /* إصلاح الأزرار */
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        justify-content: center;
    }
    
    .action-buttons button {
        font-size: 12px;
        padding: 6px 10px;
        min-width: auto;
    }
}

/* تحسينات للألوان والتدرجات */
.charts-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin: 30px 0;
}

/* تأثيرات تحميل للرسوم البيانية */
.chart-loading {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* تحسينات للنصوص العربية */
.chart-card h3, 
.analytics-card h3,
.stat-label {
    font-family: 'Tajawal', sans-serif;
    font-weight: 700;
}

/* تخصيص ألوان للرسوم البيانية */
:root {
    --chart-color-1: #2c5aa0;
    --chart-color-2: #27ae60;
    --chart-color-3: #e74c3c;
    --chart-color-4: #f39c12;
    --chart-color-5: #9b59b6;
}

/* ===== أنماط مؤشر التحميل ===== */
#global-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    display: none;
}

.loader-overlay {
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
}

.loader-content {
    background: white;
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    text-align: center;
    animation: fadeIn 0.3s ease;
}

.spinner {
    width: 60px;
    height: 60px;
    margin: 0 auto 20px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loader-message {
    color: var(--text-color);
    font-size: 1.1em;
    font-weight: 600;
    margin: 0;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}
/* ===== نهاية أنماط مؤشر التحميل ===== */

/* ===== أنماط نظام الإشعارات ===== */
#notifications-container {
    position: fixed;
    top: 80px;
    left: 20px;
    z-index: 9999;
    max-width: 400px;
    pointer-events: none;
}

.notification {
    background: white;
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 12px;
    box-shadow: 0 6px 25px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.4s ease;
    pointer-events: all;
    cursor: pointer;
    transition: all 0.3s ease;
    border-right: 4px solid var(--primary-color);
}

.notification:hover {
    transform: translateX(-5px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.2);
}

.notification.success {
    border-right-color: var(--success-color);
}

.notification.warning {
    border-right-color: #f39c12;
}

.notification.error {
    border-right-color: var(--accent-color);
}

.notification.info {
    border-right-color: var(--primary-color);
}

.notification-icon {
    font-size: 24px;
    flex-shrink: 0;
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-weight: 700;
    font-size: 0.95em;
    margin-bottom: 4px;
    color: var(--text-color);
}

.notification-message {
    font-size: 0.85em;
    color: #666;
    line-height: 1.4;
}

.notification-close {
    font-size: 20px;
    color: #999;
    cursor: pointer;
    padding: 4px;
    flex-shrink: 0;
}

.notification-close:hover {
    color: var(--accent-color);
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(100px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slideOut {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(100px);
    }
}

.notification.removing {
    animation: slideOut 0.3s ease forwards;
}

/* أيقونة الإشعارات في الهيدر */
.notification-bell {
    position: relative;
    cursor: pointer;
    padding: 8px 12px;
    font-size: 1.3em;
    transition: all 0.3s ease;
}

.notification-bell:hover {
    color: var(--primary-color);
    transform: scale(1.1);
}

.notification-badge {
    position: absolute;
    top: 4px;
    right: 4px;
    background: var(--accent-color);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}
/* ===== نهاية أنماط الإشعارات ===== */

/* ===== أنماط نظام الحوار الاحترافي (Confirm Dialog) ===== */
.confirm-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 10000;
    backdrop-filter: blur(3px);
    animation: fadeIn 0.3s ease;
}

.confirm-overlay.active {
    display: flex;
    justify-content: center;
    align-items: center;
}

.confirm-dialog {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    max-width: 480px;
    width: 90%;
    overflow: hidden;
    animation: scaleIn 0.3s ease;
    font-family: var(--font-family);
}

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.confirm-header {
    padding: 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    border-bottom: 2px solid #f0f0f0;
}

.confirm-icon {
    font-size: 48px;
    line-height: 1;
}

.confirm-header.warning .confirm-icon {
    color: #f39c12;
}

.confirm-header.danger .confirm-icon {
    color: #e74c3c;
}

.confirm-header.info .confirm-icon {
    color: var(--primary-color);
}

.confirm-header.success .confirm-icon {
    color: var(--success-color);
}

.confirm-title {
    font-size: 1.4em;
    font-weight: 700;
    color: var(--text-color);
}

.confirm-body {
    padding: 24px;
    font-size: 1.05em;
    line-height: 1.6;
    color: #555;
}

.confirm-footer {
    padding: 20px 24px;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    background: #f8f9fa;
    border-top: 1px solid #e0e0e0;
}

.confirm-footer button {
    padding: 12px 28px;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: var(--font-family);
}

.confirm-btn-cancel {
    background: #e0e0e0;
    color: #666;
}

.confirm-btn-cancel:hover {
    background: #d0d0d0;
    transform: translateY(-2px);
}

.confirm-btn-confirm {
    background: var(--primary-color);
    color: white;
}

.confirm-btn-confirm:hover {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

.confirm-btn-confirm.danger {
    background: #e74c3c;
}

.confirm-btn-confirm.danger:hover {
    background: #c0392b;
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
}

.confirm-btn-confirm.success {
    background: var(--success-color);
}

.confirm-btn-confirm.success:hover {
    background: #229954;
    box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
}

/* ===== نهاية أنماط نظام الحوار الاحترافي ===== */

/* ===== أنماط سلة المحذوفات ===== */
#trash-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
}

#trash-modal.active {
    display: flex;
}

.trash-content {
    background: white;
    border-radius: 15px;
    padding: 30px;
    max-width: 900px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    animation: fadeIn 0.3s ease;
}

.trash-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #eee;
}

.trash-header h2 {
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 10px;
}

.trash-tabs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 8px;
    margin-bottom: 20px;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 8px;
}

.trash-tab {
    padding: 10px 8px;
    background: white;
    border: none;
    cursor: pointer;
    font-size: 0.8em;
    color: #666;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    text-align: center;
    white-space: normal;
    word-wrap: break-word;
}

.trash-tab:hover {
    color: var(--primary-color);
    background: #f0f8ff;
    transform: translateY(-2px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.trash-tab.active {
    color: white;
    background: var(--primary-color);
    font-weight: bold;
    box-shadow: 0 3px 8px rgba(44, 120, 208, 0.3);
}

.trash-items {
    margin-top: 20px;
}

.trash-item {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}

.trash-item:hover {
    background: #f0f0f0;
    border-color: var(--primary-color);
}

.trash-item-info {
    flex: 1;
}

.trash-item-name {
    font-weight: bold;
    color: var(--text-color);
    margin-bottom: 5px;
}

.trash-item-meta {
    font-size: 0.85em;
    color: #666;
}

.trash-item-actions {
    display: flex;
    gap: 8px;
}

.trash-empty-state {
    text-align: center;
    padding: 40px;
    color: #999;
}

.trash-empty-state i {
    font-size: 4em;
    margin-bottom: 15px;
    opacity: 0.3;
}

.trash-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
    gap: 8px;
    margin-bottom: 15px;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 8px;
}

.trash-stat {
    text-align: center;
    padding: 8px 6px;
    background: white;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.trash-stat:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.trash-stat-value {
    font-size: 1.6em;
    font-weight: bold;
    color: var(--primary-color);
}

.trash-stat-label {
    font-size: 0.75em;
    color: #666;
    margin-top: 2px;
    white-space: normal;
    word-wrap: break-word;
    line-height: 1.2;
}

/* تحسينات للجوال */
@media (max-width: 768px) {
    .trash-stats {
        grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
        gap: 6px;
        padding: 8px;
    }
    
    .trash-tabs {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    }
    
    .trash-stat {
        padding: 6px 4px;
    }
    
    .trash-stat-value {
        font-size: 1.2em;
    }
    
    .trash-stat-label {
        font-size: 0.65em;
    }
    
    .trash-tab {
        font-size: 0.7em;
        padding: 8px 6px;
    }
}
/* ===== نهاية أنماط سلة المحذوفات ===== */


    * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); font-size: var(--font-size); background: var(--bg-color); color: var(--text-color); direction: rtl; line-height: 1.6; min-height: 100vh; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(5px); }
        #login-box { background: white; padding: 40px; border-radius: var(--border-radius); box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 420px; text-align: center; animation: fadeIn 0.5s ease; }
        
        /* شعار البرنامج في شاشة الدخول */
        .login-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            display: block;
            object-fit: contain;
            animation: scaleIn 0.6s ease;
        }
        
        #login-box h2 { color: var(--primary-color); margin-bottom: 25px; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: var(--border-radius); font-size: calc(var(--font-size) * 0.95); }
        #login-error { color: var(--accent-color); margin-bottom: 15px; display: none; font-weight: bold; }
        .login-role-selector button { width: 100%; margin-bottom: 10px; padding: 15px; font-size: 1.1em; }
        .login-form { display: none; }
        .back-to-roles { color: var(--primary-color); cursor: pointer; display: block; margin-top: 20px; font-weight: bold; }

        #activity-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(8px); }
        #activity-box { background: white; padding: 40px; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.25); width: 100%; max-width: 500px; text-align: center; animation: fadeIn 0.5s ease; }
        #activity-box h2 { color: var(--primary-color); margin-bottom: 25px; }
        #activity-list { max-height: 200px; overflow-y: auto; margin-bottom: 20px; }
        .activity-btn { width: 100%; margin-bottom: 10px; padding: 18px; font-size: 1.1em; }
        .app-container { display: flex; min-height: 100vh; }
        .container { flex: 1; margin-right: var(--sidebar-width); padding: 20px; transition: margin-right 0.3s ease; }
        .sidebar { width: var(--sidebar-width); background: var(--sidebar-bg); height: 100vh; position: fixed; right: 0; top: 0; box-shadow: var(--shadow); padding: 20px; overflow-y: auto; z-index: 100; }
        .sidebar-header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--primary-color); }
        .sidebar-header h1 { color: var(--sidebar-text); font-size: 1.5em; margin-bottom: 5px; }
        .sidebar-header .subtitle { color: #bdc3c7; font-size: 0.9em; }
        .sidebar-nav { display: flex; flex-direction: column; gap: 5px; }
        .sidebar-nav button { padding: 12px 15px; border: none; background: transparent; color: var(--sidebar-text); border-radius: var(--border-radius); cursor: pointer; font-size: calc(var(--font-size) * 0.9); font-weight: 500; transition: all 0.3s ease; text-align: right; border: 1px solid transparent; width: 100%; }
        .sidebar-nav button:hover { background: rgba(255, 255, 255, 0.1); transform: translateX(-3px); color: white; border-color: var(--primary-color); }
    .sidebar-nav button.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .user-section { margin-top: 25px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: var(--border-radius); border: 1px solid rgba(255, 255, 255, 0.2); text-align: center; }
    /* شارة هوية المستخدم الحالية في القائمة الجانبية */
    .current-user { background: #2c3e50; color: #ecf0f1; padding: 12px; border-radius: var(--border-radius); font-weight: bold; font-size: 0.95em; line-height: 1.4; }
    .current-user .user-name { display: block; font-size: 1em; margin-bottom: 6px; }
    .current-user .user-description { display: block; font-size: 0.85em; opacity: 0.85; }
    /* ألوان مخصصة حسب الدور */
    .current-user.role-admin { background: var(--success-color); color: #fff; }
    .current-user.role-manager { background: #2c78d0; color: #fff; }
    .current-user.role-user { background: #2980b9; color: #fff; }
        .header { display: flex; align-items: center; justify-content: center; margin-bottom: 30px; padding: 40px; background: var(--header-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); position: relative; color: white; }
        .header-logo { position: absolute; right: 30px; top: 50%; transform: translateY(-50%); width: 80px; height: 80px; object-fit: contain; border-radius: 8px; background: white; padding: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .header-content { text-align: center; flex: 1; }
        .header h1 { color: white; font-size: calc(var(--font-size) * 2); margin-bottom: 10px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .header .subtitle { color: rgba(255, 255, 255, 0.9); font-size: calc(var(--font-size) * 1.1); }
        .developer-credit { position: absolute; left: 20px; bottom: 20px; color: rgba(255, 255, 255, 0.8); font-size: calc(var(--font-size) * 0.8); font-style: italic; }
    .design-toggle { position: fixed; top: 20px; left: 20px; background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; font-size: 20px; box-shadow: var(--shadow); transition: all 0.3s ease; z-index: 101; }
    .design-toggle:hover { transform: scale(1.1); background: var(--secondary-color); }
        .control-panel { position: fixed; top: 20px; right: calc(var(--sidebar-width) + 20px); background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); z-index: 1000; max-width: 300px; display: none; }
        .control-panel.show { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .control-panel h3 { color: var(--primary-color); margin-bottom: 15px; text-align: center; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--secondary-color); }
        .color-picker { width: 100%; height: 40px; border: none; border-radius: 5px; cursor: pointer; }
        .font-size-control { width: 100%; }
        .section { display: none; background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 20px; min-height: 500px; }
        .section.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .section h2 { 
            color: var(--primary-color); 
            margin-bottom: 25px; 
            font-size: calc(var(--font-size) * 1.5); 
            border-bottom: 3px solid var(--primary-color); 
            padding-bottom: 10px; 
            display: flex; /* Use flexbox */
            justify-content: space-between; /* Space between title and card */
            align-items: center; /* Align items vertically */
        }

        .settings-grid { display: flex; flex-direction: column; gap: 25px; }
    .settings-card { background: #ffffff; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 25px; display: flex; flex-direction: column; gap: 20px; width: 100%; position: relative; overflow: hidden; }
    .settings-card::before { content: ''; position: absolute; top: 0; right: 0; left: 0; height: 4px; background: linear-gradient(90deg, var(--primary-color), var(--success-color)); }
        .settings-card h3 { margin-top: 0; }
        .settings-card .data-actions { margin: 0; }
        .settings-card .data-actions-grid { gap: 15px; }

        .user-selector-controls select,
        .activity-selector-controls select { width: 100%; max-width: 320px; }

        .title-stat-card {
            background-color: #fff;
            color: #1a3556;
            border: none;
            padding: 8px 18px 10px;
            border-radius: var(--border-radius);
            font-size: 0.9em;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .title-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        }

        .title-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px #FFD70099, 0 2px 8px rgba(0,0,0,0.08);
        }

        .title-stat-card .stat-mini-label {
            font-weight: normal;
            margin-left: 8px;
            color: #1a3556;
        }

        .title-stat-card .stat-mini-number {
            font-weight: 700;
            font-size: 1.2em;
        }

        .search-container { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .search-input { flex: 1; min-width: 200px; padding: 12px 15px; border: 2px solid #ddd; border-radius: var(--border-radius); font-size: calc(var(--font-size) * 0.95); transition: all 0.3s ease; font-family: var(--font-family); }
        .search-input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        
        /* Advanced Filters */
        .filters-container { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: var(--border-radius); 
            margin-bottom: 20px; 
            border: 2px solid #e0e0e0;
            display: none;
        }
        .filters-container.show { display: block; animation: slideIn 0.3s ease; }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: calc(var(--font-size) * 0.9); color: #555; font-weight: 600; }
        .filter-input { 
            padding: 10px 12px; 
            border: 2px solid #ddd; 
            border-radius: var(--border-radius); 
            font-size: calc(var(--font-size) * 0.9);
            transition: all 0.3s ease;
            font-family: var(--font-family);
        }
        .filter-input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        .filter-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; }
        .toggle-filters-btn { 
            padding: 12px 24px; 
            background: #2196F3; 
            color: white; 
            border: none; 
            border-radius: var(--border-radius); 
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: var(--font-family);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .toggle-filters-btn:hover { 
            background: #1976D2; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* Sortable Table Headers */
        .sortable { 
            cursor: pointer; 
            user-select: none; 
            position: relative;
            transition: all 0.3s ease;
        }
        .sortable.asc::after { content: '↑'; opacity: 1; color: #4CAF50; position: absolute; left: 8px; font-size: 0.8em; }
        .sortable.desc::after { content: '↓'; opacity: 1; color: #f44336; position: absolute; left: 8px; font-size: 0.8em; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-top: 25px; }
        .stat-card { 
            background: white; 
            padding: 25px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow); 
            border-top: 5px solid var(--primary-color); 
            text-align: center; 
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
        }
        .stat-card h3 { color: var(--secondary-color); margin-bottom: 15px; font-size: calc(var(--font-size) * 1.1); }
        .stat-number { 
            font-size: calc(var(--font-size) * 2.5); 
            font-weight: bold; 
            color: var(--primary-color); 
            margin: 15px 0; 
        }
        .stat-label { 
            color: var(--secondary-color); 
            font-size: calc(var(--font-size) * 1);
            font-weight: 600;
        }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: calc(var(--font-size) * 0.95); }
        th { background: var(--primary-color); color: white; padding: 15px; text-align: right; font-weight: 600; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: right; }
        tr:hover { background: #f8f9fa; }
    .form-grid { display: grid; gap: 20px; margin-bottom: 30px; }
    .grid-5 { grid-template-columns: repeat(5, 1fr); }
    .grid-users { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .account-info-grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); margin-top: 20px; }
    .account-info-card { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); display: flex; flex-direction: column; }
    .account-info-card h3 { color: var(--primary-color); margin-bottom: 15px; font-size: 1.1em; }
    .account-info-field { margin-bottom: 12px; font-size: 0.95em; }
    .account-info-field strong { color: var(--secondary-color); display: inline-block; min-width: 110px; }
    .account-info-actions { display: flex; gap: 10px; margin-top: auto; padding-top: 15px; flex-wrap: wrap; }
    .account-info-actions button { flex: 1 1 160px; background: #1b4f72; color: #ffffff; border: 1px solid #143b55; box-shadow: 0 2px 6px rgba(20, 59, 85, 0.2); }
    .account-info-actions button:hover { background: #163d59; color: #ffffff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(20, 59, 85, 0.3); }
    .data-actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    @media (min-width: 768px) {
        .data-actions-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        input, select, textarea { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: var(--border-radius); font-size: calc(var(--font-size) * 0.95); transition: all 0.3s ease; font-family: var(--font-family); }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        button { padding: 10px 15px; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: calc(var(--font-size) * 0.95); font-weight: 600; transition: all 0.3s ease; font-family: var(--font-family); }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-primary:hover { background: #254a8a; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(44, 90, 160, 0.3); }
    .btn-add { background: #008976; color: white; }
    .btn-add:hover { background: #007460; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 137, 118, 0.25); }
    .btn-success { background: var(--success-color); color: white; }
    .btn-success:hover { background: #219653; transform: translateY(-2px); }
    .btn-success.code-generator-btn { background: #1b4f72; color: #ffffff; border: 1px solid #143b55; box-shadow: 0 2px 6px rgba(20, 59, 85, 0.2); }
    .btn-success.code-generator-btn:hover { background: #163d59; color: #ffffff; box-shadow: 0 4px 12px rgba(20, 59, 85, 0.3); }
        .btn-danger { background: var(--accent-color); color: white; }
        .btn-danger:hover { background: #c0392b; transform: translateY(-2px); }
    .btn-secondary { background: #008976; color: white; }
    .btn-secondary:hover { background: #007460; transform: translateY(-2px); }
        .btn-info { background: #1abc9c; color: white; }
        .btn-info:hover { background: #16a085; transform: translateY(-2px); }
        #settings .data-actions-grid button { background: #005189; color: #ffffff; border: 1px solid #003f68; box-shadow: 0 2px 6px rgba(0, 81, 137, 0.2); }
        #settings .data-actions-grid button:hover { background: #004373; color: #ffffff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 81, 137, 0.3); }
    /* أزرار التحذير/التنبيه (تعديل/نسخ احتياطي) بلون كهرماني متناسق */
    .btn-warning { background: #E6B980; color: #2c3e50; border: 1px solid #DDB07A; box-shadow: 0 2px 6px rgba(217, 154, 89, 0.12); }
    .btn-warning:hover { background: #D99A59; color: #1a1a1a; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(217, 154, 89, 0.22); }
    /* تخصيص زر التعديل باللون الأخضر والنص الأبيض */
    .btn-warning.edit-btn { background: #005189; color: #ffffff; border: 1px solid #003f68; box-shadow: 0 2px 6px rgba(0, 81, 137, 0.2); }
    .btn-warning.edit-btn:hover { background: #004373; color: #ffffff; box-shadow: 0 4px 12px rgba(0, 81, 137, 0.3); }
    /* تخصيص زر النسخ الاحتياطي باللون الأخضر الداكن */
    .btn-warning.backup-btn { background: #1e8449; color: #ffffff; border: 1px solid #16653a; box-shadow: 0 2px 6px rgba(22, 101, 58, 0.18); }
    .btn-warning.backup-btn:hover { background: #16653a; color: #ffffff; box-shadow: 0 4px 12px rgba(22, 101, 58, 0.28); }
      .remaining-unpaid { 
    color: var(--accent-color); /* أحمر - عليه مبلغ */
    font-weight: bold; 
}
.remaining-paid { 
    color: var(--text-color); /* أسود/عادي - الرصيد صفر */
    font-weight: normal; 
}
.remaining-credit { 
    color: var(--success-color); /* أخضر - له رصيد */
    font-weight: bold; 
}
        .report-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .report-controls select, .report-controls input[type="date"] { max-width: 200px; min-width: 150px; }
        .report-controls button { min-width: 150px; }
        .export-options { display: flex; gap: 10px; margin-top: 20px; }
        .report-summary { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: var(--border-radius); }
        .invoice-print { display: none; background: white; padding: 30px; direction: rtl; max-width: 800px; margin: 20px auto; }
        @media print { body * { visibility: hidden; } .invoice-print, .invoice-print * { visibility: visible; } .invoice-print { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; } .no-print { display: none !important; } }
        .invoice-header-print { display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #2c5aa0; }
        .invoice-details { margin: 20px 0; }
        .invoice-items-print table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 1.1em; }
        .invoice-items-print th { background: #e3f2fd; color: #2c5aa0; padding: 12px; text-align: right; font-size: 1.1em; }
        .invoice-items-print th:nth-child(1) { width: 50%; } /* الصنف */
        .invoice-items-print th:nth-child(2) { width:35%; text-align: center; } /* الكمية */
        .invoice-items-print th:nth-child(3) { width: 35%; text-align: center; } /* السعر */
        .invoice-items-print th:nth-child(4) { width: 35%; text-align: left; } /* الإجمالي */
        .invoice-items-print td { padding: 10px 12px; border-bottom: 1px solid #ddd; text-align: right; font-size: 1.05em; }
        .invoice-items-print td:nth-child(2) { text-align: center; } /* الكمية */
        .invoice-items-print td:nth-child(3) { text-align: center; } /* السعر */
        .invoice-items-print td:nth-child(4) { text-align: left; direction: ltr; } /* الإجمالي */
    .invoice-totals { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .invoice-totals > div { display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 8px; }
    .invoice-totals > div.total { font-weight: bold; font-size: 1.1em; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px; }
    .invoice-totals > div span:last-child { min-width: 120px; text-align: left; direction: ltr; display: inline-block; }
    .invoice-totals input[type="number"] { width: 120px; flex: 0 0 120px; text-align: left; direction: ltr; }
    .invoice-totals-print { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .invoice-totals-print div { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .invoice-totals-print .total { font-weight: bold; font-size: 1.1em; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px; }
        .code-generator-btn { padding: 10px 15px; font-size: calc(var(--font-size) * 0.9); width: auto; min-width: 120px; }
        .user-management { background: #f8f9fa; padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px; }
        .user-card { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 15px; border-right: 4px solid var(--primary-color); }
    #settings .user-selector { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-top: 20px; }
    #settings .user-selector-controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px; }
    #settings .user-selector-controls select { flex: 1 1 220px; min-width: 200px; padding: 12px; border: 2px solid #ddd; border-radius: var(--border-radius); font-family: var(--font-family); }
    #settings .selected-user-info { display: none; gap: 12px; align-items: center; flex-wrap: nowrap; }
    #settings .selected-user-grid { display: flex; gap: 12px; flex-wrap: nowrap; overflow-x: auto; align-items: center; padding-bottom: 5px; }
    #settings .selected-user-field { flex: 0 0 170px; }
    #settings .selected-user-field.role-field { flex: 0 0 120px; }
    #settings .selected-user-field.phone-field { flex: 0 0 140px; }
    #settings .selected-user-field label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--secondary-color); }
    #settings .selected-user-field input { width: 100%; padding: 8px 10px; border: 2px solid #ddd; border-radius: var(--border-radius); background: #f5f7fb; font-family: var(--font-family); font-size: 0.9em; color: #2c3e50; }
    #settings .selected-user-actions { display: flex; gap: 10px; align-items: center; flex: 0 0 auto; margin-top: 22px; }
    #settings .selected-user-actions button { flex: 0 0 120px; max-width: 130px; padding: 8px 10px; }
    #settings .activity-selector { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-top: 20px; }
    #settings .activity-selector-controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px; }
    #settings .activity-selector-controls select { flex: 1 1 220px; min-width: 200px; padding: 12px; border: 2px solid #ddd; border-radius: var(--border-radius); font-family: var(--font-family); }
    #settings .selected-activity-info { display: none; gap: 12px; align-items: center; flex-wrap: nowrap; }
    #settings .selected-activity-field { flex: 0 0 220px; }
    #settings .selected-activity-field label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--secondary-color); }
    #settings .selected-activity-field input { width: 100%; padding: 8px 10px; border: 2px solid #ddd; border-radius: var(--border-radius); background: #f5f7fb; font-family: var(--font-family); font-size: 0.9em; color: #2c3e50; }
    #settings .selected-activity-actions { display: flex; gap: 10px; align-items: center; flex: 0 0 auto; margin-top: 30px; }
    #settings .selected-activity-actions button { flex: 0 0 120px; max-width: 130px; padding: 8px 10px; }
        .user-role { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; margin-right: 10px; }
    .role-admin { background: #e74c3c; color: white; }
    .role-manager { background: #2c78d0; color: white; }
        .role-user { background: #3498db; color: white; }
        .role-viewer { background: #95a5a6; color: white; }
        .user-status { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-left: 10px; }
        .status-active { background: #27ae60; }
        .status-inactive { background: #e74c3c; }
        .email-settings { background: #fff3cd; padding: 20px; border-radius: var(--border-radius); border-right: 4px solid #ffc107; margin-bottom: 20px; display: none; }
        @media (max-width: 1024px) { .sidebar { width: 250px; } .container { margin-right: 250px; } .control-panel { right: calc(250px + 20px); } }
        @media (max-width: 768px) { 
            * { max-width: 100vw; }
            body { flex-direction: column; overflow-x: hidden; width: 100%; } 
            .sidebar { position: fixed; width: 100%; height: 100vh; max-height: 100vh; overflow-y: auto; box-shadow: none; transform: translateX(100%); transition: transform 0.3s ease; padding: 15px; } 
            .sidebar.open { transform: translateX(0); } 
            .container { max-width: 100vw; width: 100%; margin-right: 0; padding: 10px 5px; overflow-x: hidden; box-sizing: border-box; } 
            .control-panel { right: 10px; } 
            .nav { flex-direction: column; } 
            .nav button { width: 100%; } 
            .form-grid { grid-template-columns: 1fr !important; gap: 10px; padding: 0; } 
            .form-grid input, .form-grid select, .form-grid textarea { width: 100%; max-width: 100%; box-sizing: border-box; }
            .control-panel { position: fixed; top: 0; right: 0; left: 0; bottom: 0; max-width: 100vw; z-index: 2000; overflow-y: auto; } 
            .design-toggle { position: fixed; top: 20px; left: 20px; z-index: 2001; } 
            .invoice-header { flex-direction: column; gap: 10px; align-items: stretch; } 
            .report-controls { flex-direction: column; align-items: stretch; gap: 8px; } 
            .report-controls select, .report-controls input, .report-controls button { width: 100%; max-width: 100%; box-sizing: border-box; } 
            .invoice-header-print { flex-direction: column; gap: 10px; } 
            .search-container { flex-direction: column; gap: 10px; } 
            .search-container input { width: 100%; }
            .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr !important; } 
            .section { padding: 15px 10px; overflow-x: auto; max-width: 100vw; } 
            .section > * { max-width: 100%; }
            table { font-size: 12px; display: block; overflow-x: auto; width: 100%; } 
            th, td { padding: 6px 4px; white-space: nowrap; font-size: 11px; } 
            .invoice-items { overflow-x: auto; -webkit-overflow-scrolling: touch; max-width: 100%; } 
            .invoice-items table { min-width: 500px; display: table; }
            .invoice-totals { padding: 10px; font-size: 14px; }
            .action-buttons { flex-wrap: wrap; gap: 5px; justify-content: center; }
            .action-buttons button { min-width: 70px; padding: 6px 10px; font-size: 12px; }
            button, .btn { padding: 8px 12px; font-size: 13px; }
            
            /* إصلاح البطاقات في لوحة التحكم المتقدمة */
            .advanced-stats { 
                display: flex !important; 
                flex-direction: column !important; 
                gap: 15px !important; 
            }
            .advanced-stats .stat-card { 
                width: 100% !important; 
                aspect-ratio: auto !important;
                padding: 20px !important; 
                min-height: 100px;
            }
            .advanced-stats .stat-number { font-size: 2em !important; }
            .advanced-stats .stat-label { font-size: 1em !important; }
            
            /* إصلاح بطاقات الرسوم البيانية */
            .charts-container {
                display: flex !important;
                flex-direction: column !important;
                gap: 20px !important;
            }
            .chart-card {
                width: 100% !important;
                height: auto !important;
                min-height: 300px;
                padding: 15px !important;
            }
            .chart-card canvas {
                height: 250px !important;
                max-height: 250px !important;
            }
        }
    .sidebar-toggle { display: none; position: fixed; top: 20px; right: 20px; background: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 10px 15px; cursor: pointer; z-index: 102; }
        @media (max-width: 768px) { .sidebar-toggle { display: block; } 


    }
@media (max-width: 640px) {
    .section {
        overflow-x: visible;
    }

    .section table {
        min-width: 100%;
        display: block;
        border: none;
        background: transparent;
    }

    .section thead {
        display: none;
    }

    .section tbody {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .section tbody tr {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        background: #ffffff;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 14px;
        border: 1px solid #e5e9f2;
    }

    .section tbody tr:hover {
        background: #f8f9fa;
    }

    .section tbody td {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
        border: none;
        text-align: right;
    }

    .section tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--secondary-color);
        flex-shrink: 0;
        min-width: 50px;
        font-size: 0.85em;
    }
    
    /* السطر الأول: الكود والاسم */
    .section tbody td:nth-child(1),
    .section tbody td:nth-child(2) {
        grid-column: span 1;
    }
    
    /* السطر الثاني: الهاتف والبريد */
    .section tbody td:nth-child(3),
    .section tbody td:nth-child(4) {
        grid-column: span 1;
    }
    
    /* السطر الثالث: العنوان والأزرار */
    .section tbody td:nth-child(5) {
        grid-column: 1;
    }
    
    .section tbody td:last-child {
        grid-column: 2;
        justify-content: flex-start;
        gap: 6px;
        flex-wrap: nowrap;
        flex-direction: row;
    }

    .section tbody td button,
    .section tbody td .btn {
        flex: 0 0 auto;
        min-width: 65px;
        padding: 6px 12px;
        font-size: 11px;
        white-space: nowrap;
    }
}






        /* === START: CSS for new Returns section === */
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

      .btn-whatsapp {
    background-color: #25D366; /* لون واتساب الأخضر */
    color: white;
}
.btn-whatsapp:hover {
    background-color: #128C7E; /* لون أغمق عند التأشير */
    transform: translateY(-2px);
}

        .email-btn {
            background-color: #221658;
            color: #ffffff;
            border: 1px solid #1a1246;
            box-shadow: 0 2px 6px rgba(34, 22, 88, 0.25);
        }

        .email-btn:hover {
            background-color: #1b124e;
            color: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 22, 88, 0.35);
        }

      
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--secondary-color);
            position: relative;
            bottom: -2px;
        }
        .tab-button.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .return-invoice-details {
            background-color: #f8f9fa;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        .return-invoice-details p { margin-bottom: 5px; }
        .return-item-qty-input { width: 80px !important; padding: 8px !important; text-align: center;}
        /* === END: CSS for new Returns section === */

        .users-settings-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-settings-table th,
        .users-settings-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            text-align: right;
        }

        .users-settings-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .users-settings-table tr:hover {
            background: #f8f9fa;
        }

        .activities-management table td:last-child {
            white-space: nowrap !important;
            min-width: 120px !important;
        }

        .activities-management .btn-danger, .activities-management .btn-warning {
            margin: 2px;
            padding: 8px 12px !important;
            font-size: 0.9em !important;
        }

        @media (max-width: 768px) {
            .activities-management table td:last-child {
                min-width: 100px !important;
            }
            
            .activities-management .btn-danger, .activities-management .btn-warning {
                padding: 6px 10px !important;
                font-size: 0.85em !important;
            }
        }



        @media (max-width: 768px) {
            .users-settings-table {
                font-size: 0.9em;
            }
            
            .users-settings-table th,
            .users-settings-table td {
                padding: 8px 10px;
            }
            
            .users-settings-table td:last-child {
                min-width: 100px;
            }
        }

        .report-total-row { background-color: var(--primary-color) !important; color: white !important; font-weight: bold !important; font-size: 1.1em !important; }
        .report-total-row td { padding: 15px !important; border-bottom: 2px solid var(--secondary-color) !important; }
   
        .users-settings-table td:last-child,
        .activities-management table td:last-child {
            white-space: nowrap !important;
            min-width: 120px !important;
            text-align: left !important;
        }

        .users-settings-table .btn-danger {
            margin: 2px;
            padding: 8px 12px !important;
        }

        /* === START: CSS for new Salaries section === */
        #salaries .form-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }

        .salary-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: var(--border-radius);
            border-left: 5px solid var(--primary-color);
        }

        .salary-card h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .salary-summary {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            font-size: 1.05em;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item span:first-child {
            font-weight: 600;
            color: var(--secondary-color);
        }

        .summary-item span:last-child {
            font-weight: bold;
        }

        .summary-total {
            font-size: 1.3em;
            color: var(--primary-color);
            border-top: 2px solid var(--primary-color);
            margin-top: 10px;
            padding-top: 15px;
        }
        
        .gosi-deduction {
            color: var(--accent-color);
        }

        .net-salary {
            color: var(--success-color);
        }

        .salary-actions {
            margin-top: 25px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        /* === END: CSS for new Salaries section === */

        @media (max-width: 768px) {
            .users-settings-table td:last-child,
            .activities-management table td:last-child {
                min-width: 100px !important;
            }
            
            .users-settings-table .btn-danger {
                padding: 6px 10px !important;
                font-size: 0.85em !important;
            }
        }
        #sales td.actions-cell {
            text-align: center !important;
            min-width: 240px !important;
        }

        #sales td.actions-cell .action-buttons {
            justify-content: center;
            flex-wrap: wrap;
        }

        #sales td.actions-cell .action-buttons button {
            flex: 1 1 110px;
            margin: 2px !important;
            padding: 8px 10px !important;
            font-size: 0.85em !important;
        }

/* === تنسيق أزرار الإجراءات في الجداول === */
.action-buttons {
    display: flex; /* يجعل العناصر داخله مرنة ومتجاورة */
    gap: 10px;      /* يضيف مسافة 5 بكسل بين الأزرار */
    min-width: 80px; /* يضمن وجود مساحة كافية للأزرار */
}

.action-buttons button {
    flex: 1;       /* يجعل كل زر يأخذ نفس الحجم ليملأ المساحة المتاحة */
    padding: 6px 8px; /* تعديل الحشو الداخلي للزر ليتناسب مع الحجم */
    font-size: 0.9em; /* تصغير طفيف لحجم الخط */
}

/* إصلاح نهائي وشامل لواجهة الجوال */
@media (max-width: 768px) {

    /* 1. إجبار زر القائمة على الظهور */
    .sidebar-toggle {
        display: block !important;
    }

    /* 2. إصلاح أزرار الجداول */
    #items td .action-buttons,
    #customers td .action-buttons,
    #suppliers td .action-buttons,
    #purchases td .action-buttons,
    #sales td .action-buttons,
    #returns td .action-buttons,
    #expenses td .action-buttons,
    #revenues td .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    /* أكواد إضافية لتحسين التجاوب */
    body { flex-direction: column; }
    .sidebar { position: fixed; width: 100%; height: auto; box-shadow: none; transform: translateX(100%); transition: transform 0.3s ease; z-index: 2000; }
    .sidebar.open { transform: translateX(0); }
    .container { max-width: 100%; margin-right: 0; padding: 10px; }
    .form-grid, .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
    .search-container { flex-direction: column; }

    .form-grid button {
        font-size: 0.9em;
        padding: 10px;
    }
    
    .search-input {
        font-size: 0.9em;
        padding: 10px;
    }
    
    /* إصلاح الرسوم البيانية */
    .charts-container {
        overflow-x: auto;
        padding-bottom: 10px;
    }
    
    .chart-card {
        min-width: 300px;
        flex-shrink: 0;
    }

    /* تصميم خاص لعرض قائمة الأصناف في الجوال */
    #items table {
        display: block;
        overflow-x: auto;
    }

    #items thead {
        display: none;
    }

    #items tbody {
        display: block;
    }

    #items tr {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-areas:
            "code name stock"
            "cost price price"
            "actions actions actions";
        row-gap: 8px;
        column-gap: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #items td {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 6px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
    }

    #items td::before {
        content: attr(data-label) " :";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
    }

    #items td[data-label="الكود"] { grid-area: code; }
    #items td[data-label="الاسم"] { grid-area: name; }
    #items td[data-label="الرصيد"] { grid-area: stock; }

    #items td[data-label="سعر الشراء"] { grid-area: cost; }
    #items td[data-label="سعر البيع"] { grid-area: price; }

    #items td[data-label="الإجراءات"] {
        grid-area: actions;
        display: block;
        margin-top: 6px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #items td[data-label="الإجراءات"]::before {
        display: none;
    }

    #items td[data-label="الإجراءات"] .action-buttons {
        display: flex;
        gap: 12px;
        width: 100%;
    }

    #items td[data-label="الإجراءات"] button {
        flex: 1;
        font-size: 0.95em;
        padding: 11px 0;
    }

    /* تصميم خاص لعرض العملاء في الجوال */
    #customers table {
        display: block;
        overflow-x: auto;
    }

    #customers thead {
        display: none;
    }

    #customers tbody {
        display: block;
    }

    #customers tr {
        display: grid;
        grid-template-columns: minmax(110px, auto) 1fr;
        grid-template-areas:
            "code name"
            "phone email"
            "address address"
            "actions actions";
        column-gap: 10px;
        row-gap: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #customers td {
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        gap: 6px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
    }

    #customers td::before {
        content: attr(data-label) " :";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
    }

    #customers td[data-label="الكود"] { grid-area: code; }
    #customers td[data-label="الاسم"] { grid-area: name; }
    #customers td[data-label="الهاتف"] { grid-area: phone; }
    #customers td[data-label="البريد"] { grid-area: email; }
    #customers td[data-label="العنوان"] {
        grid-area: address;
        word-break: break-word;
        margin-top: 6px;
    }

    #customers td[data-label="الإجراءات"] {
        grid-area: actions;
        display: block;
        margin-top: 8px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #customers td[data-label="الإجراءات"]::before {
        display: none;
    }

    #customers td[data-label="الإجراءات"] .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    #customers td[data-label="الإجراءات"] button {
        width: 100%;
        font-size: 0.9em;
        padding: 9px 0;
    }

    /* تصميم خاص لعرض الموردين في الجوال */
    #suppliers table {
        display: block;
        overflow-x: auto;
    }

    #suppliers thead {
        display: none;
    }

    #suppliers tbody {
        display: block;
    }

    #suppliers tr {
        display: grid;
        grid-template-columns: minmax(110px, auto) 1fr;
        grid-template-areas:
            "code name"
            "phone email"
            "address address"
            "actions actions";
        column-gap: 10px;
        row-gap: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #suppliers td {
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        gap: 6px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
    }

    #suppliers td::before {
        content: attr(data-label) " :";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
    }

    #suppliers td[data-label="الكود"] { grid-area: code; }
    #suppliers td[data-label="الاسم"] { grid-area: name; }
    #suppliers td[data-label="الهاتف"] { grid-area: phone; }
    #suppliers td[data-label="البريد"] { grid-area: email; }
    #suppliers td[data-label="العنوان"] {
        grid-area: address;
        word-break: break-word;
        margin-top: 6px;
    }

    #suppliers td[data-label="الإجراءات"] {
        grid-area: actions;
        display: block;
        margin-top: 8px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #suppliers td[data-label="الإجراءات"]::before {
        display: none;
    }

    #suppliers td[data-label="الإجراءات"] .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    #suppliers td[data-label="الإجراءات"] button {
        width: 100%;
        font-size: 0.9em;
        padding: 9px 0;
    }

    /* تصميم خاص لعرض المشتريات في الجوال */
    #purchases table {
        display: block;
        overflow-x: auto;
    }

    #purchases thead {
        display: none;
    }

    #purchases tbody {
        display: block;
    }

    #purchases tr {
        display: grid;
        grid-template-columns: max-content max-content minmax(0, 1fr) minmax(0, 1fr);
        grid-template-areas:
            "number date supplier supplier"
            "quantity total paid paid"
            "remaining remaining remaining remaining"
            "actions actions actions actions";
        column-gap: 2px;
        row-gap: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #purchases td {
        display: flex;
        align-items: baseline;
        justify-content: flex-start;
        gap: 4px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
        min-width: 0;
        direction: rtl;
    }

    #purchases td::before {
        content: attr(data-label) ":";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
        background: transparent;
        flex-shrink: 0;
        display: inline-block;
    }
    #purchases td[data-label="رقم الفاتورة"] {
        grid-area: number;
        white-space: nowrap;
    }
    #purchases td[data-label="التاريخ"] {
        grid-area: date;
        white-space: nowrap;
        margin-inline-start: 12px;
    }
    #purchases td[data-label="المورد"] {
        grid-area: supplier;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #purchases td[data-label="الكمية"] {
        grid-area: quantity;
        white-space: nowrap;
    }
    #purchases td[data-label="الإجمالي"] {
        grid-area: total;
        white-space: nowrap;
        margin-inline-end: 12px;
    }
    #purchases td[data-label="المدفوع"] {
        grid-area: paid;
        white-space: nowrap;
        margin-inline-end: 12px;
    }
    #purchases td[data-label="المتبقي"] {
        grid-area: remaining;
        font-weight: 600;
        white-space: nowrap;
        justify-content: flex-start;
        padding-top: 6px;
        border-top: 1px solid #eee;
    }

    #purchases td[data-label="المورد"] {
        justify-content: flex-start;
        direction: rtl;
        text-align: right;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #purchases td[data-label="الإجراءات"] {
        grid-area: actions;
        display: block;
        margin-top: 6px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #purchases td[data-label="الإجراءات"]::before {
        display: none;
    }

    #purchases td[data-label="الإجراءات"] .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
    }

    #purchases td[data-label="الإجراءات"] .action-buttons button {
        width: 100%;
        font-size: 0.85em;
        padding: 8px 0;
    }

    /* تصميم خاص لعرض المبيعات في الجوال */
    #sales table {
        display: block;
        overflow-x: auto;
    }

    #sales thead {
        display: none;
    }

    #sales tbody {
        display: block;
    }

    #sales tr {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-areas:
            "number number date"
            "customer customer quantity"
            "total paid remaining"
            "actions actions actions";
        column-gap: 8px;
        row-gap: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #sales td {
        display: flex;
        align-items: baseline;
        justify-content: flex-start;
        gap: 4px;
        border: none;
        padding: 0;
        font-size: 0.95em;
        text-align: right;
        white-space: normal;
        min-width: 0;
        direction: rtl;
    }

    #sales td::before {
        content: attr(data-label) ":";
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
        background: transparent;
        flex-shrink: 0;
        display: inline-block;
    }

    #sales td[data-label="رقم الفاتورة"] {
        grid-area: number;
        white-space: nowrap;
    }

    #sales td[data-label="التاريخ"] {
        grid-area: date;
        white-space: nowrap;
    }

    #sales td[data-label="العميل"] {
        grid-area: customer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #sales td[data-label="الكمية"] {
        grid-area: quantity;
        white-space: nowrap;
    }

    #sales td[data-label="الإجمالي"] {
        grid-area: total;
        white-space: nowrap;
    }

    #sales td[data-label="المدفوع"] {
        grid-area: paid;
        white-space: nowrap;
    }

    #sales td[data-label="المتبقي"] {
        grid-area: remaining;
        font-weight: 600;
        white-space: nowrap;
        justify-content: flex-start;
    }

    #sales td[data-label="الإجراءات"] {
        grid-area: actions;
        display: block;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    #sales td[data-label="الإجراءات"]::before {
        display: none;
    }

    #sales td[data-label="الإجراءات"] .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
    }

    #sales td[data-label="الإجراءات"] .action-buttons button {
        width: 100%;
        font-size: 0.85em;
        padding: 8px 0;
    }

}

@media (max-width: 480px) {
    /* إصلاحات إضافية للشاشات الصغيرة جداً */
    * { font-size: 14px; }
    
    .analytics-card {
        min-width: 100%;
        margin: 0;
    }
    
    .chart-card {
        min-width: 100%;
        padding: 10px;
    }
    
    .container { padding: 5px 2px; }
    
    .section { padding: 10px 5px; }
    
    table { font-size: 10px; }
    
    th, td { padding: 4px 2px; font-size: 10px; }
    
    .form-grid input, .form-grid select, .form-grid textarea { 
        font-size: 14px;
        padding: 6px 8px;
    }
    
    .action-buttons button { 
        font-size: 11px;
        padding: 5px 8px;
        min-width: 60px;
    }
    
    .btn { 
        font-size: 12px;
        padding: 6px 10px;
    }
    
    h2 { font-size: 1.3em; }
    h3 { font-size: 1.1em; }
    
    .sidebar { font-size: 14px; }
    
    .nav button { font-size: 13px; padding: 8px; }
    
    .invoice-items table { min-width: 400px; }
    
    .user-section button {
        font-size: 0.95em;
        padding: 12px 15px;
        margin: 5px 0;
        min-height: 44px;
    }
}

/* ===== أنماط التحقق من صحة المدخلات ===== */

/* حقل به خطأ */
input.input-error,
select.input-error,
textarea.input-error {
    border: 2px solid #e74c3c !important;
    background-color: #ffebee !important;
    animation: shake 0.5s ease;
}

/* حقل صحيح */
input.input-success,
select.input-success,
textarea.input-success {
    border: 2px solid #27ae60 !important;
    background-color: #f1f8f4 !important;
}

/* أيقونة الحالة في الحقل */
input.input-error::after,
input.input-success::after {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
}

input.input-error::after {
    content: '❌';
}

input.input-success::after {
    content: '✅';
}

/* تأثير الاهتزاز للحقول الخاطئة */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

/* رسالة خطأ أسفل الحقل */
.field-error-message {
    color: #e74c3c;
    font-size: 0.85em;
    margin-top: 4px;
    display: block;
    animation: fadeIn 0.3s ease;
}

/* رسالة نجاح أسفل الحقل */
.field-success-message {
    color: #27ae60;
    font-size: 0.85em;
    margin-top: 4px;
    display: block;
    animation: fadeIn 0.3s ease;
}

/* تحسين مظهر الحقول عند التركيز */
input.input-error:focus,
select.input-error:focus,
textarea.input-error:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
}

input.input-success:focus,
select.input-success:focus,
textarea.input-success:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2);
}

/* ===== نهاية أنماط التحقق من صحة المدخلات ===== */


 </style>


</head>
<body>
    <div id="login-overlay">
        <div id="login-box">
            <!-- شعار البرنامج -->
            <img src="logo/logo.png" alt="شعار نظام ديواني" class="login-logo" id="loginLogo" style="display: none;" onerror="this.style.display='none'">
            
            <h2>ديواني<br><span style="font-size: 0.8em; font-weight: normal; color: #1e3a5f;">نظام محاسبي متكامل</span></h2>
            <input type="email" id="loginEmail" class="login-input" placeholder="البريد الإلكتروني" onkeypress="if(event.key==='Enter')handleLogin()">
            <input type="password" id="loginPassword" class="login-input" placeholder="كلمة المرور" onkeypress="if(event.key==='Enter')handleLogin()">
            <button class="btn-primary" onclick="handleLogin()" style="width: 100%;">تسجيل الدخول</button>
            <a class="back-to-roles" onclick="openForgotPasswordModal()">نسيت كلمة المرور؟</a>
            <p id="login-error">بيانات الدخول غير صحيحة أو غير مصرح لك بالدخول.</p>
        </div>
    </div>
    
    <div id="activity-overlay" style="display: none;">
        <div id="activity-box">
            <h2>اختر أو أنشئ نشاطاً تجارياً</h2>
            <div id="activity-list"></div>
            <hr style="margin: 20px 0;">
            <h3>أو أنشئ نشاطاً جديداً</h3>
            <input type="text" id="newActivityName" class="login-input" placeholder="اسم النشاط الجديد (مثال: بيع لحافات الأطفال)">
            <button class="btn-success" onclick="addNewActivity()" style="width: 100%;">+ إنشاء وبدء النشاط</button>
        </div>
    </div>

    <!-- نافذة تعديل المستخدم -->
    <div id="user-edit-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 10001; backdrop-filter: blur(5px);">
        <div id="user-edit-box" style="background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 480px; text-align: center;">
            <h2 style="color: var(--primary-color); margin-bottom: 20px;">✏️ تعديل بيانات المستخدم</h2>
            <input type="text" id="editUserName" class="login-input" placeholder="اسم المستخدم">
            <input type="email" id="editUserEmail" class="login-input" placeholder="البريد الإلكتروني">
            <input type="tel" id="editUserPhone" class="login-input" placeholder="رقم الجوال">
            <input type="password" id="editUserPassword" class="login-input" placeholder="كلمة المرور">
            <select id="editUserRole" class="login-input">
                <option value="admin">مدير</option>
                <option value="manager">مدير نشاط</option>
                <option value="user">مستخدم</option>
            </select>
            <select id="editUserActivity" class="login-input" style="display: none;">
                <option value="">-- تعيين لنشاط --</option>
            </select>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn-success" onclick="saveEditedUser()" style="flex:1;">حفظ</button>
                <button class="btn-secondary" onclick="closeEditUserModal()" style="flex:1;">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نافذة تغيير كلمة المرور (للمستخدم المسجل) -->
    <div id="change-password-overlay" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10002; backdrop-filter: blur(5px);">
        <div style="background:white; padding: 24px; border-radius: var(--border-radius); width: 100%; max-width: 420px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            <h2 style="margin-top:0; color: var(--primary-color);">🔒 تغيير كلمة المرور</h2>
            <input type="password" id="cp-old" class="login-input" placeholder="كلمة المرور الحالية">
            <input type="password" id="cp-new" class="login-input" placeholder="كلمة المرور الجديدة">
            <input type="password" id="cp-confirm" class="login-input" placeholder="تأكيد كلمة المرور الجديدة">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-success" onclick="submitPasswordChange()" style="flex:1;">حفظ</button>
                <button class="btn-secondary" onclick="closeChangePasswordModal()" style="flex:1;">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نافذة نسيت كلمة المرور (طلب رابط) -->
    <div id="forgot-password-overlay" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10002; backdrop-filter: blur(5px);">
        <div style="background:white; padding: 24px; border-radius: var(--border-radius); width: 100%; max-width: 420px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align:center;">
            <h2 style="margin-top:0; color: var(--primary-color);">📧 استعادة كلمة المرور</h2>
            <p style="margin: 0 0 10px;">أدخل بريدك الإلكتروني وسنرسل لك رابطاً لإعادة تعيين كلمة المرور.</p>
            <input type="email" id="fp-email" class="login-input" placeholder="البريد الإلكتروني">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-success" onclick="requestPasswordReset()" style="flex:1;">إرسال الرابط</button>
                <button class="btn-secondary" onclick="closeForgotPasswordModal()" style="flex:1;">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نافذة إدخال كلمة مرور جديدة عبر الرابط -->
    <div id="reset-password-overlay" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10003; backdrop-filter: blur(5px);">
        <div style="background:white; padding: 24px; border-radius: var(--border-radius); width: 100%; max-width: 420px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align:center;">
            <h2 style="margin-top:0; color: var(--primary-color);">🔁 تعيين كلمة مرور جديدة</h2>
            <input type="password" id="rp-new" class="login-input" placeholder="كلمة المرور الجديدة">
            <input type="password" id="rp-confirm" class="login-input" placeholder="تأكيد كلمة المرور الجديدة">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-success" onclick="submitTokenPasswordReset()" style="flex:1;">حفظ</button>
                <button class="btn-secondary" onclick="closeResetPasswordModal()" style="flex:1;">إلغاء</button>
            </div>
        </div>
    </div>

    <div class="app-container" style="display: none;">
        <button class="sidebar-toggle" onclick="toggleSidebar()">☰ القائمة</button>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <!-- شعار البرنامج في القائمة الجانبية -->
                <img src="" alt="شعار ديواني" class="header-logo" id="sidebarLogo" style="display: none; width: 100px; height: 100px; margin: 0 auto 15px; position: static; transform: none; border-radius: 8px; background: white; padding: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
            </div>
            
            <div class="sidebar-nav" id="sidebarNav">
                <!-- سيتم تعبئة الأزرار هنا ديناميكياً -->
            </div>

            <div class="user-section">
                <div class="current-user" id="currentUserDisplay"></div>
                <button class="btn-secondary" onclick="showSection('account-info')" style="width: 100%; margin-top: 10px;">👤 معلومات الحساب</button>
                <button class="btn-danger" onclick="logout()" style="width: 100%; margin-top: 10px;">تسجيل الخروج</button>
            </div>
        </div>

        <button class="design-toggle" onclick="toggleControlPanel()">🎨</button>

        <div class="control-panel" id="controlPanel">
            <h3>🎨 تخصيص الواجهة</h3>
            
            <div class="control-group">
                <label>اختيار الخط:</label>
                <select id="fontFamilySelect" onchange="updateFontFamily(this.value)">
                    <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                    <option value="'Tajawal', sans-serif">Tajawal</option>
                    <option value="'Amiri', serif">Amiri</option>
                    <option value="'El Messiri', sans-serif">El Messiri</option>
                    <option value="'Reem Kufi', sans-serif">Reem Kufi</option>
                    <option value="'Arial', sans-serif">Arial</option>
                    <option value="'Helvetica', sans-serif">Helvetica</option>
                </select>
            </div>

            <div class="control-group">
                <label>حجم الخط:</label>
                <input type="range" class="font-size-control" min="12" max="20" value="16" onchange="updateFontSize(this.value)">
                <span id="font-size-value">16px</span>
            </div>

            <div class="control-group">
                <label>اللون الرئيسي:</label>
                <input type="color" class="color-picker" value="#2c5aa0" onchange="updateColor('--primary-color', this.value)">
            </div>

            <div class="control-group">
                <label>لون الخلفية:</label>
                <input type="color" class="color-picker" value="#ecf0f1" onchange="updateColor('--bg-color', this.value)">
            </div>

            <div class="control-group">
                <label>لون النص:</label>
                <input type="color" class="color-picker" value="#2c3e50" onchange="updateColor('--text-color', this.value)">
            </div>

            <button onclick="resetDesign()" class="btn-primary" style="width: 100%; margin-top: 10px;">🔄 إعادة تعيين</button>
            <button onclick="toggleControlPanel()" class="btn-danger" style="width: 100%; margin-top: 10px;">❌ إغلاق</button>
        </div>

<div class="container">
    <div class="header">
        <div class="header-content">
            <!-- شعار النشاط في الوسط -->
            <img src="" alt="شعار النشاط" class="activity-header-logo" id="activityHeaderLogo" style="display: none; width: 80px; height: 80px; margin: 0 auto 10px; object-fit: contain; border-radius: 8px;">
            
            <h1 id="activityHeaderTitle">ديواني</h1>
            <div class="subtitle" id="activityHeaderSubtitle">نظام محاسبي متكامل</div>
        </div>
        
        <div class="developer-credit">برمجة وتطوير: صالح الصملة</div>
    </div>

    <!-- حاوية الإشعارات -->
    <div id="notifications-container"></div>

    <!-- مودال سلة المحذوفات -->
    <div id="trash-modal">
        <div class="trash-content">
            <div class="trash-header">
                <h2>🗑️ سلة المحذوفات</h2>
                <button class="btn-secondary" onclick="closeTrashModal()">✖ إغلاق</button>
            </div>
            
            <p style="text-align: center; color: #666; font-size: 0.95em; margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 8px;">
                يتم الاحتفاظ بالعناصر المحذوفة لمدة 30 يوماً
            </p>
            
            <div class="trash-stats">
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-items">0</div>
                    <div class="trash-stat-label">أصناف</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-customers">0</div>
                    <div class="trash-stat-label">عملاء</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-suppliers">0</div>
                    <div class="trash-stat-label">موردين</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-purchases">0</div>
                    <div class="trash-stat-label">مشتريات</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-sales">0</div>
                    <div class="trash-stat-label">مبيعات</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-expenses">0</div>
                    <div class="trash-stat-label">مصروفات</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-revenues">0</div>
                    <div class="trash-stat-label">إيرادات</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-salesReturns">0</div>
                    <div class="trash-stat-label">مرتجع مبيعات</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-purchaseReturns">0</div>
                    <div class="trash-stat-label">مرتجع مشتريات</div>
                </div>
                <div class="trash-stat">
                    <div class="trash-stat-value" id="trash-count-total">0</div>
                    <div class="trash-stat-label">الإجمالي</div>
                </div>
            </div>

            <div class="trash-tabs">
                <button class="trash-tab active" onclick="renderTrashItems('items')">📦 الأصناف</button>
                <button class="trash-tab" onclick="renderTrashItems('customers')">👥 العملاء</button>
                <button class="trash-tab" onclick="renderTrashItems('suppliers')">🏭 الموردين</button>
                <button class="trash-tab" onclick="renderTrashItems('purchases')">📥 المشتريات</button>
                <button class="trash-tab" onclick="renderTrashItems('sales')">📤 المبيعات</button>
                <button class="trash-tab" onclick="renderTrashItems('expenses')">💸 المصروفات</button>
                <button class="trash-tab" onclick="renderTrashItems('revenues')">💰 الإيرادات</button>
                <button class="trash-tab" onclick="renderTrashItems('salesReturns')">↩️ مرتجع مبيعات</button>
                <button class="trash-tab" onclick="renderTrashItems('purchaseReturns')">↪️ مرتجع مشتريات</button>
            </div>

            <div id="trash-items-container" class="trash-items"></div>
        </div>
    </div>

    <div id="home" class="section active">
        <h2>مرحباً بك في نظام الديوان المحاسبي</h2>
        <p>نظام متكامل لإدارة عملياتك المحاسبية بكل سهولة واحترافية</p>
       <div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">إجمالي كمية المخزون</div>
        <div class="stat-number" id="totalStockQuantity">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">قيمة المخزون</div>
        <div class="stat-number" id="stockValue">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">إجمالي الأصناف</div>
        <div class="stat-number" id="totalItems">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">إجمالي العملاء</div>
        <div class="stat-number" id="totalCustomers">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">إجمالي الموردين</div>
        <div class="stat-number" id="totalSuppliers">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">إجمالي المبيعات</div>
        <div class="stat-number" id="totalSales">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">إجمالي المشتريات</div>
        <div class="stat-number" id="totalPurchases">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">إجمالي المصروفات</div>
        <div class="stat-number" id="totalExpensesHome">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">إجمالي الإيرادات</div>
        <div class="stat-number" id="totalRevenuesHome">0</div>
    </div>
</div>
</div> 
<div id="advanced-dashboard" class="section">
    <h2>📊 لوحة التحكم المتقدمة</h2>
    
    <!-- مؤشرات سريعة -->
    <div class="stats-grid advanced-stats">
        <div class="stat-card">
            <div class="stat-number" id="liveSales">0</div>
            <div class="stat-label">المبيعات اليوم</div>
            <div class="stat-trend" id="salesTrend">↗️ +12%</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="liveRevenue">0</div>
            <div class="stat-label">الإيرادات الشهرية</div>
            <div class="stat-trend" id="revenueTrend">↗️ +8%</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="liveProfit">0</div>
            <div class="stat-label">صافي الربح</div>
            <div class="stat-trend" id="profitTrend">↗️ +15%</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="liveCustomers">0</div>
            <div class="stat-label">عملاء جدد</div>
            <div class="stat-trend" id="customersTrend">↗️ +5%</div>
        </div>
    </div>

    <!-- الرسوم البيانية -->
    <div class="charts-container">
        <div class="chart-card">
            <h3>📈 أداء المبيعات آخر 7 أيام</h3>
            <canvas id="salesChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>💰 توزيع الإيرادات</h3>
            <canvas id="revenueChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>💸 تطور المصروفات الشهرية</h3>
            <canvas id="expensesChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>📊 مقارنة المشتريات والمبيعات</h3>
            <canvas id="purchasesSalesChart"></canvas>
        </div>
    </div>

    <!-- الشبكة التحليلية -->
    <div class="analytics-grid">
        <div class="analytics-card">
            <h3>📋 الملخص الشهري</h3>
            <div id="monthlySummary">
                <!-- سيتم تعبئته بالبيانات -->
            </div>
        </div>
        <div class="analytics-card">
            <h3>🎯 الأداء المالي</h3>
            <div id="financialPerformance">
                <!-- سيتم تعبئته بالبيانات -->
            </div>
        </div>
        <div class="analytics-card">
            <h3>💸 المصروفات الشهرية</h3>
            <div id="monthlyExpenses">
                <!-- سيتم تعبئته بالبيانات -->
            </div>
        </div>
        <div class="analytics-card">
            <h3>💰 الأرباح المتراكمة</h3>
            <div id="cumulativeProfits">
                <!-- سيتم تعبئته بالبيانات -->
            </div>
        </div>
    </div>

    <!-- الأصناف الأكثر مبيعاً -->
    <div class="chart-card">
        <h3>🏆 الأصناف الأكثر مبيعاً</h3>
        <canvas id="topItemsChart"></canvas>
    </div>
</div>

<div id="items" class="section">
    <h2>📦 إدارة الأصناف <span class="title-stat-card"><span class="stat-mini-label">الإجمالي:</span><span id="miniStatItems" class="stat-mini-number">0</span></span></h2>
    
    <div class="form-grid grid-4">
        <input type="text" id="itemCode" placeholder="كود الصنف">
        <input type="text" id="itemName" placeholder="اسم الصنف *" required>
        <input type="number" id="itemCost" placeholder="سعر الشراء">
        <input type="number" id="itemPrice" placeholder="سعر البيع">
        <input type="number" id="itemStock" placeholder="الرصيد الأولي">
    <button class="btn-primary btn-add" onclick="addItem()">➕ إضافة صنف</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchItems" class="search-input" placeholder="🔍 بحث في الأصناف...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('itemsFilters')">
            <span>�</span>
            <span>فلترة متقدمة</span>
            <span>▼</span>
        </button>
    </div>
    
    <!-- لوحة الفلترة المتقدمة -->
    <div id="itemsFilters" class="filters-container">
        <div class="filters-grid">
            <div class="filter-group">
                <label>سعر الشراء (من)</label>
                <input type="number" id="itemCostFrom" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>سعر الشراء (إلى)</label>
                <input type="number" id="itemCostTo" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>سعر البيع (من)</label>
                <input type="number" id="itemPriceFrom" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>سعر البيع (إلى)</label>
                <input type="number" id="itemPriceTo" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>الرصيد (من)</label>
                <input type="number" id="itemStockFrom" class="filter-input" placeholder="0">
            </div>
            <div class="filter-group">
                <label>الرصيد (إلى)</label>
                <input type="number" id="itemStockTo" class="filter-input" placeholder="0">
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetItemsFilters()">🔄 إعادة تعيين</button>
            <button class="btn-primary" onclick="applyItemsFilters()">✅ تطبيق الفلاتر</button>
        </div>
    </div>

    <table id="itemsTable">
   <thead>
    <tr>
        <th class="sortable" data-column="code">الكود</th>
        <th class="sortable" data-column="name">الاسم</th>
        <th class="sortable" data-column="cost">سعر الشراء</th>
        <th class="sortable" data-column="price">سعر البيع</th>
        <th class="sortable" data-column="stock">الرصيد</th>
        <th>الإجراءات</th>
    </tr>
</thead>
        <tbody id="itemsList"></tbody>
    </table>
</div>

<div id="customers" class="section">
    <h2>👥 إدارة العملاء <span class="title-stat-card"><span class="stat-mini-label">الإجمالي:</span><span id="miniStatCustomers" class="stat-mini-number">0</span></span></h2>
    
    <div class="form-grid grid-3">
        <input type="text" id="customerCode" placeholder="كود العميل">
        <input type="text" id="customerName" placeholder="اسم العميل *" required>
        <input type="text" id="customerPhone" placeholder="الهاتف">
        <input type="email" id="customerEmail" placeholder="البريد الإلكتروني">
        <input type="text" id="customerAddress" placeholder="العنوان">
    <button class="btn-primary btn-add" onclick="addCustomer()">➕ إضافة عميل</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchCustomers" class="search-input" placeholder="🔍 بحث في العملاء...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('customersFilters')">
            <span>�</span>
            <span>فلترة متقدمة</span>
            <span>▼</span>
        </button>
    </div>
    
    <!-- لوحة الفلترة المتقدمة -->
    <div id="customersFilters" class="filters-container">
        <p style="color: #666; margin-bottom: 10px;">💡 استخدم مربع البحث أعلاه للبحث في جميع الحقول (الكود، الاسم، الهاتف، البريد، العنوان)</p>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetCustomersFilters()">🔄 إعادة تعيين البحث</button>
        </div>
    </div>

    <table id="customersTable">
        <thead>
    <tr>
        <th class="sortable" data-column="code">الكود</th>
        <th class="sortable" data-column="name">الاسم</th>
        <th class="sortable" data-column="phone">الهاتف</th>
        <th class="sortable" data-column="email">البريد الإلكتروني</th>
        <th class="sortable" data-column="address">العنوان</th>
        <th>الإجراءات</th>
    </tr>
</thead>
        <tbody id="customersList"></tbody>
    </table>
</div>

<div id="suppliers" class="section">
    <h2>🏢 إدارة الموردين <span class="title-stat-card"><span class="stat-mini-label">الإجمالي:</span><span id="miniStatSuppliers" class="stat-mini-number">0</span></span></h2>
    
    <div class="form-grid grid-3">
        <input type="text" id="supplierCode" placeholder="كود المورد">
        <input type="text" id="supplierName" placeholder="اسم المورد *" required>
        <input type="text" id="supplierPhone" placeholder=" الهاتف">
        <input type="email" id="supplierEmail" placeholder="البريد الإلكتروني">
        <input type="text" id="supplierAddress" placeholder="العنوان">
    <button class="btn-primary btn-add" onclick="addSupplier()">➕ إضافة مورد</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchSuppliers" class="search-input" placeholder="🔍 بحث في الموردين...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('suppliersFilters')">
            <span>�</span>
            <span>فلترة متقدمة</span>
            <span>▼</span>
        </button>
    </div>
    
    <!-- لوحة الفلترة المتقدمة -->
    <div id="suppliersFilters" class="filters-container">
        <p style="color: #666; margin-bottom: 10px;">💡 استخدم مربع البحث أعلاه للبحث في جميع الحقول (الكود، الاسم، الهاتف، البريد، العنوان)</p>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetSuppliersFilters()">🔄 إعادة تعيين البحث</button>
        </div>
    </div>

    <table id="suppliersTable">
        <thead>
            <tr>
                <th class="sortable" data-column="code">الكود</th>
                <th class="sortable" data-column="name">الاسم</th>
                <th class="sortable" data-column="phone">الهاتف</th>
                <th class="sortable" data-column="email">البريد الإلكتروني</th>
                <th class="sortable" data-column="address">العنوان</th>
                <th>الإجراءات</th>
            </tr>
        </thead>
        <tbody id="suppliersList"></tbody>
    </table>
</div>

<div id="purchases" class="section">
    <h2>🛒 فواتير المشتريات <span class="title-stat-card"><span class="stat-mini-label">الإجمالي:</span><span id="miniStatPurchases" class="stat-mini-number">0</span></span></h2>
    <p>📝 هنا يمكنك إدارة فواتير المشتريات وإضافة أصناف جديدة للمخزون</p>
    
    <div class="form-grid grid-4">
        <input type="text" id="purchaseCode" placeholder="كود الفاتورة" readonly>
        <input type="date" id="purchaseDate">
        <select id="purchaseSupplier">
            <option value="">اختر المورد</option>
        </select>
        <input type="text" id="purchaseNotes" placeholder="ملاحظات">
    </div>
    
    <div class="form-grid grid-4">
        <select id="purchaseItem">
            <option value="">اختر الصنف</option>
        </select>
        <input type="number" id="purchaseQuantity" placeholder="الكمية" min="1" value="1">
        <select id="purchaseUnit">
            <option value="قطعة">قطعة</option>
            <option value="درزن">درزن</option>
        </select>
        <input type="number" id="purchasePrice" placeholder="سعر الشراء">
    <button class="btn-primary btn-add" onclick="addPurchaseItem()">➕ إضافة صنف</button>
    </div>
    
    <div class="invoice-items">
        <table>
            <thead>
                <tr>
                    <th>الصنف</th>
                    <th>الكمية</th>
                    <th>الوحدة</th>
                    <th>سعر الشراء</th>
                    <th>الإجمالي</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody id="purchaseItemsList"></tbody>
        </table>
    </div>
    
    <div class="invoice-totals">
        <div>
            <span>المجموع:</span>
            <span id="purchaseSubtotal">0.00</span>
        </div>
        <div>
            <span>الضريبة:</span>
            <span id="purchaseTax">0.00</span>
        </div>
         <div>
            <span>المبلغ المدفوع:</span>
            <input type="number" id="purchasePaidAmount" placeholder="0.00" oninput="updatePurchaseTotals()">
        </div>
        <div>
            <span>المبلغ المتبقي:</span>
            <span id="purchaseRemainingAmount" class="remaining-unpaid">0.00</span>
        </div>
        <div class="total">
            <span>الإجمالي النهائي:</span>
            <span id="purchaseTotal">0.00</span>
        </div>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn-primary" id="savePurchaseBtn" onclick="savePurchase()">💾 حفظ الفاتورة</button>
        <button class="btn-secondary" onclick="newPurchase()">🆕 فاتورة جديدة</button>
    </div>
    
    <h3 style="margin-top: 30px;">فواتير المشتريات السابقة</h3>
    
    <div class="search-container">
        <input type="text" id="searchPurchases" class="search-input" placeholder="🔍 بحث في فواتير المشتريات...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('purchasesFilters')">
            <span>�</span>
            <span>فلترة متقدمة</span>
            <span>▼</span>
        </button>
    </div>
    
    <!-- لوحة الفلترة المتقدمة -->
    <div id="purchasesFilters" class="filters-container">
        <div class="filters-grid">
            <div class="filter-group">
                <label>من تاريخ</label>
                <input type="date" id="purchasesDateFrom" class="filter-input">
            </div>
            <div class="filter-group">
                <label>إلى تاريخ</label>
                <input type="date" id="purchasesDateTo" class="filter-input">
            </div>
            <div class="filter-group">
                <label>المبلغ الإجمالي (من)</label>
                <input type="number" id="purchasesAmountFrom" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>المبلغ الإجمالي (إلى)</label>
                <input type="number" id="purchasesAmountTo" class="filter-input" placeholder="0.00">
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetPurchasesFilters()">🔄 إعادة تعيين</button>
            <button class="btn-primary" onclick="applyPurchasesFilters()">✅ تطبيق الفلاتر</button>
        </div>
    </div>
    
    <table id="purchasesTable">
        <thead>
            <tr>
                <th class="sortable" data-column="code">رقم الفاتورة</th>
                <th class="sortable" data-column="date">التاريخ</th>
                <th class="sortable" data-column="supplierId">المورد</th>
                <th class="sortable" data-column="itemsCount">الكمية</th>
                <th class="sortable" data-column="total">الإجمالي</th>
                <th class="sortable" data-column="paidAmount">المدفوع</th>
                <th class="sortable" data-column="remainingAmount">المتبقي</th>
                <th>الإجراءات</th>
            </tr>
        </thead>
        <tbody id="purchasesList"></tbody>
    </table>
</div>

<div id="sales" class="section">
    <h2>💰 فواتير المبيعات <span class="title-stat-card"><span class="stat-mini-label">الإجمالي:</span><span id="miniStatSales" class="stat-mini-number">0</span></span></h2>
    <p>📈 هنا يمكنك إدارة فواتير المبيعات وتحديث المخزون تلقائياً</p>
    
    <div class="form-grid grid-4">
        <input type="text" id="saleCode" placeholder="كود الفاتورة" readonly>
        <input type="date" id="saleDate">
        <select id="saleCustomer">
            <option value="">اختر العميل</option>
        </select>
        <input type="text" id="saleCustomerCode" placeholder="كود العميل" readonly>
    </div>
    
    <div class="form-grid grid-4">
        <input type="text" id="saleCustomerName" placeholder="اسم العميل" readonly>
        <input type="text" id="saleCustomerPhone" placeholder="رقم جوال العميل" readonly>
        <input type="text" id="saleCustomerAddress" placeholder="عنوان العميل">
        <input type="text" id="saleNotes" placeholder="ملاحظات">
    </div>
    
    <div class="form-grid grid-4">
        <select id="saleItem">
            <option value="">اختر الصنف</option>
        </select>
        <input type="number" id="saleQuantity" placeholder="الكمية" min="1" value="1">
        <select id="saleUnit">
            <option value="قطعة">قطعة</option>
            <option value="درزن">درزن</option>
        </select>
        <input type="number" id="salePrice" placeholder="سعر البيع">
    <button class="btn-primary btn-add" onclick="addSaleItem()">➕ إضافة صنف</button>
    </div>
    
    <div class="invoice-items">
        <table>
            <thead>
                <tr>
                    <th>الصنف</th>
                    <th>الكمية</th>
                    <th>الوحدة</th>
                    <th>سعر البيع</th>
                    <th>الإجمالي</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody id="saleItemsList"></tbody>
        </table>
    </div>
    
    <div class="invoice-totals">
        <div>
            <span>المجموع:</span>
            <span id="saleSubtotal">0.00</span>
        </div>
       <div>
            <span>
                <input type="checkbox" id="applySaleTax" onchange="updateSaleTotals()" checked style="margin-right: 5px; vertical-align: middle;">
                <label for="applySaleTax" style="cursor: pointer;">تطبيق الضريبة (15%)</label>
            </span>
            <span id="saleTax">0.00</span>
        </div>
         <div>
            <span>المبلغ المدفوع:</span>
            <input type="number" id="salePaidAmount" placeholder="0.00" oninput="updateSaleTotals()">
        </div>
        <div>
            <span>المبلغ المتبقي:</span>
            <span id="saleRemainingAmount" class="remaining-unpaid">0.00</span>
        </div>
        <div class="total">
            <span>الإجمالي النهائي:</span>
            <span id="saleTotal">0.00</span>
        </div>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn-primary" id="saveSaleBtn" onclick="saveSale()">💾 حفظ الفاتورة</button>
        <button class="btn-secondary" onclick="newSale()">🆕 فاتورة جديدة</button>
    </div>
    
    <h3 style="margin-top: 30px;">فواتير المبيعات السابقة</h3>
    
    <div class="search-container">
        <input type="text" id="searchSales" class="search-input" placeholder="🔍 بحث في فواتير المبيعات...">
        <button class="toggle-filters-btn" onclick="FilterSortHelper.toggleFilters('salesFilters')">
            <span>�</span>
            <span>فلترة متقدمة</span>
            <span>▼</span>
        </button>
    </div>
    
    <!-- لوحة الفلترة المتقدمة -->
    <div id="salesFilters" class="filters-container">
        <div class="filters-grid">
            <div class="filter-group">
                <label>من تاريخ</label>
                <input type="date" id="salesDateFrom" class="filter-input">
            </div>
            <div class="filter-group">
                <label>إلى تاريخ</label>
                <input type="date" id="salesDateTo" class="filter-input">
            </div>
            <div class="filter-group">
                <label>المبلغ الإجمالي (من)</label>
                <input type="number" id="salesAmountFrom" class="filter-input" placeholder="0.00">
            </div>
            <div class="filter-group">
                <label>المبلغ الإجمالي (إلى)</label>
                <input type="number" id="salesAmountTo" class="filter-input" placeholder="0.00">
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn-secondary" onclick="resetSalesFilters()">🔄 إعادة تعيين</button>
            <button class="btn-primary" onclick="applySalesFilters()">✅ تطبيق الفلاتر</button>
        </div>
    </div>
    
    <table id="salesTable">
        <thead>
            <tr>
                <th class="sortable" data-column="code">رقم الفاتورة</th>
                <th class="sortable" data-column="date">التاريخ</th>
                <th class="sortable" data-column="customerId">العميل</th>
                <th class="sortable" data-column="itemsCount">الكمية</th>
                <th class="sortable" data-column="total">الإجمالي</th>
                <th class="sortable" data-column="paidAmount">المدفوع</th>
                <th class="sortable" data-column="remainingAmount">المتبقي</th>
                <th style="text-align: center;">الإجراءات</th>
            </tr>
        </thead>
        <tbody id="salesList"></tbody>
    </table>
</div>

<div id="returns" class="section">
    <h2>↩️ إدارة المرتجعات</h2>
    <div class="tabs">
        <button id="salesReturnTabBtn" class="tab-button active" onclick="showReturnTab('sales')">مرتجعات المبيعات</button>
        <button id="purchasesReturnTabBtn" class="tab-button" onclick="showReturnTab('purchases')">مرتجعات المشتريات</button>
    </div>

    <div id="salesReturnContent" class="tab-content active">
        <h3>إنشاء مرتجع مبيعات (إشعار دائن)</h3>
        <div class="search-container">
            <input type="number" id="salesReturnInvoiceSearch" class="search-input" placeholder="أدخل رقم فاتورة البيع الأصلية...">
            <button class="btn-primary" onclick="findSaleForReturn()">🔍 بحث</button>
        </div>
        
        <div id="salesReturnInvoiceDetails" class="return-invoice-details" style="display: none;"></div>

        <div id="salesReturnItemsContainer" style="display: none;">
            <h4>الأصناف القابلة للإرجاع:</h4>
            <table>
                <thead>
                    <tr>
                        <th>الصنف</th>
                        <th>سعر البيع</th>
                        <th>الكمية المباعة</th>
                        <th>الكمية المرتجعة</th>
                    </tr>
                </thead>
                <tbody id="salesReturnItemsList"></tbody>
            </table>
            <div class="invoice-totals">
                <div class="total">
                    <span>إجمالي قيمة المرتجع:</span>
                    <span id="salesReturnTotal">0.00</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-success" onclick="saveSaleReturn()">💾 حفظ المرتجع</button>
                <button class="btn-secondary" onclick="newSaleReturn()">🆕 مرتجع جديد</button>
            </div>
        </div>
        
        <h3 style="margin-top: 30px;">مرتجعات المبيعات السابقة</h3>
        <table>
            <thead>
                <tr>
                    <th>رقم المرتجع</th>
                    <th>التاريخ</th>
                    <th>العميل</th>
                    <th>فاتورة البيع الأصلية</th>
                    <th>إجمالي القيمة</th>
                </tr>
            </thead>
            <tbody id="salesReturnsList"></tbody>
        </table>
    </div>

    <div id="purchaseReturnContent" class="tab-content">
        <h3>إنشاء مرتجع مشتريات (إشعار مدين)</h3>
        <div class="search-container">
            <input type="number" id="purchaseReturnInvoiceSearch" class="search-input" placeholder="أدخل رقم فاتورة الشراء الأصلية...">
            <button class="btn-primary" onclick="findPurchaseForReturn()">🔍 بحث</button>
        </div>

        <div id="purchaseReturnInvoiceDetails" class="return-invoice-details" style="display: none;"></div>

        <div id="purchaseReturnItemsContainer" style="display: none;">
            <h4>الأصناف القابلة للإرجاع:</h4>
            <table>
                <thead>
                    <tr>
                        <th>الصنف</th>
                        <th>سعر الشراء</th>
                        <th>الكمية المشتراة</th>
                        <th>الكمية المرتجعة</th>
                    </tr>
                </thead>
                <tbody id="purchaseReturnItemsList"></tbody>
            </table>
            <div class="invoice-totals">
                <div class="total">
                    <span>إجمالي قيمة المرتجع:</span>
                    <span id="purchaseReturnTotal">0.00</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-success" onclick="savePurchaseReturn()">💾 حفظ المرتجع</button>
                <button class="btn-secondary" onclick="newPurchaseReturn()">🆕 مرتجع جديد</button>
            </div>
        </div>

        <h3 style="margin-top: 30px;">مرتجعات المشتريات السابقة</h3>
        <table>
            <thead>
                <tr>
                    <th>رقم المرتجع</th>
                    <th>التاريخ</th>
                    <th>المورد</th>
                    <th>فاتورة الشراء الأصلية</th>
                    <th>إجمالي القيمة</th>
                </tr>
            </thead>
            <tbody id="purchaseReturnsList"></tbody>
        </table>
    </div>
</div>
<div id="expenses" class="section">
    <h2>💸 إدارة المصروفات <span class="title-stat-card"><span class="stat-mini-label">الإجمالي:</span><span id="miniStatExpenses" class="stat-mini-number">0</span></span></h2>
    <p>💰 هنا يمكنك إدارة وتصنيف المصروفات اليومية</p>
    
    <div class="form-grid grid-4">
        <input type="date" id="expenseDate" value="">
        <input type="text" id="expenseCategory" placeholder="تصنيف المصروف *" required>
        <input type="number" id="expenseAmount" placeholder="المبلغ *" required min="0">
        <input type="text" id="expenseDescription" placeholder="وصف المصروف">
    </div>
    
    <div class="form-grid grid-3">
        <select id="expensePaymentMethod">
            <option value="cash">نقدي</option>
            <option value="bank">تحويل بنكي</option>
            <option value="check">شيك</option>
            <option value="card">بطاقة ائتمان</option>
        </select>
        <input type="text" id="expenseReference" placeholder="رقم المرجع (اختياري)">
    <button class="btn-primary btn-add" onclick="addExpense()">➕ إضافة مصروف</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchExpenses" class="search-input" placeholder="🔍 بحث في المصروفات...">
    </div>

    <table>
        <thead>
            <tr>
                <th>التاريخ</th>
                <th>التصنيف</th>
                <th>المبلغ</th>
                <th>طريقة الدفع</th>
                <th>الوصف</th>
                <th>رقم المرجع</th>
                <th>الإجراءات</th>
            </tr>
        </thead>
        <tbody id="expensesList"></tbody>
    </table>
    
    <div class="stats-grid" style="margin-top: 30px;">
        <div class="stat-card">
            <div class="stat-number" id="totalExpenses">0</div>
            <div class="stat-label">إجمالي المصروفات</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="todayExpenses">0</div>
            <div class="stat-label">مصروفات اليوم</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="monthExpenses">0</div>
            <div class="stat-label">مصروفات الشهر</div>
        </div>
    </div>
</div>

<div id="revenues" class="section">
    <h2>💰 إدارة الإيرادات <span class="title-stat-card"><span class="stat-mini-label">الإجمالي:</span><span id="miniStatRevenues" class="stat-mini-number">0</span></span></h2>
    <p>💵 هنا يمكنك إدارة وتصنيف الإيرادات المختلفة</p>
    
    <div class="form-grid grid-4">
        <input type="date" id="revenueDate" value="">
        <input type="text" id="revenueCategory" placeholder="تصنيف الإيراد *" required>
        <input type="number" id="revenueAmount" placeholder="المبلغ *" required min="0">
        <input type="text" id="revenueDescription" placeholder="وصف الإيراد">
    </div>
    
    <div class="form-grid grid-3">
        <select id="revenueSource">
            <option value="sales">مبيعات</option>
            <option value="services">خدمات</option>
            <option value="investment">استثمار</option>
            <option value="other">أخرى</option>
        </select>
        <input type="text" id="revenueReference" placeholder="رقم المرجع (اختياري)">
    <button class="btn-primary btn-add" onclick="addRevenue()">➕ إضافة إيراد</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchRevenues" class="search-input" placeholder="🔍 بحث في الإيرادات...">
    </div>

    <table>
        <thead>
            <tr>
                <th>التاريخ</th>
                <th>التصنيف</th>
                <th>المصدر</th>
                <th>المبلغ</th>
                <th>الوصف</th>
                <th>رقم المرجع</th>
                <th>الإجراءات</th>
            </tr>
        </thead>
        <tbody id="revenuesList"></tbody>
    </table>
    
    <div class="stats-grid" style="margin-top: 30px;">
        <div class="stat-card">
            <div class="stat-number" id="totalRevenues">0</div>
            <div class="stat-label">إجمالي الإيرادات</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="todayRevenues">0</div>
            <div class="stat-label">إيرادات اليوم</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="monthRevenues">0</div>
            <div class="stat-label">إيرادات الشهر</div>
        </div>
    </div>
</div>


<div id="salaries" class="section">
    <h2>💼 إدارة الرواتب <span class="title-stat-card"><span class="stat-mini-label">الإجمالي:</span><span id="miniStatSalaries" class="stat-mini-number">0.00</span></span></h2>
    <p>🧾 قم بإعداد ومتابعة مسيرات الرواتب الشهرية للموظفين مع تطبيق أنظمة التأمينات الاجتماعية تلقائياً.</p>

    <div class="salary-card">
        <h3>إدخال بيانات الرواتب</h3>
        <div class="form-grid">
            <input type="month" id="salaryMonth" value="">
            <input type="text" id="salaryEmployeeName" placeholder="اسم الموظف *" required>
            <input type="text" id="salaryEmployeeId" placeholder="الرقم الوطني *" required>
            <input type="text" id="salaryJobTitle" placeholder="المسمى الوظيفي">
            <input type="number" id="salaryBasic" placeholder="الراتب الأساسي *" min="0" step="0.01" required>
            <input type="number" id="salaryHousing" placeholder="بدل السكن" min="0" step="0.01">
            <input type="number" id="salaryTransport" placeholder="بدل النقل" min="0" step="0.01">
            <input type="number" id="salaryOtherAllowances" placeholder="بدلات أخرى" min="0" step="0.01">
            <input type="number" id="salaryOvertime" placeholder="مكافآت إضافية" min="0" step="0.01">
            <input type="number" id="salaryOtherDeductions" placeholder="استقطاعات أخرى" min="0" step="0.01">
            <textarea id="salaryNotes" placeholder="ملاحظات حول المسير" rows="2"></textarea>
        </div>
        <div class="salary-actions">
            <button class="btn-primary" onclick="addSalary()">➕ حفظ المسير</button>
            <button class="btn-secondary" onclick="clearSalaryForm()">↺ تفريغ الحقول</button>
        </div>
    </div>

    <div class="salary-summary">
        <h3>ملخص الرواتب للشهر المحدد</h3>
        <div class="summary-item"><span>عدد الموظفين</span><span id="salarySummaryCount">0</span></div>
        <div class="summary-item"><span>إجمالي الرواتب الأساسية</span><span id="salarySummaryBasic">0.00</span></div>
        <div class="summary-item"><span>إجمالي البدلات</span><span id="salarySummaryAllowances">0.00</span></div>
        <div class="summary-item"><span>إجمالي الرواتب</span><span id="salarySummaryGross">0.00</span></div>
        <div class="summary-item gosi-deduction"><span>إجمالي استقطاعات GOSI</span><span id="salarySummaryGosi">0.00</span></div>
        <div class="summary-item"><span>مساهمة جهة العمل (GOSI)</span><span id="salarySummaryGosiEmployer">0.00</span></div>
        <div class="summary-item"><span>استقطاعات أخرى</span><span id="salarySummaryOtherDeductions">0.00</span></div>
        <div class="summary-item summary-total"><span>صافي الرواتب</span><span id="salarySummaryNet" class="net-salary">0.00</span></div>
    </div>

    <div class="search-container">
        <input type="text" id="searchSalaries" class="search-input" placeholder="🔍 بحث في مسيرات الرواتب...">
    </div>

    <table>
        <thead>
            <tr>
                <th>الموظف</th>
                <th>الشهر</th>
                <th>المسمى الوظيفي</th>
                <th>الراتب الأساسي</th>
                <th>إجمالي البدلات</th>
                <th>الإجمالي</th>
                <th>استقطاع GOSI</th>
                <th>استقطاعات أخرى</th>
                <th>صافي الراتب</th>
                <th>الإجراءات</th>
            </tr>
        </thead>
        <tbody id="salariesList"></tbody>
    </table>
</div>

<div id="reports" class="section">
    <h2>📊 التقارير</h2>
    <p>📋اختر نوع التقرير والفترة الزمنية ثم اضغط على "عرض التقرير"</p>

    <div id="reportsTab" class="tab-content active">
        <div class="report-controls">
            <select id="reportType" onchange="changeReportType()">
                <option value="sales">تقارير المبيعات</option>
                <option value="purchases">تقارير المشتريات</option>
                <option value="sales_returns">↩️ تقارير مرتجعات المبيعات</option>
                <option value="purchase_returns">↩️ تقارير مرتجعات المشتريات</option>
                <option value="expenses">تقارير المصروفات</option>
                <option value="revenues">تقارير الإيرادات</option>
                <option value="salaries">💼 تقارير الرواتب</option>
                <option value="profit_loss">📊 تقرير الربح والخسارة</option>
            </select>
            
            <input type="date" id="reportFrom">
            <input type="date" id="reportTo">
            
            <select id="reportSupplierFilter" style="display: none;">
                <option value="all">كل الموردين</option>
            </select>

            <select id="reportCustomerFilter" style="display: none;">
                <option value="all">كل العملاء</option>
            </select>

            <select id="paymentStatusFilter">
                <option value="all">كل الفواتير</option>
                <option value="paid">المدفوعة</option>
                <option value="unpaid">غير المدفوعة</option>
            </select>
            
            <select id="reportItemFilter" onchange="updateReportItemFilter()">
                <option value="all">جميع الأصناف</option>
                <option value="specific">صنف محدد</option>
            </select>
            
            <select id="reportSpecificItem" style="display: none;">
                <option value="">اختر الصنف</option>
            </select>
            
            <button class="btn-primary" onclick="generateReport()">🔍 عرض التقرير</button>
        </div>
        
        <div class="export-options">
            <button class="btn-success" onclick="exportToExcel()">📊 تصدير إلى Excel</button>
            <button class="btn-secondary" onclick="exportToWeb()">🖨️ طباعة التقرير</button>
        </div>
        
        <div class="report-summary" id="reportSummary">
               
        </div>
        
        <div id="reportResults">
        </div>
    </div>
</div>

<div id="settings" class="section">
    <h2>⚙️ الإعدادات والنظام</h2>

    <div class="settings-grid">
        <div id="userManagementSection" class="user-management settings-card" style="display: none;">
            <h3>👥 إدارة المستخدمين</h3>
            <div class="form-grid grid-users">
                <input type="text" id="newUserName" placeholder="اسم المستخدم *">
                <select id="newUserRole">
                    <option value="admin">مدير</option>
                    <option value="manager">مدير نشاط</option>
                    <option value="user">مستخدم</option>
                </select>
                <input type="email" id="newUserEmail" placeholder="البريد الإلكتروني *">
                <input type="tel" id="newUserPhone" placeholder="رقم الجوال *">
                <input type="password" id="newUserPassword" placeholder="كلمة المرور *">
                <select id="newUserActivity">
                    <option value="">-- تعيين لنشاط --</option>
                </select>
                <button class="btn-primary btn-add" onclick="addUser()">➕ إضافة مستخدم</button>
            </div>
            <div class="user-selector">
                <label for="usersDropdown" class="user-selector-label">قائمة المستخدمين:</label>
                <div class="user-selector-controls">
                    <select id="usersDropdown" onchange="handleUserSelection()">
                        <option value="">اختر مستخدمًا</option>
                    </select>
                </div>
                <div id="selectedUserInfo" class="selected-user-info" style="display: none;">
                    <div class="selected-user-grid">
                        <div class="selected-user-field">
                            <label for="selectedUserName">الاسم</label>
                            <input type="text" id="selectedUserName" readonly>
                        </div>
                        <div class="selected-user-field role-field">
                            <label for="selectedUserRole">الصلاحية</label>
                            <input type="text" id="selectedUserRole" readonly>
                        </div>
                        <div class="selected-user-field">
                            <label for="selectedUserEmail">البريد الإلكتروني</label>
                            <input type="text" id="selectedUserEmail" readonly>
                        </div>
                        <div class="selected-user-field phone-field">
                            <label for="selectedUserPhone">رقم الجوال</label>
                            <input type="text" id="selectedUserPhone" readonly>
                        </div>
                        <div class="selected-user-field">
                            <label for="selectedUserActivity">النشاط المخصص</label>
                            <input type="text" id="selectedUserActivity" readonly>
                        </div>
                    </div>
                    <div class="selected-user-actions">
                        <button class="btn-warning edit-btn" id="editSelectedUserBtn" onclick="handleEditSelectedUser()" disabled>✏️ تعديل</button>
                        <button class="btn-danger" id="deleteSelectedUserBtn" onclick="handleDeleteSelectedUser()" disabled>🗑️ حذف</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="activityManagementSection" class="activities-management settings-card" style="display: none;">
            <h3>🏢 إدارة الأنشطة التجارية</h3>
            <div class="form-grid grid-3">
                <input type="text" id="settingNewActivityName" placeholder="اسم النشاط الجديد">
                <button class="btn-primary btn-add" onclick="addNewActivity(true)">➕ إضافة نشاط</button>
                <button class="btn-danger" onclick="showTrashModal()">
                    🗑️ سلة المحذوفات
                    <span id="trash-count-badge" style="background: #fff; color: #d32f2f; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-right: 5px; font-weight: bold;"></span>
                </button>
            </div>
            <div class="activity-selector" style="margin-top: 20px;">
                <label for="activitiesDropdown" class="activity-selector-label">قائمة الأنشطة:</label>
                <div class="activity-selector-controls">
                    <select id="activitiesDropdown" onchange="handleActivitySelection()">
                        <option value="">اختر نشاطًا</option>
                    </select>
                </div>
                <div id="selectedActivityInfo" class="selected-activity-info" style="display: none;">
                    <div class="selected-activity-field">
                        <label for="selectedActivityName">اسم النشاط</label>
                        <input type="text" id="selectedActivityName" readonly>
                    </div>
                    <div class="selected-activity-actions">
                        <button class="btn-warning edit-btn" id="editSelectedActivityBtn" onclick="handleEditSelectedActivity()" disabled>✏️ تعديل</button>
                        <button class="btn-danger" id="deleteSelectedActivityBtn" onclick="handleDeleteSelectedActivity()" disabled>🗑️ حذف</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- شعار النشاط التجاري - متاح لمدير النشاط -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div id="activityLogoSection" class="activity-logo-settings settings-card" style="display: none;">
                <h3>🏢 شعار النشاط التجاري</h3>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">اختر شعاراً للنشاط التجاري الحالي (يظهر في الترويسة والفواتير)</p>
            
            <div class="logo-preview-container" style="text-align: center; margin-bottom: 20px;">
                <img id="activityLogoPreview" src="" alt="معاينة شعار النشاط" style="max-width: 150px; max-height: 150px; display: none; border: 2px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
                <p id="noActivityLogoText" style="color: #999; font-style: italic;">لم يتم رفع شعار للنشاط بعد</p>
            </div>
            
            <div class="logo-actions" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <input type="file" id="activityLogoFileInput" accept="image/*" style="display: none;" onchange="handleActivityLogoUpload(this)">
                <button class="btn-primary" onclick="document.getElementById('activityLogoFileInput').click()">📤 اختيار شعار النشاط</button>
                <button class="btn-danger" id="removeActivityLogoBtn" onclick="removeActivityLogo()" style="display: none;">🗑️ حذف الشعار</button>
            </div>
            
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 0.85em;">
                <p><strong>💡 نصائح:</strong></p>
                <ul style="margin: 5px 0; padding-right: 20px;">
                    <li>سيظهر الشعار في وسط الترويسة مع اسم النشاط تحته</li>
                    <li>يُفضل استخدام صورة بخلفية شفافة (PNG)</li>
                    <li>الحجم الموصى به: 400×400 بكسل</li>
                    <li>أقصى حجم للملف: 2 ميجابايت</li>
                </ul>
            </div>
            </div>

            <div id="programLogoSection" class="logo-settings settings-card">
                <h3>🎨 شعار البرنامج</h3>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">اختر شعاراً يظهر في شاشة تسجيل الدخول</p>
            
            <div class="logo-preview-container" style="text-align: center; margin-bottom: 20px;">
                <img id="logoPreview" src="" alt="معاينة الشعار" style="max-width: 150px; max-height: 150px; display: none; border: 2px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
                <p id="noLogoText" style="color: #999; font-style: italic;">لم يتم رفع شعار بعد</p>
            </div>
            
            <div class="logo-actions" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <input type="file" id="logoFileInput" accept="image/*" style="display: none;" onchange="handleLogoUpload(this)">
                <button class="btn-primary" onclick="document.getElementById('logoFileInput').click()">📤 اختيار شعار</button>
                <button class="btn-danger" id="removeLogoBtn" onclick="removeLogo()" style="display: none;">🗑️ حذف الشعار</button>
            </div>
            
            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 0.85em;">
                <p><strong>💡 نصائح:</strong></p>
                <ul style="margin: 5px 0; padding-right: 20px;">
                    <li>يُفضل استخدام صورة بخلفية شفافة (PNG)</li>
                    <li>الحجم الموصى به: 500×500 بكسل</li>
                    <li>أقصى حجم للملف: 2 ميجابايت</li>
                </ul>
            </div>
            </div>
        </div>

        <div class="auto-backup-settings settings-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
            <h3 style="color: white;">🔄 النسخ الاحتياطي التلقائي</h3>
            <p style="opacity: 0.95; margin-bottom: 20px;">يتم إنشاء نسخة احتياطية تلقائياً كل 24 ساعة وحفظها محلياً على جهازك</p>
            
            <div class="data-actions-grid" style="gap: 15px;">
                <button class="btn-success" onclick="performAutoBackup()" style="background: #10b981;">
                    💾 إنشاء نسخة احتياطية الآن
                </button>
                <button class="btn-info" onclick="showAutoBackupInfo()" style="background: #3b82f6;">
                    ℹ️ معلومات آخر نسخة
                </button>
                <button class="btn-warning" onclick="restoreAutoBackup()" style="background: #f59e0b;">
                    ↩️ استعادة آخر نسخة
                </button>
                <button class="btn-secondary" onclick="downloadAutoBackup()" style="background: #6366f1;">
                    📥 تنزيل النسخة كملف
                </button>
            </div>
            
            <div style="background: rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 8px; margin-top: 20px; backdrop-filter: blur(10px);">
                <h4 style="color: white; margin-bottom: 10px;">✨ مميزات النظام:</h4>
                <ul style="margin: 0; padding-right: 20px; opacity: 0.95;">
                    <li>نسخ احتياطي تلقائي كل 24 ساعة</li>
                    <li>حفظ محلي آمن على جهازك</li>
                    <li>الاحتفاظ بنسختين (الحالية والسابقة)</li>
                    <li>استعادة سريعة بضغطة واحدة</li>
                    <li>إمكانية تنزيل النسخة كملف JSON</li>
                </ul>
            </div>
        </div>

        <div class="data-management settings-card">
            <h3>🔄 إدارة بيانات النشاط الحالي</h3>
            <div class="data-actions">
                <div class="data-actions-grid">
                    <button class="btn-success" onclick="exportActivityData()">📥 تصدير بيانات النشاط</button>
                    <button class="btn-info" onclick="exportActivityDataExcel()">📊 تصدير بيانات Excel</button>
                    <button class="btn-primary" onclick="importData()">📤 استيراد بيانات للنشاط</button>
                    <button class="btn-warning backup-btn" onclick="createBackup()">💾 نسخ احتياطي</button>
                    <button class="btn-secondary" onclick="importSampleData()">🧪 بيانات تجريبية للنشاط</button>
                    <button class="btn-danger" onclick="clearActivityData()">🗑️ مسح بيانات النشاط</button>
                </div>
            </div>
            <div class="backup-info" style="background: #fff3cd; padding: 20px; border-radius: 8px; border-right: 4px solid #ffc107;">
                <h4>💡 نصائح مهمة:</h4>
                <ul style="margin: 10px 0; padding-right: 20px;">
                    <li>الإجراءات أعلاه خاصة بالنشاط المحدد حالياً فقط.</li>
                    <li>احفظ نسخة احتياطية لكل نشاط بشكل دوري.</li>
                    <li>تأكد من اختيار النشاط الصحيح قبل استيراد أو مسح البيانات.</li>
                </ul>
            </div>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(this.files)">
        </div>
    </div>

    <button id="toggleEmailSettingsBtn" class="btn-success" onclick="toggleEmailSettings()" style="margin-top: 30px; margin-bottom: 10px;">
        ⚙️ إظهار/إخفاء إعدادات البريد الإلكتروني
    </button>
    <div class="email-settings">
    <h3>📧 إعدادات البريد الإلكتروني (EmailJS)</h3>
    <p>هذه الإعدادات ضرورية لتفعيل خاصية إرسال الفواتير وروابط إعادة تعيين كلمة المرور عبر البريد. يمكنك الحصول عليها من حسابك في <a href="https://www.emailjs.com/" target="_blank">EmailJS</a>.</p>
        <div class="form-grid grid-3" style="margin-top: 15px;">
            <div style="display: flex; flex-direction: column;">
                <label for="emailJsServiceId" style="margin-bottom: 5px; font-weight: bold;">Service ID</label>
                <code style="background-color: #eee; padding: 5px; border-radius: 4px; margin-bottom: 5px; cursor: pointer; user-select: all;" onclick="navigator.clipboard.writeText(this.innerText); alert('تم نسخ Service ID');">service_hu6ucxi</code>
                <input type="text" id="emailJsServiceId" placeholder="أدخل Service ID هنا">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="emailJsTemplateId" style="margin-bottom: 5px; font-weight: bold;">Template ID</label>
                <code style="background-color: #eee; padding: 5px; border-radius: 4px; margin-bottom: 5px; cursor: pointer; user-select: all;" onclick="navigator.clipboard.writeText(this.innerText); alert('تم نسخ Template ID');">template_cwep9ok</code>
                <input type="text" id="emailJsTemplateId" placeholder="أدخل Template ID هنا">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="emailJsResetTemplateId" style="margin-bottom: 5px; font-weight: bold;">Reset Template ID</label>
                <code style="background-color: #eee; padding: 5px; border-radius: 4px; margin-bottom: 5px; cursor: pointer; user-select: all;" onclick="navigator.clipboard.writeText(this.innerText); alert('تم نسخ Reset Template ID');">template_password_reset</code>
                <input type="text" id="emailJsResetTemplateId" placeholder="أدخل Template ID لرسالة إعادة كلمة المرور">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="emailJsPublicKey" style="margin-bottom: 5px; font-weight: bold;">Public Key</label>
                <code style="background-color: #eee; padding: 5px; border-radius: 4px; margin-bottom: 5px; cursor: pointer; user-select: all;" onclick="navigator.clipboard.writeText(this.innerText); alert('تم نسخ Public Key');">-FKicwCTdzG90IoY6</code>
                <input type="text" id="emailJsPublicKey" placeholder="أدخل Public Key هنا">
            </div>
        </div>
        <button class="btn-success" onclick="saveEmailJsSettings()">💾 حفظ إعدادات البريد</button>
        <div style="margin-top: 10px; font-size: 0.9em;">
            <p><strong>ملاحظة:</strong>
                - قالب الفاتورة يجب أن يحتوي على: <code>{{to_name}}</code>, <code>{{to_email}}</code>, <code>{{from_name}}</code>, <code>{{invoice_number}}</code>, <code>{{invoice_details}}</code>.
                <br>- قالب إعادة كلمة المرور يجب أن يحتوي على: <code>{{to_email}}</code>, <code>{{reset_link}}</code>, <code>{{app_name}}</code>.
            </p>
        </div>
    </div>

    
</div>

<div id="account-info" class="section">
    <h2>👤 معلومات الحساب</h2>
    <p>استعرض بيانات حسابك وحدد الإجراءات المتعلقة بأمان الدخول.</p>
    <div class="account-info-grid">
        <div class="account-info-card">
            <h3>بيانات المستخدم</h3>
            <div class="account-info-field"><strong>الاسم:</strong> <span id="accountInfoName">غير متوفر</span></div>
            <div class="account-info-field"><strong>البريد الإلكتروني:</strong> <span id="accountInfoEmail">غير متوفر</span></div>
            <div class="account-info-field"><strong>رقم الجوال:</strong> <span id="accountInfoPhone">غير متوفر</span></div>
            <div class="account-info-field"><strong>الصلاحية:</strong> <span id="accountInfoRole">غير متوفر</span></div>
            <div class="account-info-actions">
                <button class="btn-primary" id="accountInfoEditBtn" onclick="openSelfEditUserModal()">✏️ تعديل بياناتي</button>
            </div>
        </div>
        <div class="account-info-card">
            <h3>النشاط الحالي</h3>
            <div class="account-info-field"><strong>النشاط الحالي:</strong> <span id="accountInfoActivity">لم يتم تحديد نشاط</span></div>
            <div class="account-info-actions">
                <button class="btn-warning" id="accountInfoChangeActivityBtn" onclick="showActivityModal()">🔄 تغيير النشاط</button>
            </div>
        </div>
        <div class="account-info-card">
            <h3>إدارة كلمة المرور</h3>
            <p style="margin-bottom: 15px;">ننصح بتغيير كلمة المرور بشكل دوري للحفاظ على أمان بياناتك.</p>
            <div class="account-info-actions">
                <button class="btn-warning" onclick="openChangePasswordModal()">🔒 تغيير كلمة المرور</button>
            </div>
        </div>
    </div>
</div>

<div id="purchaseInvoicePrint" class="invoice-print">
    <!-- الإطار الخارجي -->
    <div style="border: 4px double #2c5aa0; padding: 15px; position: relative;">
        
        <!-- الهيدر: الشعار (أقصى اليسار) + اسم النشاط -->
        <div style="border: 2px solid #2c5aa0; border-radius: 15px; padding: 10px; margin-bottom: 8px; display: flex; align-items: center;">
            <div style="width: 60px; display: flex; justify-content: flex-start;">
                <img id="printPurchaseActivityLogo" src="" alt="شعار" style="width: 50px; height: 50px; display: none; margin: 0; border-radius: 50%; border: 2px solid #2c5aa0;">
            </div>
            <div style="text-align: center; flex: 1;">
                <h2 id="printPurchaseActivityName" style="margin: 0; color: #2c5aa0; font-size: 1.5em; font-weight: bold;">اسم النشاط</h2>
                <div style="font-size: 0.85em; margin-top: 2px;">فاتورة مشتريات</div>
            </div>
            <div style="width: 60px;"></div>
        </div>
        
        <!-- صف المعلومات العلوي -->
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 0.95em;">
            <div style="border: 1px solid #2c5aa0; padding: 8px;">
                <strong>التاريخ:</strong> <span id="printPurchaseDate"></span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px;">
                <strong>رقم الفاتورة:</strong> <span id="printPurchaseNumber"></span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px;">
                <strong>الوقت:</strong> <span id="printPurchaseTime">--:--</span>
            </div>
        </div>
        
        <!-- بيانات المورد -->
        <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 10px; font-size: 0.95em;">
            <strong>المورد:</strong> <span id="printSupplierName">-----</span>
        </div>
        
        <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 10px; font-size: 0.9em;">
            <strong>ملاحظات:</strong> <span id="printPurchaseNotes">-----</span>
        </div>
        
        <!-- جدول الأصناف -->
        <table class="invoice-items-table" style="width: 100%; border-collapse: collapse; margin-bottom: 10px; table-layout: fixed; display: table; margin: 0;">
            <colgroup>
                <col style="width: 5%;">    <!-- م -->
                <col style="width: 25%;">   <!-- اسم الصنف -->
                <col style="width: 12.5%;"> <!-- الكمية -->
                <col style="width: 12.5%;"> <!-- الوحدة -->
                <col style="width: 12.5%;"> <!-- السعر -->
                <col style="width: 12.5%;"> <!-- الإجمالي -->
            </colgroup>
            <thead>
                <tr style="background: #e3f2fd; color: #2c5aa0;">
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">م</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: right;">اسم الصنف</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">الكمية</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">الوحدة</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">السعر</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left;">الإجمالي</th>
                </tr>
            </thead>
            <tbody id="printPurchaseItems" style="font-size: 0.95em;">
                <!-- سيتم ملؤها ديناميكياً -->
            </tbody>
        </table>
        
        <!-- المجاميع أسفل يسار الصفحة -->
        <div style="margin-top: 15px; width: 280px; float: left;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #f8f9fa; font-size: 0.9em;">
                <strong>المجموع الفرعي:</strong>
                <span id="printPurchaseSubtotal">0.00</span>
            </div>
            <div id="printPurchaseTaxRow" style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9em;">
                <strong>الضريبة (15%):</strong>
                <span id="printPurchaseTax">0.00</span>
            </div>
            <div style="border: 2px solid #2c5aa0; padding: 10px; background: #e3f2fd; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-weight: bold; font-size: 1em; color: #2c5aa0;">
                <strong>الإجمالي النهائي:</strong>
                <span id="printPurchaseTotal">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9em;">
                <strong>المدفوع:</strong>
                <span id="printPurchasePaid">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #fff3cd; font-size: 0.9em;">
                <strong>المتبقي:</strong>
                <span id="printPurchaseRemaining">0.00</span>
            </div>
        </div>
        
        <div style="clear: both;"></div>
    </div>
</div>

<div id="saleInvoicePrint" class="invoice-print">
    <!-- الإطار الخارجي -->
    <div style="border: 4px double #2c5aa0; padding: 15px; position: relative;">
        
        <!-- الهيدر: الشعار (أقصى اليسار) + اسم النشاط -->
        <div style="border: 2px solid #2c5aa0; border-radius: 15px; padding: 10px; margin-bottom: 8px; display: flex; align-items: center;">
            <div style="width: 60px; display: flex; justify-content: flex-start;">
                <img id="printSaleActivityLogo" src="" alt="شعار" style="width: 50px; height: 50px; display: none; margin: 0; border-radius: 50%; border: 2px solid #2c5aa0;">
            </div>
            <div style="text-align: center; flex: 1;">
                <h2 id="printSaleActivityName" style="margin: 0; color: #2c5aa0; font-size: 1.5em; font-weight: bold;">اسم النشاط</h2>
                <div style="font-size: 0.85em; margin-top: 2px;">فاتورة مبيعات</div>
            </div>
            <div style="width: 60px;"></div>
        </div>
        
        <!-- صف المعلومات العلوي -->
        <div style="display: grid; grid-template-columns: 1fr 1.5fr 0.8fr; gap: 10px; margin-bottom: 10px; font-size: 0.95em;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; font-size: 0.85em; border-radius: 8px;">
                <strong>التاريخ:</strong> <span id="printSaleDate"></span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; background: #e3f2fd; font-size: 0.85em; border-radius: 8px;">
                <strong>فاتورة ضريبية مبسطة ـ رقم:</strong> <span id="printSaleNumber"></span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; font-size: 0.85em; border-radius: 8px;">
                <strong>الوقت:</strong> <span id="printSaleTime">--:--</span>
            </div>
        </div>
        
        <!-- بيانات العميل -->
        <div style="display: grid; grid-template-columns: 1.5fr 0.8fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 0.95em;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>اسم العميل:</strong> <span id="printCustomerName">-----</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>كود العميل:</strong> <span id="printCustomerCode">-----</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>رقم الجوال:</strong> <span id="printCustomerPhone">-----</span>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 0.9em;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>عنوان العميل:</strong> <span id="printCustomerAddress">-----</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; border-radius: 8px;">
                <strong>ملاحظات:</strong> <span id="printSaleNotes">-----</span>
            </div>
        </div>
        
        <!-- جدول الأصناف -->
    <table class="invoice-items-table" style="width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 10px;">
            <thead>
                <tr style="background: #e3f2fd; color: #2c5aa0;">
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 5%; border-radius: 6px;">م</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 15%; border-radius: 6px;">رقم الصنف</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 33%; border-radius: 6px;">اسم الصنف</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 15.5%; border-radius: 6px;">الكمية</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 15.5%; border-radius: 6px;">الوحدة</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 15.5%; border-radius: 6px;">السعر</th>
                    <th style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; width: 12.5%; border-radius: 6px;">الإجمالي</th>
                </tr>
            </thead>
            <tbody id="printSaleItems" style="font-size: 0.9em;">
                <!-- سيتم ملؤها ديناميكياً -->
            </tbody>
        </table>
        
        <!-- المجاميع أسفل يسار الصفحة -->
            <div style="margin-top: 15px; width: 280px; float: left;">
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #f8f9fa; font-size: 0.9em;">
                <strong>المجموع الفرعي:</strong>
                <span id="printSaleSubtotal">0.00</span>
            </div>
            <div id="printSaleTaxRow" style="border: 1px solid #2c5aa0; padding: 8px; margin-bottom: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9em;">
                <strong>الضريبة (15%):</strong>
                <span id="printSaleTax">0.00</span>
            </div>
            <div style="border: 2px solid #2c5aa0; padding: 10px; background: #e3f2fd; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-weight: bold; font-size: 1em; color: #2c5aa0;">
                <strong>الإجمالي النهائي:</strong>
                <span id="printSaleTotal">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; font-size: 0.9em;">
                <strong>المدفوع:</strong>
                <span id="printSalePaid">0.00</span>
            </div>
            <div style="border: 1px solid #2c5aa0; padding: 8px; margin-top: 5px; display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #fff3cd; font-size: 0.9em;">
                <strong>المتبقي:</strong>
                <span id="printSaleRemaining">0.00</span>
            </div>
        </div>
        
        <div style="clear: both;"></div>
    </div>
</div>
        </div>
    </div>
    <script>

// === وضع التطوير/الإنتاج ===
const DEBUG_MODE = true; // تفعيل وضع التصحيح

// دالة للطباعة الآمنة في وضع التطوير فقط
function debugLog(...args) {
    if (DEBUG_MODE) {
        console.log(...args);
    }
}

// === إعداد Firebase ===
const firebaseConfig = {
  apiKey: "AIzaSyDtm443qVDGFOH7NIFgaxVWPhhW5Ezrfrw",
  authDomain: "diwani-bc43f.firebaseapp.com",
  // -->> هذا هو الرابط الصحيح من شاشتك <<--
  databaseURL: "https://diwani-bc43f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "diwani-bc43f",
  storageBucket: "diwani-bc43f.firebasestorage.app",
  messagingSenderId: "796547946795",
  appId: "1:796547946795:web:fe9d572923625463dc0d6e",
  measurementId: "G-VEZFJDN2LB"
};
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // === متغيرات النظام ===
    let activities = [];
    let currentActivityId = null;
    let items = [], customers = [], suppliers = [], purchases = [], sales = [], expenses = [], revenues = [], salaries = [];
    let salesReturns = [], purchaseReturns = [];
        let currentPurchaseItems = [], currentSaleItems = [];
        let editingPurchaseId = null, editingSaleId = null, editingSalaryId = null;
        let currentPurchaseNumber = 1, currentSaleNumber = 1;
        let currentSaleReturnNumber = 1, currentPurchaseReturnNumber = 1;
        let activeSaleReturn = null, activePurchaseReturn = null;
        let users = [];
        const FIREBASE_SHARED_ROOT = 'shared_activities';
    const GOSI_RATE = 0.09;
    const GOSI_SALARY_CAP = 45000;
    
    // ===== متغيرات الإشعارات وسلة المحذوفات =====
    let notifications = [];
    let trashBin = {
        items: [],
        customers: [],
        suppliers: [],
        purchases: [],
        sales: [],
        expenses: [],
        revenues: [],
        salaries: []
    };
    const LOW_STOCK_THRESHOLD = 5; // حد التنبيه لانخفاض المخزون
    
    // ===== تكوين EmailJS الثابت (عدّل القيم أدناه ثم فعّل العلم EMAILJS_FIXED) =====
    const EMAILJS_FIXED = false; // true = استخدام الإعدادات الثابتة الموضوعة أدناه وعدم إظهار واجهة الإعداد

    const EMAILJS_DEFAULTS = {
        serviceID: 'service_hu6ucxi',
        templateID: 'VH3waGBnucCE-S4eeM0I4', // قالب الفواتير
        resetTemplateID: 'template_aqp69jt', // قالب إعادة كلمة المرور
        publicKey: '-FKicwCTdzG90IoY6'
    };
    let emailJsConfig = { ...EMAILJS_DEFAULTS };

    // ===== وظائف التشفير للأمان =====
    async function hashPassword(password) {
        // استخدام SHA-256 لتشفير كلمة المرور
        const msgBuffer = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
    }

    async function verifyPassword(inputPassword, hashedPassword) {
        const inputHash = await hashPassword(inputPassword);
        return inputHash === hashedPassword;
    }

    // ===== نظام مؤشرات التحميل =====
    function showLoading(message = 'جاري التحميل...') {
        let loader = document.getElementById('global-loader');
        if (!loader) {
            loader = document.createElement('div');
            loader.id = 'global-loader';
            loader.innerHTML = `
                <div class="loader-overlay">
                    <div class="loader-content">
                        <div class="spinner"></div>
                        <p class="loader-message">${message}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(loader);
        } else {
            loader.querySelector('.loader-message').textContent = message;
            loader.style.display = 'block';
        }
    }

    function hideLoading() {
        const loader = document.getElementById('global-loader');
        if (loader) {
            loader.style.display = 'none';
        }
    }

    function updateLoadingMessage(message) {
        const loader = document.getElementById('global-loader');
        if (loader) {
            loader.querySelector('.loader-message').textContent = message;
        }
    }

    // ===== نظام معالجة الأخطاء المتقدم =====
    function logError(context, error, showToUser = true) {
        const timestamp = new Date().toISOString();
        const errorLog = {
            timestamp,
            context,
            error: error.message || error,
            stack: error.stack || 'No stack trace'
        };
        
        console.error('🔴 خطأ في النظام:', errorLog);
        
        // حفظ السجل في localStorage للمراجعة
        try {
            let errorLogs = JSON.parse(localStorage.getItem('systemErrors') || '[]');
            errorLogs.push(errorLog);
            // الاحتفاظ بآخر 50 خطأ فقط
            if (errorLogs.length > 50) errorLogs = errorLogs.slice(-50);
            localStorage.setItem('systemErrors', JSON.stringify(errorLogs));
        } catch (e) {
            console.error('فشل حفظ سجل الأخطاء:', e);
        }
        
        if (showToUser) {
            showNotification(
                '⚠️ حدث خطأ في النظام',
                `${error.message || error}\n\nيرجى المحاولة مرة أخرى أو التواصل مع الدعم الفني.`,
                'error',
                8000
            );
        }
    }

    async function safeAsyncOperation(operation, context, loadingMessage = null) {
        try {
            if (loadingMessage) showLoading(loadingMessage);
            const result = await operation();
            return { success: true, data: result };
        } catch (error) {
            logError(context, error);
            return { success: false, error: error.message || error };
        } finally {
            if (loadingMessage) hideLoading();
        }
    }

    // ===== نظام الإشعارات =====
    function showNotification(title, message, type = 'info', duration = 5000) {
        const container = document.getElementById('notifications-container') || createNotificationContainer();
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        const icons = {
            success: '✅',
            warning: '⚠️',
            error: '❌',
            info: 'ℹ️'
        };
        
        notification.innerHTML = `
            <div class="notification-icon">${icons[type]}</div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <div class="notification-close" onclick="closeNotification(this)">✖</div>
        `;
        
        container.appendChild(notification);
        
        // إزالة تلقائية بعد المدة المحددة
        setTimeout(() => {
            if (notification.parentElement) {
                closeNotification(notification.querySelector('.notification-close'));
            }
        }, duration);
        
        // تسجيل الإشعار
        notifications.push({
            id: Date.now(),
            title,
            message,
            type,
            timestamp: new Date().toISOString()
        });
        
        return notification;
    }

    function createNotificationContainer() {
        const container = document.createElement('div');
        container.id = 'notifications-container';
        document.body.appendChild(container);
        return container;
    }

    function closeNotification(closeButton) {
        const notification = closeButton.closest('.notification');
        notification.classList.add('removing');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }

    function checkLowStock() {
        const lowStockItems = items.filter(item => item.stock <= LOW_STOCK_THRESHOLD && item.stock > 0);
        const outOfStockItems = items.filter(item => item.stock <= 0);
        
        if (outOfStockItems.length > 0) {
            showNotification(
                '🚨 تنبيه: أصناف نفذت',
                `${outOfStockItems.length} صنف نفذ من المخزون. يرجى إعادة التزويد فوراً.`,
                'error',
                8000
            );
        }
        
        if (lowStockItems.length > 0) {
            showNotification(
                '⚠️ تحذير: مخزون منخفض',
                `${lowStockItems.length} صنف على وشك النفاد (أقل من ${LOW_STOCK_THRESHOLD} وحدات).`,
                'warning',
                7000
            );
        }
    }

    function checkUnpaidDebts() {
        const unpaidSales = sales.filter(s => s.remainingAmount > 0);
        const totalDebt = unpaidSales.reduce((sum, s) => sum + s.remainingAmount, 0);
        
        if (unpaidSales.length > 0) {
            showNotification(
                '💰 تذكير: ديون غير مدفوعة',
                `لديك ${unpaidSales.length} فاتورة بإجمالي ${totalDebt.toFixed(2)} ر.س غير مدفوعة.`,
                'warning',
                6000
            );
        }
    }

    // ===== سلة المحذوفات =====
    function moveToTrash(type, item) {
        if (!trashBin[type]) trashBin[type] = [];
        
        const trashItem = {
            ...item,
            deletedAt: new Date().toISOString(),
            deletedBy: JSON.parse(sessionStorage.getItem('loggedInUser'))?.name || 'غير معروف',
            type: type
        };
        
        trashBin[type].push(trashItem);
        saveTrashToLocalStorage();
        
        showNotification(
            '🗑️ تم النقل إلى سلة المحذوفات',
            `تم نقل العنصر إلى سلة المحذوفات. يمكنك استعادته خلال 30 يوماً.`,
            'info',
            4000
        );
        
        // تحديث سلة المحذوفات إذا كانت مفتوحة
        refreshTrashModalIfOpen(type);
        
        return true;
    }

    function restoreFromTrash(type, itemId) {
        const itemIndex = trashBin[type].findIndex(item => item.id === itemId);
        if (itemIndex === -1) return false;
        
        const item = trashBin[type][itemIndex];
        trashBin[type].splice(itemIndex, 1);
        
        // استعادة العنصر إلى المصفوفة الأصلية
        const { deletedAt, deletedBy, type: itemType, ...originalItem } = item;
        
        switch(type) {
            case 'items': items.push(originalItem); break;
            case 'customers': customers.push(originalItem); break;
            case 'suppliers': suppliers.push(originalItem); break;
            case 'purchases': purchases.push(originalItem); break;
            case 'sales': sales.push(originalItem); break;
            case 'expenses': expenses.push(originalItem); break;
            case 'revenues': revenues.push(originalItem); break;
            case 'salaries': salaries.push(originalItem); break;
        }
        
        saveTrashToLocalStorage();
        showNotification(
            '✅ تمت الاستعادة',
            'تم استعادة العنصر بنجاح.',
            'success'
        );
        
        // تحديث سلة المحذوفات إذا كانت مفتوحة
        refreshTrashModalIfOpen(type);
        
        return true;
    }

    async function permanentlyDelete(type, itemId) {
        const confirmed = await showConfirmDialog({
            title: '⚠️ حذف نهائي',
            message: 'هل أنت متأكد من الحذف النهائي؟\n❌ لا يمكن التراجع عن هذه العملية!',
            type: 'danger',
            confirmText: 'نعم، احذف نهائياً',
            cancelText: 'إلغاء',
            icon: '🚫'
        });
        
        if (!confirmed) {
            return false;
        }
        
        const itemIndex = trashBin[type].findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            trashBin[type].splice(itemIndex, 1);
            saveTrashToLocalStorage();
            showNotification(
                '🗑️ تم الحذف نهائياً',
                'تم حذف العنصر بشكل نهائي.',
                'info'
            );
            
            // تحديث سلة المحذوفات إذا كانت مفتوحة
            refreshTrashModalIfOpen(type);
            
            return true;
        }
        return false;
    }

    function saveTrashToLocalStorage() {
        const key = currentActivityId ? `trash_${currentActivityId}` : 'trash_global';
        localStorage.setItem(key, JSON.stringify(trashBin));
    }

    function loadTrashFromLocalStorage() {
        const key = currentActivityId ? `trash_${currentActivityId}` : 'trash_global';
        const saved = localStorage.getItem(key);
        if (saved) {
            trashBin = JSON.parse(saved);
            cleanOldTrashItems();
        }
    }

    function cleanOldTrashItems() {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        Object.keys(trashBin).forEach(type => {
            trashBin[type] = trashBin[type].filter(item => {
                const deletedDate = new Date(item.deletedAt);
                return deletedDate > thirtyDaysAgo;
            });
        });
        
        saveTrashToLocalStorage();
    }

    function getTrashCount() {
        let count = 0;
        Object.keys(trashBin).forEach(type => {
            count += (trashBin[type] || []).length;
        });
        return count;
    }

    function refreshTrashModalIfOpen(type) {
        // التحقق من أن سلة المحذوفات مفتوحة
        const trashModal = document.getElementById('trash-modal');
        if (trashModal && trashModal.classList.contains('active')) {
            // تحديث العدادات
            updateTrashBadge();
            
            // تحديث المحتوى المعروض للنوع الحالي
            // نجد التبويب النشط
            const activeTab = document.querySelector('.trash-tab.active');
            if (activeTab) {
                // نحصل على النوع من onclick attribute
                const onclickAttr = activeTab.getAttribute('onclick');
                const match = onclickAttr.match(/renderTrashItems\('([^']+)'\)/);
                if (match) {
                    const currentType = match[1];
                    renderTrashItems(currentType);
                }
            }
        }
    }

    function showTrashModal() {
        loadTrashFromLocalStorage();
        document.getElementById('trash-modal').classList.add('active');
        renderTrashItems('items');
    }

    function closeTrashModal() {
        document.getElementById('trash-modal').classList.remove('active');
    }

    function renderTrashItems(type) {
        const container = document.getElementById('trash-items-container');
        const items = trashBin[type] || [];
        
        // تحديث الأزرار النشطة
        document.querySelectorAll('.trash-tab').forEach(tab => tab.classList.remove('active'));
        event?.target?.classList.add('active');
        
        if (items.length === 0) {
            container.innerHTML = `
                <div class="trash-empty-state">
                    <i>🗑️</i>
                    <p>لا توجد عناصر محذوفة في هذا القسم</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = items.map(item => {
            // تحديد اسم العنصر بناءً على نوعه
            let displayName = item.name || item.code || 'عنصر';
            if (type === 'purchases' || type === 'sales' || type === 'salesReturns' || type === 'purchaseReturns') {
                displayName = `فاتورة رقم ${item.id} - ${item.date || ''}`;
            }
            
            return `
                <div class="trash-item">
                    <div class="trash-item-info">
                        <div class="trash-item-name">${displayName}</div>
                        <div class="trash-item-meta">
                            حذف بواسطة: ${item.deletedBy} | 
                            ${formatDate(item.deletedAt)}
                        </div>
                    </div>
                    <div class="trash-item-actions">
                        <button class="btn-success btn-sm" onclick="restoreItem('${type}', ${item.id})">
                            ↺ استعادة
                        </button>
                        <button class="btn-danger btn-sm" onclick="deleteItemPermanently('${type}', ${item.id})">
                            🗑️ حذف نهائي
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function restoreItem(type, itemId) {
        if (restoreFromTrash(type, itemId)) {
            // خريطة آمنة بدلاً من eval()
            const dataMap = {
                'items': items,
                'customers': customers,
                'suppliers': suppliers,
                'purchases': purchases,
                'sales': sales,
                'expenses': expenses,
                'revenues': revenues,
                'salesReturns': salesReturns,
                'purchaseReturns': purchaseReturns
            };
            
            await saveToFirebase(type, dataMap[type]);
            renderTrashItems(type);
            updateDashboard();
            
            // تحديث العرض حسب النوع
            switch(type) {
                case 'items': renderItems(); break;
                case 'customers': renderCustomers(); break;
                case 'suppliers': renderSuppliers(); break;
                case 'purchases': renderPurchasesList(); break;
                case 'sales': renderSalesList(); break;
                case 'expenses': renderExpenses(); break;
                case 'revenues': renderRevenues(); break;
                case 'salesReturns': renderSalesReturns(); break;
                case 'purchaseReturns': renderPurchaseReturns(); break;
            }
            
            showNotification('✅ تمت الاستعادة', `تم استعادة ${getTypeNameAr(type)} بنجاح`, 'success');
        }
    }

    function deleteItemPermanently(type, itemId) {
        if (permanentlyDelete(type, itemId)) {
            renderTrashItems(type);
        }
    }

    function emptyTrash(type) {
        if (!confirm(`⚠️ هل أنت متأكد من إفراغ سلة المحذوفات لـ ${getTypeNameAr(type)}؟`)) {
            return;
        }
        
        trashBin[type] = [];
        saveTrashToLocalStorage();
        renderTrashItems(type);
        showNotification(
            '🗑️ تم إفراغ سلة المحذوفات',
            `تم حذف جميع عناصر ${getTypeNameAr(type)} نهائياً.`,
            'success'
        );
    }

    function getTypeNameAr(type) {
        const names = {
            items: 'الأصناف',
            customers: 'العملاء',
            suppliers: 'الموردين',
            purchases: 'المشتريات',
            sales: 'المبيعات',
            expenses: 'المصروفات',
            revenues: 'الإيرادات',
            salesReturns: 'مرتجعات المبيعات',
            purchaseReturns: 'مرتجعات المشتريات',
            salaries: 'الرواتب'
        };
        return names[type] || type;
    }

    function updateTrashBadge() {
        const totalCount = getTrashCount();
        const badge = document.getElementById('trash-count-badge');
        
        if (badge) {
            if (totalCount > 0) {
                badge.textContent = totalCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // تحديث إحصائيات المودال لجميع الأنواع
        ['items', 'customers', 'suppliers', 'purchases', 'sales', 'expenses', 'revenues', 'salesReturns', 'purchaseReturns'].forEach(type => {
            const el = document.getElementById(`trash-count-${type}`);
            if (el) el.textContent = (trashBin[type] || []).length;
        });
        
        const totalEl = document.getElementById('trash-count-total');
        if (totalEl) totalEl.textContent = totalCount;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) return 'اليوم';
        if (diffDays === 1) return 'أمس';
        if (diffDays < 7) return `منذ ${diffDays} أيام`;
        if (diffDays < 30) return `منذ ${Math.floor(diffDays / 7)} أسابيع`;
        return date.toLocaleDateString('ar-SA');
    }

    // ===== نظام الفلترة والترتيب المتقدم =====
    
    /**
     * نظام شامل لفلترة وترتيب البيانات في الجداول
     */
    const FilterSortHelper = {
        // حالة الفلترة الحالية لكل قسم
        currentFilters: {},
        
        // حالة الترتيب الحالية لكل قسم
        currentSort: {},
        
        /**
         * تطبيق الفلترة على مصفوفة من البيانات
         * @param {Array} data - البيانات المراد فلترتها
         * @param {Object} filters - معايير الفلترة
         * @returns {Array} - البيانات المفلترة
         */
        applyFilters(data, filters) {
            if (!data || !Array.isArray(data)) return [];
            
            return data.filter(item => {
                // فلترة النص (البحث العام)
                if (filters.searchText) {
                    const searchLower = filters.searchText.toLowerCase();
                    const matchFound = Object.values(item).some(value => 
                        value && value.toString().toLowerCase().includes(searchLower)
                    );
                    if (!matchFound) return false;
                }
                
                // فلترة حسب التاريخ (من)
                if (filters.dateFrom && item.date) {
                    if (new Date(item.date) < new Date(filters.dateFrom)) return false;
                }
                
                // فلترة حسب التاريخ (إلى)
                if (filters.dateTo && item.date) {
                    if (new Date(item.date) > new Date(filters.dateTo)) return false;
                }
                
                // فلترة حسب السعر (من)
                if (filters.priceFrom !== undefined && filters.priceFrom !== '' && item.price !== undefined) {
                    if (parseFloat(item.price) < parseFloat(filters.priceFrom)) return false;
                }
                
                // فلترة حسب السعر (إلى)
                if (filters.priceTo !== undefined && filters.priceTo !== '' && item.price !== undefined) {
                    if (parseFloat(item.price) > parseFloat(filters.priceTo)) return false;
                }
                
                // فلترة حسب المبلغ (من)
                if (filters.amountFrom !== undefined && filters.amountFrom !== '' && item.total !== undefined) {
                    if (parseFloat(item.total) < parseFloat(filters.amountFrom)) return false;
                }
                
                // فلترة حسب المبلغ (إلى)
                if (filters.amountTo !== undefined && filters.amountTo !== '' && item.total !== undefined) {
                    if (parseFloat(item.total) > parseFloat(filters.amountTo)) return false;
                }
                
                // فلترة حسب الكمية (من)
                if (filters.quantityFrom !== undefined && filters.quantityFrom !== '' && item.quantity !== undefined) {
                    if (parseFloat(item.quantity) < parseFloat(filters.quantityFrom)) return false;
                }
                
                // فلترة حسب الكمية (إلى)
                if (filters.quantityTo !== undefined && filters.quantityTo !== '' && item.quantity !== undefined) {
                    if (parseFloat(item.quantity) > parseFloat(filters.quantityTo)) return false;
                }
                
                // فلترة حسب الحالة/النوع
                if (filters.status && item.status) {
                    if (item.status !== filters.status) return false;
                }
                
                // فلترة حسب الفئة
                if (filters.category && item.category) {
                    if (item.category !== filters.category) return false;
                }
                
                return true;
            });
        },
        
        /**
         * ترتيب البيانات حسب عمود معين
         * @param {Array} data - البيانات المراد ترتيبها
         * @param {String} column - اسم العمود
         * @param {String} direction - اتجاه الترتيب (asc/desc)
         * @returns {Array} - البيانات المرتبة
         */
        sortData(data, column, direction = 'asc') {
            if (!data || !Array.isArray(data)) return [];
            
            const sortedData = [...data].sort((a, b) => {
                let valueA = a[column];
                let valueB = b[column];
                
                // معالجة القيم الفارغة
                if (valueA === null || valueA === undefined) valueA = '';
                if (valueB === null || valueB === undefined) valueB = '';
                
                // التعامل مع الأرقام
                if (!isNaN(valueA) && !isNaN(valueB)) {
                    valueA = parseFloat(valueA);
                    valueB = parseFloat(valueB);
                }
                // التعامل مع التواريخ
                else if (this.isDate(valueA) && this.isDate(valueB)) {
                    valueA = new Date(valueA);
                    valueB = new Date(valueB);
                }
                // التعامل مع النصوص
                else {
                    valueA = valueA.toString().toLowerCase();
                    valueB = valueB.toString().toLowerCase();
                }
                
                if (valueA < valueB) return direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            return sortedData;
        },
        
        /**
         * التحقق من كون القيمة تاريخ
         */
        isDate(value) {
            return value && !isNaN(Date.parse(value)) && /\d{4}-\d{2}-\d{2}/.test(value);
        },
        
        /**
         * إضافة إمكانية الترتيب لرؤوس الأعمدة
         * @param {String} tableId - معرف الجدول
         * @param {String} section - اسم القسم
         * @param {Function} renderCallback - دالة إعادة رسم الجدول
         */
        makeSortable(tableId, section, renderCallback) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const headers = table.querySelectorAll('thead th.sortable');
            headers.forEach((header, index) => {
                header.addEventListener('click', () => {
                    const column = header.getAttribute('data-column');
                    if (!column) return;
                    
                    // تحديد اتجاه الترتيب
                    let direction = 'asc';
                    if (this.currentSort[section]?.column === column) {
                        direction = this.currentSort[section].direction === 'asc' ? 'desc' : 'asc';
                    }
                    
                    // حفظ حالة الترتيب
                    this.currentSort[section] = { column, direction };
                    
                    // تحديث واجهة رؤوس الأعمدة
                    headers.forEach(h => {
                        h.classList.remove('asc', 'desc');
                    });
                    header.classList.add(direction);
                    
                    // إعادة رسم الجدول
                    if (renderCallback) renderCallback();
                });
            });
        },
        
        /**
         * إظهار/إخفاء لوحة الفلترة
         */
        toggleFilters(filterId) {
            const filtersContainer = document.getElementById(filterId);
            if (filtersContainer) {
                filtersContainer.classList.toggle('show');
            }
        },
        
        /**
         * إعادة تعيين الفلاتر
         */
        resetFilters(section, filterId) {
            this.currentFilters[section] = {};
            const filtersContainer = document.getElementById(filterId);
            if (filtersContainer) {
                const inputs = filtersContainer.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
            }
        }
    };
    
    // ===== نظام التحقق من صحة المدخلات (Input Validation) =====
    
    /**
     * مجموعة شاملة من دوال التحقق من صحة المدخلات
     */
    const ValidationHelper = {
        
        // التحقق من أن الحقل ليس فارغاً
        required(value, fieldName = 'هذا الحقل') {
            if (!value || value.toString().trim() === '') {
                return `❌ ${fieldName} مطلوب ولا يمكن تركه فارغاً`;
            }
            return null;
        },
        
        // التحقق من الحد الأدنى للطول
        minLength(value, min, fieldName = 'هذا الحقل') {
            if (value && value.toString().trim().length < min) {
                return `❌ ${fieldName} يجب أن يحتوي على ${min} أحرف على الأقل`;
            }
            return null;
        },
        
        // التحقق من الحد الأقصى للطول
        maxLength(value, max, fieldName = 'هذا الحقل') {
            if (value && value.toString().length > max) {
                return `❌ ${fieldName} يجب ألا يتجاوز ${max} حرفاً`;
            }
            return null;
        },
        
        // التحقق من أن القيمة رقم صحيح
        isNumber(value, fieldName = 'هذا الحقل') {
            if (value !== '' && isNaN(parseFloat(value))) {
                return `❌ ${fieldName} يجب أن يكون رقماً صحيحاً`;
            }
            return null;
        },
        
        // التحقق من أن الرقم موجب
        isPositive(value, fieldName = 'هذا الحقل') {
            const num = parseFloat(value);
            if (!isNaN(num) && num < 0) {
                return `❌ ${fieldName} يجب أن يكون رقماً موجباً`;
            }
            return null;
        },
        
        // التحقق من أن الرقم أكبر من صفر
        isGreaterThanZero(value, fieldName = 'هذا الحقل') {
            const num = parseFloat(value);
            if (!isNaN(num) && num <= 0) {
                return `❌ ${fieldName} يجب أن يكون أكبر من صفر`;
            }
            return null;
        },
        
        // التحقق من أن الرقم ضمن نطاق معين
        inRange(value, min, max, fieldName = 'هذا الحقل') {
            const num = parseFloat(value);
            if (!isNaN(num) && (num < min || num > max)) {
                return `❌ ${fieldName} يجب أن يكون بين ${min} و ${max}`;
            }
            return null;
        },
        
        // التحقق من صحة البريد الإلكتروني
        isEmail(value, fieldName = 'البريد الإلكتروني') {
            if (value && value.trim() !== '') {
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailPattern.test(value)) {
                    return `❌ ${fieldName} غير صحيح (مثال: user@example.com)`;
                }
            }
            return null;
        },
        
        // التحقق من رقم الجوال السعودي
        isSaudiPhone(value, fieldName = 'رقم الجوال') {
            if (value && value.trim() !== '') {
                const phonePattern = /^(05|5)[0-9]{8}$/;
                if (!phonePattern.test(value.replace(/\s/g, ''))) {
                    return `❌ ${fieldName} غير صحيح (يجب أن يبدأ بـ 05 ويتكون من 10 أرقام)`;
                }
            }
            return null;
        },
        
        // التحقق من عدم التكرار في قائمة
        isUnique(value, list, field, fieldName = 'هذا الحقل', excludeId = null) {
            if (value && value.trim() !== '') {
                const exists = list.some(item => {
                    const isDifferentItem = excludeId ? item.id !== excludeId : true;
                    return isDifferentItem && item[field] && 
                           item[field].toString().toLowerCase() === value.toString().toLowerCase();
                });
                
                if (exists) {
                    return `❌ ${fieldName} موجود مسبقاً. الرجاء استخدام قيمة مختلفة`;
                }
            }
            return null;
        },
        
        // التحقق من صحة التاريخ
        isValidDate(value, fieldName = 'التاريخ') {
            if (value && value.trim() !== '') {
                const date = new Date(value);
                if (isNaN(date.getTime())) {
                    return `❌ ${fieldName} غير صحيح`;
                }
            }
            return null;
        },
        
        // التحقق من أن التاريخ ليس في المستقبل
        notFutureDate(value, fieldName = 'التاريخ') {
            if (value && value.trim() !== '') {
                const date = new Date(value);
                const today = new Date();
                today.setHours(23, 59, 59, 999);
                
                if (date > today) {
                    return `❌ ${fieldName} لا يمكن أن يكون في المستقبل`;
                }
            }
            return null;
        }
    };
    
    /**
     * دالة عامة للتحقق من صحة نموذج
     * @param {Object} validations - كائن يحتوي على الحقول وقواعد التحقق
     * @returns {Object} - { isValid: boolean, errors: Array }
     */
    function validateForm(validations) {
        const errors = [];
        
        for (const [fieldId, rules] of Object.entries(validations)) {
            const element = document.getElementById(fieldId);
            if (!element) continue;
            
            const value = element.value;
            let hasError = false;
            
            // تطبيق كل قاعدة تحقق
            for (const rule of rules) {
                const error = rule.validator(value);
                if (error) {
                    errors.push({
                        fieldId,
                        element,
                        message: error
                    });
                    hasError = true;
                    break; // إيقاف عند أول خطأ لكل حقل
                }
            }
            
            // تلوين الحقل حسب الحالة
            if (hasError) {
                element.classList.add('input-error');
                element.classList.remove('input-success');
            } else if (value && value.trim() !== '') {
                element.classList.add('input-success');
                element.classList.remove('input-error');
            } else {
                element.classList.remove('input-error', 'input-success');
            }
        }
        
        return {
            isValid: errors.length === 0,
            errors
        };
    }
    
    /**
     * عرض أخطاء التحقق للمستخدم
     */
    function displayValidationErrors(errors) {
        if (errors.length === 0) return;
        
        // التركيز على أول حقل خاطئ
        if (errors[0].element) {
            errors[0].element.focus();
            errors[0].element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // عرض الأخطاء في إشعار
        const errorMessages = errors.map(e => e.message).join('\n');
        showNotification(
            '⚠️ يرجى تصحيح الأخطاء التالية',
            errorMessages,
            'error',
            6000
        );
    }
    
    /**
     * إزالة التنسيق من جميع الحقول
     */
    function clearValidationStyles() {
        document.querySelectorAll('.input-error, .input-success').forEach(el => {
            el.classList.remove('input-error', 'input-success');
        });
    }

    // ===== نظام الحوار الاحترافي (Professional Confirm Dialog) =====
    
    /**
     * عرض حوار تأكيد احترافي بدلاً من confirm() العادي
     * @param {Object} options - خيارات الحوار
     * @param {string} options.title - عنوان الحوار
     * @param {string} options.message - نص الرسالة
     * @param {string} options.type - نوع الحوار (warning, danger, info, success)
     * @param {string} options.confirmText - نص زر التأكيد
     * @param {string} options.cancelText - نص زر الإلغاء
     * @param {string} options.icon - أيقونة الحوار
     * @returns {Promise<boolean>} - true إذا تم التأكيد، false إذا تم الإلغاء
     */
    function showConfirmDialog(options = {}) {
        return new Promise((resolve) => {
            const {
                title = 'تأكيد العملية',
                message = 'هل أنت متأكد من رغبتك في تنفيذ هذه العملية؟',
                type = 'warning', // warning, danger, info, success
                confirmText = 'تأكيد',
                cancelText = 'إلغاء',
                icon = null
            } = options;
            
            // الحصول على عناصر الحوار
            const overlay = document.getElementById('confirm-overlay');
            const header = document.getElementById('confirm-header');
            const iconEl = document.getElementById('confirm-icon');
            const titleEl = document.getElementById('confirm-title');
            const bodyEl = document.getElementById('confirm-body');
            const confirmBtn = document.getElementById('confirm-btn-confirm');
            const cancelBtn = document.getElementById('confirm-btn-cancel');
            
            // تحديد الأيقونة حسب النوع
            const icons = {
                warning: '⚠️',
                danger: '❌',
                info: 'ℹ️',
                success: '✅'
            };
            
            // تعيين المحتوى
            iconEl.textContent = icon || icons[type] || '⚠️';
            titleEl.textContent = title;
            bodyEl.textContent = message;
            confirmBtn.textContent = confirmText;
            cancelBtn.textContent = cancelText;
            
            // تعيين الفئات
            header.className = `confirm-header ${type}`;
            confirmBtn.className = `confirm-btn-confirm ${type === 'danger' ? 'danger' : type === 'success' ? 'success' : ''}`;
            
            // عرض الحوار
            overlay.classList.add('active');
            
            // معالجات الأحداث
            const handleConfirm = () => {
                overlay.classList.remove('active');
                cleanup();
                resolve(true);
            };
            
            const handleCancel = () => {
                overlay.classList.remove('active');
                cleanup();
                resolve(false);
            };
            
            const handleOverlayClick = (e) => {
                if (e.target === overlay) {
                    handleCancel();
                }
            };
            
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    handleCancel();
                }
            };
            
            const cleanup = () => {
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
                overlay.removeEventListener('click', handleOverlayClick);
                document.removeEventListener('keydown', handleEscape);
            };
            
            // إضافة المعالجات
            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
            overlay.addEventListener('click', handleOverlayClick);
            document.addEventListener('keydown', handleEscape);
        });
    }
    
    // ===== نهاية نظام الحوار الاحترافي =====

        // === دوال Firebase المحسّنة مع معالجة الأخطاء ===
        async function firebaseSet(key, data) {
            try {
                await database.ref(key).set(data);
                return true;
            } catch (error) {
                logError('Firebase Set', error, false);
                console.error('Firebase set error:', error);
                return false;
            }
        }

        async function firebaseGet(key) {
            try {
                const snapshot = await database.ref(key).once('value');
                return snapshot.val();
            } catch (error) {
                logError('Firebase Get', error, false);
                console.error('Firebase get error:', error);
                return null;
            }
        }

        async function firebaseRemove(key) {
            try {
                await database.ref(key).remove();
                return true;
            } catch (error) {
                logError('Firebase Remove', error, false);
                console.error('Firebase remove error:', error);
                return false;
            }
        }

        async function saveToFirebase(key, data) {
            if (!currentActivityId) return false;

            try {
                const sharedKey = `${FIREBASE_SHARED_ROOT}/${currentActivityId}/${key}`;
                const sharedSaved = await firebaseSet(sharedKey, data);

                const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                if (sharedSaved && currentUser && currentUser.email) {
                    const legacyKey = `users/${currentUser.email.replace('.', '_')}/activities/${currentActivityId}/${key}`;
                    await firebaseSet(legacyKey, data);
                }

                return sharedSaved;
            } catch (error) {
                logError('Save to Firebase', error);
                return false;
            }
        }

        async function loadFromFirebase(key) {
            if (!currentActivityId) return null;

            const sharedKey = `${FIREBASE_SHARED_ROOT}/${currentActivityId}/${key}`;
            let data = await firebaseGet(sharedKey);
            if (data !== null && data !== undefined) {
                return data;
            }

            const legacyEmails = [];
            const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (currentUser && currentUser.email) {
                legacyEmails.push(currentUser.email);
            }
            if (Array.isArray(users)) {
                users.forEach(u => {
                    if (u.email && !legacyEmails.includes(u.email)) {
                        legacyEmails.push(u.email);
                    }
                });
            }

            for (const email of legacyEmails) {
                const legacyKey = `users/${email.replace('.', '_')}/activities/${currentActivityId}/${key}`;
                data = await firebaseGet(legacyKey);
                if (data !== null && data !== undefined) {
                    await firebaseSet(sharedKey, data);
                    return data;
                }
            }

            return null;
        }

        async function removeFromFirebase(key) {
            if (!currentActivityId) return false;

            const sharedKey = `${FIREBASE_SHARED_ROOT}/${currentActivityId}/${key}`;
            const sharedRemoved = await firebaseRemove(sharedKey);

            const legacyResults = [];
            if (Array.isArray(users)) {
                for (const user of users) {
                    if (user.email) {
                        const legacyKey = `users/${user.email.replace('.', '_')}/activities/${currentActivityId}/${key}`;
                        const result = await firebaseRemove(legacyKey);
                        legacyResults.push(result);
                    }
                }
            }

            if (legacyResults.length === 0) {
                return sharedRemoved;
            }

            return sharedRemoved && legacyResults.every(r => r !== false);
        }

        // === دوال التخزين المعدلة ===
        async function saveActivities() {
            const success = await firebaseSet('diwan_activities', activities);
            if (success) {
                loadActivities();
            }
        }

        async function saveUsers() {
            await firebaseSet('diwan_users', users);
        }

        async function loadUsers() {
            users = (await firebaseGet('diwan_users')) || [];
            if (users.length === 0) {
                users.push({ id: 1, name: 'مدير النظام', email: 'msafr3972@gmail.com', phone: '', password: 'A711858322', role: 'admin', activityId: null });
                await saveUsers();
            }
        }

        // === دوال تخصيص الواجهة ===
        function toggleControlPanel() {
            const panel = document.getElementById('controlPanel');
            panel.classList.toggle('show');
        }

        function updateFontSize(size) {
            document.documentElement.style.setProperty('--font-size', size + 'px');
            document.getElementById('font-size-value').textContent = size + 'px';
        }

        function updateColor(variable, color) {
            document.documentElement.style.setProperty(variable, color);
        }

        function updateFontFamily(font) {
            document.documentElement.style.setProperty('--font-family', font);
        }

        function resetDesign() {
            document.documentElement.style.setProperty('--primary-color', '#2c5aa0');
            document.documentElement.style.setProperty('--bg-color', '#ecf0f1');
            document.documentElement.style.setProperty('--text-color', '#2c3e50');
            document.documentElement.style.setProperty('--font-size', '16px');
            document.documentElement.style.setProperty('--font-family', "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif");
            
            document.querySelector('input[type="range"]').value = 16;
            document.getElementById('font-size-value').textContent = '16px';
            document.querySelector('input[value="#2c5aa0"]').value = '#2c5aa0';
            document.querySelector('input[value="#ecf0f1"]').value = '#ecf0f1';
            document.querySelector('input[value="#2c3e50"]').value = '#2c3e50';
            document.getElementById('fontFamilySelect').value = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        }

        // === تبديل القائمة الجانبية للهواتف ===
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        function updateAccountInfoSection(user) {
            const nameEl = document.getElementById('accountInfoName');
            const emailEl = document.getElementById('accountInfoEmail');
            const phoneEl = document.getElementById('accountInfoPhone');
            const roleEl = document.getElementById('accountInfoRole');
            const activityEl = document.getElementById('accountInfoActivity');
            const changeActivityAccountBtn = document.getElementById('accountInfoChangeActivityBtn');
            const editAccountBtn = document.getElementById('accountInfoEditBtn');

            const fallbackText = 'غير متوفر';
            const fallbackActivity = 'لم يتم تحديد نشاط';
            if (nameEl) {
                const hasName = user && user.name && user.name.trim();
                nameEl.textContent = hasName ? user.name : (user && user.email ? user.email : fallbackText);
            }
            if (emailEl) {
                emailEl.textContent = user && user.email ? user.email : fallbackText;
            }
            if (phoneEl) {
                const hasPhone = user && user.phone && user.phone.trim();
                phoneEl.textContent = hasPhone ? user.phone : fallbackText;
            }
            if (roleEl) {
                if (user && user.role) {
                    const roleNames = { admin: 'مدير النظام', manager: 'مدير نشاط', user: 'مستخدم' };
                    roleEl.textContent = roleNames[user.role] || 'دور غير معروف';
                } else {
                    roleEl.textContent = fallbackText;
                }
            }
            if (activityEl) {
                let activityName = fallbackActivity;
                if (currentActivityId) {
                    const activity = activities.find(a => a.id == currentActivityId);
                    activityName = activity ? activity.name : 'نشاط غير معروف';
                }
                activityEl.textContent = activityName;
            }
            if (changeActivityAccountBtn) {
                const showChange = (user && user.role === 'admin');
                changeActivityAccountBtn.style.display = showChange ? 'block' : 'none';
                if (changeActivityAccountBtn.parentElement) {
                    changeActivityAccountBtn.parentElement.style.display = showChange ? 'flex' : 'none';
                }
            }
            if (editAccountBtn) {
                const showEdit = Boolean(user);
                editAccountBtn.style.display = showEdit ? 'block' : 'none';
                if (editAccountBtn.parentElement) {
                    editAccountBtn.parentElement.style.display = showEdit ? 'flex' : 'none';
                }
            }
        }

        function updateSidebar(role) {
            const sidebarNav = document.getElementById('sidebarNav');
            if (!sidebarNav) return;

            // Refreshes the navigation menu according to the signed-in role.
            const baseSections = [
                { id: 'home', label: '🏠 الرئيسية' },
                { id: 'advanced-dashboard', label: '📊 لوحة التحكم المتقدمة' },
                { id: 'items', label: '📦 إدارة الأصناف' },
                { id: 'customers', label: '👥 إدارة العملاء' },
                { id: 'suppliers', label: '🏢 إدارة الموردين' },
                { id: 'purchases', label: '🛒 فواتير المشتريات' },
                { id: 'sales', label: '💰 فواتير المبيعات' },
                { id: 'returns', label: '↩️ إدارة المرتجعات' },
                { id: 'expenses', label: '💸 إدارة المصروفات' },
                { id: 'revenues', label: '💰 إدارة الإيرادات' },
                { id: 'sadaqa', label: '🤲 حساب الصدقة' },
                { id: 'salaries', label: '💼 إدارة الرواتب' },
                { id: 'reports', label: '📑 التقارير' },
                { id: 'settings', label: '⚙️ الإعدادات والنظام' }
            ];

            let sectionsToRender;
            if (role === 'admin') {
                sectionsToRender = baseSections;
            } else if (role === 'manager') {
                sectionsToRender = baseSections.filter(section => section.id !== 'advanced-dashboard');
            } else if (role === 'user') {
                sectionsToRender = baseSections.filter(section => !['advanced-dashboard', 'settings', 'salaries'].includes(section.id));
            } else {
                sectionsToRender = baseSections.filter(section => !['advanced-dashboard', 'salaries'].includes(section.id));
            }

            sidebarNav.innerHTML = '';
            sectionsToRender.forEach(section => {
                const button = document.createElement('button');
                button.textContent = section.label;
                button.setAttribute('onclick', `showSection('${section.id}')`);
                sidebarNav.appendChild(button);
            });
            // إضافة قسم الصدقة إذا لم يكن موجوداً
            if (!document.getElementById('sadaqa')) {
                const container = document.querySelector('.container');
                if (container) {
                    const sadaqaSection = document.createElement('div');
                    sadaqaSection.id = 'sadaqa';
                    sadaqaSection.className = 'section';
                    sadaqaSection.innerHTML = `
                        <h2>🤲 حساب الصدقة</h2>
                        <div class="form-grid grid-3">
                            <input type="number" id="sadaqaAmount" placeholder="المبلغ (ريال) *" min="1" required>
                            <input type="date" id="sadaqaDate" required>
                            <input type="text" id="sadaqaDesc" placeholder="وصف أو اسم المستفيد">
                            <button class="btn-primary btn-add" onclick="addSadaqa()">➕ إضافة صدقة</button>
                        </div>
                        <div id="sadaqaList" style="margin-top:2em;"></div>
                        <div id="sadaqaTotal" style="margin-top:1em; font-weight:bold;"></div>
                    `;
                    container.appendChild(sadaqaSection);
                    // عرض السجلات مباشرة بعد إنشاء القسم
                    setTimeout(() => { window.renderSadaqaList(); }, 0);
                }
            }
            // دوال الصدقة
            window.addSadaqa = function() {
                const amount = parseFloat(document.getElementById('sadaqaAmount').value);
                const date = document.getElementById('sadaqaDate').value;
                const desc = document.getElementById('sadaqaDesc').value;
                if (!amount || !date) {
                    showNotification('⚠️ خطأ', 'يرجى إدخال المبلغ والتاريخ', 'error');
                    return;
                }
                const sadaqat = JSON.parse(localStorage.getItem('sadaqat') || '[]');
                sadaqat.push({ amount, date, desc });
                localStorage.setItem('sadaqat', JSON.stringify(sadaqat));
                document.getElementById('sadaqaAmount').value = '';
                document.getElementById('sadaqaDate').value = '';
                document.getElementById('sadaqaDesc').value = '';
                renderSadaqaList();
            };
            window.renderSadaqaList = function() {
                const sadaqat = JSON.parse(localStorage.getItem('sadaqat') || '[]');
                let html = '<table border="1" style="width:100%;text-align:center"><tr><th>المبلغ</th><th>التاريخ</th><th>الوصف</th><th style="text-align:left">إجراءات</th></tr>';
                let total = 0;
                sadaqat.forEach((s, i) => {
                    html += `<tr>
                        <td>${s.amount}</td>
                        <td>${s.date}</td>
                        <td>${s.desc || ''}</td>
                        <td style='text-align:left'>
                            <div class='action-buttons' style='justify-content: flex-start;'>
                                <button class='btn-warning edit-btn' onclick="editSadaqa(${i})">✏️ تعديل</button>
                                <button class='btn-danger' onclick="deleteSadaqa(${i})">حذف</button>
                            </div>
                        </td>
                    </tr>`;
                    total += s.amount;
                });
                html += '</table>';
                document.getElementById('sadaqaList').innerHTML = html;
                document.getElementById('sadaqaTotal').innerText = 'إجمالي الصدقات: ' + total + ' ريال';
            };
            // حذف سجل صدقة
            window.deleteSadaqa = function(idx) {
                const sadaqat = JSON.parse(localStorage.getItem('sadaqat') || '[]');
                if (confirm('هل أنت متأكد من حذف هذا السجل؟')) {
                    sadaqat.splice(idx, 1);
                    localStorage.setItem('sadaqat', JSON.stringify(sadaqat));
                    renderSadaqaList();
                }
            };
            // تعديل سجل صدقة
            window.editSadaqa = function(idx) {
                const sadaqat = JSON.parse(localStorage.getItem('sadaqat') || '[]');
                const s = sadaqat[idx];
                document.getElementById('sadaqaAmount').value = s.amount;
                document.getElementById('sadaqaDate').value = s.date;
                document.getElementById('sadaqaDesc').value = s.desc;
                // عند الحفظ، نستبدل السجل القديم
                window._sadaqaEditIdx = idx;
                const btn = document.querySelector('#sadaqa .btn-add');
                if (btn) {
                    btn.textContent = '💾 حفظ التعديل';
                    btn.onclick = function() {
                        const amount = parseFloat(document.getElementById('sadaqaAmount').value);
                        const date = document.getElementById('sadaqaDate').value;
                        const desc = document.getElementById('sadaqaDesc').value;
                        if (!amount || !date) {
                            showNotification('⚠️ خطأ', 'يرجى إدخال المبلغ والتاريخ', 'error');
                            return;
                        }
                        sadaqat[idx] = { amount, date, desc };
                        localStorage.setItem('sadaqat', JSON.stringify(sadaqat));
                        renderSadaqaList();
                        document.getElementById('sadaqaAmount').value = '';
                        document.getElementById('sadaqaDate').value = '';
                        document.getElementById('sadaqaDesc').value = '';
                        btn.textContent = '➕ إضافة صدقة';
                        btn.onclick = addSadaqa;
                        window._sadaqaEditIdx = null;
                    };
                }
            };
            // عرض السجلات عند فتح القسم
            if (!window._sadaqaListLoaded) {
                document.addEventListener('DOMContentLoaded', window.renderSadaqaList);
                window._sadaqaListLoaded = true;
            }

            const activeSection = document.querySelector('.section.active');
            if (activeSection) {
                const activeButton = sidebarNav.querySelector(`button[onclick="showSection('${activeSection.id}')"]`);
                if (activeButton) {
                    activeButton.classList.add('active');
                }
            }
        }

        function updateLoggedInUserDisplay(user) {
            const userEl = document.getElementById('currentUserDisplay');
            if (userEl) {
                if (user) {
                    const displayName = (user.name && user.name.trim()) ? user.name : user.email || 'مستخدم';
                    const roleInfo = {
                        admin: { label: '🔑 مدير النظام', cls: 'role-admin' },
                        manager: { label: '🧭 مدير نشاط', cls: 'role-manager' },
                        user: { label: '👨‍💼 مستخدم', cls: 'role-user' }
                    };
                    const currentRole = roleInfo[user.role] || { label: 'دور غير معروف', cls: '' };
                    userEl.innerHTML = `<span class="user-name">👤 ${displayName}</span><span class="user-description">${currentRole.label}</span>`;
                    userEl.classList.remove('role-admin', 'role-manager', 'role-user');
                    if (currentRole.cls) {
                        userEl.classList.add(currentRole.cls);
                    }
                } else {
                    userEl.innerHTML = '<span class="user-name">لم يتم تسجيل الدخول</span><span class="user-description">يرجى تسجيل الدخول لمتابعة العمل</span>';
                    userEl.classList.remove('role-admin', 'role-manager', 'role-user');
                }
            }

            updateAccountInfoSection(user);
        }

        // === دوال التطبيق الأساسية ===
        async function showSection(sectionId) {
            if (editingSaleId || editingPurchaseId) {
                if (!confirm('لديك فاتورة قيد التعديل، هل تريد إلغاء التعديلات والانتقال؟')) {
                    return;
                }
                resetInvoiceForms();
            }

            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.querySelectorAll('.sidebar-nav button').forEach(button => button.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            const activeButton = Array.from(document.querySelectorAll('.sidebar-nav button')).find(
                btn => btn.getAttribute('onclick') === `showSection('${sectionId}')`
            );
            if(activeButton) activeButton.classList.add('active');

            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
            
            // Update mini stats based on section
            if (sectionId === 'items') {
                const miniStatItemsEl = document.getElementById('miniStatItems');
                if (miniStatItemsEl) miniStatItemsEl.textContent = items.length;
                renderItems();
                generateItemCode(); // توليد الكود تلقائياً عند فتح صفحة الأصناف
            }
            else if (sectionId === 'customers') {
                const miniStatCustomersEl = document.getElementById('miniStatCustomers');
                if (miniStatCustomersEl) miniStatCustomersEl.textContent = customers.length;
                renderCustomers();
                generateCustomerCode(); // توليد الكود تلقائياً عند فتح صفحة العملاء
            }
            else if (sectionId === 'suppliers') {
                const miniStatSuppliersEl = document.getElementById('miniStatSuppliers');
                if (miniStatSuppliersEl) miniStatSuppliersEl.textContent = suppliers.length;
                renderSuppliers();
                generateSupplierCode(); // توليد الكود تلقائياً عند فتح صفحة الموردين
            }
            else if (sectionId === 'purchases') {
                const miniStatPurchasesEl = document.getElementById('miniStatPurchases');
                if (miniStatPurchasesEl) miniStatPurchasesEl.textContent = purchases.length;
                updatePurchaseDropdowns();
                generatePurchaseCode(); // توليد كود المشتريات تلقائياً
                const purchaseDateEl = document.getElementById('purchaseDate');
                if (purchaseDateEl) purchaseDateEl.value = new Date().toISOString().split('T')[0];
            }
            else if (sectionId === 'sales') {
                const miniStatSalesEl = document.getElementById('miniStatSales');
                if (miniStatSalesEl) miniStatSalesEl.textContent = sales.length;
                updateSaleDropdowns();
                generateSaleCode(); // توليد كود المبيعات تلقائياً
                const saleDateEl = document.getElementById('saleDate');
                if (saleDateEl) saleDateEl.value = new Date().toISOString().split('T')[0];
            }
            else if (sectionId === 'expenses') {
                const miniStatExpensesEl = document.getElementById('miniStatExpenses');
                if (miniStatExpensesEl) miniStatExpensesEl.textContent = expenses.length;
                updateExpenseStats();
                renderExpenses();
                const expenseDateEl = document.getElementById('expenseDate');
                if (expenseDateEl) expenseDateEl.value = new Date().toISOString().split('T')[0];
            } else if (sectionId === 'revenues') {
                const miniStatRevenuesEl = document.getElementById('miniStatRevenues');
                if (miniStatRevenuesEl) miniStatRevenuesEl.textContent = revenues.length;
                updateRevenueStats();
                renderRevenues();
                const revenueDateEl = document.getElementById('revenueDate');
                if (revenueDateEl) revenueDateEl.value = new Date().toISOString().split('T')[0];
            } else if (sectionId === 'salaries') {
                renderSalaries();
                updateSalarySummary();
            }
            else if (sectionId === 'advanced-dashboard') initAdvancedDashboard();
            else if (sectionId === 'returns') showReturnTab('sales');
            else if (sectionId === 'settings') {
                const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                updateLoggedInUserDisplay(loggedInUser);

                // Show/hide admin sections
                const userRole = loggedInUser ? loggedInUser.role : null;
                const isAdmin = userRole === 'admin';
                const isManager = userRole === 'manager';
                
                debugLog('⚙️ فتح صفحة الإعدادات - الدور:', userRole, 'مدير نشاط؟', isManager);
                
                const userMgmt = document.getElementById('userManagementSection');
                const activityMgmt = document.getElementById('activityManagementSection');
                const activityLogoSection = document.getElementById('activityLogoSection');
                const programLogoSection = document.getElementById('programLogoSection');
                
                debugLog('🔍 عنصر قسم شعار النشاط:', activityLogoSection ? 'موجود' : 'غير موجود');
                
                if (userMgmt) {
                    userMgmt.style.display = (isAdmin || isManager) ? 'block' : 'none';
                }
                if (activityMgmt) {
                    activityMgmt.style.display = isAdmin ? 'block' : 'none';
                }
                if (activityLogoSection) {
                    activityLogoSection.style.display = (isAdmin || isManager) ? 'block' : 'none';
                    debugLog('✅ تم ضبط عرض قسم شعار النشاط:', (isAdmin || isManager) ? 'مرئي' : 'مخفي');
                }
                if (programLogoSection) {
                    programLogoSection.style.display = isAdmin ? 'block' : 'none';
                    debugLog('✅ تم ضبط عرض قسم شعار البرنامج:', isAdmin ? 'مرئي (مدير نظام فقط)' : 'مخفي');
                }
                
                updateDataStats();
                renderActivitiesInSettings();
                renderUsersInSettings();
                loadEmailJsSettings();
                loadActivityLogo();
            } else if (sectionId === 'account-info') {
                const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                updateAccountInfoSection(loggedInUser);
            } else if (sectionId === 'reports') {
                updateReportItemFilter();
                changeReportType();
            }
        }
        
        // ===== Activity and Header Functions =====
        function updateHeaderForActivity(activity) {
            if (activity) {
                document.getElementById('activityHeaderTitle').textContent = activity.name;
                document.getElementById('activityHeaderSubtitle').style.display = 'none';
                
                // Load activity logo
                loadActivityLogo();
            } else {
                document.getElementById('activityHeaderTitle').textContent = 'ديواني';
                document.getElementById('activityHeaderSubtitle').style.display = 'block';
                
                // Hide activity logo
                const headerLogo = document.getElementById('activityHeaderLogo');
                if (headerLogo) headerLogo.style.display = 'none';
            }

            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            updateAccountInfoSection(loggedInUser);
        }
        
        function getActivityDataKey(baseKey) {
            if (!currentActivityId) return null;
            return `activity_${currentActivityId}_${baseKey}`;
        }
        
        async function loadActivities() {
            activities = (await firebaseGet('diwan_activities')) || [];
            const activitySelect = document.getElementById('userActivitySelect');
            if (activitySelect) {
                activitySelect.innerHTML = '<option value="">-- اختر النشاط التجاري أولاً --</option>';
                activities.forEach(act => {
                    activitySelect.innerHTML += `<option value="${act.id}">${act.name}</option>`;
                });
            }
        }

        async function saveActivities() {
            const success = await firebaseSet('diwan_activities', activities);
            if (success) {
                loadActivities();
            }
        }
        
        function showActivityModal() {
            document.getElementById('activity-overlay').style.display = 'flex';
            document.querySelector('.app-container').style.display = 'none';
            renderActivitiesInModal();
        }
        
        function renderActivitiesInModal() {
            const listDiv = document.getElementById('activity-list');
            listDiv.innerHTML = '';
            if (activities.length === 0) {
                listDiv.innerHTML = '<p>لم تقم بإنشاء أي نشاط بعد. قم بإنشاء واحد للبدء.</p>';
            } else {
                activities.forEach(activity => {
                    const button = document.createElement('button');
                    button.className = 'btn-primary activity-btn';
                    button.textContent = activity.name;
                    button.onclick = () => selectActivity(activity.id);
                    listDiv.appendChild(button);
                });
            }
        }
        
        async function addNewActivity(fromSettings = false) {
            const inputId = fromSettings ? 'settingNewActivityName' : 'newActivityName';
            const activityName = document.getElementById(inputId).value.trim();
            if (!activityName) {
                showNotification('⚠️ اسم مطلوب', 'يرجى إدخال اسم للنشاط', 'warning');
                return;
            }

            const newActivity = {
                id: Date.now(),
                name: activityName
            };
            activities.push(newActivity);
            await saveActivities();
            document.getElementById(inputId).value = '';

            if (fromSettings) {
                renderActivitiesInSettings();
            } else {
                selectActivity(newActivity.id);
            }
        }
        
        async function selectActivity(id) {
            showLoading('جاري تحميل بيانات النشاط...');
            
            try {
                currentActivityId = id;
                sessionStorage.setItem('currentActivityId', id);
                const activity = activities.find(a => a.id == id);
                
                // حفظ بيانات النشاط الحالي في sessionStorage للاستخدام في رفع الشعار
                if (activity) {
                    sessionStorage.setItem('currentActivity', JSON.stringify(activity));
                }
                
                updateHeaderForActivity(activity);
                document.getElementById('activity-overlay').style.display = 'none';
                document.querySelector('.app-container').style.display = 'flex';
                
                // تحديث القائمة الجانبية بعد اختيار النشاط
                const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
                if (user) {
                    updateSidebar(user.role);
                }

                await initializeApp();
                hideLoading();
            } catch (error) {
                hideLoading();
                logError('Select Activity', error);
            }
        }
        
        function renderActivitiesInSettings() {
            const dropdown = document.getElementById('activitiesDropdown');
            if (!dropdown) return;

            const previousSelection = dropdown.value;
            dropdown.innerHTML = '<option value="">اختر نشاطًا</option>';

            activities.forEach(activity => {
                const option = document.createElement('option');
                option.value = activity.id;
                option.textContent = activity.name;
                dropdown.appendChild(option);
            });

            if (previousSelection && activities.some(a => String(a.id) === previousSelection)) {
                dropdown.value = previousSelection;
            } else {
                dropdown.value = '';
            }

            handleActivitySelection();
        }

        function handleActivitySelection() {
            const dropdown = document.getElementById('activitiesDropdown');
            const infoBox = document.getElementById('selectedActivityInfo');
            const nameInput = document.getElementById('selectedActivityName');
            const editBtn = document.getElementById('editSelectedActivityBtn');
            const deleteBtn = document.getElementById('deleteSelectedActivityBtn');

            if (!dropdown) return;

            const selectedId = dropdown.value;
            const activity = activities.find(a => String(a.id) === selectedId);

            if (!activity) {
                if (infoBox) infoBox.style.display = 'none';
                if (nameInput) nameInput.value = '';
                if (editBtn) editBtn.disabled = true;
                if (deleteBtn) deleteBtn.disabled = true;
                return;
            }

            if (infoBox) infoBox.style.display = 'flex';
            if (nameInput) nameInput.value = activity.name;
            if (editBtn) editBtn.disabled = false;
            if (deleteBtn) deleteBtn.disabled = false;
        }

        function handleEditSelectedActivity() {
            const dropdown = document.getElementById('activitiesDropdown');
            if (!dropdown || !dropdown.value) {
                showNotification('⚠️ لم يتم الاختيار', 'يرجى اختيار نشاط من القائمة', 'warning');
                return;
            }
            const activityId = Number(dropdown.value);
            if (!Number.isNaN(activityId)) {
                editActivity(activityId);
            }
        }

        function handleDeleteSelectedActivity() {
            const dropdown = document.getElementById('activitiesDropdown');
            if (!dropdown || !dropdown.value) {
                showNotification('⚠️ لم يتم الاختيار', 'يرجى اختيار نشاط من القائمة', 'warning');
                return;
            }
            const activityId = Number(dropdown.value);
            if (!Number.isNaN(activityId)) {
                deleteActivity(activityId);
            }
        }

        async function editActivity(id) {
            const activityIndex = activities.findIndex(a => a.id === id);
            if (activityIndex === -1) return;

            const currentName = activities[activityIndex].name;
            const newName = prompt("أدخل الاسم الجديد للنشاط:", currentName);

            if (newName && newName.trim() !== "" && newName.trim() !== currentName) {
                activities[activityIndex].name = newName.trim();
                await saveActivities();
                renderActivitiesInSettings();
                
                if (currentActivityId == id) {
                    updateHeaderForActivity(activities[activityIndex]);
                }
                showNotification('✅ تم التحديث', 'تم تحديث اسم النشاط بنجاح', 'success');
            }
        }
        
        async function deleteActivity(id) {
            if (id == currentActivityId) {
                showNotification('⚠️ غير مسموح', 'لا يمكنك حذف النشاط المفتوح حالياً. يرجى تغيير النشاط أولاً', 'warning');
                return;
            }
            const activity = activities.find(a => a.id === id);
            const confirmed = await showConfirmDialog(
                'حذف النشاط نهائياً',
                `هل أنت متأكد من حذف نشاط "${activity.name}"؟ سيتم حذف جميع بياناته نهائياً.`,
                'danger',
                'حذف نهائياً',
                'إلغاء'
            );
            if (confirmed) {
                const dataKeys = ['items', 'customers', 'suppliers', 'purchases', 'sales', 'salesReturns', 'purchaseReturns', 'expenses', 'revenues', 'lastBackup'];
                for (const key of dataKeys) {
                    await removeFromFirebase(key);
                }
                activities = activities.filter(a => a.id !== id);
                await saveActivities();
                renderActivitiesInSettings();
            }
        }

        // ===== Search Functions =====
        function searchItems() {
            const searchTerm = document.getElementById('searchItems').value.toLowerCase();
            const filteredItems = items.filter(item => 
                item.name.toLowerCase().includes(searchTerm) || 
                item.code.toLowerCase().includes(searchTerm)
            );
            renderFilteredItems(filteredItems);
        }

        function renderFilteredItems(filteredItems) {
            const tbody = document.getElementById('itemsList');
            tbody.innerHTML = '';
            if (filteredItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد أصناف تطابق البحث</td></tr>';
                return;
            }
            filteredItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="الكود">${item.code}</td>
                    <td data-label="الاسم">${item.name}</td>
                    <td data-label="سعر الشراء">${item.cost}</td>
                    <td data-label="سعر البيع">${item.price}</td>
                    <td data-label="الرصيد">${item.stock}</td>
                    <td data-label="الإجراءات">
                     <div class="action-buttons">
                        <button class="btn-warning edit-btn" onclick="editItem(${item.id})">✏️ تعديل</button>
                        <button class="btn-danger" onclick="deleteItem(${item.id})">حذف</button>
                    </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function searchCustomers() {
            const searchTerm = document.getElementById('searchCustomers').value.toLowerCase();
            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) || 
                customer.code.toLowerCase().includes(searchTerm) ||
                (customer.phone && customer.phone.toLowerCase().includes(searchTerm))
            );
            renderFilteredCustomers(filteredCustomers);
        }

        function renderFilteredCustomers(filteredCustomers) {
            const tbody = document.getElementById('customersList');
            tbody.innerHTML = '';
            if (filteredCustomers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد عملاء تطابق البحث</td></tr>';
                return;
            }
            filteredCustomers.forEach(customer => {
                const tr = document.createElement('tr');
                tr.innerHTML = `

                    <td data-label="الكود">${customer.code}</td>
                    <td data-label="الاسم">${customer.name}</td>
                    <td data-label="الهاتف">${customer.phone || ''}</td>
                    <td data-label="البريد">${customer.email || ''}</td>
                    <td data-label="العنوان">${customer.address || ''}</td>
                    <td data-label="الإجراءات">
                        <div class="action-buttons">
                            <button class="btn-warning edit-btn" onclick="editCustomer(${customer.id})">✏️ تعديل</button>
                            <button class="btn-danger" onclick="deleteCustomer(${customer.id})">حذف</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function searchSuppliers() {
            const searchTerm = document.getElementById('searchSuppliers').value.toLowerCase();
            const filteredSuppliers = suppliers.filter(supplier => 
                supplier.name.toLowerCase().includes(searchTerm) || 
                supplier.code.toLowerCase().includes(searchTerm) ||
                (supplier.phone && supplier.phone.toLowerCase().includes(searchTerm))
            );
            renderFilteredSuppliers(filteredSuppliers);
        }

        function renderFilteredSuppliers(filteredSuppliers) {
            const tbody = document.getElementById('suppliersList');
            tbody.innerHTML = '';
            if (filteredSuppliers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا يوجد موردون تطابق البحث</td></tr>';
                return;
            }
            filteredSuppliers.forEach(supplier => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                        <td data-label="الكود">${supplier.code}</td>
                        <td data-label="الاسم">${supplier.name}</td>
                        <td data-label="الهاتف">${supplier.phone || ''}</td>
                        <td data-label="البريد">${supplier.email || ''}</td>
                        <td data-label="العنوان">${supplier.address || ''}</td>
                        <td data-label="الإجراءات">
                            <div class="action-buttons">
                                <button class="btn-warning edit-btn" onclick="editSupplier(${supplier.id})">✏️ تعديل</button>
                                <button class="btn-danger" onclick="deleteSupplier(${supplier.id})">حذف</button>
                            </div>
                        </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function searchSalaries() {
            const input = document.getElementById('searchSalaries');
            if (!input) return;
            const term = input.value.trim().toLowerCase();
            if (!term) {
                renderSalaries();
                return;
            }
            const filtered = salaries.filter(salary => {
                const nameMatch = (salary.employeeName || '').toLowerCase().includes(term);
                const idMatch = (salary.employeeId || '').toLowerCase().includes(term);
                const jobMatch = (salary.jobTitle || '').toLowerCase().includes(term);
                const monthMatch = (salary.month || '').toLowerCase().includes(term);
                return nameMatch || idMatch || jobMatch || monthMatch;
            });
            renderSalaries(filtered, true);
        }

        // ===== Items Functions =====
        function generateItemCode() {
            document.getElementById('itemCode').value = 'IT' + (items.length + 1).toString().padStart(3, '0');
        }

        async function addItem() {
            // إزالة التنسيقات السابقة
            clearValidationStyles();
            
            // التحقق من صحة المدخلات
            const validation = validateForm({
                itemName: [
                    { validator: (v) => ValidationHelper.required(v, 'اسم الصنف') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'اسم الصنف') },
                    { validator: (v) => ValidationHelper.isUnique(v, items, 'name', 'اسم الصنف') }
                ],
                itemCost: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'سعر الشراء') },
                    { validator: (v) => ValidationHelper.isPositive(v, 'سعر الشراء') }
                ],
                itemPrice: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'سعر البيع') },
                    { validator: (v) => ValidationHelper.isGreaterThanZero(v, 'سعر البيع') }
                ],
                itemStock: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'الكمية') },
                    { validator: (v) => ValidationHelper.isPositive(v, 'الكمية') }
                ]
            });
            
            // إذا كان هناك أخطاء، عرضها وإيقاف العملية
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const code = document.getElementById('itemCode').value;
            const name = document.getElementById('itemName').value.trim();
            const cost = document.getElementById('itemCost').value;
            const price = document.getElementById('itemPrice').value;
            const stock = document.getElementById('itemStock').value;

            showLoading('جاري إضافة الصنف...');

            try {
                const item = {
                    id: Date.now(),
                    code: code || 'IT' + (items.length + 1).toString().padStart(3, '0'),
                    name: name,
                    cost: parseFloat(cost) || 0,
                    price: parseFloat(price) || 0,
                    stock: parseInt(stock) || 0
                };

                items.push(item);
                const success = await saveToFirebase('items', items);
                
                hideLoading();
                
                if (success) {
                    updateDashboard();
                    clearItemForm();
                    renderItems();
                    showNotification('✅ نجاح', 'تم إضافة الصنف بنجاح!', 'success');
                } else {
                    items.pop(); // إزالة الصنف من المصفوفة إذا فشل الحفظ
                    showNotification('❌ خطأ', 'حدث خطأ في حفظ البيانات', 'error');
                }
            } catch (error) {
                hideLoading();
                logError('Add Item', error);
            }
        }

        function renderItems() {
            const tbody = document.getElementById('itemsList');
            tbody.innerHTML = '';
            
            // تطبيق الفلترة
            let filteredItems = [...items];
            const searchText = document.getElementById('searchItems')?.value || '';
            
            // الفلاتر المتقدمة
            const filters = {
                searchText: searchText,
                priceFrom: document.getElementById('itemCostFrom')?.value,
                priceTo: document.getElementById('itemCostTo')?.value,
            };
            
            // إضافة فلاتر إضافية
            if (document.getElementById('itemPriceFrom')?.value) {
                filters.price = { 
                    from: parseFloat(document.getElementById('itemPriceFrom').value),
                    to: parseFloat(document.getElementById('itemPriceTo')?.value || Infinity)
                };
            }
            
            if (document.getElementById('itemStockFrom')?.value) {
                filters.quantity = {
                    from: parseFloat(document.getElementById('itemStockFrom').value),
                    to: parseFloat(document.getElementById('itemStockTo')?.value || Infinity)
                };
            }
            
            // تطبيق الفلترة باستخدام FilterSortHelper
            if (searchText) {
                filteredItems = filteredItems.filter(item => 
                    item.name.toLowerCase().includes(searchText.toLowerCase()) ||
                    item.code.toLowerCase().includes(searchText.toLowerCase())
                );
            }
            
            // فلترة حسب سعر الشراء
            if (filters.priceFrom) {
                filteredItems = filteredItems.filter(item => parseFloat(item.cost) >= parseFloat(filters.priceFrom));
            }
            if (filters.priceTo) {
                filteredItems = filteredItems.filter(item => parseFloat(item.cost) <= parseFloat(filters.priceTo));
            }
            
            // فلترة حسب سعر البيع
            if (filters.price) {
                filteredItems = filteredItems.filter(item => {
                    const price = parseFloat(item.price);
                    return price >= filters.price.from && price <= filters.price.to;
                });
            }
            
            // فلترة حسب الرصيد
            if (filters.quantity) {
                filteredItems = filteredItems.filter(item => {
                    const stock = parseFloat(item.stock);
                    return stock >= filters.quantity.from && stock <= filters.quantity.to;
                });
            }
            
            // تطبيق الترتيب
            const sortState = FilterSortHelper.currentSort['items'];
            if (sortState) {
                filteredItems = FilterSortHelper.sortData(filteredItems, sortState.column, sortState.direction);
            }
            
            if (filteredItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد نتائج</td></tr>';
                return;
            }
            
            filteredItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.code}</td>
                    <td>${item.name}</td>
                    <td>${item.cost}</td>
                    <td>${item.price}</td>
                    <td>${item.stock}</td>
                    <td>
                    <div class="action-buttons">
                        <button class="btn-warning edit-btn" onclick="editItem(${item.id})">✏️ تعديل</button>
                        <button class="btn-danger" onclick="deleteItem(${item.id})">حذف</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // دوال الفلترة للأصناف
        function applyItemsFilters() {
            renderItems();
        }
        
        function resetItemsFilters() {
            document.getElementById('itemCostFrom').value = '';
            document.getElementById('itemCostTo').value = '';
            document.getElementById('itemPriceFrom').value = '';
            document.getElementById('itemPriceTo').value = '';
            document.getElementById('itemStockFrom').value = '';
            document.getElementById('itemStockTo').value = '';
            renderItems();
        }

        function editItem(id) {
            const item = items.find(item => item.id === id);
            if (!item) return;
            
            document.getElementById('itemCode').value = item.code;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemCost').value = item.cost;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemStock').value = item.stock;
            const addButton = document.querySelector('#items .btn-primary');
            addButton.textContent = '💾 تحديث الصنف';
            addButton.onclick = function() { updateItem(id); };
        }

        async function updateItem(id) {
            // إزالة التنسيقات السابقة
            clearValidationStyles();
            
            // التحقق من صحة المدخلات مع استثناء العنصر الحالي من فحص التكرار
            const validation = validateForm({
                itemName: [
                    { validator: (v) => ValidationHelper.required(v, 'اسم الصنف') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'اسم الصنف') },
                    { validator: (v) => ValidationHelper.isUnique(v, items, 'name', 'اسم الصنف', id) }
                ],
                itemCost: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'سعر الشراء') },
                    { validator: (v) => ValidationHelper.isPositive(v, 'سعر الشراء') }
                ],
                itemPrice: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'سعر البيع') },
                    { validator: (v) => ValidationHelper.isGreaterThanZero(v, 'سعر البيع') }
                ],
                itemStock: [
                    { validator: (v) => ValidationHelper.isNumber(v, 'الكمية') },
                    { validator: (v) => ValidationHelper.isPositive(v, 'الكمية') }
                ]
            });
            
            // إذا كان هناك أخطاء، عرضها وإيقاف العملية
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('itemName').value.trim();

            showLoading('جاري تحديث الصنف...');

            try {
                const itemIndex = items.findIndex(item => item.id === id);
                if (itemIndex !== -1) {
                    const oldName = items[itemIndex].name; // حفظ الاسم القديم
                    debugLog('🔄 تحديث الصنف:', { oldName, newName: name, itemId: id });
                    
                    items[itemIndex] = {
                        id: id,
                        code: document.getElementById('itemCode').value,
                        name: name,
                        cost: parseFloat(document.getElementById('itemCost').value) || 0,
                        price: parseFloat(document.getElementById('itemPrice').value) || 0,
                        stock: parseInt(document.getElementById('itemStock').value) || 0
                    };
                    
                    // تحديث اسم الصنف في جميع فواتير المبيعات
                    let salesUpdated = false;
                    let salesCount = 0;
                    sales.forEach(sale => {
                        sale.items.forEach(item => {
                            if (item.id === id || item.name === oldName) {
                                item.name = name;
                                salesUpdated = true;
                                salesCount++;
                            }
                        });
                    });
                    debugLog(`✅ تم تحديث ${salesCount} صنف في فواتير المبيعات`);
                    
                    // تحديث اسم الصنف في جميع فواتير المشتريات
                    let purchasesCount = 0;
                    purchases.forEach(purchase => {
                        purchase.items.forEach(item => {
                            if (item.id === id || item.name === oldName) {
                                item.name = name;
                                purchasesCount++;
                            }
                        });
                    });
                    debugLog(`✅ تم تحديث ${purchasesCount} صنف في فواتير المشتريات`);
                    
                    const success = await saveToFirebase('items', items);
                    const salesSuccess = salesUpdated ? await saveToFirebase('sales', sales) : true;
                    const purchasesSuccess = await saveToFirebase('purchases', purchases);
                    
                    debugLog('💾 حفظ البيانات:', { success, salesSuccess, purchasesSuccess });
                    
                    hideLoading();
                    
                    if (success && salesSuccess && purchasesSuccess) {
                        updateDashboard();
                        clearItemForm();
                        renderItems();
                        
                        // تحديث الرسوم البيانية إذا كانت لوحة التحكم المتقدمة مفتوحة
                        if (document.getElementById('advanced-dashboard') && 
                            document.getElementById('advanced-dashboard').classList.contains('active')) {
                            debugLog('🔄 تحديث الرسوم البيانية...');
                            renderCharts();
                            updateLiveStats();
                        }
                        
                        const addButton = document.querySelector('#items .btn-primary');
                        addButton.textContent = '➕ إضافة صنف';
                        addButton.onclick = addItem;
                        showNotification('✅ نجاح', `تم تحديث الصنف بنجاح!\n- تم تحديث ${salesCount} صنف في فواتير المبيعات\n- تم تحديث ${purchasesCount} صنف في فواتير المشتريات`, 'success');
                    } else {
                        showNotification('❌ خطأ', 'حدث خطأ في تحديث البيانات', 'error');
                    }
                }
            } catch (error) {
                hideLoading();
                logError('Update Item', error);
            }
        }

        async function deleteItem(id) {
            const confirmed = await showConfirmDialog({
                title: '🗑️ نقل إلى سلة المحذوفات',
                message: 'هل تريد نقل هذا الصنف إلى سلة المحذوفات؟\nيمكنك استعادته خلال 30 يوماً.',
                type: 'warning',
                confirmText: 'نعم، انقله',
                cancelText: 'إلغاء'
            });
            
            if (confirmed) {
                showLoading('جاري نقل الصنف...');
                
                try {
                    const item = items.find(i => i.id === id);
                    if (!item) {
                        hideLoading();
                        showNotification('❌ خطأ', 'الصنف غير موجود', 'error');
                        return;
                    }
                    
                    // نقل إلى سلة المحذوفات
                    moveToTrash('items', item);
                    
                    // حذف من المصفوفة
                    const itemsCopy = [...items];
                    items = items.filter(item => item.id !== id);
                    const success = await saveToFirebase('items', items);
                    
                    hideLoading();
                    
                    if (success) {
                        renderItems();
                        updateDashboard();
                        updateTrashBadge();
                    } else {
                        items = itemsCopy; // استعادة البيانات في حالة الفشل
                        showNotification(
                            '❌ خطأ',
                            'حدث خطأ في حذف البيانات',
                            'error'
                        );
                    }
                } catch (error) {
                    hideLoading();
                    logError('Delete Item', error);
                }
            }
        }

        function clearItemForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('itemCost').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemStock').value = '';
            const addButton = document.querySelector('#items .btn-primary');
            addButton.textContent = '➕ إضافة صنف';
            addButton.onclick = addItem;
            generateItemCode(); // توليد كود جديد تلقائياً بعد التفريغ
        }
        
        // ===== Customers Functions =====
        function generateCustomerCode() {
            document.getElementById('customerCode').value = 'CU' + (customers.length + 1).toString().padStart(3, '0');
        }

        async function addCustomer() {
            // إزالة التنسيقات السابقة
            clearValidationStyles();
            
            // التحقق من صحة المدخلات
            const validation = validateForm({
                customerName: [
                    { validator: (v) => ValidationHelper.required(v, 'اسم العميل') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'اسم العميل') },
                    { validator: (v) => ValidationHelper.isUnique(v, customers, 'name', 'اسم العميل') }
                ],
                customerPhone: [
                    { validator: (v) => ValidationHelper.isSaudiPhone(v, 'رقم الجوال') }
                ],
                customerEmail: [
                    { validator: (v) => ValidationHelper.isEmail(v, 'البريد الإلكتروني') }
                ]
            });
            
            // إذا كان هناك أخطاء، عرضها وإيقاف العملية
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('customerName').value.trim();

            showLoading('جاري إضافة العميل...');

            try {
                const customer = {
                    id: Date.now(),
                    code: document.getElementById('customerCode').value || 'CU' + (customers.length + 1).toString().padStart(3, '0'),
                    name: name,
                    phone: document.getElementById('customerPhone').value,
                    email: document.getElementById('customerEmail').value,
                    address: document.getElementById('customerAddress').value
                };
                customers.push(customer);
                const success = await saveToFirebase('customers', customers);
                
                hideLoading();
                
                if (success) {
                    updateDashboard();
                    clearCustomerForm();
                    renderCustomers();
                    showNotification('✅ نجاح', 'تم إضافة العميل بنجاح!', 'success');
                } else {
                    customers.pop();
                    showNotification('❌ خطأ', 'حدث خطأ في حفظ البيانات', 'error');
                }
            } catch (error) {
                hideLoading();
                logError('Add Customer', error);
            }
        }

        function renderCustomers() {
            const tbody = document.getElementById('customersList');
            tbody.innerHTML = '';
            
            // تطبيق الفلترة
            let filteredCustomers = [...customers];
            const searchText = document.getElementById('searchCustomers')?.value || '';
            
            if (searchText) {
                filteredCustomers = filteredCustomers.filter(customer => 
                    customer.name.toLowerCase().includes(searchText.toLowerCase()) ||
                    customer.code.toLowerCase().includes(searchText.toLowerCase()) ||
                    (customer.phone && customer.phone.includes(searchText)) ||
                    (customer.email && customer.email.toLowerCase().includes(searchText.toLowerCase())) ||
                    (customer.address && customer.address.toLowerCase().includes(searchText.toLowerCase()))
                );
            }
            
            // تطبيق الترتيب
            const sortState = FilterSortHelper.currentSort['customers'];
            if (sortState) {
                filteredCustomers = FilterSortHelper.sortData(filteredCustomers, sortState.column, sortState.direction);
            }

            if (filteredCustomers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد نتائج</td></tr>';
                return;
            }

            filteredCustomers.forEach(customer => {
                const tr = document.createElement('tr');
                tr.innerHTML = `

                    <td>${customer.code}</td>
                    <td>${customer.name}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.email}</td>
                    <td>${customer.address}</td>
                    <td>

                               <div class="action-buttons">
                        <button class="btn-warning edit-btn" onclick="editCustomer(${customer.id})">✏️ تعديل</button>
                        <button class="btn-danger" onclick="deleteCustomer(${customer.id})">حذف</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // دوال الفلترة للعملاء
        function resetCustomersFilters() {
            document.getElementById('searchCustomers').value = '';
            renderCustomers();
        }

        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (!customer) return;
            
            document.getElementById('customerCode').value = customer.code;
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerPhone').value = customer.phone;
            document.getElementById('customerEmail').value = customer.email;
            document.getElementById('customerAddress').value = customer.address;
            const addButton = document.querySelector('#customers .btn-primary');
            addButton.textContent = '💾 تحديث العميل';
            addButton.onclick = () => updateCustomer(id);
        }

        async function updateCustomer(id) {
            // إزالة التنسيقات السابقة
            clearValidationStyles();
            
            // التحقق من صحة المدخلات مع استثناء العنصر الحالي من فحص التكرار
            const validation = validateForm({
                customerName: [
                    { validator: (v) => ValidationHelper.required(v, 'اسم العميل') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'اسم العميل') },
                    { validator: (v) => ValidationHelper.isUnique(v, customers, 'name', 'اسم العميل', id) }
                ],
                customerPhone: [
                    { validator: (v) => ValidationHelper.isSaudiPhone(v, 'رقم الجوال') }
                ],
                customerEmail: [
                    { validator: (v) => ValidationHelper.isEmail(v, 'البريد الإلكتروني') }
                ]
            });
            
            // إذا كان هناك أخطاء، عرضها وإيقاف العملية
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('customerName').value.trim();

            showLoading('جاري تحديث العميل...');

            try {
                const customerIndex = customers.findIndex(c => c.id === id);
                if (customerIndex !== -1) {
                    customers[customerIndex] = {
                        id: id,
                        code: document.getElementById('customerCode').value,
                        name: name,
                        phone: document.getElementById('customerPhone').value,
                        email: document.getElementById('customerEmail').value,
                        address: document.getElementById('customerAddress').value
                    };
                    const success = await saveToFirebase('customers', customers);
                    
                    hideLoading();
                    
                    if (success) {
                        updateDashboard();
                        clearCustomerForm();
                        renderCustomers();
                        
                        const addButton = document.querySelector('#customers .btn-primary');
                        addButton.textContent = '➕ إضافة عميل';
                        addButton.onclick = addCustomer;
                        
                        showNotification('✅ نجاح', 'تم تحديث العميل بنجاح', 'success');
                    } else {
                        showNotification('❌ خطأ', 'حدث خطأ في تحديث البيانات', 'error');
                    }
                }
            } catch (error) {
                hideLoading();
                logError('Update Customer', error);
            }
        }

        async function deleteCustomer(id) {
            const confirmed = await showConfirmDialog({
                title: '🗑️ نقل عميل إلى سلة المحذوفات',
                message: 'هل تريد نقل هذا العميل إلى سلة المحذوفات؟\nيمكنك استعادته خلال 30 يوماً.',
                type: 'warning',
                confirmText: 'نعم، انقله',
                cancelText: 'إلغاء'
            });
            
            if (confirmed) {
                const customer = customers.find(c => c.id === id);
                if (customer) {
                    moveToTrash('customers', customer);
                    customers = customers.filter(c => c.id !== id);
                    const success = await saveToFirebase('customers', customers);
                    if (success) {
                        renderCustomers();
                        updateDashboard();
                        showNotification('✅ تم النقل', 'تم نقل العميل إلى سلة المحذوفات', 'success');
                    } else {
                        showNotification('❌ خطأ', 'حدث خطأ في حذف البيانات', 'error');
                    }
                }
            }
        }

        function clearCustomerForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerAddress').value = '';
            const addButton = document.querySelector('#customers .btn-primary');
            addButton.textContent = '➕ إضافة عميل';
            addButton.onclick = addCustomer;
            generateCustomerCode(); // توليد كود جديد تلقائياً بعد التفريغ
        }

        // ===== Suppliers Functions =====
        function generateSupplierCode() {
            document.getElementById('supplierCode').value = 'SU' + (suppliers.length + 1).toString().padStart(3, '0');
        }

        async function addSupplier() {
            // إزالة التنسيقات السابقة
            clearValidationStyles();
            
            // التحقق من صحة المدخلات
            const validation = validateForm({
                supplierName: [
                    { validator: (v) => ValidationHelper.required(v, 'اسم المورد') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'اسم المورد') },
                    { validator: (v) => ValidationHelper.isUnique(v, suppliers, 'name', 'اسم المورد') }
                ],
                supplierPhone: [
                    { validator: (v) => ValidationHelper.isSaudiPhone(v, 'رقم الجوال') }
                ],
                supplierEmail: [
                    { validator: (v) => ValidationHelper.isEmail(v, 'البريد الإلكتروني') }
                ]
            });
            
            // إذا كان هناك أخطاء، عرضها وإيقاف العملية
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('supplierName').value.trim();

            showLoading('جاري إضافة المورد...');

            try {
                const supplier = {
                    id: Date.now(),
                    code: document.getElementById('supplierCode').value || 'SU' + (suppliers.length + 1).toString().padStart(3, '0'),
                    name: name,
                    phone: document.getElementById('supplierPhone').value,
                    email: document.getElementById('supplierEmail').value,
                    address: document.getElementById('supplierAddress').value
                };
                suppliers.push(supplier);
                const success = await saveToFirebase('suppliers', suppliers);
                
                hideLoading();
                
                if (success) {
                    updateDashboard();
                    clearSupplierForm();
                    renderSuppliers();
                    showNotification('✅ نجاح', 'تم إضافة المورد بنجاح!', 'success');
                } else {
                    suppliers.pop();
                    showNotification('❌ خطأ', 'حدث خطأ في حفظ البيانات', 'error');
                }
            } catch (error) {
                hideLoading();
                logError('Add Supplier', error);
            }
        }

        function renderSuppliers() {
            const tbody = document.getElementById('suppliersList');
            tbody.innerHTML = '';
            
            // تطبيق الفلترة
            let filteredSuppliers = [...suppliers];
            const searchText = document.getElementById('searchSuppliers')?.value || '';
            
            if (searchText) {
                filteredSuppliers = filteredSuppliers.filter(supplier => 
                    supplier.name.toLowerCase().includes(searchText.toLowerCase()) ||
                    supplier.code.toLowerCase().includes(searchText.toLowerCase()) ||
                    (supplier.phone && supplier.phone.includes(searchText)) ||
                    (supplier.email && supplier.email.toLowerCase().includes(searchText.toLowerCase())) ||
                    (supplier.address && supplier.address.toLowerCase().includes(searchText.toLowerCase()))
                );
            }
            
            // تطبيق الترتيب
            const sortState = FilterSortHelper.currentSort['suppliers'];
            if (sortState) {
                filteredSuppliers = FilterSortHelper.sortData(filteredSuppliers, sortState.column, sortState.direction);
            }

            if (filteredSuppliers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد نتائج</td></tr>';
                return;
            }

            filteredSuppliers.forEach(supplier => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${supplier.code}</td>
                    <td>${supplier.name}</td>
                    <td>${supplier.phone}</td>
                    <td>${supplier.email}</td>
                    <td>${supplier.address}</td>
                    <td>
                    <div class="action-buttons">
                        <button class="btn-warning edit-btn" onclick="editSupplier(${supplier.id})">✏️ تعديل</button>
                        <button class="btn-danger" onclick="deleteSupplier(${supplier.id})">حذف</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // دوال الفلترة للموردين
        function resetSuppliersFilters() {
            document.getElementById('searchSuppliers').value = '';
            renderSuppliers();
        }

        function editSupplier(id) {
            const supplier = suppliers.find(s => s.id === id);
            if (!supplier) return;
            
            document.getElementById('supplierCode').value = supplier.code;
            document.getElementById('supplierName').value = supplier.name;
            document.getElementById('supplierPhone').value = supplier.phone;
            document.getElementById('supplierEmail').value = supplier.email;
            document.getElementById('supplierAddress').value = supplier.address;
            const addButton = document.querySelector('#suppliers .btn-primary');
            addButton.textContent = '💾 تحديث المورد';
            addButton.onclick = () => updateSupplier(id);
        }

        async function updateSupplier(id) {
            // إزالة التنسيقات السابقة
            clearValidationStyles();
            
            // التحقق من صحة المدخلات مع استثناء العنصر الحالي من فحص التكرار
            const validation = validateForm({
                supplierName: [
                    { validator: (v) => ValidationHelper.required(v, 'اسم المورد') },
                    { validator: (v) => ValidationHelper.minLength(v, 2, 'اسم المورد') },
                    { validator: (v) => ValidationHelper.isUnique(v, suppliers, 'name', 'اسم المورد', id) }
                ],
                supplierPhone: [
                    { validator: (v) => ValidationHelper.isSaudiPhone(v, 'رقم الجوال') }
                ],
                supplierEmail: [
                    { validator: (v) => ValidationHelper.isEmail(v, 'البريد الإلكتروني') }
                ]
            });
            
            // إذا كان هناك أخطاء، عرضها وإيقاف العملية
            if (!validation.isValid) {
                displayValidationErrors(validation.errors);
                return;
            }
            
            const name = document.getElementById('supplierName').value.trim();

            showLoading('جاري تحديث المورد...');

            try {
                const supplierIndex = suppliers.findIndex(s => s.id === id);
                if (supplierIndex !== -1) {
                    suppliers[supplierIndex] = {
                        id: id,
                        code: document.getElementById('supplierCode').value,
                        name: name,
                        phone: document.getElementById('supplierPhone').value,
                        email: document.getElementById('supplierEmail').value,
                        address: document.getElementById('supplierAddress').value
                    };
                    const success = await saveToFirebase('suppliers', suppliers);
                    
                    hideLoading();
                    
                    if (success) {
                        updateDashboard();
                        clearSupplierForm();
                        renderSuppliers();
                        
                        const addButton = document.querySelector('#suppliers .btn-primary');
                        addButton.textContent = '➕ إضافة مورد';
                        addButton.onclick = addSupplier;
                        
                        showNotification('✅ نجاح', 'تم تحديث المورد بنجاح', 'success');
                    } else {
                        showNotification('❌ خطأ', 'حدث خطأ في تحديث البيانات', 'error');
                    }
                }
            } catch (error) {
                hideLoading();
                logError('Update Supplier', error);
            }
        }

        async function deleteSupplier(id) {
            const confirmed = await showConfirmDialog({
                title: '🗑️ نقل مورد إلى سلة المحذوفات',
                message: 'هل تريد نقل هذا المورد إلى سلة المحذوفات؟\nيمكنك استعادته خلال 30 يوماً.',
                type: 'warning',
                confirmText: 'نعم، انقله',
                cancelText: 'إلغاء'
            });
            
            if (confirmed) {
                const supplier = suppliers.find(s => s.id === id);
                if (supplier) {
                    moveToTrash('suppliers', supplier);
                    suppliers = suppliers.filter(s => s.id !== id);
                    const success = await saveToFirebase('suppliers', suppliers);
                    if (success) {
                        renderSuppliers();
                        updateDashboard();
                        showNotification('✅ تم النقل', 'تم نقل المورد إلى سلة المحذوفات', 'success');
                    } else {
                        showNotification('❌ خطأ', 'حدث خطأ في حذف البيانات', 'error');
                    }
                }
            }
        }

        function clearSupplierForm() {
            document.getElementById('supplierName').value = '';
            document.getElementById('supplierPhone').value = '';
            document.getElementById('supplierEmail').value = '';
            document.getElementById('supplierAddress').value = '';
            const addButton = document.querySelector('#suppliers .btn-primary');
            addButton.textContent = '➕ إضافة مورد';
            addButton.onclick = addSupplier;
            generateSupplierCode(); // توليد كود جديد تلقائياً بعد التفريغ
        }
        
        // ===== General Invoice Functions =====
        function resetInvoiceForms() {
            editingSaleId = null;
            editingPurchaseId = null;
            newSale();
            newPurchase();
        }

        // ===== Purchases Functions =====
        function generatePurchaseCode() {
            document.getElementById('purchaseCode').value = 'PUR' + currentPurchaseNumber.toString().padStart(3, '0');
        }
        
        function updatePurchaseDropdowns() {
            const supplierSelect = document.getElementById('purchaseSupplier');
            const itemSelect = document.getElementById('purchaseItem');
            
            supplierSelect.innerHTML = '<option value="">اختر المورد</option>';
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = supplier.name;
                supplierSelect.appendChild(option);
            });

            itemSelect.innerHTML = '<option value="">اختر الصنف</option>';
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} (${item.stock} متوفر)`;
                option.dataset.price = item.cost;
                itemSelect.appendChild(option);
            });
            
            renderPurchasesList();
        }
        
        function addPurchaseItem() {
            const itemId = parseInt(document.getElementById('purchaseItem').value);
            const quantity = parseInt(document.getElementById('purchaseQuantity').value);
            const unit = document.getElementById('purchaseUnit').value;
            const price = parseFloat(document.getElementById('purchasePrice').value);
            
            if (!itemId || !quantity || !unit || isNaN(price)) {
                showNotification('⚠️ بيانات ناقصة', 'يرجى ملء جميع بيانات الصنف بشكل صحيح', 'warning');
                return;
            }
            
            const item = items.find(i => i.id === itemId);
            if (!item) {
                showNotification('❌ خطأ', 'الصنف غير موجود', 'error');
                return;
            }
            
            const existingItem = currentPurchaseItems.find(i => i.id === itemId && i.unit === unit);
            if (existingItem) {
                existingItem.quantity += quantity;
                existingItem.total = existingItem.quantity * existingItem.price;
            } else {
                currentPurchaseItems.push({
                    id: itemId,
                    name: item.name,
                    quantity: quantity,
                    unit: unit,
                    price: price,
                    total: quantity * price
                });
            }
            
            renderPurchaseItems();
            updatePurchaseTotals();
            
            document.getElementById('purchaseItem').value = '';
            document.getElementById('purchaseQuantity').value = '1';
            document.getElementById('purchasePrice').value = '';
        }
        
        function renderPurchaseItems() {
            const tbody = document.getElementById('purchaseItemsList');
            tbody.innerHTML = '';
            
            if (currentPurchaseItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد أصناف</td></tr>';
                return;
            }
            
            currentPurchaseItems.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit || 'قطعة'}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.total.toFixed(2)}</td>
                    <td>
                        <button class="btn-danger" onclick="removePurchaseItem(${index})">حذف</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function removePurchaseItem(index) {
            currentPurchaseItems.splice(index, 1);
            renderPurchaseItems();
            updatePurchaseTotals();
        }
        
        function updatePurchaseTotals() {
            const subtotal = currentPurchaseItems.reduce((sum, item) => sum + item.total, 0);
            const tax = subtotal * 0.15;
            const total = subtotal + tax;
            const paidAmount = parseFloat(document.getElementById('purchasePaidAmount').value) || 0;
            const remainingAmount = total - paidAmount;

            document.getElementById('purchaseSubtotal').textContent = subtotal.toFixed(2);
            document.getElementById('purchaseTax').textContent = tax.toFixed(2);
            document.getElementById('purchaseTotal').textContent = total.toFixed(2);
            
            const remainingEl = document.getElementById('purchaseRemainingAmount');
            remainingEl.textContent = remainingAmount.toFixed(2);
            remainingEl.className = remainingAmount <= 0 ? 'remaining-paid' : 'remaining-unpaid';
        }
        
        async function savePurchase() {
            const date = document.getElementById('purchaseDate').value;
            const supplierId = parseInt(document.getElementById('purchaseSupplier').value);
            const notes = document.getElementById('purchaseNotes').value;
            const paidAmount = parseFloat(document.getElementById('purchasePaidAmount').value) || 0;

            if (!date || !supplierId || currentPurchaseItems.length === 0) {
                showNotification('⚠️ بيانات ناقصة', 'يرجى ملء جميع البيانات المطلوبة وإضافة أصناف للفاتورة', 'warning');
                return;
            }
            
            const subtotal = currentPurchaseItems.reduce((sum, item) => sum + item.total, 0);
            const tax = subtotal * 0.15;
            const total = subtotal + tax;
            const remainingAmount = total - paidAmount;

            if (editingPurchaseId) {
                const purchaseIndex = purchases.findIndex(p => p.id === editingPurchaseId);
                if (purchaseIndex > -1) {
                    const originalPurchase = purchases[purchaseIndex];
                    
                    originalPurchase.items.forEach(pi => {
                        const item = items.find(i => i.id === pi.id);
                        if (item) item.stock -= pi.quantity;
                    });

                    const updatedPurchase = {
                        ...originalPurchase,
                        date,
                        supplierId,
                        notes,
                        paidAmount,
                        items: [...currentPurchaseItems],
                        subtotal,
                        tax,
                        total,
                        remainingAmount
                    };

                    purchases[purchaseIndex] = updatedPurchase;
                    
                    showNotification('✅ تم التحديث', `تم تحديث الفاتورة رقم PUR${originalPurchase.number.toString().padStart(3, '0')} بنجاح!`, 'success');
                }
            } else {
                 const newPurchaseData = { id: Date.now(), number: currentPurchaseNumber, date, supplierId, notes, paidAmount, items: [...currentPurchaseItems], subtotal, tax, total, remainingAmount };
                purchases.push(newPurchaseData);
                currentPurchaseNumber++;
                showNotification('✅ تم الحفظ', `تم حفظ الفاتورة رقم PUR${newPurchaseData.number.toString().padStart(3, '0')} بنجاح!`, 'success');
            }
            
            const success1 = await saveToFirebase('purchases', purchases);
            
            currentPurchaseItems.forEach(pi => {
                const item = items.find(i => i.id === pi.id);
                if (item) item.stock += pi.quantity;
            });
            const success2 = await saveToFirebase('items', items);
            
            if (success1 && success2) {
                newPurchase();
                updateDashboard();
                renderItems();
            } else {
                showNotification('❌ خطأ', 'حدث خطأ في حفظ البيانات', 'error');
            }
        }
        
        function newPurchase() {
            currentPurchaseItems = [];
            editingPurchaseId = null;
            document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('purchaseSupplier').value = '';
            document.getElementById('purchaseNotes').value = '';
            document.getElementById('purchasePaidAmount').value = '';
            generatePurchaseCode();
            document.getElementById('savePurchaseBtn').textContent = '💾 حفظ الفاتورة';
            renderPurchaseItems();
            updatePurchaseTotals();
            renderPurchasesList();
      
  }
    function renderPurchasesList() {
            const tbody = document.getElementById('purchasesList');
            tbody.innerHTML = '';
            
            // تطبيق الفلترة
            let filteredPurchases = [...purchases];
            const searchText = document.getElementById('searchPurchases')?.value || '';
            
            // البحث النصي
            if (searchText) {
                filteredPurchases = filteredPurchases.filter(purchase => {
                    const supplier = suppliers.find(s => s.id === purchase.supplierId);
                    return (`pur${purchase.number}`.toLowerCase().includes(searchText.toLowerCase()) || 
                            (supplier && supplier.name.toLowerCase().includes(searchText.toLowerCase())) || 
                            purchase.date.includes(searchText));
                });
            }
            
            // فلترة حسب التاريخ
            const dateFrom = document.getElementById('purchasesDateFrom')?.value;
            const dateTo = document.getElementById('purchasesDateTo')?.value;
            if (dateFrom) {
                filteredPurchases = filteredPurchases.filter(purchase => new Date(purchase.date) >= new Date(dateFrom));
            }
            if (dateTo) {
                filteredPurchases = filteredPurchases.filter(purchase => new Date(purchase.date) <= new Date(dateTo));
            }
            
            // فلترة حسب المبلغ
            const amountFrom = document.getElementById('purchasesAmountFrom')?.value;
            const amountTo = document.getElementById('purchasesAmountTo')?.value;
            if (amountFrom) {
                filteredPurchases = filteredPurchases.filter(purchase => purchase.total >= parseFloat(amountFrom));
            }
            if (amountTo) {
                filteredPurchases = filteredPurchases.filter(purchase => purchase.total <= parseFloat(amountTo));
            }
            
            // تطبيق الترتيب
            const sortState = FilterSortHelper.currentSort['purchases'];
            if (sortState) {
                filteredPurchases = FilterSortHelper.sortData(filteredPurchases, sortState.column, sortState.direction);
            }
            
            if (filteredPurchases.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">لا توجد نتائج</td></tr>';
                return;
            }
            
            filteredPurchases.forEach(purchase => {
                const supplier = suppliers.find(s => s.id === purchase.supplierId);
                const totalQty = purchase.items.reduce((sum, item) => sum + item.quantity, 0);

                // --- 💡 بداية التعديل: منطق الألوان الجديد ---
                const remaining = purchase.remainingAmount ?? (purchase.total - (purchase.paidAmount || 0));
                // تحديد الكلاس بناءً على قيمة المتبقي
                const remainingClass = remaining > 0.01 ? 'remaining-unpaid' : (remaining < -0.01 ? 'remaining-credit' : 'remaining-paid');
                const remainingText = remaining.toFixed(2);
                // --- 💡 نهاية التعديل ---

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>PUR${purchase.number.toString().padStart(3, '0')}</td>
                    <td>${purchase.date}</td>
                    <td>${supplier ? supplier.name : 'غير معروف'}</td>
                    <td>${totalQty}</td>
                    <td>${purchase.total.toFixed(2)}</td>
                    <td>${(purchase.paidAmount || 0).toFixed(2)}</td>
                    <td class="${remainingClass}">${remainingText}</td>
                    <td>
                    <div class="action-buttons">
                        <button class="btn-secondary" onclick="printPurchaseInvoice(${purchase.id})">🖨️ طباعة</button>
                        <button class="btn-warning edit-btn" onclick="editPurchase(${purchase.id})">✏️ تعديل</button>
                        <button class="btn-danger" onclick="deletePurchase(${purchase.id})">حذف</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        

        // دوال الفلترة للمشتريات
        function applyPurchasesFilters() {
            renderPurchasesList();
        }
        
        function resetPurchasesFilters() {
            document.getElementById('purchasesDateFrom').value = '';
            document.getElementById('purchasesDateTo').value = '';
            document.getElementById('purchasesAmountFrom').value = '';
            document.getElementById('purchasesAmountTo').value = '';
            document.getElementById('searchPurchases').value = '';
            renderPurchasesList();
        }

        function searchPurchases() {
            renderPurchasesList();
        }

        function renderFilteredPurchases(filtered) {
            // هذه الدالة لم تعد مستخدمة - تم دمجها في renderPurchasesList
            renderPurchasesList();
        }

        function printPurchaseInvoice(purchaseId) {
            const purchase = purchases.find(p => p.id === purchaseId);
            if (!purchase) return;
            
            const supplier = suppliers.find(s => s.id === purchase.supplierId);
            
            // تحميل شعار النشاط واسمه
            const currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
            if (currentActivity) {
                document.getElementById('printPurchaseActivityName').textContent = currentActivity.name;
                
                // تحميل الشعار من localStorage
                const storageKey = `activity_${currentActivity.id}_data`;
                const activityData = JSON.parse(localStorage.getItem(storageKey));
                const logoImg = document.getElementById('printPurchaseActivityLogo');
                
                if (activityData && activityData.logo) {
                    logoImg.src = activityData.logo;
                    logoImg.style.display = 'block';
                } else {
                    logoImg.style.display = 'none';
                }
            }
            
            // التاريخ والوقت
            document.getElementById('printPurchaseDate').textContent = purchase.date;
            const now = new Date();
            document.getElementById('printPurchaseTime').textContent = now.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});
            document.getElementById('printPurchaseNumber').textContent = purchase.number.toString().padStart(3, '0');
            
            // بيانات المورد
            document.getElementById('printSupplierName').textContent = supplier ? supplier.name : '-----';
            
            // ملاحظات
            const notesElement = document.getElementById('printPurchaseNotes');
            if (notesElement) {
                notesElement.textContent = purchase.notes || '-----';
            }
            
            // جدول الأصناف
            const itemsBody = document.getElementById('printPurchaseItems');
            itemsBody.innerHTML = '';
            purchase.items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">${index + 1}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: right;">${item.name}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">${item.quantity}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">${item.unit || 'قطعة'}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center;">${item.price.toFixed(2)}</td>
                    <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; direction: ltr; font-weight: bold;">${item.total.toFixed(2)}</td>
                `;
                itemsBody.appendChild(tr);
            });
            
            // المجاميع
            document.getElementById('printPurchaseSubtotal').textContent = (purchase.subtotal || 0).toFixed(2);
            
            const taxRow = document.getElementById('printPurchaseTaxRow');
            if (purchase.includeTax) {
                document.getElementById('printPurchaseTax').textContent = (purchase.tax || 0).toFixed(2);
                if (taxRow) taxRow.style.display = 'grid';
            } else {
                if (taxRow) taxRow.style.display = 'none';
            }
            
            document.getElementById('printPurchaseTotal').textContent = (purchase.total || 0).toFixed(2);
            document.getElementById('printPurchasePaid').textContent = (purchase.paidAmount || 0).toFixed(2);
            const remaining = (purchase.remainingAmount !== undefined) ? purchase.remainingAmount : ((purchase.total || 0) - (purchase.paidAmount || 0));
            document.getElementById('printPurchaseRemaining').textContent = remaining.toFixed(2);
            
            const printSection = document.getElementById('purchaseInvoicePrint');
            printSection.style.display = 'block';
            setTimeout(() => {
                window.print();
                printSection.style.display = 'none';
            }, 100);
        }
        
        async function deletePurchase(id) {
            const confirmed = await showConfirmDialog({
                title: '🗑️ حذف فاتورة مشتريات',
                message: 'هل تريد نقل هذه الفاتورة إلى سلة المحذوفات؟\n⚠️ سيتم إرجاع الكميات من المخزون.',
                type: 'warning',
                confirmText: 'نعم، احذفها',
                cancelText: 'إلغاء',
                icon: '📦'
            });
            
            if (confirmed) {
                const pIndex = purchases.findIndex(p => p.id === id);
                if (pIndex > -1) {
                    const purchase = purchases[pIndex];
                    
                    // إرجاع الكميات
                    purchase.items.forEach(pi => {
                        const item = items.find(i => i.id === pi.id);
                        if (item) item.stock -= pi.quantity;
                    });
                    await saveToFirebase('items', items);
                    
                    // نقل إلى سلة المحذوفات
                    moveToTrash('purchases', purchase);
                    purchases.splice(pIndex, 1);
                    await saveToFirebase('purchases', purchases);
                    
                    renderPurchasesList();
                    updateDashboard();
                    renderItems();
                    showNotification('✅ تم النقل', 'تم نقل فاتورة المشتريات إلى سلة المحذوفات', 'success');
                }
            }
        }
        
        function editPurchase(id) {
            const purchase = purchases.find(p => p.id === id);
            if (!purchase) return;
            
            editingPurchaseId = id;
            currentPurchaseItems = JSON.parse(JSON.stringify(purchase.items));
            
            document.getElementById('purchaseDate').value = purchase.date;
            document.getElementById('purchaseSupplier').value = purchase.supplierId;
            document.getElementById('purchaseNotes').value = purchase.notes;
            document.getElementById('purchasePaidAmount').value = purchase.paidAmount || 0;
            document.getElementById('purchaseCode').value = `تعديل PUR${purchase.number.toString().padStart(3, '0')}`;
            document.getElementById('savePurchaseBtn').textContent = '💾 تحديث الفاتورة';
            
            renderPurchaseItems();
            updatePurchaseTotals();
        }

        // ===== Sales Functions =====
        function generateSaleCode() {
            document.getElementById('saleCode').value = 'SAL' + currentSaleNumber.toString().padStart(3, '0');
        }
        
        function updateSaleDropdowns() {
            const customerSelect = document.getElementById('saleCustomer');
            const itemSelect = document.getElementById('saleItem');
            
            customerSelect.innerHTML = '<option value="">اختر العميل</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                customerSelect.appendChild(option);
            });

            itemSelect.innerHTML = '<option value="">اختر الصنف</option>';
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} (${item.stock} متوفر)`;
                option.dataset.price = item.price;
                itemSelect.appendChild(option);
            });
            
            renderSalesList();
        }
        
        // تحديث بيانات العميل عند الاختيار
        function updateCustomerFields() {
            const customerSelect = document.getElementById('saleCustomer');
            const customerId = parseInt(customerSelect.value);
            const customer = customers.find(c => c.id === customerId);
            
            if (customer) {
                document.getElementById('saleCustomerName').value = customer.name || '';
                document.getElementById('saleCustomerCode').value = customer.code || '';
                document.getElementById('saleCustomerPhone').value = customer.phone || '';
            } else {
                document.getElementById('saleCustomerName').value = '';
                document.getElementById('saleCustomerCode').value = '';
                document.getElementById('saleCustomerPhone').value = '';
            }
        }
        
        function addSaleItem() {
            const itemId = parseInt(document.getElementById('saleItem').value);
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const unit = document.getElementById('saleUnit').value;
            const price = parseFloat(document.getElementById('salePrice').value);
            
            if (!itemId || !quantity || !unit || isNaN(price)) {
                showNotification('⚠️ بيانات ناقصة', 'يرجى ملء جميع بيانات الصنف بشكل صحيح', 'warning');
                return;
            }
            
            const item = items.find(i => i.id === itemId);
            if (!item) {
                showNotification('❌ خطأ', 'الصنف غير موجود', 'error');
                return;
            }
            
            const existingInCart = currentSaleItems.find(i => i.id === itemId && i.unit === unit);
            const qtyInCart = existingInCart ? existingInCart.quantity : 0;

            if (item.stock < (quantity + qtyInCart)) {
                showNotification('⚠️ مخزون غير كافٍ', `الكمية المطلوبة (${quantity + qtyInCart}) غير متوفرة. المخزون الحالي: ${item.stock}`, 'warning', 6000);
                return;
            }
            
            if (existingInCart) {
                existingInCart.quantity += quantity;
                existingInCart.total = existingInCart.quantity * existingInCart.price;
            } else {
                currentSaleItems.push({ id: itemId, name: item.name, quantity, unit: unit, price, total: quantity * price });
            }
            
            renderSaleItems();
            updateSaleTotals();
            
            document.getElementById('saleItem').value = '';
            document.getElementById('saleQuantity').value = '1';
            document.getElementById('salePrice').value = '';
        }
        
        function renderSaleItems() {
            const tbody = document.getElementById('saleItemsList');
            tbody.innerHTML = '';
            if (currentSaleItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد أصناف</td></tr>';
                return;
            }
            currentSaleItems.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit || 'قطعة'}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.total.toFixed(2)}</td>
                    <td><button class="btn-danger" onclick="removeSaleItem(${index})">حذف</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function removeSaleItem(index) {
            currentSaleItems.splice(index, 1);
            renderSaleItems();
            updateSaleTotals();
        }
        
        function updateSaleTotals() {
            const subtotal = currentSaleItems.reduce((sum, item) => sum + item.total, 0);
            const applyTax = document.getElementById('applySaleTax').checked;
            const tax = applyTax ? subtotal * 0.15 : 0;
            const total = subtotal + tax;
            const paidAmount = parseFloat(document.getElementById('salePaidAmount').value) || 0;
            const remainingAmount = total - paidAmount;

            document.getElementById('saleSubtotal').textContent = subtotal.toFixed(2);
            document.getElementById('saleTax').textContent = tax.toFixed(2);
            document.getElementById('saleTotal').textContent = total.toFixed(2);
            
            const remainingEl = document.getElementById('saleRemainingAmount');
            remainingEl.textContent = remainingAmount.toFixed(2);
            remainingEl.className = remainingAmount <= 0 ? 'remaining-paid' : 'remaining-unpaid';
        }
        
        function newSale() {
            currentSaleItems = [];
            editingSaleId = null;
            document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('saleCustomer').value = '';
            document.getElementById('saleCustomerName').value = '';
            document.getElementById('saleCustomerCode').value = '';
            document.getElementById('saleCustomerPhone').value = '';
            document.getElementById('saleCustomerAddress').value = '';
            document.getElementById('saleNotes').value = '';
            document.getElementById('salePaidAmount').value = '';
            generateSaleCode();
            document.getElementById('saveSaleBtn').textContent = '💾 حفظ الفاتورة';
            renderSaleItems();
            updateSaleTotals();
            renderSalesList();
        }

        async function saveSale() {
            const date = document.getElementById('saleDate').value;
            const customerId = parseInt(document.getElementById('saleCustomer').value);
            const notes = document.getElementById('saleNotes').value;
            const customerAddress = document.getElementById('saleCustomerAddress').value;
            const paidAmount = parseFloat(document.getElementById('salePaidAmount').value) || 0;
            const taxApplied = document.getElementById('applySaleTax').checked;

            if (!date || !customerId || currentSaleItems.length === 0) {
                showNotification('⚠️ بيانات ناقصة', 'يرجى ملء جميع البيانات المطلوبة وإضافة أصناف للفاتورة', 'warning');
                return;
            }
            
            const subtotal = currentSaleItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxApplied ? subtotal * 0.15 : 0;
            const total = subtotal + tax;
            const remainingAmount = total - paidAmount;

            if (editingSaleId) {
                const saleIndex = sales.findIndex(s => s.id === editingSaleId);
                if (saleIndex > -1) {
                    const originalSale = sales[saleIndex];
                    
                    originalSale.items.forEach(si => {
                        const item = items.find(i => i.id === si.id);
                        if (item) item.stock += si.quantity;
                    });

                    const updatedSale = {
                        ...originalSale,
                        date,
                        customerId,
                        notes,
                        customerAddress,
                        paidAmount,
                        items: [...currentSaleItems],
                        subtotal,
                        tax,
                        total,
                        remainingAmount,
                        taxApplied
                    };
                    
                    sales[saleIndex] = updatedSale;
                    
                    showNotification('✅ تم التحديث', `تم تحديث الفاتورة رقم SAL${originalSale.number.toString().padStart(3, '0')} بنجاح!`, 'success');
                }
            } else {
                const newSaleData = { id: Date.now(), number: currentSaleNumber, date, customerId, notes, customerAddress, paidAmount, items: [...currentSaleItems], subtotal, tax, total, remainingAmount, taxApplied };
                sales.push(newSaleData);
                currentSaleNumber++;
                showNotification('✅ تم الحفظ', `تم حفظ الفاتورة رقم SAL${newSaleData.number.toString().padStart(3, '0')} بنجاح!`, 'success');
            }
            
            const success1 = await saveToFirebase('sales', sales);
            
            currentSaleItems.forEach(si => {
                const item = items.find(i => i.id === si.id);
                if (item) item.stock -= si.quantity;
            });
            const success2 = await saveToFirebase('items', items);
            
            if (success1 && success2) {
                newSale();
                updateDashboard();
                renderItems();
            } else {
                showNotification('❌ خطأ', 'حدث خطأ في حفظ البيانات', 'error');
            }
        }
    function renderSalesList() {
    const tbody = document.getElementById('salesList');
    tbody.innerHTML = '';
    
    // تطبيق الفلترة
    let filteredSales = [...sales];
    const searchText = document.getElementById('searchSales')?.value || '';
    
    // البحث النصي
    if (searchText) {
        filteredSales = filteredSales.filter(sale => {
            const customer = customers.find(c => c.id === sale.customerId);
            return (`sal${sale.number}`.toLowerCase().includes(searchText.toLowerCase()) || 
                    (customer && customer.name.toLowerCase().includes(searchText.toLowerCase())) || 
                    sale.date.includes(searchText));
        });
    }
    
    // فلترة حسب التاريخ
    const dateFrom = document.getElementById('salesDateFrom')?.value;
    const dateTo = document.getElementById('salesDateTo')?.value;
    if (dateFrom) {
        filteredSales = filteredSales.filter(sale => new Date(sale.date) >= new Date(dateFrom));
    }
    if (dateTo) {
        filteredSales = filteredSales.filter(sale => new Date(sale.date) <= new Date(dateTo));
    }
    
    // فلترة حسب المبلغ
    const amountFrom = document.getElementById('salesAmountFrom')?.value;
    const amountTo = document.getElementById('salesAmountTo')?.value;
    if (amountFrom) {
        filteredSales = filteredSales.filter(sale => sale.total >= parseFloat(amountFrom));
    }
    if (amountTo) {
        filteredSales = filteredSales.filter(sale => sale.total <= parseFloat(amountTo));
    }
    
    // تطبيق الترتيب
    const sortState = FilterSortHelper.currentSort['sales'];
    if (sortState) {
        filteredSales = FilterSortHelper.sortData(filteredSales, sortState.column, sortState.direction);
    }
    
    if (filteredSales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">لا توجد نتائج</td></tr>';
        return;
    }
    
    filteredSales.forEach(sale => {
        const customer = customers.find(c => c.id === sale.customerId);
        const totalQty = sale.items.reduce((sum, item) => sum + item.quantity, 0);
        
        // --- 💡 بداية التعديل: منطق الألوان الجديد ---
        const remaining = sale.remainingAmount ?? (sale.total - (sale.paidAmount || 0));
        // تحديد الكلاس بناءً على قيمة المتبقي
        // remaining-unpaid: أحمر (عليه فلوس)
        // remaining-credit: أخضر (له فلوس)
        // remaining-paid: أسود (الرصيد صفر)
        const remainingClass = remaining > 0.01 ? 'remaining-unpaid' : (remaining < -0.01 ? 'remaining-credit' : 'remaining-paid');
        const remainingText = remaining.toFixed(2);
        // --- 💡 نهاية التعديل ---

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td data-label="رقم الفاتورة">SAL${sale.number.toString().padStart(3, '0')}</td>
            <td data-label="التاريخ">${sale.date}</td>
            <td data-label="العميل">${customer ? customer.name : 'غير معروف'}</td>
            <td data-label="الكمية">${totalQty}</td>
            <td data-label="الإجمالي">${sale.total.toFixed(2)}</td>
            <td data-label="المدفوع">${(sale.paidAmount || 0).toFixed(2)}</td>
            <td data-label="المتبقي" class="${remainingClass}">${remainingText}</td>
            <td data-label="الإجراءات">
                <div class="action-buttons">
                    <button class="btn-secondary" onclick="printSaleInvoice(${sale.id})">🖨️ طباعة</button>
                    <button class="email-btn" onclick="emailSaleInvoice(${sale.id})">📧 بريد</button>
                    <button class="btn-whatsapp" onclick="sendWhatsAppInvoice(${sale.id})">💬 واتساب</button>
                    <button class="btn-warning edit-btn" onclick="editSale(${sale.id})">✏️ تعديل</button>
                    <button class="btn-danger" onclick="deleteSale(${sale.id})">حذف</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

        // دوال الفلترة للمبيعات
        function applySalesFilters() {
            renderSalesList();
        }
        
        function resetSalesFilters() {
            document.getElementById('salesDateFrom').value = '';
            document.getElementById('salesDateTo').value = '';
            document.getElementById('salesAmountFrom').value = '';
            document.getElementById('salesAmountTo').value = '';
            document.getElementById('searchSales').value = '';
            renderSalesList();
        }

        function searchSales() {
            renderSalesList();
        }

     function renderFilteredSales(filtered) {
    // هذه الدالة لم تعد مستخدمة - تم دمجها في renderSalesList
    renderSalesList();
}

        function printSaleInvoice(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;
            
            const customer = customers.find(c => c.id === sale.customerId);
            
            // تحميل شعار النشاط واسمه
            const currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
            if (currentActivity) {
                document.getElementById('printSaleActivityName').textContent = currentActivity.name;
                
                // تحميل الشعار من localStorage
                const storageKey = `activity_${currentActivity.id}_data`;
                const activityData = JSON.parse(localStorage.getItem(storageKey));
                const logoImg = document.getElementById('printSaleActivityLogo');
                
                if (activityData && activityData.logo) {
                    logoImg.src = activityData.logo;
                    logoImg.style.display = 'block';
                } else {
                    logoImg.style.display = 'none';
                }
            }
            
            // التاريخ والوقت
            document.getElementById('printSaleDate').textContent = sale.date;
            const now = new Date();
            document.getElementById('printSaleTime').textContent = now.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});
            document.getElementById('printSaleNumber').textContent = 'SAL' + sale.number.toString().padStart(3, '0');
            
            // بيانات العميل
            document.getElementById('printCustomerName').textContent = customer ? customer.name : '-----';
            document.getElementById('printCustomerCode').textContent = customer ? customer.code : '-----';
            document.getElementById('printCustomerPhone').textContent = customer ? customer.phone : '-----';
            document.getElementById('printCustomerAddress').textContent = sale.customerAddress || '-----';
            
            // ملاحظات
            const notesElement = document.getElementById('printSaleNotes');
            if (notesElement) {
                notesElement.textContent = sale.notes || '-----';
            }
            
            // جدول الأصناف - دمج جميع الأصناف في صف واحد
            const itemsBody = document.getElementById('printSaleItems');
            itemsBody.innerHTML = '';
            
            // إنشاء صف واحد يحتوي على جميع الأصناف
            const tr = document.createElement('tr');
            
            // عمود التسلسل
            let numbersHtml = '';
            let codesHtml = '';
            let namesHtml = '';
            let quantitiesHtml = '';
            let unitsHtml = '';
            let pricesHtml = '';
            let totalsHtml = '';
            
            sale.items.forEach((item, index) => {
                const itemData = items.find(i => i.id === item.id);
                const itemCode = itemData ? itemData.code : '---';
                
                const separator = index < sale.items.length - 1 ? '<hr style="margin: 4px 0; border: none; border-top: 1px solid #ccc;">' : '';
                
                numbersHtml += `${index + 1}${separator}`;
                codesHtml += `${itemCode}${separator}`;
                namesHtml += `${item.name}${separator}`;
                quantitiesHtml += `${item.quantity}${separator}`;
                unitsHtml += `${item.unit || 'قطعة'}${separator}`;
                pricesHtml += `${item.price.toFixed(2)}${separator}`;
                totalsHtml += `${item.total.toFixed(2)}${separator}`;
            });
            
            tr.innerHTML = `
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${numbersHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${codesHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: right; vertical-align: top; border-radius: 6px;">${namesHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${quantitiesHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${unitsHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: center; vertical-align: top; border-radius: 6px;">${pricesHtml}</td>
                <td style="border: 1px solid #2c5aa0; padding: 8px; text-align: left; vertical-align: top; direction: ltr; font-weight: bold; border-radius: 6px;">${totalsHtml}</td>
            `;
            itemsBody.appendChild(tr);
            
            // المجاميع
            document.getElementById('printSaleSubtotal').textContent = (sale.subtotal || 0).toFixed(2);
            
            const taxRow = document.getElementById('printSaleTaxRow');
            if (sale.includeTax) {
                document.getElementById('printSaleTax').textContent = (sale.tax || 0).toFixed(2);
                if (taxRow) taxRow.style.display = 'grid';
            } else {
                if (taxRow) taxRow.style.display = 'none';
            }
            
            document.getElementById('printSaleTotal').textContent = (sale.total || 0).toFixed(2);
            document.getElementById('printSalePaid').textContent = (sale.paidAmount || 0).toFixed(2);
            const remaining = (sale.remainingAmount !== undefined) ? sale.remainingAmount : ((sale.total || 0) - (sale.paidAmount || 0));
            document.getElementById('printSaleRemaining').textContent = remaining.toFixed(2);
            
            const printSection = document.getElementById('saleInvoicePrint');
            printSection.style.display = 'block';
            setTimeout(() => {
                window.print();
                printSection.style.display = 'none';
            }, 100);
        }
        
        async function deleteSale(id) {
            const confirmed = await showConfirmDialog({
                title: '🗑️ حذف فاتورة مبيعات',
                message: 'هل تريد نقل هذه الفاتورة إلى سلة المحذوفات؟\n⚠️ سيتم إرجاع الكميات إلى المخزون.',
                type: 'warning',
                confirmText: 'نعم، احذفها',
                cancelText: 'إلغاء',
                icon: '📝'
            });
            
            if (confirmed) {
                 const saleIndex = sales.findIndex(s => s.id === id);
                if (saleIndex > -1) {
                    const sale = sales[saleIndex];
                    
                    // إرجاع الكميات
                    sale.items.forEach(si => {
                        const item = items.find(i => i.id === si.id);
                        if (item) item.stock += si.quantity;
                    });
                    await saveToFirebase('items', items);
                    
                    // نقل إلى سلة المحذوفات
                    moveToTrash('sales', sale);
                    sales.splice(saleIndex, 1);
                    await saveToFirebase('sales', sales);
                    
                    renderSalesList();
                    updateDashboard();
                    renderItems();
                    showNotification('✅ تم النقل', 'تم نقل فاتورة المبيعات إلى سلة المحذوفات', 'success');
                }
            }
        }
        
        function editSale(id) {
            const sale = sales.find(s => s.id === id);
            if (!sale) return;
            
            editingSaleId = id;
            currentSaleItems = JSON.parse(JSON.stringify(sale.items));
            
            document.getElementById('saleDate').value = sale.date;
            document.getElementById('saleCustomer').value = sale.customerId;
            
            // تحديث بيانات العميل
            updateCustomerFields();
            
            document.getElementById('saleCustomerAddress').value = sale.customerAddress || '';
            document.getElementById('saleNotes').value = sale.notes;
            document.getElementById('salePaidAmount').value = sale.paidAmount || 0;
            document.getElementById('saleCode').value = `تعديل SAL${sale.number.toString().padStart(3, '0')}`;
            document.getElementById('saveSaleBtn').textContent = '💾 تحديث الفاتورة';
            
            document.getElementById('applySaleTax').checked = sale.taxApplied ?? true;
            
            renderSaleItems();
            updateSaleTotals();
        }

        // ===== Returns Functions =====
        function showReturnTab(type) {
            document.getElementById('salesReturnContent').classList.remove('active');
            document.getElementById('purchaseReturnContent').classList.remove('active');
            document.getElementById('salesReturnTabBtn').classList.remove('active');
            document.getElementById('purchasesReturnTabBtn').classList.remove('active');

            if (type === 'sales') {
                document.getElementById('salesReturnContent').classList.add('active');
                document.getElementById('salesReturnTabBtn').classList.add('active');
                newSaleReturn();
            } else {
                document.getElementById('purchaseReturnContent').classList.add('active');
                document.getElementById('purchasesReturnTabBtn').classList.add('active');
                newPurchaseReturn();
            }
        }
        
        function newSaleReturn() {
            activeSaleReturn = null;
            document.getElementById('salesReturnInvoiceSearch').value = '';
            document.getElementById('salesReturnInvoiceDetails').style.display = 'none';
            document.getElementById('salesReturnItemsContainer').style.display = 'none';
            document.getElementById('salesReturnItemsList').innerHTML = '';
            document.getElementById('salesReturnTotal').textContent = '0.00';
        }

        function findSaleForReturn() {
            const invoiceNumber = parseInt(document.getElementById('salesReturnInvoiceSearch').value);
            if (isNaN(invoiceNumber)) {
                showNotification('⚠️ رقم غير صحيح', 'الرجاء إدخال رقم فاتورة صحيح', 'warning');
                return;
            }
            
            const sale = sales.find(s => s.number === invoiceNumber);
            if (!sale) {
                showNotification('❌ غير موجود', 'لم يتم العثور على فاتورة بهذا الرقم', 'error');
                newSaleReturn();
                return;
            }

            activeSaleReturn = sale;
            const customer = customers.find(c => c.id === sale.customerId);
            
            const detailsDiv = document.getElementById('salesReturnInvoiceDetails');
            detailsDiv.innerHTML = `
                <p><strong>رقم الفاتورة:</strong> SAL${sale.number.toString().padStart(3, '0')}</p>
                <p><strong>العميل:</strong> ${customer ? customer.name : 'غير معروف'}</p>
                <p><strong>التاريخ:</strong> ${sale.date}</p>
            `;
            detailsDiv.style.display = 'block';

            const itemsTbody = document.getElementById('salesReturnItemsList');
            itemsTbody.innerHTML = '';
            sale.items.forEach(item => {
                const tr = document.createElement('tr');
                tr.dataset.itemId = item.id;
                tr.dataset.price = item.price;
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td><input type="number" class="return-item-qty-input" min="0" max="${item.quantity}" value="0" oninput="updateSaleReturnTotal()"></td>
                `;
                itemsTbody.appendChild(tr);
            });
            
            document.getElementById('salesReturnItemsContainer').style.display = 'block';
            updateSaleReturnTotal();
        }

        function updateSaleReturnTotal() {
            let total = 0;
            document.querySelectorAll('#salesReturnItemsList tr').forEach(tr => {
                const price = parseFloat(tr.dataset.price);
                const qty = parseInt(tr.querySelector('input').value) || 0;
                total += price * qty;
            });
            document.getElementById('salesReturnTotal').textContent = total.toFixed(2);
        }

        async function saveSaleReturn() {
            if (!activeSaleReturn) {
                showNotification('⚠️ لم يتم البحث', 'الرجاء البحث عن فاتورة أولاً', 'warning');
                return;
            }
            
            const returnedItems = [];
            let totalReturnValue = 0;
            document.querySelectorAll('#salesReturnItemsList tr').forEach(tr => {
                const qty = parseInt(tr.querySelector('input').value) || 0;
                if (qty > 0) {
                    const originalItem = activeSaleReturn.items.find(i => i.id == tr.dataset.itemId);
                    returnedItems.push({
                        id: originalItem.id,
                        name: originalItem.name,
                        price: originalItem.price,
                        quantity: qty
                    });
                    totalReturnValue += originalItem.price * qty;
                }
            });

            if (returnedItems.length === 0) {
                showNotification('⚠️ لا يوجد أصناف', 'لم يتم تحديد أي كميات للإرجاع', 'warning');
                return;
            }

            returnedItems.forEach(returnedItem => {
                const itemInStock = items.find(i => i.id === returnedItem.id);
                if (itemInStock) {
                    itemInStock.stock += returnedItem.quantity;
                }
            });

            const newReturn = {
                id: Date.now(),
                number: currentSaleReturnNumber,
                date: new Date().toISOString().split('T')[0],
                originalInvoiceId: activeSaleReturn.id,
                originalInvoiceNumber: activeSaleReturn.number,
                customerId: activeSaleReturn.customerId,
                items: returnedItems,
                total: totalReturnValue
            };


// --- 💡 إضافة جديدة: تحديث الفاتورة الأصلية ---
            // 1. ابحث عن الفاتورة الأصلية في مصفوفة المبيعات
            const originalSaleIndex = sales.findIndex(s => s.id === activeSaleReturn.id);
            
            if (originalSaleIndex > -1) {
                // 2. قم بتحديث قيم الفاتورة الأصلية
                const originalSale = sales[originalSaleIndex];
                
                // خصم قيمة المرتجع من الإجمالي والمتبقي
                originalSale.total = roundCurrency((originalSale.total || 0) - totalReturnValue);
                originalSale.remainingAmount = roundCurrency((originalSale.remainingAmount || 0) - totalReturnValue);
                
                // (اختياري) يمكنك إضافة ملاحظة للفاتورة الأصلية
                originalSale.notes = (originalSale.notes || '') + ` [مرتجع بقيمة: ${totalReturnValue.toFixed(2)}]`;
                
                debugLog('تم تحديث الفاتورة الأصلية:', sales[originalSaleIndex]);
            }
            // --- 💡 نهاية الإضافة ---

            // السطر 7930 يبدأ من هنا
         salesReturns.push(newReturn);
            currentSaleReturnNumber++;
            
            const success1 = await saveToFirebase('salesReturns', salesReturns);
            const success2 = await saveToFirebase('items', items);
            const success3 = await saveToFirebase('sales', sales); // <-- إضافة جديدة: لحفظ التعديل على المبيعات
            
            if (success1 && success2 && success3) { // <-- تعديل الشرط: التأكد من حفظ كل شيء
                showNotification('✅ تم الحفظ', `تم حفظ مرتجع المبيعات رقم SR${newReturn.number.toString().padStart(3, '0')} بنجاح`, 'success');
                newSaleReturn();
                renderSalesReturns();
                updateDashboard();
                renderItems();
                renderSalesList(); // <-- إضافة جديدة: لتحديث قائمة المبيعات وإظهار الرصيد الجديد
            } else {
                showNotification('❌ خطأ', 'حدث خطأ في حفظ البيانات', 'error');
            }
        }

       function renderSalesReturns() {
    const tbody = document.getElementById('salesReturnsList');
    // تعديل رأس الجدول لإضافة عمود الإجراءات
    tbody.parentElement.querySelector('thead tr').innerHTML = `
        <th>رقم المرتجع</th>
        <th>التاريخ</th>
        <th>العميل</th>
        <th>فاتورة البيع الأصلية</th>
        <th>إجمالي القيمة</th>
        <th>الإجراءات</th> 
    `;

    tbody.innerHTML = '';
    if (salesReturns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد مرتجعات مبيعات</td></tr>';
        return;
    }
    salesReturns.forEach(sr => {
        const customer = customers.find(c => c.id === sr.customerId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>SR${sr.number.toString().padStart(3, '0')}</td>
            <td>${sr.date}</td>
            <td>${customer ? customer.name : 'غير معروف'}</td>
            <td>SAL${sr.originalInvoiceNumber.toString().padStart(3, '0')}</td>
            <td>${sr.total.toFixed(2)}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-danger" onclick="deleteSaleReturn(${sr.id})">حذف</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

        function newPurchaseReturn() {
            activePurchaseReturn = null;
            document.getElementById('purchaseReturnInvoiceSearch').value = '';
            document.getElementById('purchaseReturnInvoiceDetails').style.display = 'none';
            document.getElementById('purchaseReturnItemsContainer').style.display = 'none';
            document.getElementById('purchaseReturnItemsList').innerHTML = '';
            document.getElementById('purchaseReturnTotal').textContent = '0.00';
        }

        function findPurchaseForReturn() {
            const invoiceNumber = parseInt(document.getElementById('purchaseReturnInvoiceSearch').value);
            if (isNaN(invoiceNumber)) {
                showNotification('⚠️ رقم غير صحيح', 'الرجاء إدخال رقم فاتورة صحيح', 'warning');
                return;
            }
            
            const purchase = purchases.find(p => p.number === invoiceNumber);
            if (!purchase) {
                showNotification('❌ غير موجود', 'لم يتم العثور على فاتورة بهذا الرقم', 'error');
                newPurchaseReturn();
                return;
            }

            activePurchaseReturn = purchase;
            const supplier = suppliers.find(s => s.id === purchase.supplierId);
            
            const detailsDiv = document.getElementById('purchaseReturnInvoiceDetails');
            detailsDiv.innerHTML = `
                <p><strong>رقم الفاتورة:</strong> PUR${purchase.number.toString().padStart(3, '0')}</p>
                <p><strong>المورد:</strong> ${supplier ? supplier.name : 'غير معروف'}</p>
                <p><strong>التاريخ:</strong> ${purchase.date}</p>
            `;
            detailsDiv.style.display = 'block';

            const itemsTbody = document.getElementById('purchaseReturnItemsList');
            itemsTbody.innerHTML = '';
            purchase.items.forEach(item => {
                const tr = document.createElement('tr');
                tr.dataset.itemId = item.id;
                tr.dataset.price = item.price;
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td><input type="number" class="return-item-qty-input" min="0" max="${item.quantity}" value="0" oninput="updatePurchaseReturnTotal()"></td>
                `;
                itemsTbody.appendChild(tr);
            });
            
            document.getElementById('purchaseReturnItemsContainer').style.display = 'block';
            updatePurchaseReturnTotal();
        }

        function updatePurchaseReturnTotal() {
            let total = 0;
            document.querySelectorAll('#purchaseReturnItemsList tr').forEach(tr => {
                const price = parseFloat(tr.dataset.price);
                const qty = parseInt(tr.querySelector('input').value) || 0;
                total += price * qty;
            });
            document.getElementById('purchaseReturnTotal').textContent = total.toFixed(2);
        }

     async function savePurchaseReturn() {
            if (!activePurchaseReturn) {
                showNotification('⚠️ لم يتم البحث', 'الرجاء البحث عن فاتورة أولاً', 'warning');
                return;
            }
            
            const returnedItems = [];
            let totalReturnValue = 0;
            document.querySelectorAll('#purchaseReturnItemsList tr').forEach(tr => {
                const qty = parseInt(tr.querySelector('input').value) || 0;
                if (qty > 0) {
                    const originalItem = activePurchaseReturn.items.find(i => i.id == tr.dataset.itemId);
                    returnedItems.push({
                        id: originalItem.id,
                        name: originalItem.name,
                        price: originalItem.price,
                        quantity: qty
                    });
                    totalReturnValue += originalItem.price * qty;
                }
            });

            if (returnedItems.length === 0) {
                showNotification('⚠️ لا يوجد كميات', 'لم يتم تحديد أي كميات للإرجاع', 'warning');
                return;
            }

            returnedItems.forEach(returnedItem => {
                const itemInStock = items.find(i => i.id === returnedItem.id);
                if (itemInStock) {
                    itemInStock.stock -= returnedItem.quantity;
                }
            });

            const newReturn = {
                id: Date.now(),
                number: currentPurchaseReturnNumber,
                date: new Date().toISOString().split('T')[0],
                originalInvoiceId: activePurchaseReturn.id,
                originalInvoiceNumber: activePurchaseReturn.number,
                supplierId: activePurchaseReturn.supplierId,
                items: returnedItems,
                total: totalReturnValue
            };

            // --- 💡 إضافة جديدة: تحديث فاتورة الشراء الأصلية ---
            // 1. ابحث عن الفاتورة الأصلية في مصفوفة المشتريات
            const originalPurchaseIndex = purchases.findIndex(p => p.id === activePurchaseReturn.id);

            if (originalPurchaseIndex > -1) {
                // 2. قم بتحديث قيم الفاتورة الأصلية
                const originalPurchase = purchases[originalPurchaseIndex];
                
                // خصم قيمة المرتجع من الإجمالي والمتبقي
                originalPurchase.total = roundCurrency((originalPurchase.total || 0) - totalReturnValue);
                originalPurchase.remainingAmount = roundCurrency((originalPurchase.remainingAmount || 0) - totalReturnValue);
                
                // (اختياري) يمكنك إضافة ملاحظة للفاتورة الأصلية
                originalPurchase.notes = (originalPurchase.notes || '') + ` [مرتجع بقيمة: ${totalReturnValue.toFixed(2)}]`;
                
                debugLog('تم تحديث فاتورة الشراء الأصلية:', purchases[originalPurchaseIndex]);
            }
            // --- 💡 نهاية الإضافة ---

            purchaseReturns.push(newReturn);
            currentPurchaseReturnNumber++;
            
            const success1 = await saveToFirebase('purchaseReturns', purchaseReturns);
            const success2 = await saveToFirebase('items', items);
            const success3 = await saveToFirebase('purchases', purchases); // <-- إضافة جديدة: حفظ المشتريات
            
            if (success1 && success2 && success3) { // <-- تعديل الشرط
                showNotification('✅ تم الحفظ', `تم حفظ مرتجع المGit¹S-PR${newReturn.number.toString().padStart(3, '0')} بنجاح`, 'success');
                newPurchaseReturn();
                renderPurchaseReturns();
                updateDashboard();
                renderItems();
                renderPurchasesList(); // <-- إضافة جديدة: تحديث قائمة المشتريات
            } else {
                showNotification('❌ خطأ', 'حدث خطأ في حفظ البيانات', 'error');
            }
        }
function renderPurchaseReturns() {
    const tbody = document.getElementById('purchaseReturnsList');
    // تعديل رأس الجدول لإضافة عمود الإجراءات
    tbody.parentElement.querySelector('thead tr').innerHTML = `
        <th>رقم المرتجع</th>
        <th>التاريخ</th>
        <th>المورد</th>
        <th>فاتورة الشراء الأصلية</th>
        <th>إجمالي القيمة</th>
        <th>الإجراءات</th>
    `;

    tbody.innerHTML = '';
    if (purchaseReturns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد مرتجعات مشتريات</td></tr>';
        return;
    }
    purchaseReturns.forEach(pr => {
        const supplier = suppliers.find(s => s.id === pr.supplierId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>PR${pr.number.toString().padStart(3, '0')}</td>
            <td>${pr.date}</td>
            <td>${supplier ? supplier.name : 'غير معروف'}</td>
            <td>PUR${pr.originalInvoiceNumber.toString().padStart(3, '0')}</td>
            <td>${pr.total.toFixed(2)}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-danger" onclick="deletePurchaseReturn(${pr.id})">حذف</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

        function calculateTotalStock() {
            return items.reduce((total, item) => total + (parseInt(item.stock) || 0), 0);
        }

        // ===== Expenses and Revenues Functions =====
        async function addExpense() {
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            if (!date || !category || isNaN(amount)) { showNotification('⚠️ بيانات ناقصة', 'يرجى ملء الحقول المطلوبة', 'warning'); return; }

            const expense = { id: Date.now(), date, category, amount, description: document.getElementById('expenseDescription').value, paymentMethod: document.getElementById('expensePaymentMethod').value, reference: document.getElementById('expenseReference').value };
            expenses.push(expense);
            const success = await saveToFirebase('expenses', expenses);
            if (success) {
                clearExpenseForm();
                renderExpenses();
                updateExpenseStats();
                updateDashboard();
            } else {
                showNotification('❌ خطأ', 'حدث خطأ في حفظ البيانات', 'error');
            }
        }

        function renderExpenses() {
            const tbody = document.getElementById('expensesList');
            tbody.innerHTML = '';
            if (expenses.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">لا توجد مصروفات</td></tr>'; return; }
            [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(exp => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${exp.date}</td><td>${exp.category}</td><td>${exp.amount.toFixed(2)}</td><td>${getPaymentMethodName(exp.paymentMethod)}</td><td>${exp.description || '-'}</td><td>${exp.reference || '-'}</td><td><button class="btn-warning edit-btn" onclick="editExpense(${exp.id})">✏️ تعديل</button><button class="btn-danger" onclick="deleteExpense(${exp.id})">حذف</button></td>`;
                tbody.appendChild(tr);
            });
        }
        
        function getPaymentMethodName(method) { return { 'cash': 'نقدي', 'bank': 'تحويل بنكي', 'check': 'شيك', 'card': 'بطاقة ائتمان' }[method] || method; }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expenseCategory').value = expense.category;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseDescription').value = expense.description || '';
            document.getElementById('expensePaymentMethod').value = expense.paymentMethod;
            document.getElementById('expenseReference').value = expense.reference || '';
            const btn = document.querySelector('#expenses .btn-primary');
            btn.textContent = '💾 تحديث المصروف';
            btn.onclick = () => updateExpense(id);
        }

        async function updateExpense(id) {
            const date = document.getElementById('expenseDate').value, category = document.getElementById('expenseCategory').value, amount = parseFloat(document.getElementById('expenseAmount').value);
            if (!date || !category || isNaN(amount)) { showNotification('⚠️ بيانات ناقصة', 'يرجى ملء الحقول المطلوبة', 'warning'); return; }
            const index = expenses.findIndex(e => e.id === id);
            if (index > -1) {
                expenses[index] = { ...expenses[index], date, category, amount, description: document.getElementById('expenseDescription').value, paymentMethod: document.getElementById('expensePaymentMethod').value, reference: document.getElementById('expenseReference').value };
                const success = await saveToFirebase('expenses', expenses);
                if (success) {
                    clearExpenseForm();
                    renderExpenses();
                    updateExpenseStats();
                    showNotification('✅ تم التحديث', 'تم تحديث المصروف بنجاح', 'success');
                } else {
                    showNotification('❌ خطأ', 'حدث خطأ في تحديث البيانات', 'error');
                }
            }
        }
        
        async function deleteExpense(id) {
            const confirmed = await showConfirmDialog(
                'نقل إلى سلة المحذوفات',
                'هل تريد نقل هذا المصروف إلى سلة المحذوفات؟',
                'warning',
                'نقل',
                'إلغاء'
            );
            if (confirmed) {
                const expense = expenses.find(e => e.id === id);
                if (expense) {
                    moveToTrash('expenses', expense);
                    expenses = expenses.filter(e => e.id !== id);
                    const success = await saveToFirebase('expenses', expenses);
                    if (success) {
                        renderExpenses();
                        updateExpenseStats();
                        updateDashboard();
                        showNotification('✅ تم النقل', 'تم نقل المصروف إلى سلة المحذوفات', 'success');
                    } else {
                        showNotification('❌ خطأ', 'حدث خطأ في حذف البيانات', 'error');
                    }
                }
            }
        }
        
        function clearExpenseForm() {
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            ['expenseCategory', 'expenseAmount', 'expenseDescription', 'expenseReference'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('expensePaymentMethod').value = 'cash';
            const btn = document.querySelector('#expenses .btn-primary');
            btn.textContent = '➕ إضافة مصروف';
            btn.onclick = addExpense;
        }

        function updateExpenseStats() {
            const today = new Date().toISOString().split('T')[0];
            const month = today.substring(0, 7);
            const total = expenses.reduce((s, e) => s + e.amount, 0);
            const todayTotal = expenses.filter(e => e.date === today).reduce((s, e) => s + e.amount, 0);
            const monthTotal = expenses.filter(e => e.date.substring(0, 7) === month).reduce((s, e) => s + e.amount, 0);
            document.getElementById('totalExpenses').textContent = total.toFixed(2);
            document.getElementById('todayExpenses').textContent = todayTotal.toFixed(2);
            document.getElementById('monthExpenses').textContent = monthTotal.toFixed(2);
        }
        
        async function addRevenue() {
            const date = document.getElementById('revenueDate').value, category = document.getElementById('revenueCategory').value, amount = parseFloat(document.getElementById('revenueAmount').value);
            if (!date || !category || isNaN(amount)) { showNotification('⚠️ بيانات ناقصة', 'يرجى ملء الحقول المطلوبة', 'warning'); return; }
            const revenue = { id: Date.now(), date, category, amount, source: document.getElementById('revenueSource').value, description: document.getElementById('revenueDescription').value, reference: document.getElementById('revenueReference').value };
            revenues.push(revenue);
            const success = await saveToFirebase('revenues', revenues);
            if (success) {
                clearRevenueForm();
                renderRevenues();
                updateRevenueStats();
                updateDashboard();
            } else {
                showNotification('❌ خطأ', 'حدث خطأ في حفظ البيانات', 'error');
            }
        }
        function renderRevenues() {
            const tbody = document.getElementById('revenuesList');
            tbody.innerHTML = '';
            if (revenues.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">لا توجد إيرادات</td></tr>'; return; }
             [...revenues].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(rev => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${rev.date}</td><td>${rev.category}</td><td>${getRevenueSourceName(rev.source)}</td><td>${rev.amount.toFixed(2)}</td><td>${rev.description || '-'}</td><td>${rev.reference || '-'}</td><td><button class="btn-warning edit-btn" onclick="editRevenue(${rev.id})">✏️ تعديل</button><button class="btn-danger" onclick="deleteRevenue(${rev.id})">حذف</button></td>`;
                tbody.appendChild(tr);
            });
        }
        function getRevenueSourceName(source) { return { 'sales': 'مبيعات', 'services': 'خدمات', 'investment': 'استثمار', 'other': 'أخرى' }[source] || source; }
        function editRevenue(id) {
            const rev = revenues.find(r => r.id === id);
            if (!rev) return;
            document.getElementById('revenueDate').value = rev.date;
            document.getElementById('revenueCategory').value = rev.category;
            document.getElementById('revenueAmount').value = rev.amount;
            document.getElementById('revenueDescription').value = rev.description || '';
            document.getElementById('revenueSource').value = rev.source;
            document.getElementById('revenueReference').value = rev.reference || '';
            const btn = document.querySelector('#revenues .btn-primary');
            btn.textContent = '💾 تحديث الإيراد';
            btn.onclick = () => updateRevenue(id);
        }
        async function updateRevenue(id) {
            const date = document.getElementById('revenueDate').value, category = document.getElementById('revenueCategory').value, amount = parseFloat(document.getElementById('revenueAmount').value);
            if (!date || !category || isNaN(amount)) { showNotification('⚠️ بيانات ناقصة', 'يرجى ملء الحقول المطلوبة', 'warning'); return; }
            const index = revenues.findIndex(r => r.id === id);
            if (index > -1) {
                revenues[index] = { ...revenues[index], date, category, amount, source: document.getElementById('revenueSource').value, description: document.getElementById('revenueDescription').value, reference: document.getElementById('revenueReference').value };
                const success = await saveToFirebase('revenues', revenues);
                if (success) {
                    clearRevenueForm();
                    renderRevenues();
                    updateRevenueStats();
                    showNotification('✅ تم التحديث', 'تم تحديث الإيراد بنجاح', 'success');
                } else {
                    showNotification('❌ خطأ', 'حدث خطأ في تحديث البيانات', 'error');
                }
            }
        }
        async function deleteRevenue(id) {
            const confirmed = await showConfirmDialog(
                'نقل إلى سلة المحذوفات',
                'هل تريد نقل هذا الإيراد إلى سلة المحذوفات؟',
                'warning',
                'نقل',
                'إلغاء'
            );
            if (confirmed) {
                const revenue = revenues.find(r => r.id === id);
                if (revenue) {
                    moveToTrash('revenues', revenue);
                    revenues = revenues.filter(r => r.id !== id);
                    const success = await saveToFirebase('revenues', revenues);
                    if (success) {
                        renderRevenues();
                        updateRevenueStats();
                        updateDashboard();
                        showNotification('✅ تم النقل', 'تم نقل الإيراد إلى سلة المحذوفات', 'success');
                    } else {
                        showNotification('❌ خطأ', 'حدث خطأ في حذف البيانات', 'error');
                    }
                }
            }
        }
        function clearRevenueForm() {
            document.getElementById('revenueDate').value = new Date().toISOString().split('T')[0];
            ['revenueCategory', 'revenueAmount', 'revenueDescription', 'revenueReference'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('revenueSource').value = 'sales';
            const btn = document.querySelector('#revenues .btn-primary');
            btn.textContent = '➕ إضافة إيراد';
            btn.onclick = addRevenue;
        }
        function updateRevenueStats() {
            const today = new Date().toISOString().split('T')[0];
            const month = today.substring(0, 7);
            const total = revenues.reduce((s, r) => s + r.amount, 0);
            const todayTotal = revenues.filter(r => r.date === today).reduce((s, r) => s + r.amount, 0);
            const monthTotal = revenues.filter(r => r.date.substring(0, 7) === month).reduce((s, r) => s + r.amount, 0);
            document.getElementById('totalRevenues').textContent = total.toFixed(2);
            document.getElementById('todayRevenues').textContent = todayTotal.toFixed(2);
            document.getElementById('monthRevenues').textContent = monthTotal.toFixed(2);
        }

        // ===== Salaries Functions =====
        function normalizeAmount(value) {
            const amount = parseFloat(value);
            return Number.isFinite(amount) ? amount : 0;
        }

        function roundCurrency(value) {
            return Math.round((Number(value) || 0) * 100) / 100;
        }

        function formatCurrency(value) {
            const amount = Number(value);
            return Number.isFinite(amount) ? amount.toFixed(2) : '0.00';
        }

        function getSalaryFormValues() {
            const monthInput = document.getElementById('salaryMonth');
            if (!monthInput) return null;
            const getValue = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : '';
            };
            return {
                month: monthInput.value || '',
                employeeName: getValue('salaryEmployeeName').trim(),
                employeeId: getValue('salaryEmployeeId').trim(),
                jobTitle: getValue('salaryJobTitle').trim(),
                basic: getValue('salaryBasic') || '0',
                housing: getValue('salaryHousing') || '0',
                transport: getValue('salaryTransport') || '0',
                otherAllowances: getValue('salaryOtherAllowances') || '0',
                overtime: getValue('salaryOvertime') || '0',
                otherDeductions: getValue('salaryOtherDeductions') || '0',
                notes: getValue('salaryNotes').trim()
            };
        }

        function computeSalaryBreakdown(formData) {
            const basic = roundCurrency(normalizeAmount(formData.basic));
            const housing = roundCurrency(normalizeAmount(formData.housing));
            const transport = roundCurrency(normalizeAmount(formData.transport));
            const otherAllowances = roundCurrency(normalizeAmount(formData.otherAllowances));
            const overtime = roundCurrency(normalizeAmount(formData.overtime));
            const allowancesTotal = roundCurrency(housing + transport + otherAllowances + overtime);
            const gross = roundCurrency(basic + allowancesTotal);
            const gosiBase = Math.min(basic + housing, GOSI_SALARY_CAP);
            const gosiEmployee = roundCurrency(gosiBase * GOSI_RATE);
            const gosiEmployer = roundCurrency(gosiBase * GOSI_RATE);
            const otherDeductions = roundCurrency(normalizeAmount(formData.otherDeductions));
            const net = roundCurrency(gross - gosiEmployee - otherDeductions);

            return {
                basic,
                housing,
                transport,
                otherAllowances,
                overtime,
                allowancesTotal,
                gross,
                gosiEmployee,
                gosiEmployer,
                otherDeductions,
                net
            };
        }

        async function addSalary() {
            const formData = getSalaryFormValues();
            if (!formData) return;
            if (!formData.month || !formData.employeeName || !formData.employeeId) {
                showNotification('⚠️ بيانات ناقصة', 'يرجى إدخال الشهر واسم الموظف والرقم الوطني', 'warning');
                return;
            }
            if (normalizeAmount(formData.basic) <= 0) {
                showNotification('⚠️ راتب غير صحيح', 'يرجى إدخال الراتب الأساسي بشكل صحيح', 'warning');
                return;
            }
            const breakdown = computeSalaryBreakdown(formData);
            const salaryRecord = {
                id: Date.now(),
                month: formData.month,
                employeeName: formData.employeeName,
                employeeId: formData.employeeId,
                jobTitle: formData.jobTitle,
                notes: formData.notes,
                basic: breakdown.basic,
                housing: breakdown.housing,
                transport: breakdown.transport,
                otherAllowances: breakdown.otherAllowances,
                overtime: breakdown.overtime,
                allowancesTotal: breakdown.allowancesTotal,
                gross: breakdown.gross,
                gosiEmployee: breakdown.gosiEmployee,
                gosiEmployer: breakdown.gosiEmployer,
                otherDeductions: breakdown.otherDeductions,
                net: breakdown.net,
                createdAt: new Date().toISOString()
            };

            salaries.push(salaryRecord);
            const success = await saveToFirebase('salaries', salaries);
            if (success) {
                clearSalaryForm();
                renderSalaries();
                updateSalarySummary();
                updateDataStats();
            } else {
                showNotification('❌ خطأ', 'حدث خطأ في حفظ مسير الرواتب', 'error');
            }
        }

        async function updateSalary(id) {
            const formData = getSalaryFormValues();
            if (!formData) return;
            if (!formData.month || !formData.employeeName || !formData.employeeId) {
                showNotification('⚠️ بيانات ناقصة', 'يرجى إدخال الشهر واسم الموظف والرقم الوطني', 'warning');
                return;
            }
            const index = salaries.findIndex(s => s.id === id);
            if (index === -1) return;
            const breakdown = computeSalaryBreakdown(formData);
            const existing = salaries[index];
            salaries[index] = {
                ...existing,
                month: formData.month,
                employeeName: formData.employeeName,
                employeeId: formData.employeeId,
                jobTitle: formData.jobTitle,
                notes: formData.notes,
                basic: breakdown.basic,
                housing: breakdown.housing,
                transport: breakdown.transport,
                otherAllowances: breakdown.otherAllowances,
                overtime: breakdown.overtime,
                allowancesTotal: breakdown.allowancesTotal,
                gross: breakdown.gross,
                gosiEmployee: breakdown.gosiEmployee,
                gosiEmployer: breakdown.gosiEmployer,
                otherDeductions: breakdown.otherDeductions,
                net: breakdown.net,
                updatedAt: new Date().toISOString()
            };

            const success = await saveToFirebase('salaries', salaries);
            if (success) {
                showNotification('✅ تم التحديث', 'تم تحديث مسير الرواتب بنجاح', 'success');
                clearSalaryForm();
                renderSalaries();
                updateSalarySummary();
                updateDataStats();
            } else {
                showNotification('❌ خطأ', 'حدث خطأ في تحديث مسير الرواتب', 'error');
            }
        }

        function editSalary(id) {
            const salary = salaries.find(s => s.id === id);
            if (!salary) return;
            editingSalaryId = id;
            if (document.getElementById('salaryMonth')) document.getElementById('salaryMonth').value = salary.month || '';
            if (document.getElementById('salaryEmployeeName')) document.getElementById('salaryEmployeeName').value = salary.employeeName || '';
            if (document.getElementById('salaryEmployeeId')) document.getElementById('salaryEmployeeId').value = salary.employeeId || '';
            if (document.getElementById('salaryJobTitle')) document.getElementById('salaryJobTitle').value = salary.jobTitle || '';
            if (document.getElementById('salaryBasic')) document.getElementById('salaryBasic').value = formatCurrency(salary.basic);
            if (document.getElementById('salaryHousing')) document.getElementById('salaryHousing').value = formatCurrency(salary.housing);
            if (document.getElementById('salaryTransport')) document.getElementById('salaryTransport').value = formatCurrency(salary.transport);
            if (document.getElementById('salaryOtherAllowances')) document.getElementById('salaryOtherAllowances').value = formatCurrency(salary.otherAllowances);
            if (document.getElementById('salaryOvertime')) document.getElementById('salaryOvertime').value = formatCurrency(salary.overtime);
            if (document.getElementById('salaryOtherDeductions')) document.getElementById('salaryOtherDeductions').value = formatCurrency(salary.otherDeductions);
            if (document.getElementById('salaryNotes')) document.getElementById('salaryNotes').value = salary.notes || '';

            const addBtn = document.querySelector('#salaries .btn-primary');
            if (addBtn) {
                addBtn.textContent = '💾 تحديث المسير';
                addBtn.onclick = () => updateSalary(id);
            }
        }

        async function deleteSalary(id) {
            const confirmed = await showConfirmDialog(
                'حذف مسير الرواتب',
                'هل تريد حذف هذا المسير؟',
                'danger',
                'حذف',
                'إلغاء'
            );
            if (!confirmed) return;
            salaries = salaries.filter(s => s.id !== id);
            const success = await saveToFirebase('salaries', salaries);
            if (success) {
                if (editingSalaryId === id) {
                    clearSalaryForm();
                }
                renderSalaries();
                updateSalarySummary();
                updateDataStats();
            } else {
                showNotification('❌ خطأ', 'حدث خطأ في حذف مسير الرواتب', 'error');
            }
        }

        function clearSalaryForm(skipSummaryUpdate = true) {
            editingSalaryId = null;
            const monthEl = document.getElementById('salaryMonth');
            let monthWasEmpty = false;
            if (monthEl && !monthEl.value) {
                monthEl.value = new Date().toISOString().slice(0, 7);
                monthWasEmpty = true;
            }
            const inputs = ['salaryEmployeeName', 'salaryEmployeeId', 'salaryJobTitle', 'salaryBasic', 'salaryHousing', 'salaryTransport', 'salaryOtherAllowances', 'salaryOvertime', 'salaryOtherDeductions'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            const notesEl = document.getElementById('salaryNotes');
            if (notesEl) notesEl.value = '';

            const addBtn = document.querySelector('#salaries .btn-primary');
            if (addBtn) {
                addBtn.textContent = '➕ حفظ المسير';
                addBtn.onclick = addSalary;
            }

            if (monthWasEmpty || !skipSummaryUpdate) {
                updateSalarySummary();
            }
        }

        function renderSalaries(data = null, isFiltered = false) {
            const tbody = document.getElementById('salariesList');
            if (!tbody) return;
            const source = Array.isArray(data) ? data : salaries;
            tbody.innerHTML = '';
            if (source.length === 0) {
                const message = isFiltered ? 'لا توجد مسيرات مطابقة للبحث' : 'لا توجد مسيرات رواتب مسجلة بعد';
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">${message}</td></tr>`;
                return;
            }

            const sorted = [...source].sort((a, b) => {
                if ((b.month || '') > (a.month || '')) return 1;
                if ((b.month || '') < (a.month || '')) return -1;
                return (a.employeeName || '').localeCompare(b.employeeName || '');
            });

            sorted.forEach(salary => {
                const allowances = typeof salary.allowancesTotal === 'number'
                    ? salary.allowancesTotal
                    : normalizeAmount(salary.housing) + normalizeAmount(salary.transport) + normalizeAmount(salary.otherAllowances) + normalizeAmount(salary.overtime);
                const gross = typeof salary.gross === 'number' ? salary.gross : normalizeAmount(salary.basic) + allowances;
                const gosiEmployee = normalizeAmount(salary.gosiEmployee);
                const otherDeductions = normalizeAmount(salary.otherDeductions);
                const net = typeof salary.net === 'number' ? salary.net : gross - gosiEmployee - otherDeductions;
                const tr = document.createElement('tr');
                if (salary.notes) {
                    tr.title = salary.notes;
                }
                tr.innerHTML = `
                    <td>${salary.employeeName || '-'}</td>
                    <td>${salary.month || '-'}</td>
                    <td>${salary.jobTitle || '-'}</td>
                    <td>${formatCurrency(salary.basic)}</td>
                    <td>${formatCurrency(allowances)}</td>
                    <td>${formatCurrency(gross)}</td>
                    <td>${formatCurrency(gosiEmployee)}</td>
                    <td>${formatCurrency(otherDeductions)}</td>
                    <td>${formatCurrency(net)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-warning edit-btn" onclick="editSalary(${salary.id})">✏️ تعديل</button>
                            <button class="btn-danger" onclick="deleteSalary(${salary.id})">حذف</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateSalarySummary() {
            const monthInput = document.getElementById('salaryMonth');
            const targetMonth = monthInput ? monthInput.value : '';
            const dataset = targetMonth ? salaries.filter(s => s.month === targetMonth) : [...salaries];
            const totals = dataset.reduce((acc, salary) => {
                acc.count += 1;
                const basic = normalizeAmount(salary.basic);
                const housing = normalizeAmount(salary.housing);
                const transport = normalizeAmount(salary.transport);
                const otherAllowances = normalizeAmount(salary.otherAllowances);
                const overtime = normalizeAmount(salary.overtime);
                const allowances = typeof salary.allowancesTotal === 'number' ? salary.allowancesTotal : housing + transport + otherAllowances + overtime;
                const gross = typeof salary.gross === 'number' ? salary.gross : basic + allowances;
                const gosiEmployee = normalizeAmount(salary.gosiEmployee);
                const gosiEmployer = normalizeAmount(salary.gosiEmployer);
                const otherDeductions = normalizeAmount(salary.otherDeductions);
                const net = typeof salary.net === 'number' ? salary.net : gross - gosiEmployee - otherDeductions;

                acc.basic += basic;
                acc.allowances += allowances;
                acc.gross += gross;
                acc.gosi += gosiEmployee;
                acc.gosiEmployer += gosiEmployer;
                acc.otherDeductions += otherDeductions;
                acc.net += net;
                return acc;
            }, { count: 0, basic: 0, allowances: 0, gross: 0, gosi: 0, gosiEmployer: 0, otherDeductions: 0, net: 0 });

            const summaryCount = document.getElementById('salarySummaryCount');
            if (summaryCount) summaryCount.textContent = totals.count;
            const summaryBasic = document.getElementById('salarySummaryBasic');
            if (summaryBasic) summaryBasic.textContent = formatCurrency(totals.basic);
            const summaryAllowances = document.getElementById('salarySummaryAllowances');
            if (summaryAllowances) summaryAllowances.textContent = formatCurrency(totals.allowances);
            const summaryGross = document.getElementById('salarySummaryGross');
            if (summaryGross) summaryGross.textContent = formatCurrency(totals.gross);
            const summaryGosi = document.getElementById('salarySummaryGosi');
            if (summaryGosi) summaryGosi.textContent = formatCurrency(totals.gosi);
            const summaryGosiEmployer = document.getElementById('salarySummaryGosiEmployer');
            if (summaryGosiEmployer) summaryGosiEmployer.textContent = formatCurrency(totals.gosiEmployer);
            const summaryOther = document.getElementById('salarySummaryOtherDeductions');
            if (summaryOther) summaryOther.textContent = formatCurrency(totals.otherDeductions);
            const summaryNet = document.getElementById('salarySummaryNet');
            if (summaryNet) summaryNet.textContent = formatCurrency(totals.net);

            const miniStat = document.getElementById('miniStatSalaries');
            if (miniStat) miniStat.textContent = formatCurrency(totals.net);
        }

        // ===== Reports Functions =====
        function updateReportItemFilter() {
            const filterType = document.getElementById('reportItemFilter').value;
            const specificItemSelect = document.getElementById('reportSpecificItem');
            if (filterType === 'specific') {
                specificItemSelect.style.display = 'block';
                specificItemSelect.innerHTML = '<option value="">اختر الصنف</option>';
                items.forEach(item => {
                    specificItemSelect.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                });
            } else {
                specificItemSelect.style.display = 'none';
                specificItemSelect.value = '';
            }
        }
        
        function changeReportType() {
            const reportType = document.getElementById('reportType').value;
            const isInvoiceReport = (reportType === 'sales' || reportType === 'purchases' || reportType === 'sales_returns' || reportType === 'purchase_returns');
            
            // إظهار/إخفاء فلترة الأصناف
            document.getElementById('reportItemFilter').style.display = isInvoiceReport ? 'inline-block' : 'none';
            document.getElementById('reportSpecificItem').style.display = 'none';
            
            // إظهار/إخفاء فلتر حالة الدفع (فقط للمبيعات والمشتريات وليس المرتجعات)
            document.getElementById('paymentStatusFilter').style.display = (reportType === 'sales' || reportType === 'purchases') ? 'inline-block' : 'none';

            const supplierFilter = document.getElementById('reportSupplierFilter');
            const customerFilter = document.getElementById('reportCustomerFilter');

            supplierFilter.style.display = 'none';
            customerFilter.style.display = 'none';

            if (reportType === 'purchases' || reportType === 'purchase_returns') {
                supplierFilter.style.display = 'inline-block';
                supplierFilter.innerHTML = '<option value="all">كل الموردين</option>';
                suppliers.forEach(supplier => {
                    supplierFilter.innerHTML += `<option value="${supplier.id}">${supplier.name}</option>`;
                });
            } else if (reportType === 'sales' || reportType === 'sales_returns') {
                customerFilter.style.display = 'inline-block';
                customerFilter.innerHTML = '<option value="all">كل العملاء</option>';
                customers.forEach(customer => {
                    customerFilter.innerHTML += `<option value="${customer.id}">${customer.name}</option>`;
                });
            }
        }


function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const fromDate = document.getElementById('reportFrom').value;
    const toDate = document.getElementById('reportTo').value;
    const paymentStatus = document.getElementById('paymentStatusFilter').value;
    const itemFilterType = document.getElementById('reportItemFilter').value;
    const specificItemId = parseInt(document.getElementById('reportSpecificItem').value);
    
    const selectedSupplierId = document.getElementById('reportSupplierFilter').value;
    const selectedCustomerId = document.getElementById('reportCustomerFilter').value;

    let data = [];
    let reportTitle = '';
    let tableHeaders = '';
    let tableBody = '';
    let summary = {
        count: 0,
        totalAmount: 0,
        totalPaid: 0,
        totalRemaining: 0,
        totalBasic: 0,
        totalAllowances: 0,
        totalGross: 0,
        totalGosiEmployee: 0,
        totalGosiEmployer: 0,
        totalOtherDeductions: 0,
        totalNet: 0
    };

    switch (reportType) {
        case 'sales': {
            reportTitle = 'تقرير المبيعات';
            tableHeaders = `<th>رقم الفاتورة</th><th>التاريخ</th><th>العميل</th><th>الإجمالي</th><th>المدفوع</th><th>المتبقي</th>`;
            let src = Array.isArray(sales) ? sales : [];
            data = src.filter(s => (!fromDate || s.date >= fromDate) && (!toDate || s.date <= toDate));
            
            if (selectedCustomerId !== 'all') {
                data = data.filter(s => s.customerId == selectedCustomerId);
            }
            break;
        }
        case 'purchases': {
            reportTitle = 'تقرير المشتريات';
            tableHeaders = `<th>رقم الفاتورة</th><th>التاريخ</th><th>المورد</th><th>الإجمالي</th><th>المدفوع</th><th>المتبقي</th>`;
            let src = Array.isArray(purchases) ? purchases : [];
            data = src.filter(p => (!fromDate || p.date >= fromDate) && (!toDate || p.date <= toDate));

            if (selectedSupplierId !== 'all') {
                data = data.filter(p => p.supplierId == selectedSupplierId);
            }
            break;
        }
        case 'sales_returns': {
            reportTitle = 'تقرير مرتجعات المبيعات';
            tableHeaders = `<th>رقم المرتجع</th><th>التاريخ</th><th>العميل</th><th>الفاتورة الأصلية</th><th>إجمالي المرتجع</th>`;
            let src = Array.isArray(salesReturns) ? salesReturns : [];
            data = src.filter(r => (!fromDate || r.date >= fromDate) && (!toDate || r.date <= toDate));
            
            if (selectedCustomerId !== 'all') {
                data = data.filter(r => r.customerId == selectedCustomerId);
            }
            break;
        }
        case 'purchase_returns': {
            reportTitle = 'تقرير مرتجعات المشتريات';
            tableHeaders = `<th>رقم المرتجع</th><th>التاريخ</th><th>المورد</th><th>الفاتورة الأصلية</th><th>إجمالي المرتجع</th>`;
            let src = Array.isArray(purchaseReturns) ? purchaseReturns : [];
            data = src.filter(r => (!fromDate || r.date >= fromDate) && (!toDate || r.date <= toDate));

            if (selectedSupplierId !== 'all') {
                data = data.filter(r => r.supplierId == selectedSupplierId);
            }
            break;
        }
        case 'expenses': {
            reportTitle = 'تقرير المصروفات';
            tableHeaders = `<th>التاريخ</th><th>التصنيف</th><th>الوصف</th><th>المبلغ</th>`;
            const src = Array.isArray(expenses) ? expenses : [];
            data = src.filter(e => (!fromDate || e.date >= fromDate) && (!toDate || e.date <= toDate));
            break;
        }
        case 'revenues': {
            reportTitle = 'تقرير الإيرادات';
            tableHeaders = `<th>التاريخ</th><th>التصنيف</th><th>المصدر</th><th>المبلغ</th>`;
            const src = Array.isArray(revenues) ? revenues : [];
            data = src.filter(r => (!fromDate || r.date >= fromDate) && (!toDate || r.date <= toDate));
            break;
        }
        case 'salaries': {
            reportTitle = 'تقرير الرواتب';
            tableHeaders = `<th>الموظف</th><th>الشهر</th><th>المسمى الوظيفي</th><th>الراتب الأساسي</th><th>البدلات</th><th>الإجمالي</th><th>استقطاع GOSI</th><th>مساهمة جهة العمل</th><th>استقطاعات أخرى</th><th>صافي الراتب</th>`;
            const src = Array.isArray(salaries) ? salaries : [];
            data = src.filter(salary => {
                if (!salary) return false;
                const monthValue = salary.month ? `${salary.month}-01` : '';
                const afterFrom = !fromDate || (monthValue && monthValue >= fromDate);
                const beforeTo = !toDate || (monthValue && monthValue <= toDate);
                return afterFrom && beforeTo;
            });
            break;
        }
        case 'profit_loss': {
            reportTitle = 'تقرير الربح والخسارة';

            const filteredSales = (Array.isArray(sales) ? sales : [])
                .filter(s => (!fromDate || s.date >= fromDate) && (!toDate || s.date <= toDate));
            const filteredExpenses = (Array.isArray(expenses) ? expenses : [])
                .filter(e => (!fromDate || e.date >= fromDate) && (!toDate || e.date <= toDate));

            const totalSalesRevenue = filteredSales.reduce((sum, sale) => sum + (Number(sale.total) || 0), 0);
            const totalCOGS = calculateCOGS(filteredSales);
            const grossProfit = totalSalesRevenue - totalCOGS;
            const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + (Number(expense.amount) || 0), 0);
            const netProfit = grossProfit - totalExpenses;

            let summaryHtml = `<h3>ملخص ${reportTitle}</h3>
                <p><strong>الفترة من:</strong> ${fromDate || '-'} <strong>إلى:</strong> ${toDate || '-'}</p>`;
            document.getElementById('reportSummary').innerHTML = summaryHtml;

            let resultsHtml = `
                <h3 style="margin-top:20px;">نتائج التقرير</h3>
                <table style="text-align: right;">
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;"><strong>إجمالي إيرادات المبيعات</strong></td>
                        <td style="padding: 10px; color: var(--success-color); font-weight: bold;">${totalSalesRevenue.toFixed(2)}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">(-) تكلفة البضاعة المباعة</td>
                        <td style="padding: 10px; color: var(--accent-color);">${totalCOGS.toFixed(2)}</td>
                    </tr>
                    <tr style="border-bottom: 2px solid #333; font-size: 1.1em;">
                        <td style="padding: 10px;"><strong>(=) مجمل الربح</strong></td>
                        <td style="padding: 10px; font-weight: bold;">${grossProfit.toFixed(2)}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px; padding-top: 20px;">(-) إجمالي المصروفات</td>
                        <td style="padding: 10px; padding-top: 20px; color: var(--accent-color);">${totalExpenses.toFixed(2)}</td>
                    </tr>
                    <tr style="background: ${netProfit >= 0 ? 'var(--success-color)' : 'var(--accent-color)'}; color: white; font-size: 1.2em; border-radius: 8px;">
                        <td style="padding: 15px;"><strong>(=) صافي الربح / الخسارة</strong></td>
                        <td style="padding: 15px; font-weight: bold;">${netProfit.toFixed(2)}</td>
                    </tr>
                </table>`;
            document.getElementById('reportResults').innerHTML = resultsHtml;
            return;
        }
    }

    if (reportType === 'sales' || reportType === 'purchases') {
        if (paymentStatus === 'paid' || paymentStatus === 'unpaid') {
            data = data.filter(inv => {
                const total = Number(inv.total) || 0;
                const paid = Number(inv.paidAmount) || 0;
                const remaining = total - paid;
                
                if (paymentStatus === 'paid') {
                    return remaining <= 0.01;
                } else {
                    return remaining > 0.01;
                }
            });
        }
    }

    if ((reportType === 'sales' || reportType === 'purchases' || reportType === 'sales_returns' || reportType === 'purchase_returns')
        && itemFilterType === 'specific' && specificItemId) {
        data = data.filter(invoice =>
            Array.isArray(invoice.items) && invoice.items.some(it => it.id === specificItemId)
        );
    }

if (data.length > 0) {
    data.forEach(item => {
        if (reportType === 'sales') {
            const customer = (Array.isArray(customers) ? customers : []).find(c => c.id === item.customerId);
            const total = Number(item.total) || 0;
            const paid  = Number(item.paidAmount) || 0;
            const remaining = total - paid;

            tableBody += `<tr>
                <td>SAL${item.number.toString().padStart(3, '0')}</td>
                <td>${item.date}</td>
                <td>${customer ? customer.name : 'غير معروف'}</td>
                <td>${total.toFixed(2)}</td>
                <td>${paid.toFixed(2)}</td>
                <td class="${Math.abs(remaining) <= 0.01 ? 'remaining-paid' : 'remaining-unpaid'}">${remaining.toFixed(2)}</td>
            </tr>`;

            summary.totalAmount += total;
            summary.totalPaid   += paid;
            summary.totalRemaining += remaining;

        } else if (reportType === 'purchases') {
            const supplier = (Array.isArray(suppliers) ? suppliers : []).find(s => s.id === item.supplierId);
            const total = Number(item.total) || 0;
            const paid  = Number(item.paidAmount) || 0;
            const remaining = total - paid;

            tableBody += `<tr>
                <td>PUR${item.number.toString().padStart(3, '0')}</td>
                <td>${item.date}</td>
                <td>${supplier ? supplier.name : 'غير معروف'}</td>
                <td>${total.toFixed(2)}</td>
                <td>${paid.toFixed(2)}</td>
                <td class="${Math.abs(remaining) <= 0.01 ? 'remaining-paid' : 'remaining-unpaid'}">${remaining.toFixed(2)}</td>
            </tr>`;

            summary.totalAmount += total;
            summary.totalPaid   += paid;
            summary.totalRemaining += remaining;

        } else if (reportType === 'sales_returns') {
            const customer = (Array.isArray(customers) ? customers : []).find(c => c.id === item.customerId);
            const total = Number(item.total) || 0;
            const originalSale = (Array.isArray(sales) ? sales : []).find(s => s.id === item.saleId);
            const originalInvoiceNumber = originalSale ? `SAL${originalSale.number.toString().padStart(3, '0')}` : '-';

            tableBody += `<tr>
                <td>SR${item.number.toString().padStart(3, '0')}</td>
                <td>${item.date}</td>
                <td>${customer ? customer.name : 'غير معروف'}</td>
                <td>${originalInvoiceNumber}</td>
                <td>${total.toFixed(2)}</td>
            </tr>`;

            summary.totalAmount += total;

        } else if (reportType === 'purchase_returns') {
            const supplier = (Array.isArray(suppliers) ? suppliers : []).find(s => s.id === item.supplierId);
            const total = Number(item.total) || 0;
            const originalPurchase = (Array.isArray(purchases) ? purchases : []).find(p => p.id === item.purchaseId);
            const originalInvoiceNumber = originalPurchase ? `PUR${originalPurchase.number.toString().padStart(3, '0')}` : '-';

            tableBody += `<tr>
                <td>PR${item.number.toString().padStart(3, '0')}</td>
                <td>${item.date}</td>
                <td>${supplier ? supplier.name : 'غير معروف'}</td>
                <td>${originalInvoiceNumber}</td>
                <td>${total.toFixed(2)}</td>
            </tr>`;

            summary.totalAmount += total;

        } else if (reportType === 'expenses') {
                const amount = Number(item.amount) || 0;
                tableBody += `<tr>
                    <td>${item.date}</td>
                    <td>${item.category}</td>
                    <td>${item.description || '-'}</td>
                    <td>${amount.toFixed(2)}</td>
                </tr>`;
                summary.totalAmount += amount;

            } else if (reportType === 'revenues') {
                const amount = Number(item.amount) || 0;
                tableBody += `<tr>
                    <td>${item.date}</td>
                    <td>${item.category}</td>
                    <td>${getRevenueSourceName(item.source)}</td>
                    <td>${amount.toFixed(2)}</td>
                </tr>`;
                summary.totalAmount += amount;
                } else if (reportType === 'salaries') {
                    const basic = normalizeAmount(item.basic);
                    const housing = normalizeAmount(item.housing);
                    const transport = normalizeAmount(item.transport);
                    const otherAllowances = normalizeAmount(item.otherAllowances);
                    const overtime = normalizeAmount(item.overtime);
                    const allowances = typeof item.allowancesTotal === 'number' ? item.allowancesTotal : housing + transport + otherAllowances + overtime;
                    const gross = typeof item.gross === 'number' ? item.gross : basic + allowances;
                    const gosiEmployee = normalizeAmount(item.gosiEmployee);
                    const gosiEmployer = normalizeAmount(item.gosiEmployer);
                    const otherDeductions = normalizeAmount(item.otherDeductions);
                    const net = typeof item.net === 'number' ? item.net : gross - gosiEmployee - otherDeductions;

                    tableBody += `<tr>
                        <td>${item.employeeName || '-'}</td>
                        <td>${item.month || '-'}</td>
                        <td>${item.jobTitle || '-'}</td>
                        <td>${formatCurrency(basic)}</td>
                        <td>${formatCurrency(allowances)}</td>
                        <td>${formatCurrency(gross)}</td>
                        <td>${formatCurrency(gosiEmployee)}</td>
                        <td>${formatCurrency(gosiEmployer)}</td>
                        <td>${formatCurrency(otherDeductions)}</td>
                        <td>${formatCurrency(net)}</td>
                    </tr>`;

                    summary.totalBasic += basic;
                    summary.totalAllowances += allowances;
                    summary.totalGross += gross;
                    summary.totalGosiEmployee += gosiEmployee;
                    summary.totalGosiEmployer += gosiEmployer;
                    summary.totalOtherDeductions += otherDeductions;
                    summary.totalNet += net;
                    summary.totalAmount += net;
            }
        });
        summary.count = data.length;
    }

    const summaryDiv = document.getElementById('reportSummary');
    let summaryHtml = `<h3>ملخص ${reportTitle}</h3>`;
    if (reportType === 'sales' || reportType === 'purchases') {
        summaryHtml += `
            <p><strong>عدد الفواتير:</strong> ${summary.count}</p>
            <p><strong>إجمالي المبالغ:</strong> ${summary.totalAmount.toFixed(2)}</p>
            <p><strong>إجمالي المدفوع:</strong> ${summary.totalPaid.toFixed(2)}</p>
            <p><strong>إجمالي المتبقي:</strong> ${summary.totalRemaining.toFixed(2)}</p>`;
    } else if (reportType === 'sales_returns' || reportType === 'purchase_returns') {
        summaryHtml += `
            <p><strong>عدد المرتجعات:</strong> ${summary.count}</p>
            <p><strong>إجمالي قيمة المرتجعات:</strong> ${summary.totalAmount.toFixed(2)}</p>`;
    } else if (reportType === 'salaries') {
        summaryHtml += `
            <p><strong>عدد المسيرات:</strong> ${summary.count}</p>
            <p><strong>إجمالي الرواتب الأساسية:</strong> ${summary.totalBasic.toFixed(2)}</p>
            <p><strong>إجمالي البدلات:</strong> ${summary.totalAllowances.toFixed(2)}</p>
            <p><strong>إجمالي الرواتب:</strong> ${summary.totalGross.toFixed(2)}</p>
            <p><strong>إجمالي استقطاعات GOSI للموظفين:</strong> ${summary.totalGosiEmployee.toFixed(2)}</p>
            <p><strong>إجمالي مساهمات جهة العمل في GOSI:</strong> ${summary.totalGosiEmployer.toFixed(2)}</p>
            <p><strong>إجمالي الاستقطاعات الأخرى:</strong> ${summary.totalOtherDeductions.toFixed(2)}</p>
            <p><strong>إجمالي صافي الرواتب:</strong> ${summary.totalNet.toFixed(2)}</p>`;
    } else {
        summaryHtml += `
            <p><strong>عدد السجلات:</strong> ${summary.count}</p>
            <p><strong>إجمالي المبالغ:</strong> ${summary.totalAmount.toFixed(2)}</p>`;
    }
    summaryDiv.innerHTML = summaryHtml;

    const resultsDiv = document.getElementById('reportResults');
    if (tableBody) {
        if (reportType === 'sales' || reportType === 'purchases') {
            tableBody += `<tr class="report-total-row">
                <td colspan="3">الإجمالي</td>
                <td>${summary.totalAmount.toFixed(2)}</td>
                <td>${summary.totalPaid.toFixed(2)}</td>
                <td>${summary.totalRemaining.toFixed(2)}</td>
            </tr>`;
        } else if (reportType === 'sales_returns' || reportType === 'purchase_returns') {
            tableBody += `<tr class="report-total-row">
                <td colspan="4">الإجمالي</td>
                <td>${summary.totalAmount.toFixed(2)}</td>
            </tr>`;
        } else if (reportType === 'salaries') {
            tableBody += `<tr class="report-total-row">
                <td colspan="3">الإجمالي</td>
                <td>${summary.totalBasic.toFixed(2)}</td>
                <td>${summary.totalAllowances.toFixed(2)}</td>
                <td>${summary.totalGross.toFixed(2)}</td>
                <td>${summary.totalGosiEmployee.toFixed(2)}</td>
                <td>${summary.totalGosiEmployer.toFixed(2)}</td>
                <td>${summary.totalOtherDeductions.toFixed(2)}</td>
                <td>${summary.totalNet.toFixed(2)}</td>
            </tr>`;
        } else {
            tableBody += `<tr class="report-total-row">
                <td colspan="3">الإجمالي</td>
                <td>${summary.totalAmount.toFixed(2)}</td>
            </tr>`;
        }

        resultsDiv.innerHTML = `
            <h3 style="margin-top:20px;">نتائج التقرير</h3>
            <table>
                <thead><tr>${tableHeaders}</tr></thead>
                <tbody>${tableBody}</tbody>
            </table>`;
    } else {
        resultsDiv.innerHTML = `<p style="text-align: center; margin-top: 20px;">لا توجد بيانات لعرضها حسب الفلاتر المحددة.</p>`;
    }
}


        function exportToExcel() {
            const reportTable = document.querySelector("#reportResults table");
            if (!reportTable) {
                showNotification('⚠️ لا يوجد تقرير', 'يرجى عرض تقرير أولاً قبل التصدير', 'warning');
                return;
            }

            let csv = [];
            const headers = [];
            reportTable.querySelectorAll("thead th").forEach(header => headers.push(`"${header.innerText}"`));
            csv.push(headers.join(','));

            reportTable.querySelectorAll("tbody tr").forEach(row => {
                const rowData = [];
                row.querySelectorAll("td").forEach(cell => rowData.push(`"${cell.innerText}"`));
                csv.push(rowData.join(','));
            });

            const csvContent = "data:text/csv;charset=utf-8," + '\uFEFF' + csv.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const reportType = document.getElementById('reportType').value;
            link.setAttribute("download", `report_${reportType}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToWeb() {
            const reportResultsHTML = document.getElementById('reportResults').innerHTML;
            const reportSummaryHTML = document.getElementById('reportSummary').innerHTML;

            if (!reportResultsHTML.trim() || reportResultsHTML.includes("لا توجد بيانات")) {
                showNotification('⚠️ لا يوجد تقرير', 'يرجى عرض تقرير أولاً قبل التصدير', 'warning');
                return;
            }
            
            const reportType = document.getElementById('reportType').value;
            const reportTitle = `تقرير ${document.querySelector(`#reportType option[value='${reportType}']`).textContent}`;

            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                    <head>
                        <title>${reportTitle}</title>
                        <meta charset="UTF-8">
                        <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">



                        <style>
                            body { font-family: 'Tajawal', sans-serif; direction: rtl; padding: 20px; color: #2c3e50; }
                            h1, h3 { color: #2c5aa0; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 14px; }
                            th, td { border: 1px solid #ddd; padding: 10px; text-align: right; }
                            th { background-color: #2c5aa0; color: white; }
                            tr:nth-child(even) { background-color: #f8f9fa; }
                            .report-summary { border: 1px solid #ddd; border-right: 5px solid #2c5aa0; padding: 15px; margin-bottom: 20px; background: #f8f9fa; border-radius: 8px; }
                            .report-total-row { font-weight: bold; background-color: #34495e; color: white; }
                            .remaining-paid { color: #27ae60; font-weight: bold; }
                            .remaining-unpaid { color: #e74c3c; font-weight: bold; }
                            @media print {
                                body { padding: 10px; }
                                button { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>${reportTitle}</h1>
                        <div class="report-summary">${reportSummaryHTML}</div>
                        ${reportResultsHTML}
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="window.print()" style="padding: 10px 20px; background: #2c5aa0; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">🖨️ طباعة</button>
                            <button onclick="window.close()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-right: 10px;">✖️ إغلاق</button>
                        </div>
                    </body>
                </html>
            `);
            newWindow.document.close();
        }

        // ===== Data Management Functions =====
        function ensureActivitySelected() {
            if (!currentActivityId) {
                showNotification('⚠️ لم يتم الاختيار', 'الرجاء اختيار نشاط قبل تنفيذ هذه العملية', 'warning');
                return false;
            }
            return true;
        }

        async function refreshActivityData() {
            if (!currentActivityId) return;
            await initializeApp();
        }

        function updateDataStats() {
            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };
            setText('dataItemsCount', items.length);
            setText('dataCustomersCount', customers.length);
            setText('dataSuppliersCount', suppliers.length);
            setText('dataPurchasesCount', purchases.length);
            setText('dataSalesCount', sales.length);
            setText('dataExpensesCount', expenses.length);
            setText('dataRevenuesCount', revenues.length);
            setText('dataSalariesCount', salaries.length);
            setText('dataStockQuantity', calculateTotalStock());
            const hasActivity = Boolean(currentActivityId);
            let lastBackupText = 'غير متاح';
            if (hasActivity) {
                const backupKey = getActivityDataKey('lastBackup');
                const lastBackup = backupKey ? localStorage.getItem(backupKey) : null;
                lastBackupText = lastBackup ? new Date(lastBackup).toLocaleDateString('ar-SA') : 'لا يوجد';
            }
            setText('dataLastBackup', lastBackupText);
        }

        function exportActivityData() {
            if (!ensureActivitySelected()) return;
            const activity = activities.find(a => a.id == currentActivityId);
            const activityData = { items, customers, suppliers, purchases, sales, expenses, revenues, salaries, salesReturns, purchaseReturns, exportDate: new Date().toISOString(), system: 'نظام الديوان المحاسبي', activityName: activity ? activity.name : 'غير معروف' };
            const dataStr = JSON.stringify(activityData, null, 2);
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([dataStr], {type: 'application/json'}));
            link.download = `الديوان_${activity ? activity.name.replace(/\s/g, '_') : 'بيانات'}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showNotification('✅ تم التصدير', 'تم تصدير بيانات النشاط الحالي بنجاح', 'success');
        }

        function exportActivityDataExcel() {
            if (!ensureActivitySelected()) return;
            if (!window.XLSX || !XLSX.utils || typeof XLSX.utils.book_new !== 'function') {
                showNotification('❌ خطأ', 'مكتبة Excel غير متاحة حالياً. يرجى تحديث الصفحة ثم المحاولة مرة أخرى', 'error');
                return;
            }

            const activity = activities.find(a => a.id == currentActivityId);
            const workbook = XLSX.utils.book_new();
            const todayISO = new Date().toISOString();
            const todayDate = todayISO.split('T')[0];

            const safeSheetName = (name) => {
                if (!name) return 'Sheet';
                const invalidChars = /[:\\\/?*\[\]]/g;
                const cleaned = name.replace(invalidChars, ' ');
                return cleaned.length > 30 ? cleaned.substring(0, 27) + '...' : cleaned;
            };

            const formatDocNumber = (prefix, number) => {
                if (typeof number === 'number') {
                    return `${prefix}${number.toString().padStart(3, '0')}`;
                }
                return `${prefix}${number || ''}`;
            };

            const formatItemsList = (list) => {
                if (!Array.isArray(list) || list.length === 0) return '';
                return list.map(item => {
                    const name = item && item.name ? item.name : '';
                    const qty = item && typeof item.quantity === 'number' ? item.quantity : 0;
                    const price = item && typeof item.price === 'number' ? item.price : 0;
                    return `${name} x${qty} @${price}`;
                }).join('\n');
            };

            const appendSheet = (rows, title) => {
                const preparedRows = (Array.isArray(rows) && rows.length) ? rows : [{ 'لا توجد بيانات': '' }];
                const worksheet = XLSX.utils.json_to_sheet(preparedRows);
                XLSX.utils.book_append_sheet(workbook, worksheet, safeSheetName(title));
            };

            const summaryRows = [
                { 'المؤشر': 'اسم النشاط', 'القيمة': activity ? activity.name : 'غير معروف' },
                { 'المؤشر': 'تاريخ التصدير', 'القيمة': new Date().toLocaleString('ar-SA') },
                { 'المؤشر': 'عدد الأصناف', 'القيمة': items.length },
                { 'المؤشر': 'عدد العملاء', 'القيمة': customers.length },
                { 'المؤشر': 'عدد الموردين', 'القيمة': suppliers.length },
                { 'المؤشر': 'عدد فواتير المشتريات', 'القيمة': purchases.length },
                { 'المؤشر': 'عدد فواتير المبيعات', 'القيمة': sales.length },
                { 'المؤشر': 'عدد المصروفات', 'القيمة': expenses.length },
                { 'المؤشر': 'عدد الإيرادات', 'القيمة': revenues.length },
                { 'المؤشر': 'عدد مسيرات الرواتب', 'القيمة': salaries.length }
            ];
            appendSheet(summaryRows, 'ملخص');

            appendSheet(items.map(item => ({
                'رمز الصنف': item.code || '',
                'اسم الصنف': item.name || '',
                'تكلفة الشراء': typeof item.cost === 'number' ? item.cost : Number(item.cost) || 0,
                'سعر البيع': typeof item.price === 'number' ? item.price : Number(item.price) || 0,
                'المخزون الحالي': typeof item.stock === 'number' ? item.stock : Number(item.stock) || 0
            })), 'الأصناف');

            appendSheet(customers.map(customer => ({
                'رمز العميل': customer.code || '',
                'اسم العميل': customer.name || '',
                'رقم الجوال': customer.phone || '',
                'البريد الإلكتروني': customer.email || '',
                'العنوان': customer.address || ''
            })), 'العملاء');

            appendSheet(suppliers.map(supplier => ({
                'رمز المورد': supplier.code || '',
                'اسم المورد': supplier.name || '',
                'رقم الجوال': supplier.phone || '',
                'البريد الإلكتروني': supplier.email || '',
                'العنوان': supplier.address || ''
            })), 'الموردون');

            appendSheet(purchases.map(purchase => {
                const supplier = suppliers.find(s => s.id === purchase.supplierId);
                const remaining = (purchase && typeof purchase.remainingAmount === 'number')
                    ? purchase.remainingAmount
                    : (purchase.total || 0) - (purchase.paidAmount || 0);
                return {
                    'رقم الفاتورة': formatDocNumber('PUR', purchase.number),
                    'التاريخ': purchase.date || '',
                    'المورد': supplier ? supplier.name : '',
                    'عدد الأصناف': Array.isArray(purchase.items) ? purchase.items.length : 0,
                    'قيمة المشتريات': typeof purchase.total === 'number' ? purchase.total : Number(purchase.total) || 0,
                    'المدفوع': typeof purchase.paidAmount === 'number' ? purchase.paidAmount : Number(purchase.paidAmount) || 0,
                    'المتبقي': remaining,
                    'الأصناف التفصيلية': formatItemsList(purchase.items),
                    'ملاحظات': purchase.notes || ''
                };
            }), 'فواتير المشتريات');

            appendSheet(sales.map(sale => {
                const customer = customers.find(c => c.id === sale.customerId);
                const remaining = (sale && typeof sale.remainingAmount === 'number')
                    ? sale.remainingAmount
                    : (sale.total || 0) - (sale.paidAmount || 0);
                return {
                    'رقم الفاتورة': formatDocNumber('SAL', sale.number),
                    'التاريخ': sale.date || '',
                    'العميل': customer ? customer.name : '',
                    'عدد الأصناف': Array.isArray(sale.items) ? sale.items.length : 0,
                    'إجمالي الفاتورة': typeof sale.total === 'number' ? sale.total : Number(sale.total) || 0,
                    'المدفوع': typeof sale.paidAmount === 'number' ? sale.paidAmount : Number(sale.paidAmount) || 0,
                    'المتبقي': remaining,
                    'تم احتساب الضريبة': sale.taxApplied === false ? 'لا' : 'نعم',
                    'الأصناف التفصيلية': formatItemsList(sale.items),
                    'ملاحظات': sale.notes || ''
                };
            }), 'فواتير المبيعات');

            appendSheet(expenses.map(expense => ({
                'التاريخ': expense.date || '',
                'التصنيف': expense.category || '',
                'المبلغ': typeof expense.amount === 'number' ? expense.amount : Number(expense.amount) || 0,
                'طريقة الدفع': getPaymentMethodName ? getPaymentMethodName(expense.paymentMethod) : (expense.paymentMethod || ''),
                'المرجع': expense.reference || '',
                'الوصف': expense.description || ''
            })), 'المصروفات');

            appendSheet(revenues.map(revenue => ({
                'التاريخ': revenue.date || '',
                'التصنيف': revenue.category || '',
                'المصدر': getRevenueSourceName ? getRevenueSourceName(revenue.source) : (revenue.source || ''),
                'المبلغ': typeof revenue.amount === 'number' ? revenue.amount : Number(revenue.amount) || 0,
                'المرجع': revenue.reference || '',
                'الوصف': revenue.description || ''
            })), 'الإيرادات');

            appendSheet(salaries.map(salary => ({
                'اسم الموظف': salary.employeeName || '',
                'رقم الهوية': salary.employeeId || '',
                'شهر الاستحقاق': salary.month || '',
                'سعودي؟': salary.isSaudi ? 'نعم' : 'لا',
                'الراتب الأساسي': typeof salary.basic === 'number' ? salary.basic : Number(salary.basic) || 0,
                'بدل السكن': typeof salary.housing === 'number' ? salary.housing : Number(salary.housing) || 0,
                'بدل النقل': typeof salary.transport === 'number' ? salary.transport : Number(salary.transport) || 0,
                'بدلات أخرى': typeof salary.otherAllowances === 'number' ? salary.otherAllowances : Number(salary.otherAllowances) || 0,
                'ساعات إضافية': typeof salary.overtime === 'number' ? salary.overtime : Number(salary.overtime) || 0,
                'إجمالي الراتب': typeof salary.gross === 'number' ? salary.gross : Number(salary.gross) || 0,
                'استقطاع التأمينات (GOSI)': typeof salary.gosiEmployee === 'number' ? salary.gosiEmployee : Number(salary.gosiEmployee) || 0,
                'مساهمة جهة العمل (GOSI)': typeof salary.gosiEmployer === 'number' ? salary.gosiEmployer : Number(salary.gosiEmployer) || 0,
                'استقطاعات أخرى': typeof salary.otherDeductions === 'number' ? salary.otherDeductions : Number(salary.otherDeductions) || 0,
                'صافي الراتب': typeof salary.net === 'number' ? salary.net : Number(salary.net) || 0,
                'ملاحظات': salary.notes || ''
            })), 'الرواتب');

            appendSheet(purchaseReturns.map(returnDoc => {
                const supplier = suppliers.find(s => s.id === returnDoc.supplierId);
                return {
                    'رقم المرتجع': formatDocNumber('PR', returnDoc.number),
                    'التاريخ': returnDoc.date || '',
                    'المورد': supplier ? supplier.name : '',
                    'فاتورة الشراء الأصلية': formatDocNumber('PUR', returnDoc.originalInvoiceNumber),
                    'إجمالي القيمة': typeof returnDoc.total === 'number' ? returnDoc.total : Number(returnDoc.total) || 0,
                    'الأصناف المرتجعة': formatItemsList(returnDoc.items)
                };
            }), 'مرتجعات المشتريات');

            appendSheet(salesReturns.map(returnDoc => {
                const customer = customers.find(c => c.id === returnDoc.customerId);
                return {
                    'رقم المرتجع': formatDocNumber('SR', returnDoc.number),
                    'التاريخ': returnDoc.date || '',
                    'العميل': customer ? customer.name : '',
                    'فاتورة البيع الأصلية': formatDocNumber('SAL', returnDoc.originalInvoiceNumber),
                    'إجمالي القيمة': typeof returnDoc.total === 'number' ? returnDoc.total : Number(returnDoc.total) || 0,
                    'الأصناف المرتجعة': formatItemsList(returnDoc.items)
                };
            }), 'مرتجعات المبيعات');

            const fileName = `الديوان_${activity ? activity.name.replace(/\s/g, '_') : 'بيانات'}_${todayDate}_Excel.xlsx`;
            XLSX.writeFile(workbook, fileName);
            showNotification('✅ تم التصدير', 'تم إنشاء ملف Excel يحتوي على جميع البيانات', 'success');
        }

        async function importData() {
            if (!ensureActivitySelected()) return;
            const confirmed = await showConfirmDialog(
                'استيراد البيانات',
                'تحذير: سيتم استبدال جميع بيانات النشاط الحالي بالبيانات المستوردة. هل تريد المتابعة؟',
                'warning',
                'متابعة',
                'إلغاء'
            );
            if (confirmed) {
                document.getElementById('importFile').click();
            }
        }

         async function handleFileImport(files) { // أضفنا كلمة async
     if (!files.length) return;
     if (!ensureActivitySelected()) return;
    const reader = new FileReader();
    reader.onload = async function(e) { // أضفنا كلمة async هنا أيضاً
        try {
            const importedData = JSON.parse(e.target.result);
            if (!importedData.system || !importedData.system.includes('الديوان')) {
                showNotification('❌ ملف غير صالح', 'الملف المختار غير صالح أو تالف', 'error');
                return;
            }
            const confirmed = await showConfirmDialog(
                'تأكيد الاستيراد',
                'هل تريد استيراد البيانات إلى النشاط الحالي؟',
                'info',
                'نعم',
                'إلغاء'
            );
            if (confirmed) {

                // سنقوم بتجميع كل عمليات الحفظ
                const savePromises = [];
                const keysToImport = ['items', 'customers', 'suppliers', 'purchases', 'sales', 'expenses', 'revenues', 'salaries', 'salesReturns', 'purchaseReturns'];

                keysToImport.forEach(key => {
                    if (importedData[key] && Array.isArray(importedData[key])) {
                        // هذا هو التعديل: نستخدم دالة الحفظ في Firebase
                        savePromises.push(saveToFirebase(key, importedData[key]));
                    }
                });

                // ننتظر حتى تكتمل جميع عمليات الحفظ
                const saveResults = await Promise.all(savePromises);
                if (savePromises.length && saveResults.some(result => !result)) {
                    showNotification('❌ خطأ في الحفظ', 'تعذر حفظ بعض البيانات المستوردة. يرجى المحاولة مرة أخرى', 'error');
                    return;
                }

                await refreshActivityData();
                const importInput = document.getElementById('importFile');
                if (importInput) {
                    importInput.value = '';
                }
                showNotification('✅ تم الاستيراد', 'تم استيراد البيانات إلى Firebase بنجاح! تم تحديث البيانات الحالية', 'success');
            }
        } catch (error) {
            console.error("خطأ في الاستيراد:", error);
            const importInput = document.getElementById('importFile');
            if (importInput) {
                importInput.value = '';
            }
            showNotification('❌ خطأ', 'حدث خطأ أثناء محاولة استيراد البيانات', 'error');
        }
    };
    reader.readAsText(files[0]);
}

        function createBackup() {
            if (!ensureActivitySelected()) return;
            exportActivityData();
            const timestamp = new Date().toISOString();
            const lastBackupKey = getActivityDataKey('lastBackup');
            const reminderKey = getActivityDataKey('lastBackupTimestamp');
            if (lastBackupKey) {
                localStorage.setItem(lastBackupKey, timestamp);
            }
            if (reminderKey) {
                localStorage.setItem(reminderKey, Date.now());
            }
            updateDataStats();
        }

        async function importSampleData() {
            if (!ensureActivitySelected()) return;
            const confirmed = await showConfirmDialog(
                'بيانات تجريبية',
                'سيتم إضافة بيانات تجريبية إلى النشاط الحالي. هل تريد المتابعة؟',
                'info',
                'متابعة',
                'إلغاء'
            );
            if (confirmed) {
                const sampleItems = [{ id: Date.now() + 1, code: 'IT001', name: 'جهاز كمبيوتر محمول', cost: 2000, price: 2500, stock: 10 }];
                const sampleCustomers = [{ id: Date.now() + 2, code: 'CU001', name: 'شركة التقنية', phone: '0123456789', email: 'info@tech.com', address: 'الرياض' }];
                const sampleSuppliers = [{ id: Date.now() + 3, code: 'SU001', name: 'شركة الإمدادات', phone: '0123456791', email: 'supply@tech.com', address: 'الدمام' }];

                const updatedItems = [...items, ...sampleItems];
                const updatedCustomers = [...customers, ...sampleCustomers];
                const updatedSuppliers = [...suppliers, ...sampleSuppliers];

                const saveResults = await Promise.all([
                    saveToFirebase('items', updatedItems),
                    saveToFirebase('customers', updatedCustomers),
                    saveToFirebase('suppliers', updatedSuppliers)
                ]);

                if (saveResults.some(result => !result)) {
                    showNotification('❌ خطأ', 'تعذر حفظ البيانات التجريبية. حاول مرة أخرى لاحقاً', 'error');
                    return;
                }

                await refreshActivityData();
                showNotification('✅ تم الإضافة', 'تم إضافة البيانات التجريبية للنشاط الحالي', 'success');
            }
        }

        async function clearActivityData() {
            if (!ensureActivitySelected()) return;
            const confirmed1 = await showConfirmDialog(
                'حذف جميع البيانات',
                'تحذير: سيتم حذف جميع بيانات هذا النشاط نهائياً. هل أنت متأكد؟',
                'danger',
                'نعم',
                'إلغاء'
            );
            if (confirmed1) {
                const confirmed2 = await showConfirmDialog(
                    'تأكيد نهائي',
                    'هل أنت متأكد جداً؟ هذه العملية لا يمكن التراجع عنها!',
                    'danger',
                    'حذف نهائياً',
                    'إلغاء'
                );
                if (confirmed2) {
                    const dataKeys = ['items', 'customers', 'suppliers', 'purchases', 'sales', 'salesReturns', 'purchaseReturns', 'expenses', 'revenues', 'salaries', 'lastBackup'];
                    const removalResults = await Promise.all(dataKeys.map(key => removeFromFirebase(key)));
                    if (removalResults.some(result => !result)) {
                        showNotification('❌ خطأ', 'تعذر حذف البيانات بالكامل. يرجى التحقق من الاتصال وإعادة المحاولة', 'error');
                        return;
                    }
                    dataKeys.forEach(key => {
                        const storageKey = getActivityDataKey(key);
                        if (storageKey) {
                            localStorage.removeItem(storageKey);
                        }
                    });
                    const reminderKey = getActivityDataKey('lastBackupTimestamp');
                    if (reminderKey) {
                        localStorage.removeItem(reminderKey);
                    }
                    items = [];
                    customers = [];
                    suppliers = [];
                    purchases = [];
                    sales = [];
                    expenses = [];
                    revenues = [];
                    salaries = [];
                    salesReturns = [];
                    purchaseReturns = [];
                    await refreshActivityData();
                    showNotification('✅ تم المسح', 'تم مسح جميع بيانات النشاط الحالي', 'success');
                }
            }
        }

        // ===== Dashboard Update =====
 function updateDashboard() {
    const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
    const allowEmpty = !currentActivityId && loggedInUser && loggedInUser.role === 'admin';
    if (!currentActivityId && !allowEmpty) return;

    const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    };

    setText('totalItems', items.length);
    setText('totalCustomers', customers.length);
    setText('totalSuppliers', suppliers.length);
    setText('stockValue', items.reduce((s, i) => s + ((Number(i.stock) || 0) * (Number(i.cost) || 0)), 0).toFixed(2));
    setText('totalSales', sales.reduce((s, i) => s + (Number(i.total) || 0), 0).toFixed(2));
    setText('totalPurchases', purchases.reduce((s, i) => s + (Number(i.total) || 0), 0).toFixed(2));
    setText('totalExpensesHome', expenses.reduce((s, e) => s + (Number(e.amount) || 0), 0).toFixed(2));
    setText('totalRevenuesHome', revenues.reduce((s, r) => s + (Number(r.amount) || 0), 0).toFixed(2));
    setText('totalStockQuantity', calculateTotalStock());
    // تحديث لوحة التحكم المتقدمة إذا كانت مفتوحة
    if (document.getElementById('advanced-dashboard').classList.contains('active')) {
        updateLiveStats();
        renderCharts();
    }
}
        
        // ===== Login System Functions =====
        async function handleLogin() {
            const errorMsg = document.getElementById('login-error');
            const emailInput = document.getElementById('loginEmail');
            const passwordInput = document.getElementById('loginPassword');
            if (!emailInput || !passwordInput) {
                showNotification('❌ خطأ', 'تعذر العثور على حقول تسجيل الدخول', 'error');
                return;
            }

            const email = emailInput.value.trim();
            const pass = passwordInput.value;
            if (!email || !pass) {
                showNotification('⚠️ بيانات ناقصة', 'يرجى إدخال البريد الإلكتروني وكلمة المرور', 'warning');
                return;
            }

            showLoading('جاري تسجيل الدخول...');

            try {
                let user = null;
                
                // البحث عن المستخدم والتحقق من كلمة المرور
                for (const u of users) {
                    if (u.email === email) {
                        // التحقق من كلمة المرور المشفرة أو العادية (للتوافق مع البيانات القديمة)
                        if (u.passwordHash) {
                            // استخدام كلمة المرور المشفرة
                            const isValid = await verifyPassword(pass, u.passwordHash);
                            if (isValid) {
                                user = u;
                                break;
                            }
                        } else if (u.password === pass) {
                            // كلمة مرور قديمة غير مشفرة - نقوم بتشفيرها الآن
                            user = u;
                            user.passwordHash = await hashPassword(pass);
                            delete user.password; // حذف كلمة المرور غير المشفرة
                            await saveUsers(); // حفظ التحديث
                            break;
                        }
                    }
                }

                if (user) {
                    if (user.role === 'manager') {
                        if (!user.activityId) {
                            hideLoading();
                            showNotification('⚠️ غير معين', 'لم يتم تعيين نشاط لهذا المدير. يرجى التواصل مع مدير النظام', 'warning');
                            errorMsg.style.display = 'block';
                            return;
                        }
                        const assignedActivity = activities.find(a => a.id == user.activityId);
                        if (!assignedActivity) {
                            hideLoading();
                            showNotification('⚠️ نشاط غير موجود', 'لا يمكن فتح الحساب لأن النشاط المرتبط به غير موجود. الرجاء التواصل مع مدير النظام', 'error');
                            errorMsg.style.display = 'block';
                            return;
                        }
                    } else if (user.role === 'user') {
                        if (!user.activityId) {
                            hideLoading();
                            showNotification('⚠️ غير معين', 'لم يتم تعيين نشاط لهذا المستخدم. يرجى التواصل مع مدير النظام', 'warning');
                            errorMsg.style.display = 'block';
                            return;
                        }
                        const allowedActivity = activities.find(a => a.id == user.activityId);
                        if (!allowedActivity) {
                            hideLoading();
                            showNotification('⚠️ نشاط غير موجود', 'لا يمكن فتح الحساب لأن النشاط المرتبط به غير موجود. الرجاء التواصل مع مدير النظام', 'error');
                            errorMsg.style.display = 'block';
                            return;
                        }
                    }

                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('loggedInUser', JSON.stringify(user));
                    updateLoggedInUserDisplay(user);
                    errorMsg.style.display = 'none';
                    document.getElementById('login-overlay').style.display = 'none';
                    const appContainer = document.querySelector('.app-container');
                    if (appContainer) appContainer.style.display = 'flex';

                    if (user.role === 'admin') {
                        currentActivityId = sessionStorage.getItem('currentActivityId');
                        if (currentActivityId && activities.find(a => a.id == currentActivityId)) {
                            await selectActivity(currentActivityId);
                        } else {
                            enterAdminWithoutActivity();
                        }
                    } else if (user.role === 'manager') {
                        await selectActivity(user.activityId);
                    } else {
                        await selectActivity(user.activityId);
                    }
                    
                    hideLoading();
                } else {
                    hideLoading();
                    errorMsg.textContent = 'البريد الإلكتروني أو كلمة المرور غير صحيحة';
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                hideLoading();
                logError('Login', error);
            }
        }

        function enterAdminWithoutActivity() {
            currentActivityId = null;
            sessionStorage.removeItem('currentActivityId');

            const loginOverlay = document.getElementById('login-overlay');
            if (loginOverlay) loginOverlay.style.display = 'none';
            const activityOverlay = document.getElementById('activity-overlay');
            if (activityOverlay) activityOverlay.style.display = 'none';
            const appContainer = document.querySelector('.app-container');
            if (appContainer) appContainer.style.display = 'flex';

            items = [];
            customers = [];
            suppliers = [];
            purchases = [];
            sales = [];
            expenses = [];
            revenues = [];
            salaries = [];
            salesReturns = [];
            purchaseReturns = [];
            currentPurchaseItems = [];
            currentSaleItems = [];
            currentPurchaseNumber = 1;
            currentSaleNumber = 1;
            currentSaleReturnNumber = 1;
            currentPurchaseReturnNumber = 1;
            editingPurchaseId = null;
            editingSaleId = null;

            const todayISO = new Date().toISOString().split('T')[0];
            const setValueIfExists = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.value = value;
            };
            ['purchaseDate', 'saleDate', 'expenseDate', 'revenueDate', 'reportFrom', 'reportTo'].forEach(id => setValueIfExists(id, todayISO));

            setValueIfExists('purchaseCode', `PUR${currentPurchaseNumber.toString().padStart(3, '0')}`);
            setValueIfExists('saleCode', `SAL${currentSaleNumber.toString().padStart(3, '0')}`);

            updateHeaderForActivity(null);
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            updateLoggedInUserDisplay(loggedInUser);
            updateSidebar(loggedInUser ? loggedInUser.role : null);

            newPurchase();
            newSale();
            newSaleReturn();
            newPurchaseReturn();

            renderItems();
            renderCustomers();
            renderSuppliers();
            renderPurchasesList();
            renderSalesList();
            renderSalesReturns();
            renderPurchaseReturns();
            renderExpenses();
            renderRevenues();
            updatePurchaseDropdowns();
            updateSaleDropdowns();
            updateExpenseStats();
            updateRevenueStats();
            updateDataStats();
            updateDashboard();
            updateReportItemFilter();
            changeReportType();
            const reportResults = document.getElementById('reportResults');
            if (reportResults) reportResults.innerHTML = '';
            const reportSummary = document.getElementById('reportSummary');
            if (reportSummary) reportSummary.innerHTML = '';
            renderActivitiesInSettings();
            renderUsersInSettings();
        }
        
        async function logout() {
            const confirmed = await showConfirmDialog({
                title: '👋 تسجيل الخروج',
                message: 'هل أنت متأكد من رغبتك في تسجيل الخروج؟',
                type: 'info',
                confirmText: 'نعم، سجل خروجي',
                cancelText: 'إلغاء',
                icon: '🚪'
            });
            
            if (confirmed) {
                sessionStorage.clear();
                location.reload();
            }
        }

        async function addUser() {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const phone = document.getElementById('newUserPhone').value.trim();
            const password = document.getElementById('newUserPassword').value;
            let role = document.getElementById('newUserRole').value;
            let activityId = document.getElementById('newUserActivity').value;
            const phonePattern = /^[+\d]{6,20}$/;

            if (loggedInUser && loggedInUser.role === 'manager') {
                role = 'user';
                activityId = loggedInUser.activityId;
            }

            if (!name) {
                showNotification('⚠️ اسم مطلوب', 'يرجى إدخال اسم المستخدم', 'warning');
                return;
            }
            if (!email || !password) {
                showNotification('⚠️ بيانات ناقصة', 'يرجى إدخال البريد الإلكتروني وكلمة المرور', 'warning');
                return;
            }
            if (!phone) {
                showNotification('⚠️ جوال مطلوب', 'يرجى إدخال رقم الجوال', 'warning');
                return;
            }
            if (!phonePattern.test(phone)) {
                showNotification('⚠️ رقم غير صحيح', 'رقم الجوال يجب أن يحتوي على أرقام فقط ويمكن أن يبدأ بعلامة +', 'warning');
                return;
            }
            if ((role === 'user' || role === 'manager') && !activityId) {
                showNotification('⚠️ نشاط مطلوب', 'الرجاء تعيين نشاط للمستخدم', 'warning');
                return;
            }
            if (users.some(u => u.email === email)) {
                showNotification('❌ بريد مكرر', 'هذا البريد الإلكتروني مستخدم بالفعل', 'error');
                return;
            }

            showLoading('جاري إنشاء المستخدم...');

            try {
                // تشفير كلمة المرور
                const passwordHash = await hashPassword(password);
                
                const normalizedActivityId = (role === 'user' || role === 'manager') ? activityId : null;
                const newUser = { 
                    id: Date.now(), 
                    name, 
                    email, 
                    phone, 
                    passwordHash, // استخدام كلمة المرور المشفرة
                    role, 
                    activityId: normalizedActivityId 
                };
                
                users.push(newUser);
                await saveUsers();
                
                hideLoading();
                
                renderUsersInSettings();
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserEmail').value = '';
                document.getElementById('newUserPhone').value = '';
                document.getElementById('newUserPassword').value = '';
                const roleField = document.getElementById('newUserRole');
                const activityField = document.getElementById('newUserActivity');
                if (loggedInUser && loggedInUser.role === 'manager') {
                    if (roleField) roleField.value = 'user';
                    if (activityField) activityField.value = loggedInUser.activityId || '';
                } else {
                    if (roleField) roleField.value = 'admin';
                    if (activityField) activityField.value = '';
                }
                
                showNotification('✅ تم الإضافة', 'تم إضافة المستخدم بنجاح', 'success');
            } catch (error) {
                hideLoading();
                logError('Add User', error);
            }
        }

        function renderUsersInSettings() {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const isAdmin = loggedInUser && loggedInUser.role === 'admin';
            const isManager = loggedInUser && loggedInUser.role === 'manager';
            const activitySelect = document.getElementById('newUserActivity');
            const userSelect = document.getElementById('usersDropdown');
            const roleSelect = document.getElementById('newUserRole');

            if (roleSelect) {
                if (isManager) {
                    roleSelect.value = 'user';
                    roleSelect.disabled = true;
                } else {
                    roleSelect.disabled = false;
                }
            }

            if (activitySelect) {
                activitySelect.innerHTML = '<option value="">-- تعيين لنشاط --</option>';
                const availableActivities = isManager
                    ? activities.filter(act => String(act.id) === String(loggedInUser.activityId))
                    : activities;
                availableActivities.forEach(act => {
                    activitySelect.innerHTML += `<option value="${act.id}">${act.name}</option>`;
                });
                if (isManager) {
                    activitySelect.value = loggedInUser.activityId || '';
                    activitySelect.disabled = true;
                } else {
                    activitySelect.disabled = false;
                }
            }

            if (userSelect) {
                const previousSelection = userSelect.value;
                userSelect.innerHTML = '<option value="">اختر مستخدمًا</option>';
                const filteredUsers = users.filter(user => {
                    if (isAdmin) return true;
                    if (isManager) {
                        if (user.role === 'admin') return false;
                        if (user.role === 'manager' && user.id !== loggedInUser.id) return false;
                        return user.activityId == loggedInUser.activityId;
                    }
                    return false;
                });

                filteredUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    const roleLabelMap = { admin: 'مدير النظام', manager: 'مدير نشاط', user: 'مستخدم' };
                    const baseName = (user.name && user.name.trim()) ? user.name : user.email;
                    option.textContent = `${baseName} - ${roleLabelMap[user.role] || 'دور غير معروف'}`;
                    userSelect.appendChild(option);
                });

                if (previousSelection && users.some(u => String(u.id) === previousSelection)) {
                    userSelect.value = previousSelection;
                } else {
                    userSelect.value = '';
                }
            }

            handleUserSelection();
        }

        function handleUserSelection() {
            const userSelect = document.getElementById('usersDropdown');
            const infoBox = document.getElementById('selectedUserInfo');
            const nameInput = document.getElementById('selectedUserName');
            const emailInput = document.getElementById('selectedUserEmail');
            const phoneInput = document.getElementById('selectedUserPhone');
            const roleInput = document.getElementById('selectedUserRole');
            const activityInput = document.getElementById('selectedUserActivity');
            const editBtn = document.getElementById('editSelectedUserBtn');
            const deleteBtn = document.getElementById('deleteSelectedUserBtn');

            if (!userSelect) return;

            const userId = userSelect.value;
            const user = users.find(u => String(u.id) === userId);

            if (!user) {
                if (infoBox) infoBox.style.display = 'none';
                if (nameInput) nameInput.value = '';
                if (emailInput) emailInput.value = '';
                if (phoneInput) phoneInput.value = '';
                if (roleInput) roleInput.value = '';
                if (activityInput) activityInput.value = '';
                if (editBtn) editBtn.disabled = true;
                if (deleteBtn) deleteBtn.disabled = true;
                return;
            }

            if (infoBox) infoBox.style.display = 'flex';
            if (nameInput) nameInput.value = (user.name && user.name.trim()) ? user.name : user.email;
            if (emailInput) emailInput.value = user.email || 'غير متوفر';
            if (phoneInput) phoneInput.value = (user.phone && user.phone.trim()) ? user.phone : 'غير متوفر';
            if (roleInput) {
                const roleNames = { admin: 'مدير النظام', manager: 'مدير نشاط', user: 'مستخدم' };
                roleInput.value = roleNames[user.role] || 'دور غير معروف';
            }

            let assignedActivity = 'غير مخصص';
            if (user.role === 'admin') {
                assignedActivity = 'متعدد (مدير النظام)';
            } else if (user.role === 'manager' || user.role === 'user') {
                const activity = activities.find(a => a.id == user.activityId);
                assignedActivity = activity ? activity.name : 'نشاط غير معروف';
            }
            if (activityInput) activityInput.value = assignedActivity;

            if (editBtn) editBtn.disabled = false;
            if (deleteBtn) deleteBtn.disabled = false;
        }

        function handleEditSelectedUser() {
            const userSelect = document.getElementById('usersDropdown');
            if (!userSelect || !userSelect.value) {
                showNotification('⚠️ لم يتم الاختيار', 'يرجى اختيار مستخدم من القائمة', 'warning');
                return;
            }
            const userId = Number(userSelect.value);
            if (!Number.isNaN(userId)) {
                openEditUserModal(userId);
            }
        }

        function handleDeleteSelectedUser() {
            const userSelect = document.getElementById('usersDropdown');
            if (!userSelect || !userSelect.value) {
                showNotification('⚠️ لم يتم الاختيار', 'يرجى اختيار مستخدم من القائمة', 'warning');
                return;
            }
            const userId = Number(userSelect.value);
            if (!Number.isNaN(userId)) {
                deleteUser(userId);
            }
        }

        let editingUserId = null;
        let editingUserSelf = false;
        function openEditUserModal(userId, options = {}) {
            editingUserId = userId;
            editingUserSelf = Boolean(options && options.selfEdit);
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const isManager = loggedInUser && loggedInUser.role === 'manager';
            const isSelf = loggedInUser && user.id === loggedInUser.id;

            if (isManager) {
                const sameActivity = user.activityId == loggedInUser.activityId;
                if (user.role === 'admin' || (user.role === 'manager' && !isSelf) || (!sameActivity && !isSelf)) {
                    showNotification('⚠️ غير مسموح', 'لا تملك صلاحية تعديل هذا المستخدم', 'warning');
                    return;
                }
            }

            const nameInput = document.getElementById('editUserName');
            const emailInput = document.getElementById('editUserEmail');
            const phoneInput = document.getElementById('editUserPhone');
            const passwordInput = document.getElementById('editUserPassword');
            const roleSelect = document.getElementById('editUserRole');
            const actSel = document.getElementById('editUserActivity');

            // تعبئة الحقول الأساسية
            nameInput.value = user.name || '';
            emailInput.value = user.email;
            phoneInput.value = user.phone || '';
            passwordInput.value = user.password || '';
            roleSelect.value = user.role;

            // إعداد قائمة الأنشطة
            actSel.innerHTML = '<option value="">-- تعيين لنشاط --</option>';
            const availableActivities = isManager
                ? activities.filter(a => String(a.id) === String(loggedInUser.activityId))
                : activities;
            availableActivities.forEach(a => actSel.innerHTML += `<option value="${a.id}">${a.name}</option>`);

            const shouldShowActivity = (user.role === 'user' || user.role === 'manager');
            actSel.style.display = shouldShowActivity ? 'block' : 'none';
            actSel.value = shouldShowActivity ? (user.activityId || '') : '';

            // تمكين أو تعطيل الحقول حسب سياق التحرير الذاتي
            const disableRoleSelect = editingUserSelf || isManager || isSelf;
            roleSelect.disabled = disableRoleSelect;
            actSel.disabled = editingUserSelf || isSelf;

            if (!disableRoleSelect) {
                roleSelect.onchange = function() {
                    if (this.value === 'user' || this.value === 'manager') {
                        actSel.style.display = 'block';
                        actSel.disabled = false;
                    } else {
                        actSel.style.display = 'none';
                        actSel.value = '';
                        actSel.disabled = false;
                    }
                };
            } else {
                roleSelect.onchange = null;
            }

            document.getElementById('user-edit-overlay').style.display = 'flex';
        }

        function closeEditUserModal() {
            document.getElementById('user-edit-overlay').style.display = 'none';
            editingUserId = null;
            editingUserSelf = false;
        }

        function openSelfEditUserModal() {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!loggedInUser) {
                showNotification('⚠️ غير مسجل', 'يرجى تسجيل الدخول أولاً', 'warning');
                return;
            }

            const exists = users.some(u => u.id === loggedInUser.id);
            if (!exists) {
                showNotification('❌ خطأ', 'تعذر العثور على بيانات المستخدم للتعديل', 'error');
                return;
            }

            openEditUserModal(loggedInUser.id, { selfEdit: true });
        }

        async function saveEditedUser() {
            const name = document.getElementById('editUserName').value.trim();
            const email = document.getElementById('editUserEmail').value.trim();
            const phone = document.getElementById('editUserPhone').value.trim();
            const password = document.getElementById('editUserPassword').value.trim();
            let role = document.getElementById('editUserRole').value;
            let activityId = document.getElementById('editUserActivity').value;
            const phonePattern = /^[+\d]{6,20}$/;
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const isManager = loggedInUser && loggedInUser.role === 'manager';

            if (!name) { showNotification('⚠️ اسم مطلوب', 'اسم المستخدم مطلوب', 'warning'); return; }
            if (!email) { showNotification('⚠️ بريد مطلوب', 'البريد الإلكتروني مطلوب', 'warning'); return; }
            if (!phone) { showNotification('⚠️ جوال مطلوب', 'رقم الجوال مطلوب', 'warning'); return; }
            if (!phonePattern.test(phone)) { showNotification('⚠️ رقم غير صحيح', 'رقم الجوال يجب أن يحتوي على أرقام فقط ويمكن أن يبدأ بعلامة +', 'warning'); return; }
            if (!role) { showNotification('⚠️ صلاحية مطلوبة', 'اختر الصلاحية', 'warning'); return; }

            const idx = users.findIndex(u => u.id === editingUserId);
            if (idx === -1) { showNotification('❌ غير موجود', 'لم يتم العثور على المستخدم', 'error'); return; }

            const targetUser = users[idx];
            const isSelf = loggedInUser && targetUser.id === loggedInUser.id;

            if (editingUserSelf || isSelf) {
                role = targetUser.role;
                activityId = targetUser.activityId || '';
            } else if (isManager) {
                role = 'user';
                activityId = loggedInUser.activityId || '';
            }

            if ((role === 'user' || role === 'manager') && !activityId) { showNotification('⚠️ نشاط مطلوب', 'يجب تعيين نشاط للمستخدم', 'warning'); return; }


            // منع تكرار الإيميل لمستخدم آخر
            if (users.some(u => u.email === email && u.id !== editingUserId)) {
                showNotification('❌ بريد مكرر', 'هذا البريد الإلكتروني مستخدم بالفعل', 'error');
                return;
            }

            targetUser.name = name;
            targetUser.email = email;
            targetUser.phone = phone;
            if (password) targetUser.password = password; // تحديث كلمة المرور فقط إذا تم إدخال قيمة
            targetUser.role = role;
            targetUser.activityId = (role === 'user' || role === 'manager') ? activityId : null;

            const updatedUser = targetUser;
            await saveUsers();
            if (loggedInUser && loggedInUser.id === updatedUser.id) {
                sessionStorage.setItem('loggedInUser', JSON.stringify(updatedUser));
                updateLoggedInUserDisplay(updatedUser);
            }
            renderUsersInSettings();
            closeEditUserModal();
            showNotification('✅ تم التحديث', 'تم تحديث بيانات المستخدم', 'success');
        }

        async function deleteUser(id) {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (loggedInUser.id === id) {
                showNotification('⚠️ غير مسموح', 'لا يمكنك حذف نفسك', 'warning');
                return;
            }

            if (loggedInUser.role === 'manager') {
                const target = users.find(u => u.id === id);
                if (!target || target.role !== 'user' || target.activityId != loggedInUser.activityId) {
                    showNotification('⚠️ غير مسموح', 'لا تملك صلاحية حذف هذا المستخدم', 'warning');
                    return;
                }
            }

            const admins = users.filter(u => u.role === 'admin');
            const userToDelete = users.find(u => u.id === id);
            if (!userToDelete) {
                showNotification('❌ غير موجود', 'تعذر العثور على المستخدم المحدد', 'error');
                return;
            }

            if (userToDelete.role === 'admin' && admins.length <= 1) {
                showNotification('⚠️ غير مسموح', 'يجب أن يوجد مدير واحد على الأقل في النظام', 'warning');
                return;
            }

            const confirmed = await showConfirmDialog(
                'حذف المستخدم',
                `هل أنت متأكد من حذف المستخدم ${userToDelete.email}؟`,
                'danger',
                'حذف',
                'إلغاء'
            );
            if (confirmed) {
                users = users.filter(u => u.id !== id);
                await saveUsers();
                renderUsersInSettings();
            }
        }

        // ===== Logo Management Functions =====
        function handleLogoUpload(fileInput) {
            const file = fileInput.files[0];
            if (!file) return;

            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml'];
            if (!validTypes.includes(file.type)) {
                showNotification('❌ يرجى اختيار صورة بصيغة PNG أو JPG أو SVG فقط.', 'error');
                fileInput.value = '';
                return;
            }

            // Validate file size (max 2MB)
            const maxSize = 2 * 1024 * 1024; // 2MB in bytes
            if (file.size > maxSize) {
                showNotification('❌ حجم الصورة كبير جداً. الحد الأقصى 2 ميجابايت.', 'error');
                fileInput.value = '';
                return;
            }

            // Read and convert to Base64
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64String = e.target.result;
                
                // Save to localStorage
                localStorage.setItem('systemLogo', base64String);
                
                // Update preview in Settings
                const previewImg = document.getElementById('logoPreview');
                if (previewImg) {
                    previewImg.src = base64String;
                    previewImg.style.display = 'block';
                }
                
                // Hide "no logo" text
                const noLogoText = document.getElementById('noLogoText');
                if (noLogoText) noLogoText.style.display = 'none';
                
                // Update login screen logo
                const loginLogo = document.getElementById('loginLogo');
                if (loginLogo) {
                    loginLogo.src = base64String;
                    loginLogo.style.display = 'block';
                }
                
                // Update sidebar logo
                const sidebarLogo = document.getElementById('sidebarLogo');
                if (sidebarLogo) {
                    sidebarLogo.src = base64String;
                    sidebarLogo.style.display = 'block';
                }
                
                // Show remove button
                const removeBtn = document.getElementById('removeLogoBtn');
                if (removeBtn) removeBtn.style.display = 'inline-block';
                
                showNotification('✅ تم رفع الشعار بنجاح.', 'success');
            };
            
            reader.onerror = function() {
                showNotification('❌ حدث خطأ أثناء قراءة الملف.', 'error');
                fileInput.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        function removeLogo() {
            showConfirmDialog(
                'حذف الشعار',
                'هل أنت متأكد من حذف شعار النظام؟',
                'warning',
                'حذف',
                'إلغاء'
            ).then(confirmed => {
                if (confirmed) {
                    // Remove from localStorage
                    localStorage.removeItem('systemLogo');
                    
                    // Clear preview in Settings
                    const previewImg = document.getElementById('logoPreview');
                    if (previewImg) {
                        previewImg.src = '';
                        previewImg.style.display = 'none';
                    }
                    
                    // Show "no logo" text
                    const noLogoText = document.getElementById('noLogoText');
                    if (noLogoText) noLogoText.style.display = 'block';
                    
                    // Clear login screen logo
                    const loginLogo = document.getElementById('loginLogo');
                    if (loginLogo) {
                        loginLogo.src = '';
                        loginLogo.style.display = 'none';
                    }
                    
                    // Clear sidebar logo
                    const sidebarLogo = document.getElementById('sidebarLogo');
                    if (sidebarLogo) {
                        sidebarLogo.src = '';
                        sidebarLogo.style.display = 'none';
                    }
                    
                    // Hide remove button
                    const removeBtn = document.getElementById('removeLogoBtn');
                    if (removeBtn) removeBtn.style.display = 'none';
                    
                    // Clear file input
                    const fileInput = document.getElementById('logoFileInput');
                    if (fileInput) fileInput.value = '';
                    
                    showNotification('✅ تم حذف الشعار بنجاح.', 'success');
                }
            });
        }

        function loadSavedLogo() {
            const savedLogo = localStorage.getItem('systemLogo');
            const noLogoText = document.getElementById('noLogoText');
            
            if (savedLogo) {
                // Update preview in Settings
                const previewImg = document.getElementById('logoPreview');
                if (previewImg) {
                    previewImg.src = savedLogo;
                    previewImg.style.display = 'block';
                }
                
                // Hide "no logo" text
                if (noLogoText) noLogoText.style.display = 'none';
                
                // Update login screen logo
                const loginLogo = document.getElementById('loginLogo');
                if (loginLogo) {
                    loginLogo.src = savedLogo;
                    loginLogo.style.display = 'block';
                }
                
                // Update sidebar logo
                const sidebarLogo = document.getElementById('sidebarLogo');
                if (sidebarLogo) {
                    sidebarLogo.src = savedLogo;
                    sidebarLogo.style.display = 'block';
                }
                
                // Show remove button
                const removeBtn = document.getElementById('removeLogoBtn');
                if (removeBtn) removeBtn.style.display = 'inline-block';
            } else {
                // Show "no logo" text if no logo exists
                if (noLogoText) noLogoText.style.display = 'block';
            }
        }

        // ===== Activity Logo Functions =====
        function handleActivityLogoUpload(fileInput) {
            debugLog('🔍 بدء رفع شعار النشاط...');
            
            const file = fileInput.files[0];
            if (!file) {
                debugLog('⚠️ لم يتم اختيار ملف');
                return;
            }
            
            debugLog('📄 الملف المختار:', file.name, 'الحجم:', file.size);
            
            // Check file size (max 500KB for localStorage compatibility)
            if (file.size > 500 * 1024) {
                showNotification('❌ حجم الملف كبير جداً', 'حجم الملف يجب أن يكون أقل من 500 كيلوبايت. يرجى ضغط الصورة أولاً.', 'error');
                fileInput.value = '';
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                debugLog('✅ تم قراءة الملف بنجاح');
                const base64String = e.target.result;
                
                // Get current activity
                let currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
                debugLog('🏢 النشاط الحالي:', currentActivity);
                
                if (!currentActivity) {
                    showNotification('❌ لا يوجد نشاط محدد', 'error');
                    return;
                }
                
                // حفظ الشعار في بيانات النشاط
                currentActivity.logo = base64String;
                
                // حفظ في sessionStorage
                sessionStorage.setItem('currentActivity', JSON.stringify(currentActivity));
                
                // حفظ في localStorage activities
                try {
                    const storageKey = `activity_${currentActivity.id}_data`;
                    const activityData = JSON.parse(localStorage.getItem(storageKey)) || {};
                    activityData.logo = base64String;
                    localStorage.setItem(storageKey, JSON.stringify(activityData));
                    debugLog('💾 تم حفظ الشعار في localStorage');
                } catch (error) {
                    if (error.name === 'QuotaExceededError') {
                        showNotification('❌ مساحة التخزين ممتلئة', 'الصورة كبيرة جداً. يرجى استخدام صورة أصغر (أقل من 200 كيلوبايت).', 'error');
                        fileInput.value = '';
                        return;
                    }
                    throw error;
                }
                
                // Update preview
                const previewImg = document.getElementById('activityLogoPreview');
                const noLogoText = document.getElementById('noActivityLogoText');
                if (previewImg) {
                    previewImg.src = base64String;
                    previewImg.style.display = 'block';
                    debugLog('🖼️ تم تحديث معاينة الشعار');
                }
                if (noLogoText) noLogoText.style.display = 'none';
                
                // Update header logo
                const headerLogo = document.getElementById('activityHeaderLogo');
                if (headerLogo) {
                    headerLogo.src = base64String;
                    headerLogo.style.display = 'block';
                    debugLog('📍 تم تحديث شعار الترويسة');
                }
                
                // Show remove button
                const removeBtn = document.getElementById('removeActivityLogoBtn');
                if (removeBtn) removeBtn.style.display = 'inline-block';
                
                showNotification('✅ تم رفع شعار النشاط بنجاح.', 'success');
            };
            
            reader.onerror = function() {
                debugLog('❌ خطأ في قراءة الملف');
                showNotification('❌ حدث خطأ أثناء قراءة الملف.', 'error');
                fileInput.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        function removeActivityLogo() {
            showConfirm(
                'هل أنت متأكد من حذف شعار النشاط؟',
                'سيتم إزالة الشعار من الترويسة والفواتير',
                'warning',
                () => {
                    const currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
                    if (!currentActivity) return;
                    
                    // Remove logo from localStorage
                    const storageKey = `activity_${currentActivity.id}_data`;
                    const activityData = JSON.parse(localStorage.getItem(storageKey)) || {};
                    delete activityData.logo;
                    localStorage.setItem(storageKey, JSON.stringify(activityData));
                    
                    // Update preview
                    const previewImg = document.getElementById('activityLogoPreview');
                    const noLogoText = document.getElementById('noActivityLogoText');
                    if (previewImg) previewImg.style.display = 'none';
                    if (noLogoText) noLogoText.style.display = 'block';
                    
                    // Clear header logo
                    const headerLogo = document.getElementById('activityHeaderLogo');
                    if (headerLogo) headerLogo.style.display = 'none';
                    
                    // Hide remove button
                    const removeBtn = document.getElementById('removeActivityLogoBtn');
                    if (removeBtn) removeBtn.style.display = 'none';
                    
                    // Clear file input
                    const fileInput = document.getElementById('activityLogoFileInput');
                    if (fileInput) fileInput.value = '';
                    
                    showNotification('✅ تم حذف شعار النشاط بنجاح.', 'success');
                }
            );
        }

        function loadActivityLogo() {
            const currentActivity = JSON.parse(sessionStorage.getItem('currentActivity'));
            if (!currentActivity) {
                // Hide logo if no activity
                const headerLogo = document.getElementById('activityHeaderLogo');
                if (headerLogo) headerLogo.style.display = 'none';
                return;
            }
            
            // Load logo from localStorage
            const storageKey = `activity_${currentActivity.id}_data`;
            const activityData = JSON.parse(localStorage.getItem(storageKey));
            const savedLogo = activityData?.logo;
            
            if (!savedLogo) {
                // Hide logo if no logo saved
                const headerLogo = document.getElementById('activityHeaderLogo');
                if (headerLogo) headerLogo.style.display = 'none';
                return;
            }
            
            // Update preview in settings
            const previewImg = document.getElementById('activityLogoPreview');
            const noLogoText = document.getElementById('noActivityLogoText');
            if (previewImg) {
                previewImg.src = savedLogo;
                previewImg.style.display = 'block';
            }
            if (noLogoText) noLogoText.style.display = 'none';
            
            // Update header logo
            const headerLogo = document.getElementById('activityHeaderLogo');
            if (headerLogo) {
                headerLogo.src = savedLogo;
                headerLogo.style.display = 'block';
            }
            
            // Show remove button
            const removeBtn = document.getElementById('removeActivityLogoBtn');
            if (removeBtn) removeBtn.style.display = 'inline-block';
        }

        // ===== Email Functions =====
        function saveEmailJsSettings() {
            emailJsConfig.serviceID = document.getElementById('emailJsServiceId').value.trim();
            emailJsConfig.templateID = document.getElementById('emailJsTemplateId').value.trim();
            emailJsConfig.resetTemplateID = document.getElementById('emailJsResetTemplateId').value.trim();
            emailJsConfig.publicKey = document.getElementById('emailJsPublicKey').value.trim();
            localStorage.setItem('diwan_email_config', JSON.stringify(emailJsConfig));
            showNotification('✅ تم حفظ إعدادات البريد بنجاح.', 'success');
        }

        function loadEmailJsSettings() {
            document.getElementById('emailJsServiceId').value = emailJsConfig.serviceID || '';
            document.getElementById('emailJsTemplateId').value = emailJsConfig.templateID || '';
            const resetTpl = document.getElementById('emailJsResetTemplateId');
            if (resetTpl) resetTpl.value = emailJsConfig.resetTemplateID || '';
            document.getElementById('emailJsPublicKey').value = emailJsConfig.publicKey || '';
        }
function emailSaleInvoice(saleId) {
    if (!emailJsConfig.serviceID || !emailJsConfig.templateID || !emailJsConfig.publicKey) {
        showNotification('⚠️ يرجى تكوين إعدادات البريد الإلكتروني أولاً من صفحة الإعدادات.', 'warning');
        return;
    }

    const sale = sales.find(s => s.id === saleId);
    if (!sale) return;

    const customer = customers.find(c => c.id === sale.customerId);
    if (!customer || !customer.email) {
        showNotification('❌ لا يوجد بريد إلكتروني مسجل لهذا العميل.', 'error');
        return;
    }

    // الحصول على اسم النشاط الحالي
    const currentActivity = activities.find(a => a.id == currentActivityId);
    const activityName = currentActivity ? currentActivity.name : 'بسمة بوتيك';

    // بناء محتوى البريد مع معلومات الفاتورة الكاملة
    let emailContent = `
        <div style="font-family: Arial, sans-serif; direction: rtl; text-align: right;">
            <h2 style="color: #2c5aa0; border-bottom: 2px solid #2c5aa0; padding-bottom: 10px;">فاتورة مبيعات</h2>
            
            <!-- معلومات الفاتورة الأساسية -->
            <div style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <p><strong>رقم الفاتورة:</strong> SAL${sale.number.toString().padStart(3, '0')}</p>
                <p><strong>التاريخ:</strong> ${sale.date}</p>
                <p><strong>العميل:</strong> ${customer.name}</p>
                <p><strong>ملاحظات:</strong> ${sale.notes || 'لا توجد ملاحظات'}</p>
            </div>

            <!-- جدول الأصناف -->
            <h3 style="color: #34495e;">أصناف الفاتورة:</h3>
            <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                <tr style="background-color: #2c5aa0; color: white;">
                    <th style="padding: 10px; border: 1px solid #ddd;">الصنف</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">الكمية</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">سعر البيع</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">الإجمالي</th>
                </tr>
    `;

    // إضافة الأصناف
    sale.items.forEach(item => {
        emailContent += `
            <tr>
                <td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item.quantity}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: left;">${item.price.toFixed(2)}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: left;">${item.total.toFixed(2)}</td>
            </tr>
        `;
    });

    // إضافة المجاميع
    emailContent += `
            </table>
            
            <div style="margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: left; max-width: 350px; margin-left: 0; margin-right: auto;">
                <p style="display: flex; justify-content: space-between; margin: 8px 0;"><span>المجموع:</span> <strong>${sale.subtotal.toFixed(2)}</strong></p>
                <p style="display: flex; justify-content: space-between; margin: 8px 0;"><span>الضريبة:</span> <strong>${sale.tax.toFixed(2)}</strong></p>
                <p style="display: flex; justify-content: space-between; margin: 8px 0;"><span>المدفوع:</span> <strong>${(sale.paidAmount || 0).toFixed(2)}</strong></p>
                <p style="display: flex; justify-content: space-between; margin: 8px 0;"><span>المتبقي:</span> <strong>${(sale.remainingAmount ?? sale.total).toFixed(2)}</strong></p>
                <h3 style="margin-top: 15px; padding-top: 10px; border-top: 2px solid #2c5aa0; color: #2c5aa0; display: flex; justify-content: space-between;"><span>الإجمالي النهائي:</span> <strong>${sale.total.toFixed(2)}</strong></h3>
            </div>

            <!-- التحية -->
            <div style="margin-top: 30px; text-align: center; font-style: italic; border-top: 1px solid #ddd; padding-top: 15px;">
                <p>شكراً لتعاملكم مع ${activityName}</p>
            </div>
        </div>
    `;

    const templateParams = {
        to_name: customer.name,
        to_email: customer.email,
        from_name: activityName,
        invoice_number: `SAL${sale.number.toString().padStart(3, '0')}`,
        invoice_details: emailContent,
        email_subject: `فاتورة ${activityName} - SAL${sale.number.toString().padStart(3, '0')}`
    };

    emailjs.send(emailJsConfig.serviceID, emailJsConfig.templateID, templateParams, emailJsConfig.publicKey)
        .then(function(response) {
           showNotification('✅ تم إرسال الفاتورة بنجاح!', 'success');
        }, function(error) {
           showNotification('❌ فشل إرسال الفاتورة: ' + error.text, 'error');
        });
}

        // ===== نظام النسخ الاحتياطي التلقائي =====
        
        /**
         * نظام ذكي للنسخ الاحتياطي التلقائي كل 24 ساعة
         * يحفظ نسخة محلية من البيانات تلقائياً ويحذف النسخ القديمة
         */
        function initAutoBackupSystem() {
            if (!currentActivityId) return;
            
            const backupKey = `diwan_lastAutoBackup_${currentActivityId}`;
            const lastBackupTime = Number(localStorage.getItem(backupKey) || 0);
            const now = Date.now();
            const twentyFourHours = 24 * 60 * 60 * 1000;
            
            // التحقق إذا مر 24 ساعة منذ آخر نسخة
            if ((now - lastBackupTime) >= twentyFourHours) {
                performAutoBackup();
            }
            
            // جدولة النسخ الاحتياطي التلقائي كل 24 ساعة
            setInterval(() => {
                performAutoBackup();
            }, twentyFourHours);
        }
        
        /**
         * تنفيذ النسخ الاحتياطي التلقائي
         */
        async function performAutoBackup() {
            if (!currentActivityId) return;
            
            try {
                const activity = activities.find(a => a.id == currentActivityId);
                if (!activity) return;
                
                // جمع جميع البيانات
                const backupData = {
                    activity: activity,
                    items: items || [],
                    customers: customers || [],
                    suppliers: suppliers || [],
                    purchases: purchases || [],
                    sales: sales || [],
                    expenses: expenses || [],
                    revenues: revenues || [],
                    salaries: salaries || [],
                    backupDate: new Date().toISOString(),
                    backupTimestamp: Date.now(),
                    version: '20.0'
                };
                
                // حفظ النسخة الاحتياطية في localStorage
                const backupKey = `diwan_autoBackup_${currentActivityId}`;
                const oldBackupsKey = `diwan_autoBackup_old_${currentActivityId}`;
                
                // نقل النسخة السابقة إلى النسخ القديمة
                const oldBackup = localStorage.getItem(backupKey);
                if (oldBackup) {
                    localStorage.setItem(oldBackupsKey, oldBackup);
                }
                
                // حفظ النسخة الجديدة
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                localStorage.setItem(`diwan_lastAutoBackup_${currentActivityId}`, String(Date.now()));
                
                // عرض إشعار للمستخدم
                showNotification(
                    '✅ تم إنشاء نسخة احتياطية تلقائية',
                    `تم حفظ نسخة احتياطية من نشاط "${activity.name}" بنجاح`,
                    'success'
                );
                
                debugLog(`✅ تم إنشاء نسخة احتياطية تلقائية للنشاط: ${activity.name}`);
                
            } catch (error) {
                console.error('❌ خطأ في النسخ الاحتياطي التلقائي:', error);
            }
        }
        
        /**
         * استعادة آخر نسخة احتياطية تلقائية
         */
        async function restoreAutoBackup() {
            if (!currentActivityId) {
                showNotification('⚠️ تنبيه', 'يرجى تحديد نشاط أولاً', 'warning');
                return;
            }
            
            const backupKey = `diwan_autoBackup_${currentActivityId}`;
            const backupData = localStorage.getItem(backupKey);
            
            if (!backupData) {
                showNotification('⚠️ لا توجد نسخة احتياطية', 'لم يتم العثور على نسخة احتياطية تلقائية لهذا النشاط', 'warning');
                return;
            }
            
            const confirmed = await showConfirmDialog(
                'استعادة النسخة الاحتياطية',
                'هل أنت متأكد من استعادة آخر نسخة احتياطية تلقائية؟ سيتم استبدال البيانات الحالية.',
                'warning',
                'استعادة',
                'إلغاء'
            );
            
            if (!confirmed) return;
            
            try {
                const backup = JSON.parse(backupData);
                
                // استعادة البيانات
                items = backup.items || [];
                customers = backup.customers || [];
                suppliers = backup.suppliers || [];
                purchases = backup.purchases || [];
                sales = backup.sales || [];
                expenses = backup.expenses || [];
                revenues = backup.revenues || [];
                salaries = backup.salaries || [];
                
                // حفظ البيانات المستعادة في Firebase
                await saveToFirebase('items', items);
                await saveToFirebase('customers', customers);
                await saveToFirebase('suppliers', suppliers);
                await saveToFirebase('purchases', purchases);
                await saveToFirebase('sales', sales);
                await saveToFirebase('expenses', expenses);
                await saveToFirebase('revenues', revenues);
                await saveToFirebase('salaries', salaries);
                
                // تحديث الواجهة
                renderItems();
                renderCustomers();
                renderSuppliers();
                renderPurchasesList();
                renderSalesList();
                renderExpenses();
                renderRevenues();
                renderSalaries();
                updateDataStats();
                
                const backupDate = new Date(backup.backupDate);
                showNotification(
                    '✅ تمت الاستعادة بنجاح',
                    `تم استعادة البيانات من النسخة الاحتياطية بتاريخ ${backupDate.toLocaleString('ar-SA')}`,
                    'success'
                );
                
            } catch (error) {
                console.error('❌ خطأ في استعادة النسخة الاحتياطية:', error);
                showNotification('❌ فشلت الاستعادة', 'حدث خطأ أثناء استعادة النسخة الاحتياطية', 'error');
            }
        }
        
        /**
         * عرض معلومات آخر نسخة احتياطية
         */
        function showAutoBackupInfo() {
            if (!currentActivityId) return;
            
            const backupKey = `diwan_autoBackup_${currentActivityId}`;
            const lastBackupKey = `diwan_lastAutoBackup_${currentActivityId}`;
            
            const backupData = localStorage.getItem(backupKey);
            const lastBackupTime = Number(localStorage.getItem(lastBackupKey) || 0);
            
            if (!backupData) {
                showNotification('ℹ️ معلومات النسخ الاحتياطي', 'لا توجد نسخة احتياطية تلقائية لهذا النشاط بعد', 'info');
                return;
            }
            
            try {
                const backup = JSON.parse(backupData);
                const backupDate = new Date(backup.backupDate);
                const timeDiff = Date.now() - lastBackupTime;
                const hoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
                
                let message = `📅 تاريخ آخر نسخة احتياطية: ${backupDate.toLocaleString('ar-SA')}\n`;
                message += `⏱️ منذ: ${hoursDiff} ساعة\n`;
                message += `📊 عدد الأصناف: ${backup.items?.length || 0}\n`;
                message += `👥 عدد العملاء: ${backup.customers?.length || 0}\n`;
                message += `🏢 عدد الموردين: ${backup.suppliers?.length || 0}\n`;
                message += `💰 عدد المبيعات: ${backup.sales?.length || 0}\n`;
                message += `🛒 عدد المشتريات: ${backup.purchases?.length || 0}`;
                
                showNotification('ℹ️ معلومات النسخ الاحتياطي', message, 'info');
                
            } catch (error) {
                console.error('❌ خطأ في عرض معلومات النسخة الاحتياطية:', error);
            }
        }
        
        /**
         * تنزيل النسخة الاحتياطية التلقائية كملف JSON
         */
        function downloadAutoBackup() {
            if (!currentActivityId) {
                showNotification('⚠️ تنبيه', 'يرجى تحديد نشاط أولاً', 'warning');
                return;
            }
            
            const backupKey = `diwan_autoBackup_${currentActivityId}`;
            const backupData = localStorage.getItem(backupKey);
            
            if (!backupData) {
                showNotification('⚠️ لا توجد نسخة احتياطية', 'لم يتم العثور على نسخة احتياطية تلقائية لهذا النشاط', 'warning');
                return;
            }
            
            try {
                const backup = JSON.parse(backupData);
                const activity = activities.find(a => a.id == currentActivityId);
                const activityName = activity ? activity.name : 'النشاط';
                
                // تنسيق التاريخ للملف
                const date = new Date();
                const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD
                const timeStr = date.toTimeString().split(' ')[0].replace(/:/g, '-'); // HH-MM-SS
                
                // إنشاء اسم الملف
                const fileName = `نسخة_احتياطية_تلقائية_${activityName}_${dateStr}_${timeStr}.json`;
                
                // تحويل البيانات إلى JSON منسق
                const jsonString = JSON.stringify(backup, null, 2);
                
                // إنشاء Blob وتنزيل الملف
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification(
                    '✅ تم التنزيل بنجاح',
                    `تم تنزيل النسخة الاحتياطية: ${fileName}`,
                    'success'
                );
                
            } catch (error) {
                console.error('❌ خطأ في تنزيل النسخة الاحتياطية:', error);
                showNotification('❌ فشل التنزيل', 'حدث خطأ أثناء تنزيل النسخة الاحتياطية', 'error');
            }
        }

        // ===== Initial App Load =====
        async function initializeApp() {
            if (!currentActivityId) { showActivityModal(); return; }
            
            items = (await loadFromFirebase('items')) || [];
            customers = (await loadFromFirebase('customers')) || [];
            suppliers = (await loadFromFirebase('suppliers')) || [];
            purchases = (await loadFromFirebase('purchases')) || [];
            sales = (await loadFromFirebase('sales')) || [];
            expenses = (await loadFromFirebase('expenses')) || [];
            revenues = (await loadFromFirebase('revenues')) || [];
            salaries = (await loadFromFirebase('salaries')) || [];
            salesReturns = (await loadFromFirebase('salesReturns')) || [];
            purchaseReturns = (await loadFromFirebase('purchaseReturns')) || [];

            currentPurchaseNumber = purchases.length > 0 ? Math.max(0, ...purchases.map(p => p.number)) + 1 : 1;
            currentSaleNumber = sales.length > 0 ? Math.max(0, ...sales.map(s => s.number)) + 1 : 1;
            currentSaleReturnNumber = salesReturns.length > 0 ? Math.max(0, ...salesReturns.map(r => r.number)) + 1 : 1;
            currentPurchaseReturnNumber = purchaseReturns.length > 0 ? Math.max(0, ...purchaseReturns.map(r => r.number)) + 1 : 1;
            
            const today = new Date().toISOString().split('T')[0];
            ['purchaseDate', 'saleDate', 'expenseDate', 'revenueDate', 'reportFrom', 'reportTo'].forEach(id => document.getElementById(id).value = today);
            const monthInput = document.getElementById('salaryMonth');
            if (monthInput) {
                if (!monthInput.value) {
                    monthInput.value = new Date().toISOString().slice(0, 7);
                }
                monthInput.onchange = updateSalarySummary;
            }
            
            generatePurchaseCode();
            generateSaleCode();

            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            updateLoggedInUserDisplay(loggedInUser);
            
            updateDashboard(); updateExpenseStats(); updateRevenueStats(); updateDataStats();
            renderItems(); renderCustomers(); renderSuppliers(); renderExpenses(); renderRevenues();
            renderSalaries(); updateSalarySummary();
            clearSalaryForm();
            renderSalesList(); renderPurchasesList();
            renderSalesReturns(); renderPurchaseReturns();
            updatePurchaseDropdowns(); updateSaleDropdowns(); updateReportItemFilter();
            
            // تحميل سلة المحذوفات وعرض الإشعارات
            loadTrashFromLocalStorage();
            updateTrashBadge();
            
            // عرض إشعارات المخزون والديون
            setTimeout(() => {
                checkLowStock();
                checkUnpaidDebts();
            }, 2000);
            
            // تفعيل نظام النسخ الاحتياطي التلقائي
            setTimeout(() => {
                initAutoBackupSystem();
            }, 3000);
            
            const activity = activities.find(a => a.id == currentActivityId);
            console.log(`✅ تم تهيئة النظام للنشاط: ${activity ? activity.name : 'غير معروف'}`);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // تحميل الشعار المحفوظ
            loadSavedLogo();
            
            // معالجة شعار شاشة الدخول - إخفاءه إذا لم يتم العثور على الصورة
            const loginLogo = document.getElementById('loginLogo');
            if (loginLogo) {
                loginLogo.onerror = function() {
                    // التحقق من وجود شعار في localStorage قبل الإخفاء
                    const savedLogo = localStorage.getItem('systemLogo');
                    if (!savedLogo) {
                        this.style.display = 'none';
                    }
                };
            }
            
            const hydrateResponsiveTables = () => {
                const tables = document.querySelectorAll('.section table');
                tables.forEach(table => {
                    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
                    if (!headers.length) return;
                    table.querySelectorAll('tbody tr').forEach(row => {
                        Array.from(row.children).forEach((cell, index) => {
                            if (headers[index]) {
                                cell.setAttribute('data-label', headers[index]);
                            } else {
                                cell.removeAttribute('data-label');
                            }
                        });
                    });
                });
            };

            let responsiveTablesTimer;
            const scheduleResponsiveTablesHydration = () => {
                clearTimeout(responsiveTablesTimer);
                responsiveTablesTimer = setTimeout(hydrateResponsiveTables, 100);
            };

            await loadUsers();
            if (users.length === 0) {
                users.push({ id: 1, name: 'مدير النظام', email: 'msafr3972@gmail.com', phone: '', password: 'A711858322', role: 'admin', activityId: null });
                await saveUsers();
            }
            if (EMAILJS_FIXED) {
                emailJsConfig = { ...EMAILJS_DEFAULTS };
            } else {
                const storedEmailJsConfig = JSON.parse(localStorage.getItem('diwan_email_config') || 'null') || {};
                emailJsConfig = {
                    serviceID: storedEmailJsConfig.serviceID || EMAILJS_DEFAULTS.serviceID || '',
                    templateID: storedEmailJsConfig.templateID || EMAILJS_DEFAULTS.templateID || '',
                    resetTemplateID: storedEmailJsConfig.resetTemplateID || EMAILJS_DEFAULTS.resetTemplateID || '',
                    publicKey: storedEmailJsConfig.publicKey || EMAILJS_DEFAULTS.publicKey || ''
                };
            }
            if (!('resetTemplateID' in emailJsConfig) || emailJsConfig.resetTemplateID === undefined) {
                emailJsConfig.resetTemplateID = '';
            }
            if (!EMAILJS_FIXED) {
                loadEmailJsSettings();
            }

            await loadActivities();
            // إخفاء واجهة إعدادات البريد إذا كانت الإعدادات ثابتة
            if (EMAILJS_FIXED) {
                const toggleBtn = document.getElementById('toggleEmailSettingsBtn');
                const emailSettingsDiv = document.querySelector('.email-settings');
                if (toggleBtn) toggleBtn.style.display = 'none';
                if (emailSettingsDiv) emailSettingsDiv.style.display = 'none';
            }
            await handleResetFlowFromURL();
            
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                 const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                 document.getElementById('login-overlay').style.display = 'none';
                 document.querySelector('.app-container').style.display = 'flex';
                 if (loggedInUser.role === 'admin') {
                    currentActivityId = sessionStorage.getItem('currentActivityId');
                    if (currentActivityId && activities.find(a => a.id == currentActivityId)) {
                        selectActivity(currentActivityId);
                    } else {
                        enterAdminWithoutActivity();
                    }
                 } else if (loggedInUser.role === 'manager') {
                    selectActivity(loggedInUser.activityId);
                 } else {
                    selectActivity(loggedInUser.activityId);
                 }
            } else {
                 document.getElementById('login-overlay').style.display = 'flex';
                 document.querySelector('.app-container').style.display = 'none';
            }
            
            // تفعيل الترتيب للجداول
            FilterSortHelper.makeSortable('itemsTable', 'items', renderItems);
            FilterSortHelper.makeSortable('customersTable', 'customers', renderCustomers);
            FilterSortHelper.makeSortable('suppliersTable', 'suppliers', renderSuppliers);
            FilterSortHelper.makeSortable('salesTable', 'sales', renderSalesList);
            FilterSortHelper.makeSortable('purchasesTable', 'purchases', renderPurchasesList);
            
            // ربط البحث مع الفلترة
            document.getElementById('searchItems')?.addEventListener('input', renderItems);
            document.getElementById('searchCustomers')?.addEventListener('input', renderCustomers);
            document.getElementById('searchSuppliers')?.addEventListener('input', renderSuppliers);
            document.getElementById('searchSales')?.addEventListener('input', searchSales);
            document.getElementById('searchPurchases')?.addEventListener('input', searchPurchases);
            
            // ربط تحديث بيانات العميل عند اختياره في فاتورة المبيعات
            document.getElementById('saleCustomer')?.addEventListener('change', updateCustomerFields);
            
            document.addEventListener('click', function(event) {
                const cp = document.getElementById('controlPanel'), dt = document.querySelector('.design-toggle');
                if (cp && cp.classList.contains('show') && !cp.contains(event.target) && !dt.contains(event.target)) {
                    cp.classList.remove('show');
                }
            });

            const tableObserverRoot = document.querySelector('.app-container') || document.body;
            const responsiveTableObserver = new MutationObserver(scheduleResponsiveTablesHydration);
            responsiveTableObserver.observe(tableObserverRoot, { childList: true, subtree: true });
            scheduleResponsiveTablesHydration();

            const loginEmailField = document.getElementById('loginEmail');
            const loginPasswordField = document.getElementById('loginPassword');
            const submitOnEnter = (event) => {
                if (event.key === 'Enter') {
                    handleLogin();
                }
            };
            if (loginEmailField) {
                loginEmailField.addEventListener('keyup', submitOnEnter);
            }
            if (loginPasswordField) {
                loginPasswordField.addEventListener('keyup', submitOnEnter);
            }

            const searchInputs = { 'searchItems': searchItems, 'searchCustomers': searchCustomers, 'searchSuppliers': searchSuppliers, 'searchPurchases': searchPurchases, 'searchSales': searchSales, 'searchExpenses': () => {}, 'searchRevenues': () => {}, 'searchSalaries': searchSalaries };
            let searchTimeout;
            Object.keys(searchInputs).forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.onkeyup = () => {
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(searchInputs[id], 300);
                    };
                }
            });
        });
        
        function toggleEmailSettings() {
            const emailSettingsDiv = document.querySelector('.email-settings');
            emailSettingsDiv.style.display = emailSettingsDiv.style.display === 'none' ? 'block' : 'none';
        }

        // ===== Password Management =====
        function openChangePasswordModal() {
            const isLogged = sessionStorage.getItem('isLoggedIn') === 'true';
            if (!isLogged) { alert('يرجى تسجيل الدخول أولاً.'); return; }
            const oldEl = document.getElementById('cp-old');
            const newEl = document.getElementById('cp-new');
            const confEl = document.getElementById('cp-confirm');
            if (!oldEl || !newEl || !confEl) return;
            oldEl.value = '';
            newEl.value = '';
            confEl.value = '';
            document.getElementById('change-password-overlay').style.display = 'flex';
        }
        function closeChangePasswordModal() {
            const overlay = document.getElementById('change-password-overlay');
            if (overlay) overlay.style.display = 'none';
        }
        async function submitPasswordChange() {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!loggedInUser) { alert('غير مسجل دخول.'); return; }
            const oldP = document.getElementById('cp-old').value;
            const newP = document.getElementById('cp-new').value;
            const confP = document.getElementById('cp-confirm').value;
            if (!oldP || !newP || !confP) { alert('الرجاء تعبئة جميع الحقول.'); return; }
            if (newP.length < 6) { alert('كلمة المرور الجديدة يجب أن تكون 6 أحرف/أرقام على الأقل.'); return; }
            if (newP !== confP) { alert('تأكيد كلمة المرور غير مطابق.'); return; }
            const idx = users.findIndex(u => u.id === loggedInUser.id);
            if (idx === -1) { alert('المستخدم غير موجود.'); return; }
            if (users[idx].password !== oldP) { alert('كلمة المرور الحالية غير صحيحة.'); return; }
            users[idx].password = newP;
            await saveUsers();
            // تحديث الجلسة
            loggedInUser.password = newP;
            sessionStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
            updateLoggedInUserDisplay(loggedInUser);
            closeChangePasswordModal();
            alert('✅ تم تغيير كلمة المرور بنجاح.');
        }

        function openForgotPasswordModal() {
            const emailEl = document.getElementById('fp-email');
            if (emailEl) emailEl.value = '';
            document.getElementById('forgot-password-overlay').style.display = 'flex';
        }
        function closeForgotPasswordModal() {
            const overlay = document.getElementById('forgot-password-overlay');
            if (overlay) overlay.style.display = 'none';
        }
        async function requestPasswordReset() {
            const email = document.getElementById('fp-email').value.trim();
            if (!email) { alert('يرجى إدخال البريد الإلكتروني.'); return; }
            const user = users.find(u => u.email === email);
            if (!user) { alert('لا يوجد مستخدم بهذا البريد.'); return; }
            if (!emailJsConfig.serviceID || !emailJsConfig.resetTemplateID || !emailJsConfig.publicKey) {
                alert('⚠️ يرجى إعداد EmailJS و Reset Template ID أولاً من الإعدادات.');
                return;
            }
            const token = Math.random().toString(36).slice(2) + Date.now().toString(36);
            const expiresAt = Date.now() + (60 * 60 * 1000); // صلاحية ساعة
            try {
                await firebaseSet(`diwan_password_resets/${token}`, {
                    email,
                    createdAt: Date.now(),
                    expiresAt,
                    used: false
                });
            } catch (e) {
                alert('تعذر إنشاء رابط الاستعادة.');
                return;
            }
            // توليد الرابط اعتماداً على العنوان الحالي للموقع (Netlify أو أي استضافة)
            // نحذف أي بارامترات سابقة ونستخدم الصفحة الحالية كقاعدة
            const baseUrl = window.location.href.split('?')[0];
            const resetLink = `${baseUrl}?resetToken=${encodeURIComponent(token)}`;
            const templateParams = { to_email: email, reset_link: resetLink, app_name: 'نظام الديوان' };
            emailjs.send(emailJsConfig.serviceID, emailJsConfig.resetTemplateID, templateParams, emailJsConfig.publicKey)
                .then(() => { alert('✅ تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك.'); closeForgotPasswordModal(); })
                .catch(err => {
                    let msg = '❌ فشل إرسال البريد';
                    try {
                        const eText = (err && err.text) ? String(err.text) : '';
                        const eStatus = (err && err.status) ? String(err.status) : '';
                        if (eStatus === '400' && /template id not found/i.test(eText)) {
                            msg += '\nالسبب: لم يتم العثور على Template ID.' +
                                   '\nالحل: افتح لوحة EmailJS > Email Templates وانسخ المعرف الحقيقي للقالب ثم الصقه في Reset Template ID داخل إعدادات البريد واحفظ.';
                        } else if (eStatus === '400' && /service/i.test(eText)) {
                            msg += '\nالسبب: Service ID غير صحيح.' +
                                   '\nالحل: انسخ Service ID الصحيح من EmailJS > Email Services.';
                        } else if (eStatus === '401' || /public key/i.test(eText)) {
                            msg += '\nالسبب: Public Key غير صحيح أو الصلاحيات غير كافية.' +
                                   '\nالحل: انسخ Public Key الصحيح من EmailJS > Account > API Keys.';
                        } else {
                            msg += ': ' + JSON.stringify(err);
                        }
                    } catch (_) {
                        msg += ': ' + JSON.stringify(err);
                    }
                    alert(msg);
                });
        }

        let activeResetToken = null;
        function openResetPasswordModal(token) {
            activeResetToken = token;
            const n = document.getElementById('rp-new');
            const c = document.getElementById('rp-confirm');
            if (n) n.value = '';
            if (c) c.value = '';
            document.getElementById('reset-password-overlay').style.display = 'flex';
        }
        function closeResetPasswordModal() {
            const overlay = document.getElementById('reset-password-overlay');
            if (overlay) overlay.style.display = 'none';
            activeResetToken = null;
        }
        async function submitTokenPasswordReset() {
            if (!activeResetToken) { alert('رمز غير صالح.'); return; }
            const newP = document.getElementById('rp-new').value;
            const confP = document.getElementById('rp-confirm').value;
            if (!newP || !confP) { alert('يرجى إدخال كلمة المرور وتأكيدها.'); return; }
            if (newP.length < 6) { alert('كلمة المرور الجديدة يجب أن تكون 6 أحرف/أرقام على الأقل.'); return; }
            if (newP !== confP) { alert('تأكيد كلمة المرور غير مطابق.'); return; }
            const rec = await firebaseGet(`diwan_password_resets/${activeResetToken}`);
            if (!rec) { alert('الرمز غير صالح.'); return; }
            if (rec.used) { alert('تم استخدام هذا الرابط مسبقاً.'); return; }
            if (Date.now() > rec.expiresAt) { alert('انتهت صلاحية الرابط.'); return; }
            const idx = users.findIndex(u => u.email === rec.email);
            if (idx === -1) { alert('المستخدم غير موجود.'); return; }
            users[idx].password = newP;
            await saveUsers();
            await firebaseSet(`diwan_password_resets/${activeResetToken}/used`, true);
            closeResetPasswordModal();
            alert('✅ تم تحديث كلمة المرور. يمكنك الآن تسجيل الدخول.');
            document.getElementById('login-overlay').style.display = 'flex';
            document.querySelector('.app-container').style.display = 'none';
        }

        async function handleResetFlowFromURL() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('resetToken');
            if (!token) return;
            const rec = await firebaseGet(`diwan_password_resets/${token}`);
            if (!rec) { alert('رابط الاستعادة غير صالح.'); return; }
            if (rec.used) { alert('تم استخدام هذا الرابط مسبقاً.'); return; }
            if (Date.now() > rec.expiresAt) { alert('انتهت صلاحية الرابط.'); return; }
            openResetPasswordModal(token);
        }

        function calculateCOGS(filteredSales) {
            let totalCost = 0;
            filteredSales.forEach(sale => {
                sale.items.forEach(soldItem => {
                    const masterItem = items.find(item => item.id === soldItem.id);
                    if (masterItem) {
                        totalCost += soldItem.quantity * masterItem.cost;
                    }
                });
            });
            return totalCost;
        }

// دوال لوحة التحكم المتقدمة
function initAdvancedDashboard() {
    updateLiveStats();
    renderCharts();
    updatePerformanceIndicators();
    loadRecentActivities();
}

function updateLiveStats() {
    const today = new Date().toISOString().split('T')[0];
    const currentMonth = new Date().toISOString().substring(0, 7);
    
    // المبيعات اليومية
    const todaySales = sales.filter(s => s.date === today)
                           .reduce((sum, sale) => sum + sale.total, 0);
    const liveSalesEl = document.getElementById('liveSales');
    if (liveSalesEl) liveSalesEl.textContent = todaySales.toFixed(2);
    
    // الإيرادات الشهرية
    const monthRevenue = sales.filter(s => s.date.substring(0, 7) === currentMonth)
                             .reduce((sum, sale) => sum + sale.total, 0);
    const liveRevenueEl = document.getElementById('liveRevenue');
    if (liveRevenueEl) liveRevenueEl.textContent = monthRevenue.toFixed(2);
    
    // صافي الربح (مبيعات - مشتريات - مصروفات)
    const monthPurchases = purchases.filter(p => p.date.substring(0, 7) === currentMonth)
                                   .reduce((sum, purchase) => sum + purchase.total, 0);
    const monthExpenses = expenses.filter(e => e.date.substring(0, 7) === currentMonth)
                                 .reduce((sum, expense) => sum + expense.amount, 0);
    const netProfit = monthRevenue - monthPurchases - monthExpenses;
    const liveProfitEl = document.getElementById('liveProfit');
    if (liveProfitEl) liveProfitEl.textContent = netProfit.toFixed(2);
    
    // العملاء الجدد (سنضيف createdAt لاحقاً)
    const newCustomers = customers.length; // مؤقتاً
    const liveCustomersEl = document.getElementById('liveCustomers');
    if (liveCustomersEl) liveCustomersEl.textContent = newCustomers;
    
    // المصروفات الشهرية
    const monthlyExpensesEl = document.getElementById('monthlyExpenses');
    if (monthlyExpensesEl) {
        monthlyExpensesEl.innerHTML = `<p>المصروفات هذا الشهر: ${monthExpenses.toFixed(2)} ريال</p>`;
    }

    // الأرباح المتراكمة (من بداية السنة)
    const yearStart = new Date().getFullYear() + '-01-01';
    const cumulativeRevenue = sales.filter(s => s.date >= yearStart).reduce((sum, sale) => sum + sale.total, 0);
    const cumulativePurchases = purchases.filter(p => p.date >= yearStart).reduce((sum, purchase) => sum + purchase.total, 0);
    const cumulativeExpenses = expenses.filter(e => e.date >= yearStart).reduce((sum, expense) => sum + expense.amount, 0);
    const cumulativeProfits = cumulativeRevenue - cumulativePurchases - cumulativeExpenses;
    const cumulativeProfitsEl = document.getElementById('cumulativeProfits');
    if (cumulativeProfitsEl) {
        cumulativeProfitsEl.innerHTML = `<p>الأرباح المتراكمة: ${cumulativeProfits.toFixed(2)} ريال</p>`;
    }
}

function renderCharts() {
    renderSalesChart();
    renderRevenueChart();
    renderTopItemsChart();
    renderExpensesChart();
    renderPurchasesSalesChart();
}

function renderSalesChart() {
    const ctx = document.getElementById('salesChart');
    if (!ctx) return;
    
    // بيانات آخر 7 أيام
    const last7Days = getLast7Days();
    const salesData = last7Days.map(day => 
        sales.filter(s => s.date === day)
             .reduce((sum, sale) => sum + sale.total, 0)
    );

    // تدمير الرسم البياني القديم إذا موجود
    if (window.salesChartInstance) {
        window.salesChartInstance.destroy();
    }

    window.salesChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: last7Days.map(day => formatDate(day)),
            datasets: [{
                label: 'المبيعات',
                data: salesData,
                borderColor: '#2c5aa0',
                backgroundColor: 'rgba(44, 90, 160, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    rtl: true,
                    labels: {
                        font: {
                            family: 'Tajawal',
                            size: 14
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'أداء المبيعات آخر 7 أيام',
                    font: {
                        family: 'Tajawal',
                        size: 16
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        font: {
                            family: 'Tajawal',
                            size: 12
                        }
                    }
                },
                y: {
                    ticks: {
                        font: {
                            family: 'Tajawal',
                            size: 12
                        },
                        callback: function(value) {
                            return value + ' ر.س';
                        }
                    }
                }
            }
        }
    });
}

function renderRevenueChart() {
    const ctx = document.getElementById('revenueChart');
    if (!ctx) return;
    
    const revenueBySource = {
        'مبيعات': revenues.filter(r => r.source === 'sales').reduce((sum, r) => sum + r.amount, 0),
        'خدمات': revenues.filter(r => r.source === 'services').reduce((sum, r) => sum + r.amount, 0),
        'استثمار': revenues.filter(r => r.source === 'investment').reduce((sum, r) => sum + r.amount, 0),
        'أخرى': revenues.filter(r => r.source === 'other').reduce((sum, r) => sum + r.amount, 0)
    };

    // تدمير الرسم البياني القديم إذا موجود
    if (window.revenueChartInstance) {
        window.revenueChartInstance.destroy();
    }

    window.revenueChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(revenueBySource),
            datasets: [{
                data: Object.values(revenueBySource),
                backgroundColor: [
                    '#2c5aa0',
                    '#27ae60',
                    '#e74c3c',
                    '#f39c12'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    rtl: true,
                    labels: {
                        font: {
                            family: 'Tajawal',
                            size: 12
                        },
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value.toFixed(2)} ر.س (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function renderTopItemsChart() {
    const ctx = document.getElementById('topItemsChart');
    if (!ctx) return;
    
    // حساب الأصناف الأكثر مبيعاً
    const itemSales = {};
    sales.forEach(sale => {
        sale.items.forEach(item => {
            if (!itemSales[item.name]) {
                itemSales[item.name] = 0;
            }
            itemSales[item.name] += item.quantity;
        });
    });

    const topItems = Object.entries(itemSales)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

    // تدمير الرسم البياني القديم إذا موجود
    if (window.topItemsChartInstance) {
        window.topItemsChartInstance.destroy();
    }

    window.topItemsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: topItems.map(item => item[0]),
            datasets: [{
                label: 'الكمية المباعة',
                data: topItems.map(item => item[1]),
                backgroundColor: '#2c5aa0',
                borderColor: '#1a3d7a',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'الأصناف الأكثر مبيعاً',
                    font: {
                        family: 'Tajawal',
                        size: 16
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        font: {
                            family: 'Tajawal',
                            size: 12
                        }
                    }
                },
                y: {
                    ticks: {
                        font: {
                            family: 'Tajawal',
                            size: 12
                        }
                    }
                }
            }
        }
    });
}

function renderExpensesChart() {
    const ctx = document.getElementById('expensesChart');
    if (!ctx) return;
    
    // بيانات المصروفات الشهرية لآخر 6 أشهر
    const months = [];
    const expensesData = [];
    for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        const monthStr = date.toISOString().substring(0, 7);
        months.push(monthStr);
        const monthExpenses = expenses.filter(e => e.date.substring(0, 7) === monthStr)
                                     .reduce((sum, expense) => sum + expense.amount, 0);
        expensesData.push(monthExpenses);
    }
    
    if (window.expensesChartInstance) {
        window.expensesChartInstance.destroy();
    }
    
    window.expensesChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'المصروفات',
                data: expensesData,
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function renderPurchasesSalesChart() {
    const ctx = document.getElementById('purchasesSalesChart');
    if (!ctx) return;
    
    // بيانات المشتريات والمبيعات لآخر 6 أشهر
    const months = [];
    const purchasesData = [];
    const salesData = [];
    for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        const monthStr = date.toISOString().substring(0, 7);
        months.push(monthStr);
        const monthPurchases = purchases.filter(p => p.date.substring(0, 7) === monthStr)
                                       .reduce((sum, purchase) => sum + purchase.total, 0);
        const monthSales = sales.filter(s => s.date.substring(0, 7) === monthStr)
                               .reduce((sum, sale) => sum + sale.total, 0);
        purchasesData.push(monthPurchases);
        salesData.push(monthSales);
    }
    
    if (window.purchasesSalesChartInstance) {
        window.purchasesSalesChartInstance.destroy();
    }
    
    window.purchasesSalesChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [{
                label: 'المشتريات',
                data: purchasesData,
                backgroundColor: '#e74c3c',
                borderColor: '#c0392b',
                borderWidth: 1
            }, {
                label: 'المبيعات',
                data: salesData,
                backgroundColor: '#27ae60',
                borderColor: '#219a52',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updatePerformanceIndicators() {
    const monthlySummary = document.getElementById('monthlySummary');
    const financialPerformance = document.getElementById('financialPerformance');
    
    if (!monthlySummary || !financialPerformance) return;
    
    const currentMonth = new Date().toISOString().substring(0, 7);
    
    const monthSales = sales.filter(s => s.date.substring(0, 7) === currentMonth)
                          .reduce((sum, sale) => sum + sale.total, 0);
    const monthExpenses = expenses.filter(e => e.date.substring(0, 7) === currentMonth)
                                .reduce((sum, expense) => sum + expense.amount, 0);
    const monthRevenue = revenues.filter(r => r.date.substring(0, 7) === currentMonth)
                               .reduce((sum, revenue) => sum + revenue.amount, 0);
    const monthPurchases = purchases.filter(p => p.date.substring(0, 7) === currentMonth)
                                  .reduce((sum, purchase) => sum + purchase.total, 0);

    const profitMargin = monthSales > 0 ? ((monthSales - monthPurchases - monthExpenses) / monthSales * 100).toFixed(1) : 0;
    const avgInvoice = monthSales / Math.max(sales.filter(s => s.date.substring(0, 7) === currentMonth).length, 1);

    monthlySummary.innerHTML = `
        <div style="margin-bottom: 15px;">
            <p style="margin: 8px 0; font-size: 14px;">💰 <strong>إجمالي المبيعات:</strong> ${monthSales.toFixed(2)} ر.س</p>
            <p style="margin: 8px 0; font-size: 14px;">💸 <strong>إجمالي المصروفات:</strong> ${monthExpenses.toFixed(2)} ر.س</p>
            <p style="margin: 8px 0; font-size: 14px;">📈 <strong>إجمالي الإيرادات:</strong> ${monthRevenue.toFixed(2)} ر.س</p>
            <p style="margin: 8px 0; font-size: 14px;">🎯 <strong>عدد الفواتير:</strong> ${sales.filter(s => s.date.substring(0, 7) === currentMonth).length}</p>
        </div>
    `;

    financialPerformance.innerHTML = `
        <div style="margin-bottom: 15px;">
            <p style="margin: 8px 0; font-size: 14px;">📊 <strong>هامش الربح:</strong> <span style="color: ${profitMargin > 0 ? '#27ae60' : '#e74c3c'}">${profitMargin}%</span></p>
            <p style="margin: 8px 0; font-size: 14px;">📈 <strong>متوسط الفاتورة:</strong> ${avgInvoice.toFixed(2)} ر.س</p>
            <p style="margin: 8px 0; font-size: 14px;">🔄 <strong>معدل النمو:</strong> <span style="color: #27ae60">+15%</span></p>
            <p style="margin: 8px 0; font-size: 14px;">🎯 <strong>تحقيق الهدف:</strong> <span style="color: #27ae60">85%</span></p>
        </div>
    `;
}

// ===== دوال مساعدة =====
function getLast7Days() {
    const days = [];
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toISOString().split('T')[0]);
    }
    return days;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-SA', { 
        month: 'short', 
        day: 'numeric' 
    });
}

// دالة لتجهيز رقم الهاتف للواتساب (مهمة جداً)
function formatPhoneNumberForWhatsApp(phone) {
    if (!phone) return null;

    // إزالة أي مسافات أو شرطات أو علامة +
    let cleaned = phone.replace(/[\s\-+]/g, '');

    // إذا كان الرقم يبدأ بـ 05 (الشكل السعودي المحلي)
    if (cleaned.startsWith('05')) {
        // استبدال الصفر الأول بـ 966
        return '966' + cleaned.substring(1);
    }

    // إذا كان الرقم يبدأ بـ 5 مباشرة
    if (cleaned.length === 9 && cleaned.startsWith('5')) {
        return '966' + cleaned;
    }

    // إذا كان الرقم مكتوباً بالشكل الدولي الصحيح بالفعل
    if (cleaned.startsWith('966')) {
        return cleaned;
    }

    // إذا لم يتعرف على الصيغة، أرجع الرقم كما هو (قد يعمل)
    return cleaned;
}

// الدالة الرئيسية التي يتم استدعاؤها عند الضغط على الزر
function sendWhatsAppInvoice(saleId) {
    const sale = sales.find(s => s.id === saleId);
    if (!sale) {
        alert('لم يتم العثور على الفاتورة!');
        return;
    }

    const customer = customers.find(c => c.id === sale.customerId);
    if (!customer || !customer.phone) {
        alert('لا يوجد رقم هاتف مسجل لهذا العميل.');
        return;
    }

    const formattedPhone = formatPhoneNumberForWhatsApp(customer.phone);
    if (!formattedPhone) {
        alert('رقم الهاتف غير صالح.');
        return;
    }

    // --- تجهيز نص رسالة الفاتورة ---
    const activityList = (typeof activities !== 'undefined' && Array.isArray(activities)) ? activities : [];
    const activity = activityList.find(a => a.id == currentActivityId);
    const activityName = activity && activity.name ? activity.name : 'نشاطك التجاري';
    let message = `*فاتورة مبيعات - ${activityName}*\n\n`;
    message += `مرحباً ${customer.name},\n`;
    message += `إليك تفاصيل الفاتورة رقم: *SAL${sale.number.toString().padStart(3, '0')}*\n`;
    message += `التاريخ: ${sale.date}\n\n`;

    message += "*الأصناف:*\n";
    sale.items.forEach(item => {
        message += `- ${item.name} (الكمية: ${item.quantity}, السعر: ${item.price.toFixed(2)}) = *${item.total.toFixed(2)}*\n`;
    });

    message += `\n*الإجمالي النهائي: ${sale.total.toFixed(2)} ريال سعودي*\n`;
    message += `المبلغ المدفوع: ${sale.paidAmount.toFixed(2)}\n`;
    message += `المبلغ المتبقي: ${sale.remainingAmount.toFixed(2)}\n\n`;
    message += `شكراً لتعاملكم معنا.`;
    // --- نهاية نص الرسالة ---

    // تحويل النص ليكون متوافقاً مع الرابط
    const encodedMessage = encodeURIComponent(message);

    // الرابط النهائي لفتح الواتساب
    const whatsappUrl = `https://api.whatsapp.com/send?phone=${formattedPhone}&text=${encodedMessage}`;

    // فتح الرابط في نافذة جديدة
    window.open(whatsappUrl, '_blank');
}

// دالة لتحديد كل العملاء أو إلغاء تحديدهم
function toggleAllCustomerCheckboxes(mainCheckbox) {
    const checkboxes = document.querySelectorAll('.customer-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = mainCheckbox.checked;
    });
}

// === دوال حذف المرتجعات ===

// --- حذف مرتجعات المبيعات ---
async function deleteSaleReturn(returnId) {
    if (!confirm('هل تريد نقل هذا المرتجع إلى سلة المحذوفات؟ سيتم إنقاص الكميات المرتجعة من المخزون.')) {
        return;
    }

    const returnIndex = salesReturns.findIndex(sr => sr.id === returnId);
    if (returnIndex === -1) return;

    const returnToDelete = salesReturns[returnIndex];

    // أهم خطوة: عكس تأثير المرتجع على المخزون
    // عند حذف مرتجع مبيعات، يجب إنقاص الكمية من المخزون مرة أخرى.
    returnToDelete.items.forEach(returnedItem => {
        const itemInStock = items.find(i => i.id === returnedItem.id);
        if (itemInStock) {
            itemInStock.stock -= returnedItem.quantity;
        }
    });

    moveToTrash('salesReturns', returnToDelete);
    salesReturns.splice(returnIndex, 1);

    await saveToFirebase('salesReturns', salesReturns);
    await saveToFirebase('items', items);

    renderSalesReturns();
    renderItems();
    updateDashboard();
    showNotification('✅ تم النقل', 'تم نقل مرتجع المبيعات إلى سلة المحذوفات', 'success');
}

// --- حذف مرتجعات المشتريات ---
async function deletePurchaseReturn(returnId) {
    if (!confirm('هل تريد نقل هذا المرتجع إلى سلة المحذوفات؟ سيتم إعادة الكميات إلى المخزون (زيادتها).')) {
        return;
    }

    const returnIndex = purchaseReturns.findIndex(pr => pr.id === returnId);
    if (returnIndex === -1) return;

    const returnToDelete = purchaseReturns[returnIndex];

    // أهم خطوة: عكس تأثير المرتجع على المخزون
    // عند حذف مرتجع مشتريات، يجب إعادة الكمية إلى المخزون.
    returnToDelete.items.forEach(returnedItem => {
        const itemInStock = items.find(i => i.id === returnedItem.id);
        if (itemInStock) {
            itemInStock.stock += returnedItem.quantity;
        }
    });

    moveToTrash('purchaseReturns', returnToDelete);
    purchaseReturns.splice(returnIndex, 1);

    await saveToFirebase('purchaseReturns', purchaseReturns);
    await saveToFirebase('items', items);

    renderPurchaseReturns();
    renderItems();
    updateDashboard();
    showNotification('✅ تم النقل', 'تم نقل مرتجع المشتريات إلى سلة المحذوفات', 'success');
}


    </script>

<!-- نظام الحوار الاحترافي -->
<div id="confirm-overlay" class="confirm-overlay" role="dialog" aria-modal="true" aria-labelledby="confirm-title" aria-describedby="confirm-body">
    <div class="confirm-dialog">
        <div id="confirm-header" class="confirm-header">
            <span id="confirm-icon" class="confirm-icon" aria-hidden="true">⚠️</span>
            <h3 id="confirm-title" class="confirm-title">تأكيد العملية</h3>
        </div>
        <div id="confirm-body" class="confirm-body">
            هل أنت متأكد من رغبتك في تنفيذ هذه العملية؟
        </div>
        <div class="confirm-footer">
            <button id="confirm-btn-cancel" class="confirm-btn-cancel" type="button">إلغاء</button>
            <button id="confirm-btn-confirm" class="confirm-btn-confirm" type="button">تأكيد</button>
        </div>
    </div>
</div>

</body>
</html>